{# Shared Under Construction banner script #}
<script id="site-notice-js">
(function(){
  const notice = document.getElementById('siteNotice');
  if (!notice) return;

  const versionToken = (notice.getAttribute('data-version') || 'default').trim();
  const versionSafe = versionToken.replace(/[^a-z0-9_-]/gi, '').toLowerCase() || 'default';
  const storageKey = `bgm:site-notice:${versionSafe}`;
  const cookieKey = `bgm_site_notice_${versionSafe}`;
  const dismissBtn = notice.querySelector('[data-notice-dismiss]');
  if (!dismissBtn) return;

  const focusSelector = 'a[href], button:not([disabled]), textarea:not([disabled]), input:not([disabled]), select:not([disabled]), [tabindex]:not([tabindex="-1"])';
  let lastFocused = null;

  const cookiePattern = new RegExp('(?:^|; )' + cookieKey.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\$&') + '=([^;]+)');

  const readState = () => {
    try{
      if (window.localStorage.getItem(storageKey) === 'dismissed') return true;
    }catch(_err){}
    const cookieMatch = document.cookie.match(cookiePattern);
    return cookieMatch ? cookieMatch[1] === 'dismissed' : false;
  };

  const persistState = () => {
    try{ window.localStorage.setItem(storageKey, 'dismissed'); }
    catch(_err){}
    const expires = new Date(Date.now() + 1000 * 60 * 60 * 24 * 180).toUTCString();
    document.cookie = `${cookieKey}=dismissed; expires=${expires}; path=/; SameSite=Lax`;
  };

  if (readState()) return;

  const restoreFocus = () => {
    if (lastFocused && document.contains(lastFocused)) {
      try{ lastFocused.focus({ preventScroll:true }); } catch(_err){ lastFocused.focus(); }
    }
    lastFocused = null;
  };

  const handleKeydown = (event) => {
    if (event.key === 'Escape'){
      event.preventDefault();
      closeNotice(true);
      return;
    }
    if (event.key !== 'Tab') return;

    const focusable = Array.from(notice.querySelectorAll(focusSelector))
      .filter(el => !el.hasAttribute('disabled') && el.getAttribute('tabindex') !== '-1' && el.offsetParent !== null);
    if (!focusable.length) return;
    const first = focusable[0];
    const last = focusable[focusable.length - 1];

    if (event.shiftKey){
      if (document.activeElement === first || !notice.contains(document.activeElement)){
        event.preventDefault();
        last.focus();
      }
    } else if (document.activeElement === last){
      event.preventDefault();
      first.focus();
    }
  };

  const onBackdrop = (event) => {
    if (event.target === notice){
      closeNotice(true);
    }
  };

  const openNotice = () => {
    if (!notice.hasAttribute('hidden')) return;
    lastFocused = document.activeElement;
    notice.removeAttribute('hidden');
    document.body.classList.add('site-notice-open');

    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        notice.classList.add('site-notice--visible');
        try{
          dismissBtn.focus({ preventScroll:true });
        }catch(_err){
          dismissBtn.focus();
        }
      });
    });

    document.addEventListener('keydown', handleKeydown, true);
    notice.addEventListener('click', onBackdrop);
  };

  function closeNotice(persist){
    notice.classList.remove('site-notice--visible');
    if (persist) persistState();

    let done = false;
    const finish = () => {
      if (done) return;
      done = true;
      notice.setAttribute('hidden','');
      document.removeEventListener('keydown', handleKeydown, true);
      notice.removeEventListener('click', onBackdrop);
      document.body.classList.remove('site-notice-open');
      restoreFocus();
    };

    const onTransitionEnd = (event) => {
      if (event.target === notice){
        finish();
      }
    };
    notice.addEventListener('transitionend', onTransitionEnd, { once:true });
    setTimeout(finish, 360);
  }

  dismissBtn.addEventListener('click', () => closeNotice(true));

  const ready = () => {
    setTimeout(openNotice, 320);
  };

  if (document.readyState === 'complete' || document.readyState === 'interactive'){
    ready();
  } else {
    document.addEventListener('DOMContentLoaded', ready, { once:true });
  }
})();
</script>
