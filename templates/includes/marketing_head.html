{% load static marketing_extras %}
{% firstof page_meta.title meta_title marketing.site_name as __meta_title %}
{% firstof page_meta.description meta_description marketing.default_description as __meta_description %}
{% firstof page_meta.url meta_url marketing.page_url marketing.canonical_url as __meta_url %}
{% firstof page_meta.type meta_type "website" as __meta_type %}
{% firstof page_meta.image meta_image marketing.default_image as __meta_image %}
{% firstof page_meta.keywords meta_keywords "" as __meta_keywords %}
{% firstof page_meta.robots meta_robots "" as __meta_robots %}
{% firstof page_meta.locale meta_locale "en_US" as __meta_locale %}
{% firstof page_meta.section meta_section "" as __meta_section %}
{% firstof page_meta.published meta_published "" as __meta_published %}
{% firstof page_meta.updated meta_updated "" as __meta_updated %}
{% firstof page_meta.twitter_card meta_twitter_card "summary_large_image" as __twitter_card %}
{% firstof page_meta.schema_type meta_schema_type "WebSite" as __schema_type %}
{% with meta_image_candidate=__meta_image|default:marketing.default_image %}
  {% with meta_image_absolute=meta_image_candidate|absolute_url:marketing.origin|default:marketing.default_image_absolute %}

  <meta name="description" content="{{ __meta_description }}">
  {% if __meta_keywords %}<meta name="keywords" content="{{ __meta_keywords }}">{% endif %}
  <meta name="robots" content="{{ __meta_robots|default:'index,follow' }}">
  {% if __meta_url %}<link rel="canonical" href="{{ __meta_url }}">{% endif %}
  <meta property="og:type" content="{{ __meta_type }}">
  <meta property="og:title" content="{{ __meta_title }}">
  <meta property="og:description" content="{{ __meta_description }}">
  <meta property="og:site_name" content="{{ marketing.site_name }}">
  {% if __meta_url %}<meta property="og:url" content="{{ __meta_url }}">{% endif %}
  <meta property="og:image" content="{{ meta_image_absolute }}">
  <meta property="og:locale" content="{{ __meta_locale }}">
  {% if __meta_section %}<meta property="article:section" content="{{ __meta_section }}">{% endif %}
  {% if __meta_published %}<meta property="article:published_time" content="{{ __meta_published }}">{% endif %}
  {% if __meta_updated %}<meta property="article:modified_time" content="{{ __meta_updated }}">{% endif %}
  <meta name="twitter:card" content="{{ __meta_twitter_card }}">
  <meta name="twitter:title" content="{{ __meta_title }}">
  <meta name="twitter:description" content="{{ __meta_description }}">
  <meta name="twitter:image" content="{{ meta_image_absolute }}">

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "{{ __schema_type }}",
    "name": "{{ marketing.site_name }}",
    "url": "{{ __meta_url|default:marketing.canonical_url }}",
    "description": "{{ __meta_description }}",
    "publisher": {
      "@type": "Organization",
      "name": "{{ marketing.site_name }}",
      "legalName": "{{ marketing.site_name }}",
      "url": "{{ marketing.canonical_url|default:marketing.page_url }}",
      "logo": {
        "@type": "ImageObject",
        "url": "{{ marketing.organization_logo_absolute|default:meta_image_absolute }}"
      }{% if marketing.organization_same_as %},
      "sameAs": [{% for url in marketing.organization_same_as %}"{{ url|escapejs }}"{% if not forloop.last %}, {% endif %}{% endfor %}]
      {% endif %}
    }
  }
  </script>

  <script>
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
      event: "page_view",
      page: {
        title: "{{ __meta_title|escapejs }}",
        url: "{{ __meta_url|default:marketing.page_url|escapejs }}",
        type: "{{ __meta_type|escapejs }}",
        section: "{{ __meta_section|escapejs }}",
        robots: "{{ __meta_robots|default:'index,follow'|escapejs }}"
      },
      user: {
        status: "{{ request.user.is_authenticated|yesno:'authenticated,guest' }}"
      }
    });
  </script>

  {% if marketing.google_tag_manager_id %}
    <script>
      (function(w,d,s,l,i){
        w[l]=w[l]||[];
        w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
        var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),
            dl=l!='dataLayer'?'&l='+l:'';
        j.async=true;
        j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
        f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','{{ marketing.google_tag_manager_id }}');
    </script>
  {% endif %}

  {% if marketing.google_ads_id %}
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ marketing.google_ads_id }}"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', '{{ marketing.google_ads_id }}', {
        'allow_enhanced_conversions': true,
        'send_page_view': {{ marketing.google_ads_send_page_view|yesno:"true,false" }}
      });
    </script>
    {% if marketing.google_ads_conversion_label %}
      <script>
        window.__bgmConversion = function(details){
          details = details || {};
          if (typeof gtag !== "function") {
            return;
          }
          gtag('event', 'conversion', Object.assign({
            'send_to': '{{ marketing.google_ads_id }}/{{ marketing.google_ads_conversion_label }}'
          }, details));
        };
      </script>
    {% endif %}
  {% endif %}
  {% endwith %}
{% endwith %}
