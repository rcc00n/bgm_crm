{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Daily Calendar{% endblock %}
{% block extrastyle %}
    <link rel="stylesheet" href="{% static 'admin/appointments.css' %}">
{% endblock %}
{% block content %}


    <div style="text-align: center; padding-left: 20px; width: 100%; background: rgba(239,239,239,0.52);">
        <div class="calendar-nav">
                <button class="nav-btn" onclick="changeDateToToday()">Today</button>


            <div class="nav-group">

                    <button class="nav-icon2" onclick="changeDateByDays(-1)">&lt;</button>


                <div class="fake-date-picker" onclick="document.getElementById('realDateInput').showPicker()">
                    <span id="displayDate">{{ selected_date|date:"Y-m-d" }}</span>
                    <input
                            type="date"
                            id="realDateInput"
                            value="{{ selected_date|date:'Y-m-d' }}"
                            onchange="onDateChange(this.value)"
                    />
                </div>

                <button class="nav-icon2" onclick="changeDateByDays(1)">&gt;</button>
            </div>

            <button class="nav-icon2" id="nav-icon2" style="border-radius: 10px;">
                <img src="https://img.icons8.com/?size=100&id=O7hGF9n2ssaW&format=png&color=000000" alt="Filter" style="width: 20px; height: 20px;">  <!-- filter icon -->
            </button>

            <button class="add-appointment-btn" onclick="window.location.href='/admin/core/appointment/add/'">
                Add
            </button>
        </div>
    </div>
    <!-- Sidebar -->
    <div id="filterSidebar" class="sidebar2 hidden">
        <div class="sidebar-header2">
            <h3>All filters</h3>
            <button class="close-btn2" onclick="closeSidebar()">✕</button>
        </div>


        <form id="filterForm">
            <div class="filter-section">
                <div class="filter-header" onclick="toggleSection(this)">
                    📅 Appointment status <span class="arrow">⌄</span>
                </div>
                <div class="filter-content">
                    {% for status in appointment_statuses %}
                        <label class="checkbox-wrapper">
                            <input type="checkbox" name="status" value="{{ status.id }}">
                            <span>{{ status.name }}</span>
                        </label>
                    {% endfor %}
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-header" onclick="toggleSection(this)">
                    💳 Payment status <span class="arrow">⌄</span>
                </div>
                <div class="filter-content">
                    {% for ps in payment_statuses %}
                        <label class="checkbox-wrapper">
                            <input type="checkbox" name="payment_status" value="{{ ps.id }}">
                            <span>{{ ps.name }}</span>
                        </label>
                    {% endfor %}
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-header" onclick="toggleSection(this)">
                    🏷️ Services <span class="arrow">Edit</span>
                </div>
                <div class="filter-content">
                    <select name="service" id="serviceSelect">
                        <option value="">All</option>
                        {% for service in services %}
                            <option value="{{ service.id }}">{{ service.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="filter-footer">
                <button type="submit" class="apply-btn">Apply filters</button>
                <button type="button" onclick="clearAllFilters()" class="clear-btn">Clear filters</button>
            </div>
        </form>
    </div>
    <div id="calendar-container">
        {% include "admin/appointments_calendar_partial.html" %}
    </div>

    <script>
        function getLocalDateString(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function changeDateToToday() {
            const today = getLocalDateString();
            document.getElementById('realDateInput').value = today;
            onDateChange(today);
        }

        function changeDateByDays(days) {
            const input = document.getElementById('realDateInput');

            // Преобразуем вручную в YYYY-MM-DD → локальная дата
            const [year, month, day] = input.value.split('-').map(Number);
            const currentDate = new Date(year, month - 1, day); // ← важно: месяц от 0
            currentDate.setHours(12);  // 👈 Устанавливаем безопасное время (чтобы избежать смещений при DST)

            // Меняем дату
            currentDate.setDate(currentDate.getDate() + days);

            const newDate = getLocalDateString(currentDate);
            input.value = newDate;

            onDateChange(newDate);
        }

        function onDateChange(value) {
            const display = document.getElementById("displayDate");

            display.textContent = value;
            const params = new URLSearchParams();
            params.append("date", value);
            params.append("action", "calendar");

            fetch(`/admin/core/appointment/?${params.toString()}`, {
                headers: { 'x-requested-with': 'XMLHttpRequest' }
            })
                .then(res => res.json())
                .then(data => {
                    document.getElementById("calendar-container").innerHTML = data.html;
                });
        }


        const sidebar = document.getElementById("filterSidebar");
        const filterBtn = document.getElementById("nav-icon2");
        const filterForm = document.getElementById("filterForm");

        filterBtn.addEventListener("click", () => {

            sidebar.classList.remove("hidden");
            setTimeout(() => sidebar.classList.add("visible"), 200);
        });
        function closeSidebar() {
            sidebar.classList.remove("visible");
            setTimeout(() => sidebar.classList.add("hidden"), 350);
        }

        function toggleSection(el) {
            const content = el.nextElementSibling;
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
        }

        function clearAllFilters() {
            // Сброс чекбоксов
            document.querySelectorAll('#filterForm input[type="checkbox"]').forEach(cb => cb.checked = false);
            // Сброс селектов
            document.querySelectorAll('#filterForm select').forEach(sel => sel.value = "");
        }

        // Преобразуем несколько чекбоксов в один параметр запроса: ?status=1&status=2
        filterForm.addEventListener("submit", function (e) {
            e.preventDefault();

            const formData = new FormData(filterForm);
            formData.append("action", "filter");
            const selectedDate = document.getElementById("realDateInput").value;
            formData.append("date", selectedDate);
            const params = new URLSearchParams(formData).toString();

            fetch(`?${params}`, {
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
                .then(res => res.json())
                .then(data => {
                    document.getElementById("calendar-container").innerHTML = data.html;
                    closeSidebar();
                })
                .catch(err => {
                    console.error("Error loading appointments:", err);
                });
        });

    </script>
{% endblock %}