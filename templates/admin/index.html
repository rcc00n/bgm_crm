{% extends "admin/base_site.html" %}
{% load static %}
{% block extrahead %}
    {{ block.super }}
    <!-- <link rel="stylesheet" href="{% static 'admin/css/custom_sidebar.css' %}">
    <script defer src="{% static 'admin/js/custom_sidebar.js' %}"></script> -->
    <!-- <link rel="stylesheet" href="{% static 'admin/css/admin_dashboard.css' %}"> -->
    <script defer src="{% static 'admin/js/admin_dashboard.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  {{ block.super }}
  <script defer src="{% static 'admin/js/admin_dashboard.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ===== BGM palette (–ª–æ–∫–∞–ª—å–Ω–æ, —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ —à–∞–±–ª–æ–Ω–∞) ===== */
    :root{
      --bg:#0a0a0a; --ink:#eaeaea; --muted:#bdbdbd;
      --red:#d50000; --red-dark:#b60000;
      --card-bg:#fff; --card-border:rgba(0,0,0,.06);
      --field-bg:rgba(0,0,0,.04);
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius-lg:16px; --radius-sm:10px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --card-bg:rgba(18,18,18,.75);
        --card-border:rgba(255,255,255,.08);
        --shadow:0 10px 30px rgba(0,0,0,.45);
      }
    }

    /* ======================= SIDEBAR (—Ç–æ–ª—å–∫–æ –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥) ======================= */
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –±—Ä–µ–Ω–¥–∞ */
    .main-sidebar{
      background:#111; /* –ø–ª–æ—Ç–Ω–µ–µ —Ç—ë–º–Ω—ã–π */
    }
    .brand-link{
      background:#0e0e0e !important;
      border-bottom:1px solid rgba(255,255,255,.06) !important;
    }
    .brand-link .brand-text{ font-weight:800; letter-spacing:.3px; }

    /* –ü—É–Ω–∫—Ç—ã –º–µ–Ω—é */
    .nav-sidebar .nav-item > .nav-link{
      border-radius:10px;
      margin:4px 8px;
      padding:.55rem .75rem;
      color:#cfcfcf;
      transition:background .12s ease, color .12s ease, transform .08s ease;
    }
    .nav-sidebar .nav-item > .nav-link:hover{
      background:rgba(255,255,255,.06);
      color:#fff;
      transform: translateX(1px);
    }
    /* –ê–∫—Ç–∏–≤–Ω—ã–π –ø—É–Ω–∫—Ç */
    .nav-sidebar .nav-item > .nav-link.active{
      background:linear-gradient(90deg, rgba(213,0,0,.22), rgba(213,0,0,.06));
      color:#fff;
      font-weight:700;
      border:1px solid rgba(213,0,0,.35);
    }
    /* –ò–∫–æ–Ω–∫–∏ –≤ –º–µ–Ω—é */
    .nav-sidebar .nav-link .nav-icon{
      opacity:.9;
      margin-right:.55rem;
    }
    /* –ú–∞–ª–µ–Ω—å–∫–∏–µ ¬´–ø–æ–¥–ø–∏—Å–∏¬ª —Ä–∞–∑–¥–µ–ª–æ–≤ */
    .sidebar .nav-header{
      color:#8e8e8e;
      letter-spacing:.6px;
      font-weight:700;
      margin:10px 12px 6px;
    }

    /* ======================= DASHBOARD (—Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–∞—à–±–æ—Ä–¥–∞) ======================= */
    .content{ padding-top:18px; }
    .dashboard-container{
      max-width:1280px; margin:0 auto; padding:8px 10px 24px;
    }
    .dashboard-grid{
      display:grid; grid-template-columns:repeat(12,1fr); gap:16px;
    }

    .dashboard-card{
      grid-column:span 12;
      background:var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow);
      padding:18px 18px 14px; overflow:hidden;
    }
    .dashboard-card h3{
      font-size:18px; font-weight:800; letter-spacing:.2px; margin:2px 0 10px;
    }
    .dashboard-card p{ color:#555; margin:2px 0 8px; }
    @media (prefers-color-scheme: dark){ .dashboard-card p{ color:var(--muted); } }

    /* –†–∞—Å–∫–ª–∞–¥–∫–∞ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
    @media (min-width:1024px){
      .dashboard-card:nth-of-type(1){ grid-column:span 6; } /* Sales */
      .dashboard-card:nth-of-type(2){ grid-column:span 6; } /* Upcoming */
      .dashboard-card:nth-of-type(3){ grid-column:span 7; } /* Activity (–µ—Å–ª–∏ –≤–∏–¥–µ–Ω) */
      .dashboard-card:nth-of-type(4){ grid-column:span 5; } /* Today */
      .dashboard-card:nth-of-type(5){ grid-column:span 6; } /* Top services */
      .dashboard-card:nth-of-type(6){ grid-column:span 6; } /* Top team */
    }

    /* Canvas: —Ñ–∏–∫—Å-–≤—ã—Å–æ—Ç–∞ –∏ –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
    .dashboard-card canvas{
      width:100% !important; height:240px !important; display:block; margin-top:8px;
      background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent); border-radius:10px;
    }

    /* ===== Activity list ===== */
    .appt-list{
      display:grid; grid-template-columns:1fr; gap:10px;
      max-height:420px; overflow:auto; padding-right:6px;
    }
    .appt-item{
      display:grid; grid-template-columns:64px 1fr auto; align-items:center; gap:12px;
      padding:12px 14px; background:var(--field-bg);
      border:1px solid var(--card-border); border-radius:var(--radius-sm);
      cursor:pointer; transition:transform .08s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .appt-item:hover{ transform:translateY(-1px); box-shadow:0 6px 20px rgba(0,0,0,.08); border-color:rgba(0,0,0,.15); }

    .appt-date{
      display:grid; place-items:center; width:64px; height:56px;
      border-radius:12px; background:#f3f3f3; border:1px solid var(--card-border);
    }
    .appt-day{ font-size:22px; font-weight:800; line-height:1; }
    .appt-month{ font-size:12px; text-transform:uppercase; letter-spacing:.6px; color:#666; }

    .appt-details{ display:grid; gap:4px; }
    .appt-top{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; font-size:13px; color:#666; }
    .appt-status{ padding:2px 8px; border-radius:999px; font-weight:700; font-size:12px; border:1px solid transparent; letter-spacing:.3px; }
    .appt-status.confirmed{ background:rgba(23,212,91,.12); color:#138c46; border-color:rgba(23,212,91,.35); }
    .appt-status.cancelled{ background:rgba(213,0,0,.12); color:#9c0000; border-color:rgba(213,0,0,.35); }
    .appt-service{ font-weight:700; font-size:14px; }
    .appt-master{ font-size:13px; color:#666; }
    .appt-price{ font-weight:800; letter-spacing:.2px; }

    /* ===== Today timeline ===== */
    .appt-timeline{ position:relative; margin-top:6px; }
    .appt-timeline::before{ content:""; position:absolute; left:10px; top:6px; bottom:6px; width:2px; background:rgba(0,0,0,.1); }
    .appt-timeline-item{ position:relative; padding-left:28px; margin:12px 0; }
    .appt-timeline-marker{
      position:absolute; left:2px; top:4px; width:16px; height:16px; border-radius:50%;
      background:#fff; border:3px solid var(--red); box-shadow:0 0 0 3px rgba(213,0,0,.12);
    }
    .appt-time-tag{ display:inline-block; font-weight:800; font-size:12px; padding:2px 8px; border-radius:999px; background:rgba(0,0,0,.05); }
    .appt-line-main{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .appt-service-badge{
      font-size:12px; font-weight:700; padding:2px 8px; border-radius:6px;
      background:rgba(213,0,0,.08); color:var(--red-dark); border:1px solid rgba(213,0,0,.22);
    }

    /* ===== Tables (Top services / Top team) ===== */
    .dashboard-card table{ width:100%; border-collapse:collapse; font-size:14px; }
    .dashboard-card thead th{
      text-align:left; font-size:12px; text-transform:uppercase; letter-spacing:.6px; color:#777;
      padding:10px 8px; border-bottom:1px solid var(--card-border);
    }
    .dashboard-card tbody td{ padding:10px 8px; border-bottom:1px dashed var(--card-border); }
    .dashboard-card tbody tr:hover td{ background:rgba(0,0,0,.03); }
  </style>
{% endblock %}

{% block content %}


    <div class="dashboard-container">
        <div class="dashboard-grid">
            <!-- Block 1: Recent Sales Chart -->
            {% if not is_master %}
            <div class="dashboard-card">
                <h3>Recent Sales</h3>
                <p><br>Appointments value: <strong>CA$ {{ total_sales }}</strong></p>
                <canvas id="salesChart"></canvas>
            </div>
            {% endif %}
            <!-- Block 2: Upcoming Appointments -->
            <div class="dashboard-card">
                <h3>Upcoming appointments</h3>
                <p><strong>{{ upcoming_total }} booked</strong></p>
                <p>Confirmed appointments: {{ confirmed_count }}<br>Cancelled appointments: {{ cancelled_count }}</p>
                <canvas id="upcomingChart" height="150"></canvas>
            </div>
            {% if not is_master %}
            <!-- Block 3: Appointments Activity -->
            <div class="dashboard-card">
                <h3>Appointment activity</h3>
                <div class="appt-list">
                    {% for app in recent_appointments %}

                        <div class="appt-item{% if app.start_time.date == today %} appt-today{% endif %}" onclick="window.location.href='/admin/core/appointment/{{app.id}}/change/'">
                            <div class="appt-date">
                                <span class="appt-day">{{ app.start_time|date:"d" }}</span>
                                <span class="appt-month">{{ app.start_time|date:"b" }}</span>
                            </div>
                            <div class="appt-details">
                                <div class="appt-top">
                                    <span class="appt-time">{{ app.start_time|date:"D, d M Y H:i" }}</span>
                                    <span class="appt-status {{ app.appointmentstatushistory_set.last.status.name|lower }}">{{ app.appointmentstatushistory_set.last.status.name }}</span>
                                </div>
                                <div class="appt-service">{{ app.service.name }}</div>
                                <div class="appt-master">with {{ app.master.get_full_name }}</div>
                            </div>
                            <div class="appt-price">CA$ {{ app.service.base_price }}</div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            <!-- Block 4: Today's Appointments -->
            <div class="dashboard-card">
                <h3>Today's next appointments</h3>
                {% if today_appointments %}
                    <div class="appt-timeline">
                        {% for a in today_appointments %}
                            <div class="appt-timeline-item">
                                <div class="appt-timeline-marker"></div>
                                <div class="appt-timeline-content">
                                    <div class="appt-time-tag">{{ a.start_time|time:"H:i" }}</div>
                                    <div class="appt-line-main">
                                        <strong>{{ a.client.get_full_name }}</strong>
                                        <span class="appt-service-badge">{{ a.service.name }}</span>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p style="text-align:center; margin-top: 20px;">
                        <img src="{% static 'admin/icons/calendar_empty.png' %}" style="width:40px;" alt="No appts">
                        <br>No More Appointments Today<br><a href="/admin/core/appointment/">Go to calendar</a>
                    </p>
                {% endif %}

            </div>
            <!-- Block 5: Top Services -->
            <div class="dashboard-card">
                <h3>Top services</h3>
                <table>
                    <thead><tr><th>Service</th><th>This month</th></tr></thead>
                    <tbody>
                    {% for s in top_services %}
                        <tr><td>{{ s.name }}</td><td>{{ s.count }}</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>


        {% if not is_master %}
            <!-- Block 6: Top Team Member -->
            <div class="dashboard-card">
                <h3>Top team member</h3>
                <table>
                    <thead><tr><th>Team member</th><th>This month</th></tr></thead>
                    <tbody>
                    {% for m in top_masters %}
                        <tr><td>{{ m.get_full_name }}</td><td>CA$ {{ m.total|floatformat:2 }}</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
        </div>
    </div>



    <script>
        const chartData = {{ chart_data|safe }};
        new Chart(document.getElementById('salesChart'), {
            type: 'line',
            data: {
                labels: chartData.map(x => x.day),
                datasets: [
                    {
                        label: 'Sales',
                        data: chartData.map(x => x.sales),
                        borderColor: 'blue', fill: false
                    },
                ]
            }
        });

        const dailyAppointments = {{ daily_appointments|safe }};
        const ctxUpcoming = document.getElementById("upcomingChart").getContext("2d");

        new Chart(ctxUpcoming, {
            type: 'bar',
            data: {
                labels: dailyAppointments.map(x => x.day),
                datasets: [
                    {
                        label: 'Confirmed',
                        data: dailyAppointments.map(x => x.confirmed),
                        backgroundColor: 'rgba(63,81,181,0.8)', // blue
                    },
                    {
                        label: 'Cancelled',
                        data: dailyAppointments.map(x => x.cancelled),
                        backgroundColor: 'rgba(244,67,54,0.8)', // red
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    x: { stacked: true },
                    y: { stacked: true,
                        ticks: {
                            stepSize: 1  // üëà –®–∞–≥ –ø–æ –æ—Å–∏ Y
                        },
                        beginAtZero: true}
                }
            }
        });
    </script>


{% endblock %}