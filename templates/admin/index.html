{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-shell">
  <section class="dashboard-hero">
    <div class="dashboard-hero-content">
      <div>
        <p class="panel-subtitle">Operations control room</p>
        <h1>Welcome back, {{ request.user.get_short_name|default:request.user.get_username }}</h1>
        <p>Keep a pulse on confirmed work, revenue and client flow so you can react before issues appear.</p>
      </div>
      <div class="hero-stat">
        <span>Upcoming bookings</span>
        <strong>{{ upcoming_total }}</strong>
        <small>Confirmed {{ confirmed_count }} · Cancelled {{ cancelled_count }}</small>
      </div>
      {% if not is_master %}
      <div class="hero-stat">
        <span>Appointments value (7 days)</span>
        <strong>CA$ {{ total_sales|floatformat:2 }}</strong>
        <small>Based on scheduled appointments</small>
      </div>
      {% endif %}
    </div>
  </section>

  <div class="kpi-grid">
    <article class="kpi-card">
      <small>Appointments today</small>
      <div class="kpi-value">{{ today_appointments|length }}</div>
      {% if today_appointments %}
        <div class="kpi-trend">Next slot {{ today_appointments.0.start_time|time:"H:i" }}</div>
      {% else %}
        <div class="kpi-trend neutral">No remaining time slots</div>
      {% endif %}
    </article>

    <article class="kpi-card">
      <small>Confirmed this week</small>
      <div class="kpi-value">{{ confirmed_count }}</div>
      <div class="kpi-trend critical">{{ cancelled_count }} cancelled</div>
    </article>

    <article class="kpi-card">
      <small>Recent activity</small>
      <div class="kpi-value">{{ recent_appointments|length }}</div>
      <div class="kpi-trend neutral">Last updated list</div>
    </article>

    {% if not is_master %}
    <article class="kpi-card">
      <small>Revenue (7 days)</small>
      <div class="kpi-value">CA$ {{ total_sales|floatformat:2 }}</div>
      <div class="kpi-trend neutral">Appointments only</div>
    </article>
    {% endif %}
  </div>

  <div class="dashboard-grid">
    {% if not is_master %}
      <section class="data-panel chart-card span-2">
        <div class="panel-title">Revenue trend</div>
        <div class="panel-subtitle">Last 7 days · appointment value</div>
        <canvas id="salesChart"></canvas>
      </section>
    {% endif %}

    <section class="data-panel chart-card">
      <div class="panel-title">Upcoming appointments</div>
      <div class="panel-subtitle">Confirmed vs cancelled · rolling 7 days</div>
      <canvas id="upcomingChart"></canvas>
    </section>

    {% if not is_master %}
    <section class="data-panel span-2">
      <div class="panel-title">Recent appointment activity</div>
      <div class="panel-subtitle">Tap any entry to open the admin form</div>
      <div class="scroll-area">
        {% for app in recent_appointments %}
          <div class="appt-row" onclick="window.location.href='/admin/core/appointment/{{ app.id }}/change/'">
            <div class="appt-meta">
              <span class="panel-subtitle" style="margin:0;">{{ app.start_time|date:"D · d M · H:i" }}</span>
              <strong>{{ app.client.get_full_name }} — {{ app.service.name }}</strong>
              <span>{{ app.master.get_full_name }}</span>
              {% with history=app.appointmentstatushistory_set.last %}
                {% if history and history.status %}
                  {% with status_name=history.status.name %}
                    <span class="status-pill {{ status_name|slugify }}">{{ status_name }}</span>
                  {% endwith %}
                {% endif %}
              {% endwith %}
            </div>
            <div class="appt-price">
              {% if app.service.contact_for_estimate %}
                Contact for estimate{% if app.service.estimate_from_price %} · From ${{ app.service.estimate_from_price|floatformat:2 }}{% endif %}
              {% elif app.service.base_price %}
                CA$ {{ app.service.base_price|floatformat:2 }}
              {% else %}
                —
              {% endif %}
            </div>
          </div>
        {% empty %}
          <div class="empty-state">
            <p>No recent activity.</p>
          </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <section class="data-panel span-2">
      <div class="panel-title">Today's next appointments</div>
      <div class="panel-subtitle">Live view of the remaining schedule</div>
      {% if today_appointments %}
        <div class="timeline">
          {% for a in today_appointments %}
            <div class="timeline-card">
              <strong>{{ a.start_time|time:"H:i" }}</strong>
              <div>{{ a.client.get_full_name }} · {{ a.service.name }}</div>
              <small style="color: var(--admin-text-muted);">With {{ a.master.get_full_name }}</small>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state">
          <img src="{% static 'admin/icons/calendar_empty.png' %}" alt="No appointments">
          <p>No more appointments today.</p>
          <a href="/admin/core/appointment/">Go to calendar</a>
        </div>
      {% endif %}
    </section>
  </div>

  <div class="dashboard-grid">
    <section class="data-panel chart-card">
      <div class="panel-title">Revenue by service</div>
      <div class="panel-subtitle">Last 30 days</div>
      <canvas id="serviceRevenueChart"></canvas>
    </section>

    <section class="data-panel chart-card">
      <div class="panel-title">Revenue by team member</div>
      <div class="panel-subtitle">Last 30 days</div>
      <canvas id="masterRevenueChart"></canvas>
    </section>

    <section class="data-panel chart-card">
      <div class="panel-title">Appointments by weekday</div>
      <div class="panel-subtitle">Last 60 days</div>
      <canvas id="weekdayChart"></canvas>
    </section>

    <section class="data-panel chart-card">
      <div class="panel-title">Payment methods</div>
      <div class="panel-subtitle">Last 30 days</div>
      <canvas id="paymentMethodChart"></canvas>
    </section>

    <section class="data-panel chart-card span-2">
      <div class="panel-title">Status trend</div>
      <div class="panel-subtitle">Last 14 days</div>
      <canvas id="statusTrendChart"></canvas>
    </section>
  </div>
</div>

{{ chart_data|json_script:"chart-data" }}
{{ daily_appointments|json_script:"daily-appts" }}
{{ service_revenue|json_script:"service-revenue" }}
{{ master_revenue|json_script:"master-revenue" }}
{{ weekday_counts|json_script:"weekday-counts" }}
{{ payment_methods|json_script:"payment-methods" }}
{{ status_trend|json_script:"status-trend" }}

<script>
  const $json = (id) => JSON.parse(document.getElementById(id)?.textContent || '[]');
  const gridColor = 'rgba(15, 23, 42, 0.08)';
  const tickColor = '#475569';

  if (window.Chart) {
    Chart.defaults.font.family = "Inter, 'Segoe UI', system-ui, sans-serif";
    Chart.defaults.color = '#0f172a';
  }

  (function renderSales(){
    const el = document.getElementById('salesChart');
    if(!el) return;
    const d = $json('chart-data');
    new Chart(el, {
      type: 'line',
      data: {
        labels: d.map(x => x.day),
        datasets: [{
          label: 'Sales (CA$)',
          data: d.map(x => x.sales),
          borderColor: '#2563eb',
          backgroundColor: 'rgba(37, 99, 235, 0.18)',
          tension: 0.35,
          fill: true,
          pointRadius: 3,
          pointBackgroundColor: '#1d4ed8'
        }]
      },
      options: {
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { color: tickColor }, grid: { color: gridColor } },
          y: { beginAtZero: true, ticks: { color: tickColor }, grid: { color: gridColor } }
        }
      }
    });
  })();

  (function renderUpcoming(){
    const el = document.getElementById('upcomingChart');
    if(!el) return;
    const d = $json('daily-appts');
    new Chart(el, {
      type: 'bar',
      data: {
        labels: d.map(x => x.day),
        datasets: [
          { label: 'Confirmed', data: d.map(x => x.confirmed), backgroundColor: '#22c55e' },
          { label: 'Cancelled', data: d.map(x => x.cancelled), backgroundColor: '#f97316' }
        ]
      },
      options: {
        maintainAspectRatio: false,
        scales: {
          x: { stacked: true, ticks: { color: tickColor }, grid: { color: gridColor } },
          y: { stacked: true, beginAtZero: true, ticks: { color: tickColor }, grid: { color: gridColor } }
        }
      }
    });
  })();

  (function renderServiceRevenue(){
    const el = document.getElementById('serviceRevenueChart');
    if(!el) return;
    const d = $json('service-revenue');
    new Chart(el, {
      type: 'bar',
      data: {
        labels: d.map(x => x.name),
        datasets: [{ label: 'Revenue (CA$)', data: d.map(x => x.total), backgroundColor: '#38bdf8' }]
      },
      options: {
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { color: tickColor }, grid: { color: gridColor } },
          y: { beginAtZero: true, ticks: { color: tickColor }, grid: { color: gridColor } }
        }
      }
    });
  })();

  (function renderMasterRevenue(){
    const el = document.getElementById('masterRevenueChart');
    if(!el) return;
    const d = $json('master-revenue');
    new Chart(el, {
      type: 'bar',
      data: {
        labels: d.map(x => (x.name?.trim() || '—')),
        datasets: [{ label: 'Revenue (CA$)', data: d.map(x => x.total), backgroundColor: '#a855f7' }]
      },
      options: {
        maintainAspectRatio: false,
        indexAxis: 'y',
        scales: {
          x: { beginAtZero: true, ticks: { color: tickColor }, grid: { color: gridColor } },
          y: { ticks: { color: tickColor }, grid: { color: gridColor } }
        }
      }
    });
  })();

  (function renderWeekday(){
    const el = document.getElementById('weekdayChart');
    if(!el) return;
    const d = $json('weekday-counts');
    new Chart(el, {
      type: 'bar',
      data: {
        labels: d.map(x => x.day),
        datasets: [{ label: 'Appointments', data: d.map(x => x.count), backgroundColor: '#0ea5e9' }]
      },
      options: {
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { color: tickColor }, grid: { color: gridColor } },
          y: { beginAtZero: true, ticks: { color: tickColor }, grid: { color: gridColor } }
        }
      }
    });
  })();

  (function renderPayments(){
    const el = document.getElementById('paymentMethodChart');
    if(!el) return;
    const d = $json('payment-methods');
    new Chart(el, {
      type: 'doughnut',
      data: {
        labels: d.map(x => x.method || '—'),
        datasets: [{
          data: d.map(x => x.count),
          backgroundColor: ['#2563eb','#f97316','#14b8a6','#e11d48','#facc15','#8b5cf6']
        }]
      },
      options: {
        maintainAspectRatio: false,
        plugins: { legend: { position: 'right', labels: { color: tickColor } } }
      }
    });
  })();

  (function renderStatus(){
    const el = document.getElementById('statusTrendChart');
    if(!el) return;
    const d = $json('status-trend');
    new Chart(el, {
      type: 'line',
      data: {
        labels: d.map(x => x.day),
        datasets: [
          { label: 'Confirmed', data: d.map(x => x.confirmed), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.15)', fill: true, tension: 0.35, pointRadius: 3 },
          { label: 'Cancelled', data: d.map(x => x.cancelled), borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.18)', fill: true, tension: 0.35, pointRadius: 3 }
        ]
      },
      options: {
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { color: tickColor }, grid: { color: gridColor } },
          y: { beginAtZero: true, ticks: { color: tickColor }, grid: { color: gridColor } }
        }
      }
    });
  })();
</script>
{% endblock %}
