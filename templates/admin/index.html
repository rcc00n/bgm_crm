{% extends "admin/base_site.html" %}
{% load static %}
{% block extrahead %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0a0a0a;
      --ink:#f5f5f5;
      --muted:#c2c2c2;

      --red:#e53935;
      --green:#2ecc71;
      --blue:#4285f4;

      --card-bg:#1e1e1e;
      --card-border:rgba(255,255,255,.15);
      --field-bg:#151515;

      --shadow:0 8px 28px rgba(0,0,0,.55);
      --radius-lg:16px;
      --radius-sm:10px;
    }

    body{ background:var(--bg); color:var(--ink); }

    /* Layout */
    .dashboard-container{ padding:16px; }
    .dashboard-grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:16px;
      align-items:start;
    }
    .span-6{ grid-column: span 6; }
    .span-12{ grid-column: span 12; }
    @media (max-width: 1200px){ .span-6, .span-12{ grid-column: span 12; } }

    /* Cards */
    .dashboard-card{
      background:var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow);
      padding:18px;
    }
    .dashboard-card h3{ font-size:18px; font-weight:800; color:#fff; margin-bottom:8px; }
    .dashboard-card p, .dashboard-card table, .dashboard-card li{ color:var(--muted); }

    /* Canvas */
    .dashboard-card canvas{
      width:100% !important;
      height:260px !important;
      background:#121212;
      border-radius:10px;
    }

    /* Small list items */
    .appt-item{
      display:flex; justify-content:space-between; align-items:center;
      gap:12px; padding:10px 12px; margin:8px 0;
      background:var(--field-bg);
      border:1px solid var(--card-border);
      border-radius:var(--radius-sm);
      color:#f5f5f5;
      cursor:pointer;
    }
    .appt-top{ display:flex; gap:8px; align-items:center; }
    .appt-status{ padding:2px 8px; border-radius:999px; border:1px solid var(--card-border); font-size:12px; }
    .appt-status.confirmed{ background:rgba(46,204,113,.18); color:var(--green); border-color:rgba(46,204,113,.35); }
    .appt-status.cancelled{ background:rgba(229,57,53,.18); color:#ff6f60; border-color:rgba(229,57,53,.35); }

    /* Tables */
    .dashboard-card table{ width:100%; border-collapse:collapse; }
    .dashboard-card thead th{ text-align:left; padding:8px 0; color:#bdbdbd; border-bottom:1px solid var(--card-border); }
    .dashboard-card tbody td{ padding:10px 0; border-bottom:1px dashed var(--card-border); color:#f0f0f0; }

    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; background:rgba(255,255,255,.12); color:#fff; font-size:12px; }
  </style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <div class="dashboard-grid">

    {% if not is_master %}
    <!-- Recent Sales -->
    <div class="dashboard-card span-6">
      <h3>Recent Sales</h3>
      <p>Appointments value (7 days): <strong>CA$ {{ total_sales|floatformat:2 }}</strong></p>
      <canvas id="salesChart"></canvas>
    </div>
    {% endif %}

    <!-- Upcoming Appointments -->
    <div class="dashboard-card span-6">
      <h3>Upcoming Appointments</h3>
      <p><strong>{{ upcoming_total }}</strong> booked</p>
      <p>Confirmed: {{ confirmed_count }} &nbsp;•&nbsp; Cancelled: {{ cancelled_count }}</p>
      <canvas id="upcomingChart"></canvas>
    </div>

    {% if not is_master %}
    <!-- Appointment Activity -->
    <div class="dashboard-card span-12">
      <h3>Appointment Activity</h3>
      <div class="appt-list">
        {% for app in recent_appointments %}
          <div class="appt-item" onclick="window.location.href='/admin/core/appointment/{{ app.id }}/change/'">
            <div>
              <div class="appt-top">
                <span class="badge">{{ app.start_time|date:"D, d M Y H:i" }}</span>
                <span class="appt-status {{ app.appointmentstatushistory_set.last.status.name|lower }}">{{ app.appointmentstatushistory_set.last.status.name }}</span>
              </div>
              <div>{{ app.client.get_full_name }} — {{ app.service.name }} with {{ app.master.get_full_name }}</div>
            </div>
            <div>CA$ {{ app.service.base_price }}</div>
          </div>
        {% empty %}
          <p>No recent activity.</p>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Today's Next Appointments -->
    <div class="dashboard-card span-12">
      <h3>Today's Next Appointments</h3>
      {% if today_appointments %}
        <div class="appt-list">
          {% for a in today_appointments %}
            <div class="appt-item">
              <div>
                <div class="appt-top">
                  <span class="badge">{{ a.start_time|time:"H:i" }}</span>
                </div>
                <div><strong>{{ a.client.get_full_name }}</strong> — {{ a.service.name }}</div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p style="text-align:center; margin-top: 8px;">
          <img src="{% static 'admin/icons/calendar_empty.png' %}" alt="" style="width:40px; opacity:.9;"><br>
          No more appointments today. <a href="/admin/core/appointment/">Go to calendar</a>
        </p>
      {% endif %}
    </div>

    <!-- Top services -->
    <div class="dashboard-card span-6">
      <h3>Top Services</h3>
      <table>
        <thead><tr><th>Service</th><th>This month</th></tr></thead>
        <tbody>
          {% for s in top_services %}
            <tr><td>{{ s.name }}</td><td>{{ s.count }}</td></tr>
          {% empty %}
            <tr><td colspan="2">No data yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if not is_master %}
    <!-- Top team member -->
    <div class="dashboard-card span-6">
      <h3>Top Team Member</h3>
      <table>
        <thead><tr><th>Team member</th><th>This month</th></tr></thead>
        <tbody>
          {% for m in top_masters %}
            <tr><td>{{ m.get_full_name }}</td><td>CA$ {{ m.total|floatformat:2 }}</td></tr>
          {% empty %}
            <tr><td colspan="2">No data yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

  </div>
</div>

{# Safe JSON payloads for charts #}
{{ chart_data|json_script:"chart-data" }}
{{ daily_appointments|json_script:"daily-appts" }}

<script>
  // Read data safely from script tags
  const chartData = JSON.parse(document.getElementById('chart-data').textContent || '[]');
  const dailyAppointments = JSON.parse(document.getElementById('daily-appts').textContent || '[]');

  // Sales line chart
  (function(){
    const canvas = document.getElementById('salesChart');
    if(!canvas) return;
    new Chart(canvas, {
      type: 'line',
      data: {
        labels: chartData.map(x => x.day),
        datasets: [{
          label: 'Sales (CA$)',
          data: chartData.map(x => x.sales),
          borderColor: '#4285f4',
          backgroundColor: 'rgba(66,133,244,0.18)',
          tension: 0.3,
          fill: true,
          pointRadius: 2
        }]
      },
      options: {
        plugins:{ legend:{ display:true } },
        scales:{
          x:{ ticks:{ color:'#cfcfcf' }, grid:{ color:'rgba(255,255,255,.08)' } },
          y:{ beginAtZero:true, ticks:{ color:'#cfcfcf' }, grid:{ color:'rgba(255,255,255,.08)' } }
        }
      }
    });
  })();

  // Upcoming appointments stacked bars
  (function(){
    const canvas = document.getElementById('upcomingChart');
    if(!canvas) return;
    new Chart(canvas.getContext('2d'), {
      type: 'bar',
      data: {
        labels: dailyAppointments.map(x => x.day),
        datasets: [
          { label: 'Confirmed', data: dailyAppointments.map(x => x.confirmed), backgroundColor: 'rgba(66,133,244,0.9)' },
          { label: 'Cancelled', data: dailyAppointments.map(x => x.cancelled), backgroundColor: 'rgba(229,57,53,0.9)' }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'top' } },
        scales: {
          x: { stacked:true, ticks:{ color:'#cfcfcf' }, grid:{ color:'rgba(255,255,255,.08)' } },
          y: { stacked:true, beginAtZero:true, ticks:{ stepSize:1, color:'#cfcfcf' }, grid:{ color:'rgba(255,255,255,.08)' } }
        }
      }
    });
  })();
</script>
{% endblock %}
