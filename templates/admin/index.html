{% extends "admin/base_site.html" %}
{% load static dealer_extras %}

{% block extrahead %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="col-12">
<div class="dashboard-shell">
  <section class="dashboard-hero">
    <div class="dashboard-hero-content">
      <div>
        <p class="panel-subtitle">Operations control room</p>
        <h1>Welcome back, {{ request.user.get_short_name|default:request.user.get_username }}</h1>
        <p>Keep a pulse on confirmed work, revenue and client flow so you can react before issues appear.</p>
      </div>
      <div class="hero-stat">
        <span>Upcoming bookings</span>
        <strong>{{ upcoming_total }}</strong>
        <small>Confirmed {{ confirmed_count }} · Cancelled {{ cancelled_count }}</small>
      </div>
      {% if not is_master %}
      <div class="hero-stat">
        <span>Appointments value (7 days)</span>
        <strong>CA$ {{ total_sales|floatformat:2 }}</strong>
        <small>Based on scheduled appointments</small>
      </div>
      {% endif %}
    </div>
  </section>

  <div class="kpi-grid">
    <article class="kpi-card">
      <small>Appointments today</small>
      <div class="kpi-value">{{ today_appointments|length }}</div>
      {% if today_appointments %}
        <div class="kpi-trend">Next slot {{ today_appointments.0.start_time|time:"H:i" }}</div>
      {% else %}
        <div class="kpi-trend neutral">No remaining time slots</div>
      {% endif %}
    </article>

    <article class="kpi-card">
      <small>Confirmed this week</small>
      <div class="kpi-value">{{ confirmed_count }}</div>
      <div class="kpi-trend critical">{{ cancelled_count }} cancelled</div>
    </article>

    <article class="kpi-card">
      <small>Recent activity</small>
      <div class="kpi-value">{{ recent_appointments|length }}</div>
      <div class="kpi-trend neutral">Last updated list</div>
    </article>

    {% if not is_master %}
    <article class="kpi-card">
      <small>Revenue (7 days)</small>
      <div class="kpi-value">CA$ {{ total_sales|floatformat:2 }}</div>
      <div class="kpi-trend neutral">Appointments only</div>
    </article>
    {% endif %}
  </div>

  <div class="dashboard-grid">
    {% if not is_master %}
      <section class="data-panel chart-card span-2">
        <div class="panel-title">Revenue trend</div>
        <div class="panel-subtitle">Last 7 days · appointment value</div>
        <canvas id="salesChart"></canvas>
      </section>
    {% endif %}

    <section class="data-panel chart-card">
      <div class="panel-title">Upcoming appointments</div>
      <div class="panel-subtitle">Confirmed vs cancelled · rolling 7 days</div>
      <canvas id="upcomingChart"></canvas>
    </section>

    {% if not is_master %}
    <section class="data-panel span-2">
      <div class="panel-title">Recent appointment activity</div>
      <div class="panel-subtitle">Tap any entry to open the admin form</div>
      <div class="scroll-area">
        {% for app in recent_appointments %}
          <div class="appt-row" onclick="window.location.href='/admin/core/appointment/{{ app.id }}/change/'">
            <div class="appt-meta">
              <span class="panel-subtitle" style="margin:0;">{{ app.start_time|date:"D · d M · H:i" }}</span>
              <strong>{{ app.client.get_full_name }} — {{ app.service.name }}</strong>
              <span>{{ app.master.get_full_name }}</span>
              {% with history=app.appointmentstatushistory_set.last %}
                {% if history and history.status %}
                  {% with status_name=history.status.name %}
                    <span class="status-pill {{ status_name|slugify }}">{{ status_name }}</span>
                  {% endwith %}
                {% endif %}
              {% endwith %}
            </div>
            <div class="appt-price">
              {% if app.service.contact_for_estimate %}
                Contact for estimate{% if app.service.estimate_from_price %} · From {{ app.service.estimate_from_price|money }}{% endif %}
              {% elif app.service.base_price %}
                {{ app.service.base_price|money }}
              {% else %}
                —
              {% endif %}
            </div>
          </div>
        {% empty %}
          <div class="empty-state">
            <p>No recent activity.</p>
          </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <section class="data-panel span-2">
      <div class="panel-title">Today's next appointments</div>
      <div class="panel-subtitle">Live view of the remaining schedule</div>
      {% if today_appointments %}
        <div class="timeline">
          {% for a in today_appointments %}
            <div class="timeline-card">
              <strong>{{ a.start_time|time:"H:i" }}</strong>
              <div>{{ a.client.get_full_name }} · {{ a.service.name }}</div>
              <small style="color: var(--admin-text-muted);">With {{ a.master.get_full_name }}</small>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state">
          <img src="{% static 'admin/icons/calendar_empty.png' %}" alt="No appointments">
          <p>No more appointments today.</p>
          <a href="/admin/core/appointment/">Go to calendar</a>
        </div>
      {% endif %}
    </section>
  </div>

  <div class="dashboard-grid">
    <section class="data-panel chart-card">
      <div class="panel-title">Revenue by service</div>
      <div class="panel-subtitle">Last 30 days</div>
      <canvas id="serviceRevenueChart"></canvas>
    </section>

    <section class="data-panel chart-card">
      <div class="panel-title">Revenue by team member</div>
      <div class="panel-subtitle">Last 30 days</div>
      <canvas id="masterRevenueChart"></canvas>
    </section>

    <section class="data-panel chart-card">
      <div class="panel-title">Appointments by weekday</div>
      <div class="panel-subtitle">Last 60 days</div>
      <canvas id="weekdayChart"></canvas>
    </section>

    <section class="data-panel chart-card">
      <div class="panel-title">Payment methods</div>
      <div class="panel-subtitle">Last 30 days</div>
      <canvas id="paymentMethodChart"></canvas>
    </section>

    <section class="data-panel chart-card span-2">
      <div class="panel-title">Status trend</div>
      <div class="panel-subtitle">Last 14 days</div>
      <canvas id="statusTrendChart"></canvas>
    </section>
  </div>

  {% if not is_master and web_analytics %}
  <div class="dashboard-grid analytics-grid">
    <section class="data-panel span-2 analytics-overview">
      <div class="panel-title">Web traffic overview</div>
      <div class="panel-subtitle">Last {{ web_analytics.window_days }} days · public website</div>
      <div class="analytics-kpi-grid">
        <div class="analytics-kpi">
          <span>Total visits</span>
          <strong>{{ web_analytics.totals.visits }}</strong>
          <small>{{ web_analytics.totals.page_views }} page views</small>
        </div>
        <div class="analytics-kpi">
          <span>Signed-in sessions</span>
          <strong>{{ web_analytics.totals.signed_in }}</strong>
          <small>{{ web_analytics.totals.signed_in_pct }}% with accounts</small>
        </div>
        <div class="analytics-kpi">
          <span>Average dwell time</span>
          <strong>{{ web_analytics.totals.avg_duration_seconds }}s</strong>
          <small>Active time per page</small>
        </div>
        <div class="analytics-kpi">
          <span>Pages per visit</span>
          <strong>{{ web_analytics.totals.avg_pages_per_visit }}</strong>
          <small>Mean engagements</small>
        </div>
      </div>
      <div class="analytics-chart-grid">
        <div>
          <div class="panel-subtitle">Visitors per day</div>
          <canvas id="visitorTrafficChart" aria-label="Visitors per day"></canvas>
        </div>
        <div>
          <div class="panel-subtitle">Average dwell time (s)</div>
          <canvas id="engagementQualityChart" aria-label="Average time on page"></canvas>
        </div>
      </div>
    </section>

    <section class="data-panel analytics-table-panel">
      <div class="panel-title">Top pages</div>
      <div class="panel-subtitle">Most viewed</div>
      {% if web_analytics.top_pages %}
        <table class="analytics-table">
          <thead>
            <tr>
              <th>Path</th>
              <th>Views</th>
              <th>Avg time</th>
            </tr>
          </thead>
          <tbody>
            {% for page in web_analytics.top_pages %}
              <tr>
                <td><code>{{ page.path }}</code></td>
                <td>{{ page.views }}</td>
                <td>{{ page.avg_seconds }}s</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="empty-state">
          <p>No page views collected yet.</p>
        </div>
      {% endif %}
    </section>

    <section class="data-panel analytics-table-panel">
      <div class="panel-title">Slowest pages</div>
      <div class="panel-subtitle">Highest dwell time</div>
      {% if web_analytics.slow_pages %}
        <table class="analytics-table">
          <thead>
            <tr>
              <th>Path</th>
              <th>Avg time</th>
              <th>Views</th>
            </tr>
          </thead>
          <tbody>
            {% for page in web_analytics.slow_pages %}
              <tr>
                <td><code>{{ page.path }}</code></td>
                <td>{{ page.avg_seconds }}s</td>
                <td>{{ page.views }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="empty-state">
          <p>No long reads detected.</p>
        </div>
      {% endif %}
    </section>

    <section class="data-panel analytics-table-panel">
      <div class="panel-title">Top referrers</div>
      <div class="panel-subtitle">Where visits originate</div>
      {% if web_analytics.top_referrers %}
        <table class="analytics-table">
          <thead>
            <tr>
              <th>Source</th>
              <th>Visits</th>
            </tr>
          </thead>
          <tbody>
            {% for ref in web_analytics.top_referrers %}
              <tr>
                <td>{{ ref.referrer }}</td>
                <td>{{ ref.visits }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="empty-state">
          <p>No referral data yet.</p>
        </div>
      {% endif %}
    </section>

    <section class="data-panel analytics-table-panel span-2">
      <div class="panel-title">Recent signed-in visitors</div>
      <div class="panel-subtitle">Last activity snapshot</div>
      {% if web_analytics.recent_signed_in_sessions %}
        <ul class="analytics-people">
          {% for session in web_analytics.recent_signed_in_sessions %}
            <li>
              <strong>{{ session.user_name_snapshot|default:"Unnamed account" }}</strong>
              <span>{{ session.user_email_snapshot|default:"No email on file" }}</span>
              <span>Last seen {{ session.last_seen_at|date:"M d · H:i" }}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="empty-state">
          <p>No signed-in visitors in the selected window.</p>
        </div>
      {% endif %}
    </section>
  </div>
  {% endif %}
</div>
</div>

{{ chart_data|json_script:"chart-data" }}
{{ daily_appointments|json_script:"daily-appts" }}
{{ service_revenue|json_script:"service-revenue" }}
{{ master_revenue|json_script:"master-revenue" }}
{{ weekday_counts|json_script:"weekday-counts" }}
{{ payment_methods|json_script:"payment-methods" }}
{{ status_trend|json_script:"status-trend" }}
{% if web_analytics %}
  {{ web_analytics.visitor_timeseries|json_script:"web-visitor-series" }}
  {{ web_analytics.engagement_timeseries|json_script:"web-engagement-series" }}
{% endif %}

<script>
  const $json = (id) => JSON.parse(document.getElementById(id)?.textContent || '[]');
  const gridColor = 'rgba(15, 23, 42, 0.08)';
  const tickColor = '#475569';

  if (window.Chart) {
    Chart.defaults.font.family = "Inter, 'Segoe UI', system-ui, sans-serif";
    Chart.defaults.color = '#0f172a';
  }

  (function renderSales(){
    const el = document.getElementById('salesChart');
    if(!el) return;
    const d = $json('chart-data');
    new Chart(el, {
      type: 'line',
      data: {
        labels: d.map(x => x.day),
        datasets: [{
          label: 'Sales (CA$)',
          data: d.map(x => x.sales),
          borderColor: '#2563eb',
          backgroundColor: 'rgba(37, 99, 235, 0.18)',
          tension: 0.35,
          fill: true,
          pointRadius: 3,
          pointBackgroundColor: '#1d4ed8'
        }]
      },
      options: {
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { color: tickColor }, grid: { color: gridColor } },
          y: { beginAtZero: true, ticks: { color: tickColor }, grid: { color: gridColor } }
        }
      }
    });
  })();

  (function renderUpcoming(){
    const el = document.getElementById('upcomingChart');
    if(!el) return;
    const d = $json('daily-appts');
    new Chart(el, {
      type: 'bar',
      data: {
        labels: d.map(x => x.day),
        datasets: [
          { label: 'Confirmed', data: d.map(x => x.confirmed), backgroundColor: '#22c55e' },
          { label: 'Cancelled', data: d.map(x => x.cancelled), backgroundColor: '#f97316' }
        ]
      },
      options: {
        maintainAspectRatio: false,
        scales: {
          x: { stacked: true, ticks: { color: tickColor }, grid: { color: gridColor } },
          y: { stacked: true, beginAtZero: true, ticks: { color: tickColor }, grid: { color: gridColor } }
        }
      }
    });
  })();

  (function renderServiceRevenue(){
    const el = document.getElementById('serviceRevenueChart');
    if(!el) return;
    const d = $json('service-revenue');
    new Chart(el, {
      type: 'bar',
      data: {
        labels: d.map(x => x.name),
        datasets: [{ label: 'Revenue (CA$)', data: d.map(x => x.total), backgroundColor: '#38bdf8' }]
      },
      options: {
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { color: tickColor }, grid: { color: gridColor } },
          y: { beginAtZero: true, ticks: { color: tickColor }, grid: { color: gridColor } }
        }
      }
    });
  })();

  (function renderMasterRevenue(){
    const el = document.getElementById('masterRevenueChart');
    if(!el) return;
    const d = $json('master-revenue');
    new Chart(el, {
      type: 'bar',
      data: {
        labels: d.map(x => (x.name?.trim() || '—')),
        datasets: [{ label: 'Revenue (CA$)', data: d.map(x => x.total), backgroundColor: '#a855f7' }]
      },
      options: {
        maintainAspectRatio: false,
        indexAxis: 'y',
        scales: {
          x: { beginAtZero: true, ticks: { color: tickColor }, grid: { color: gridColor } },
          y: { ticks: { color: tickColor }, grid: { color: gridColor } }
        }
      }
    });
  })();

  (function renderWeekday(){
    const el = document.getElementById('weekdayChart');
    if(!el) return;
    const d = $json('weekday-counts');
    new Chart(el, {
      type: 'bar',
      data: {
        labels: d.map(x => x.day),
        datasets: [{ label: 'Appointments', data: d.map(x => x.count), backgroundColor: '#0ea5e9' }]
      },
      options: {
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { color: tickColor }, grid: { color: gridColor } },
          y: { beginAtZero: true, ticks: { color: tickColor }, grid: { color: gridColor } }
        }
      }
    });
  })();

  (function renderPayments(){
    const el = document.getElementById('paymentMethodChart');
    if(!el) return;
    const d = $json('payment-methods');
    new Chart(el, {
      type: 'doughnut',
      data: {
        labels: d.map(x => x.method || '—'),
        datasets: [{
          data: d.map(x => x.count),
          backgroundColor: ['#2563eb','#f97316','#14b8a6','#e11d48','#facc15','#8b5cf6']
        }]
      },
      options: {
        maintainAspectRatio: false,
        plugins: { legend: { position: 'right', labels: { color: tickColor } } }
      }
    });
  })();

  (function renderStatus(){
    const el = document.getElementById('statusTrendChart');
    if(!el) return;
    const d = $json('status-trend');
    new Chart(el, {
      type: 'line',
      data: {
        labels: d.map(x => x.day),
        datasets: [
          { label: 'Confirmed', data: d.map(x => x.confirmed), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.15)', fill: true, tension: 0.35, pointRadius: 3 },
          { label: 'Cancelled', data: d.map(x => x.cancelled), borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.18)', fill: true, tension: 0.35, pointRadius: 3 }
        ]
      },
      options: {
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { color: tickColor }, grid: { color: gridColor } },
          y: { beginAtZero: true, ticks: { color: tickColor }, grid: { color: gridColor } }
        }
      }
    });
  })();

  (function renderVisitorTraffic(){
    const el = document.getElementById('visitorTrafficChart');
    if(!el) return;
    const d = $json('web-visitor-series');
    if(!Array.isArray(d) || !d.length) return;
    new Chart(el, {
      type: 'line',
      data: {
        labels: d.map(x => x.label),
        datasets: [{
          label: 'Visitors',
          data: d.map(x => x.count),
          borderColor: '#2563eb',
          backgroundColor: 'rgba(37,99,235,0.15)',
          fill: true,
          tension: 0.35,
          pointRadius: 3,
          pointBackgroundColor: '#1d4ed8'
        }]
      },
      options: {
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: tickColor }, grid: { color: gridColor } },
          y: { beginAtZero: true, ticks: { color: tickColor }, grid: { color: gridColor } }
        }
      }
    });
  })();

  (function renderEngagement(){
    const el = document.getElementById('engagementQualityChart');
    if(!el) return;
    const d = $json('web-engagement-series');
    if(!Array.isArray(d) || !d.length) return;
    new Chart(el, {
      type: 'line',
      data: {
        labels: d.map(x => x.label),
        datasets: [{
          label: 'Avg seconds on page',
          data: d.map(x => x.avg),
          borderColor: '#f97316',
          backgroundColor: 'rgba(249,115,22,0.18)',
          fill: true,
          tension: 0.35,
          pointRadius: 3,
          pointBackgroundColor: '#ea580c'
        }]
      },
      options: {
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: tickColor }, grid: { color: gridColor } },
          y: { beginAtZero: true, ticks: { color: tickColor }, grid: { color: gridColor } }
        }
      }
    });
  })();
</script>
{% endblock %}
