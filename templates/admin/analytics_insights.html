{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="col-12">
  <div class="dashboard-shell">
    <section class="dashboard-hero">
      <div class="dashboard-hero-content">
        <div>
          <p class="panel-subtitle">Behavior & traffic deep dive</p>
          <h1>Analytics insights</h1>
          <p>Last {{ analytics.window_days }} days · {{ analytics.range.start|date:"M d" }} – {{ analytics.range.end|date:"M d" }}</p>
          <div class="insights-window">
            {% for option in window_options %}
              <a class="pill{% if option == window_days %} active{% endif %}" href="?window={{ option }}">{{ option }}d</a>
            {% endfor %}
          </div>
        </div>
        <div class="hero-stat">
          <span>Total visits</span>
          <strong>{{ analytics.totals.visits }}</strong>
          <small>{{ analytics.totals.page_views }} page views</small>
        </div>
        <div class="hero-stat">
          <span>Returning sessions</span>
          <strong>{{ analytics.sessions.returning_pct }}%</strong>
          <small>{{ analytics.sessions.returning }} returning · {{ analytics.sessions.new }} new</small>
        </div>
        <div class="hero-stat">
          <span>Avg session time</span>
          <strong>{{ analytics.sessions.avg_seconds }}s</strong>
          <small>Median {{ analytics.sessions.median_seconds }}s</small>
        </div>
      </div>
    </section>

    <div class="kpi-grid">
      <article class="kpi-card">
        <small>Page views</small>
        <div class="kpi-value">{{ analytics.totals.page_views }}</div>
        <div class="kpi-trend neutral">Avg {{ analytics.totals.avg_pages_per_visit }} pages / visit</div>
      </article>
      <article class="kpi-card">
        <small>Signed-in sessions</small>
        <div class="kpi-value">{{ analytics.totals.signed_in }}</div>
        <div class="kpi-trend neutral">{{ analytics.totals.signed_in_pct }}% of visits</div>
      </article>
      <article class="kpi-card">
        <small>Unique IPs</small>
        <div class="kpi-value">{{ analytics.totals.unique_ips }}</div>
        <div class="kpi-trend neutral">Traffic sources count</div>
      </article>
      <article class="kpi-card">
        <small>Avg time on page</small>
        <div class="kpi-value">{{ analytics.totals.avg_duration_seconds }}s</div>
        <div class="kpi-trend neutral">Median {{ analytics.totals.median_duration_seconds }}s</div>
      </article>
      <article class="kpi-card">
        <small>Bounce rate</small>
        <div class="kpi-value">{{ analytics.sessions.bounce_pct }}%</div>
        <div class="kpi-trend neutral">{{ analytics.sessions.bounce_sessions }} single-page visits</div>
      </article>
      <article class="kpi-card">
        <small>Engaged sessions</small>
        <div class="kpi-value">{{ analytics.sessions.engaged_pct }}%</div>
        <div class="kpi-trend neutral">{{ analytics.sessions.engaged_sessions }} sessions</div>
      </article>
      <article class="kpi-card">
        <small>Session 90th pct</small>
        <div class="kpi-value">{{ analytics.sessions.p90_seconds }}s</div>
        <div class="kpi-trend neutral">Max {{ analytics.sessions.max_seconds }}s</div>
      </article>
      <article class="kpi-card">
        <small>Time zones</small>
        <div class="kpi-value">{{ analytics.timezone_mix|length }}</div>
        <div class="kpi-trend neutral">Top offsets in window</div>
      </article>
    </div>

    <div class="dashboard-grid analytics-grid">
      <section class="data-panel chart-card span-2">
        <div class="panel-title">Visits by day</div>
        <div class="panel-subtitle">Unique sessions per day</div>
        <canvas id="visitsChart"></canvas>
      </section>
      <section class="data-panel chart-card">
        <div class="panel-title">Activity by hour</div>
        <div class="panel-subtitle">Local visitor time</div>
        <canvas id="hourlyChart"></canvas>
      </section>
      <section class="data-panel chart-card">
        <div class="panel-title">Device mix</div>
        <div class="panel-subtitle">Viewport width buckets</div>
        <canvas id="deviceChart"></canvas>
      </section>
      <section class="data-panel chart-card">
        <div class="panel-title">Referrer mix</div>
        <div class="panel-subtitle">Session acquisition</div>
        <canvas id="referrerChart"></canvas>
      </section>
      <section class="data-panel chart-card span-2">
        <div class="panel-title">Session depth</div>
        <div class="panel-subtitle">Pages per session</div>
        <canvas id="depthChart"></canvas>
      </section>
      <section class="data-panel chart-card span-2">
        <div class="panel-title">Time on page distribution</div>
        <div class="panel-subtitle">All page views in window</div>
        <canvas id="durationChart"></canvas>
      </section>
    </div>

    <div class="dashboard-grid analytics-grid">
      <section class="data-panel analytics-table-panel span-2">
        <div class="panel-title">Top landing pages</div>
        <div class="panel-subtitle">Entry pages ranked by sessions</div>
        {% if analytics.landing_pages %}
          <div class="table-scroll">
            <table class="analytics-table">
              <thead>
                <tr>
                  <th>Landing page</th>
                  <th class="numeric">Visits</th>
                  <th class="numeric">Bounce</th>
                  <th class="numeric">Avg pages</th>
                  <th class="numeric">Avg session</th>
                </tr>
              </thead>
              <tbody>
                {% for row in analytics.landing_pages %}
                  <tr>
                    <td><code>{{ row.path }}</code></td>
                    <td class="numeric">{{ row.visits }}</td>
                    <td class="numeric">{{ row.bounce_pct }}%</td>
                    <td class="numeric">{{ row.avg_pages }}</td>
                    <td class="numeric">{{ row.avg_seconds }}s</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="empty-state"><p>No landing data yet.</p></div>
        {% endif %}
      </section>

      <section class="data-panel analytics-table-panel">
        <div class="panel-title">Top exit pages</div>
        <div class="panel-subtitle">Last page seen in session</div>
        {% if analytics.exit_pages %}
          <table class="analytics-table">
            <thead>
              <tr>
                <th>Page</th>
                <th class="numeric">Exits</th>
              </tr>
            </thead>
            <tbody>
              {% for row in analytics.exit_pages %}
                <tr>
                  <td><code>{{ row.path }}</code></td>
                  <td class="numeric">{{ row.exits }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="empty-state"><p>No exit data yet.</p></div>
        {% endif %}
      </section>

      <section class="data-panel analytics-table-panel span-2">
        <div class="panel-title">Top pages by dwell time</div>
        <div class="panel-subtitle">Avg time on page (min 3 views)</div>
        {% if analytics.top_pages_by_duration %}
          <table class="analytics-table">
            <thead>
              <tr>
                <th>Page</th>
                <th class="numeric">Avg seconds</th>
                <th class="numeric">Views</th>
              </tr>
            </thead>
            <tbody>
              {% for row in analytics.top_pages_by_duration %}
                <tr>
                  <td><code>{{ row.path }}</code></td>
                  <td class="numeric">{{ row.avg_seconds }}</td>
                  <td class="numeric">{{ row.views }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="empty-state"><p>No engagement data yet.</p></div>
        {% endif %}
      </section>

      <section class="data-panel analytics-table-panel">
        <div class="panel-title">Top referrers</div>
        <div class="panel-subtitle">Distinct sessions by source</div>
        {% if analytics.top_referrers %}
          <table class="analytics-table">
            <thead>
              <tr>
                <th>Source</th>
                <th class="numeric">Visits</th>
              </tr>
            </thead>
            <tbody>
              {% for row in analytics.top_referrers %}
                <tr>
                  <td>{{ row.referrer }}</td>
                  <td class="numeric">{{ row.visits }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="empty-state"><p>No referral data yet.</p></div>
        {% endif %}
      </section>

      <section class="data-panel analytics-table-panel">
        <div class="panel-title">Top IPs</div>
        <div class="panel-subtitle">Most active sources</div>
        {% if analytics.top_ips %}
          <table class="analytics-table">
            <thead>
              <tr>
                <th>IP address</th>
                <th class="numeric">Visits</th>
                <th class="numeric">Signed-in</th>
              </tr>
            </thead>
            <tbody>
              {% for row in analytics.top_ips %}
                <tr>
                  <td>{{ row.ip_address }}</td>
                  <td class="numeric">{{ row.visits }}</td>
                  <td class="numeric">{{ row.signed_in_pct }}%</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="empty-state"><p>No IP data yet.</p></div>
        {% endif %}
      </section>

      <section class="data-panel analytics-table-panel span-2">
        <div class="panel-title">Most engaged sessions</div>
        <div class="panel-subtitle">Highest total visible time</div>
        {% if analytics.session_leaders %}
          <table class="analytics-table">
            <thead>
              <tr>
                <th>Visitor</th>
                <th>Entry</th>
                <th class="numeric">Pages</th>
                <th class="numeric">Total time</th>
                <th class="numeric">Last seen</th>
              </tr>
            </thead>
            <tbody>
              {% for row in analytics.session_leaders %}
                <tr>
                  <td>
                    <strong>{{ row.user_name }}</strong><br>
                    <span class="panel-subtitle" style="margin:0;">{{ row.user_email }}</span>
                  </td>
                  <td><code>{{ row.landing_path }}</code></td>
                  <td class="numeric">{{ row.views }}</td>
                  <td class="numeric">{{ row.total_seconds }}s</td>
                  <td class="numeric">{{ row.last_seen|date:"M d · H:i" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="empty-state"><p>No session leaders yet.</p></div>
        {% endif %}
      </section>

      <section class="data-panel analytics-table-panel">
        <div class="panel-title">Browser & OS mix</div>
        <div class="panel-subtitle">Session user agents</div>
        <div class="insights-mix-grid">
          <div>
            <div class="eyebrow">Browsers</div>
            <ul class="insights-mix-list">
              {% for row in analytics.browser_mix %}
                <li>
                  <span>{{ row.label }}</span>
                  <strong>{{ row.count }} · {{ row.pct }}%</strong>
                </li>
              {% endfor %}
            </ul>
          </div>
          <div>
            <div class="eyebrow">Operating systems</div>
            <ul class="insights-mix-list">
              {% for row in analytics.os_mix %}
                <li>
                  <span>{{ row.label }}</span>
                  <strong>{{ row.count }} · {{ row.pct }}%</strong>
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </section>

      <section class="data-panel analytics-table-panel">
        <div class="panel-title">Screen sizes</div>
        <div class="panel-subtitle">Most common viewports</div>
        {% if analytics.screen_sizes %}
          <table class="analytics-table">
            <thead>
              <tr>
                <th>Size</th>
                <th class="numeric">Views</th>
              </tr>
            </thead>
            <tbody>
              {% for row in analytics.screen_sizes %}
                <tr>
                  <td>{{ row.label }}</td>
                  <td class="numeric">{{ row.count }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="empty-state"><p>No viewport data yet.</p></div>
        {% endif %}
      </section>
    </div>
  </div>
</div>

{{ analytics.daily_visits|json_script:"analytics-daily-visits" }}
{{ analytics.hourly_activity|json_script:"analytics-hourly" }}
{{ analytics.device_mix|json_script:"analytics-device" }}
{{ analytics.referrer_mix|json_script:"analytics-referrer" }}
{{ analytics.sessions.depth_buckets|json_script:"analytics-depth" }}
{{ analytics.views.duration_buckets|json_script:"analytics-duration" }}

<script>
  const $json = (id) => JSON.parse(document.getElementById(id)?.textContent || '[]');
  const gridColor = 'rgba(15, 23, 42, 0.08)';
  const tickColor = '#475569';

  if (window.Chart) {
    Chart.defaults.font.family = "Inter, 'Segoe UI', system-ui, sans-serif";
    Chart.defaults.color = '#0f172a';
    Chart.defaults.animation = false;
    Chart.defaults.animations = {};
  }

  (function renderDaily(){
    const el = document.getElementById('visitsChart');
    if(!el) return;
    const d = $json('analytics-daily-visits');
    new Chart(el, {
      type: 'line',
      data: {
        labels: d.map(x => x.label),
        datasets: [{
          label: 'Visits',
          data: d.map(x => x.count),
          borderColor: '#2563eb',
          backgroundColor: 'rgba(37, 99, 235, 0.15)',
          tension: 0.35,
          fill: true,
          pointRadius: 3,
          pointBackgroundColor: '#1d4ed8'
        }]
      },
      options: {
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { color: tickColor }, grid: { color: gridColor } },
          y: { beginAtZero: true, ticks: { color: tickColor }, grid: { color: gridColor } }
        }
      }
    });
  })();

  (function renderHourly(){
    const el = document.getElementById('hourlyChart');
    if(!el) return;
    const d = $json('analytics-hourly');
    new Chart(el, {
      type: 'bar',
      data: {
        labels: d.map(x => x.label),
        datasets: [{
          label: 'Views',
          data: d.map(x => x.count),
          backgroundColor: 'rgba(14, 165, 233, 0.5)'
        }]
      },
      options: {
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { color: tickColor }, grid: { color: gridColor } },
          y: { beginAtZero: true, ticks: { color: tickColor }, grid: { color: gridColor } }
        }
      }
    });
  })();

  (function renderDevice(){
    const el = document.getElementById('deviceChart');
    if(!el) return;
    const d = $json('analytics-device');
    new Chart(el, {
      type: 'doughnut',
      data: {
        labels: d.map(x => x.label),
        datasets: [{
          data: d.map(x => x.count),
          backgroundColor: ['#1d4ed8', '#38bdf8', '#a5b4fc', '#e2e8f0']
        }]
      },
      options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
    });
  })();

  (function renderReferrer(){
    const el = document.getElementById('referrerChart');
    if(!el) return;
    const d = $json('analytics-referrer');
    new Chart(el, {
      type: 'doughnut',
      data: {
        labels: d.map(x => x.label),
        datasets: [{
          data: d.map(x => x.count),
          backgroundColor: ['#0ea5e9', '#6366f1', '#f97316', '#22c55e', '#94a3b8', '#f43f5e']
        }]
      },
      options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
    });
  })();

  (function renderDepth(){
    const el = document.getElementById('depthChart');
    if(!el) return;
    const d = $json('analytics-depth');
    new Chart(el, {
      type: 'bar',
      data: {
        labels: d.map(x => x.label),
        datasets: [{
          label: 'Sessions',
          data: d.map(x => x.count),
          backgroundColor: 'rgba(37, 99, 235, 0.5)'
        }]
      },
      options: {
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { color: tickColor }, grid: { color: gridColor } },
          y: { beginAtZero: true, ticks: { color: tickColor }, grid: { color: gridColor } }
        }
      }
    });
  })();

  (function renderDuration(){
    const el = document.getElementById('durationChart');
    if(!el) return;
    const d = $json('analytics-duration');
    new Chart(el, {
      type: 'bar',
      data: {
        labels: d.map(x => x.label),
        datasets: [{
          label: 'Page views',
          data: d.map(x => x.count),
          backgroundColor: 'rgba(99, 102, 241, 0.5)'
        }]
      },
      options: {
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { color: tickColor }, grid: { color: gridColor } },
          y: { beginAtZero: true, ticks: { color: tickColor }, grid: { color: gridColor } }
        }
      }
    });
  })();
</script>
{% endblock %}
