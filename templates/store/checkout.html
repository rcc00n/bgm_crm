{% extends "store/_base_store.html" %}
{% load dealer_extras %}
{% block title %}Checkout ‚Äî BGM Store{% endblock %}

{% block body %}
<div id="bg"></div>

<section class="section">
  <div class="container">

    <!-- Progress -->
    <nav class="steps" aria-label="Checkout progress">
      <a class="steps__item" href="{% url 'store-cart' %}">Cart</a>
      <span class="steps__sep" aria-hidden="true">‚Ä∫</span>
      <span class="steps__item steps__item--current" aria-current="step">Checkout</span>
      <span class="steps__sep" aria-hidden="true">‚Ä∫</span>
      <span class="steps__item steps__item--muted">Done</span>
    </nav>

    <div class="section__head" style="align-items:center;justify-content:space-between;gap:1rem">
      <h1 class="section__title">Checkout</h1>
      <a class="btn btn--ghost" href="{% url 'store-cart' %}">‚Üê Back to cart</a>
    </div>

    {% if messages %}
      <div aria-live="polite">
        {% for m in messages %}
          <div class="callout {% if m.tags == 'success' %}callout--ok{% else %}callout--err{% endif %}">
            <div class="callout__body">{{ m }}</div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="checkout-grid">
      <!-- FORM -->
      <form class="card checkout-form" method="post" novalidate enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-grid">

          <!-- Contact -->
          <section>
            <h3 class="block-title">Contact</h3>
            <div class="fields-2">
              <div>
                <label class="label" for="customer_name">Full name*</label>
                <input id="customer_name" class="input{% if errors.customer_name %} input--invalid{% endif %}"
                       type="text" name="customer_name" autocomplete="name" required
                       placeholder="John Doe" value="{{ form.customer_name|default_if_none:'' }}">
                {% if errors.customer_name %}<div class="err">{{ errors.customer_name }}</div>{% endif %}
              </div>
              <div>
                <label class="label" for="phone">Phone*</label>
                <input id="phone" class="input{% if errors.phone %} input--invalid{% endif %}"
                       type="text" name="phone" autocomplete="tel" required
                       placeholder="+1 (555) 123-4567" value="{{ form.phone|default_if_none:'' }}">
                {% if errors.phone %}<div class="err">{{ errors.phone }}</div>{% endif %}
              </div>
              <div>
                <label class="label" for="email">Email*</label>
                <input id="email" class="input{% if errors.email %} input--invalid{% endif %}"
                       type="email" name="email" autocomplete="email" required
                       placeholder="you@example.com" value="{{ form.email|default_if_none:'' }}">
                {% if errors.email %}<div class="err">{{ errors.email }}</div>{% endif %}
              </div>
            </div>
          </section>

          <!-- Delivery -->
          <section>
            <h3 class="block-title">Delivery</h3>
            <fieldset class="options">
              <label class="opt">
                <input type="radio" name="delivery_method" value="shipping" {% if form.delivery_method != 'pickup' %}checked{% endif %}>
                <span>Shipping</span>
              </label>
              <label class="opt">
                <input type="radio" name="delivery_method" value="pickup" {% if form.delivery_method == 'pickup' %}checked{% endif %}>
                <span>Pickup</span>
              </label>
            </fieldset>

            <!-- Address -->
            <div id="addr" class="addr">
              <div class="fields-2">
                <div>
                  <label class="label" for="address_line1">Address ‚Äî street, number*</label>
                  <input id="address_line1" class="input{% if errors.address_line1 %} input--invalid{% endif %}"
                         type="text" name="address_line1" autocomplete="address-line1"
                         placeholder="123 Main St" value="{{ form.address_line1|default_if_none:'' }}">
                  {% if errors.address_line1 %}<div class="err">{{ errors.address_line1 }}</div>{% endif %}
                </div>
                <div>
                  <label class="label" for="address_line2">Apt / suite (optional)</label>
                  <input id="address_line2" class="input" type="text" name="address_line2"
                         autocomplete="address-line2" placeholder="Apt 4B"
                         value="{{ form.address_line2|default_if_none:'' }}">
                </div>
              </div>

              <div class="fields-3">
                <div>
                  <label class="label" for="city">City*</label>
                  <input id="city" class="input{% if errors.city %} input--invalid{% endif %}"
                         type="text" name="city" autocomplete="address-level2"
                         placeholder="Calgary" value="{{ form.city|default_if_none:'' }}">
                  {% if errors.city %}<div class="err">{{ errors.city }}</div>{% endif %}
                </div>
                <div>
                  <label class="label" for="region">State / Province*</label>
                  <input id="region" class="input{% if errors.region %} input--invalid{% endif %}"
                         type="text" name="region" autocomplete="address-level1"
                         placeholder="AB" value="{{ form.region|default_if_none:'' }}">
                  {% if errors.region %}<div class="err">{{ errors.region }}</div>{% endif %}
                </div>
                <div>
                  <label class="label" for="postal_code">Postal / ZIP*</label>
                  <input id="postal_code" class="input{% if errors.postal_code %} input--invalid{% endif %}"
                         type="text" name="postal_code" autocomplete="postal-code"
                         placeholder="T2X 1A1" value="{{ form.postal_code|default_if_none:'' }}">
                  {% if errors.postal_code %}<div class="err">{{ errors.postal_code }}</div>{% endif %}
                </div>
              </div>

              <div>
                <label class="label" for="country">Country*</label>
                <input id="country" class="input{% if errors.country %} input--invalid{% endif %}"
                       type="text" name="country" autocomplete="country-name"
                       placeholder="Canada" value="{{ form.country|default_if_none:'Canada' }}">
                {% if errors.country %}<div class="err">{{ errors.country }}</div>{% endif %}
              </div>
            </div>

            <!-- Pickup notes -->
            <div id="pickup" class="pickup">
              <label class="label" for="pickup_notes">Pickup preferences (time, contact, etc.)</label>
              <input id="pickup_notes" class="input" type="text" name="pickup_notes"
                     placeholder="Tomorrow after 3 PM" value="{{ form.pickup_notes|default_if_none:'' }}">
            </div>
          </section>

          <!-- Payment -->
          <section>
            <div class="section__head" style="margin-bottom:.45rem;">
              <h3 class="block-title">Payment</h3>
              <p class="section__desc">Pick a 50% deposit or pay in full. Card processing fees are passed through and shown in the totals.</p>
            </div>

            <fieldset class="options options--pay">
              <label class="opt opt--wide">
                <input type="radio" name="pay_mode" value="deposit_50" {% if pay_mode == 'deposit_50' %}checked{% endif %}>
                <div>
                  <div class="opt__title">Pay 50% now</div>
                  <div class="opt__sub">
                    Charge now {{ payment_options.deposit_50.charge|money }} (includes {{ payment_options.deposit_50.fee|money }} card fee).
                    Balance later {{ payment_options.deposit_50.balance_due|money }}.
                  </div>
                </div>
              </label>
              <label class="opt opt--wide">
                <input type="radio" name="pay_mode" value="full" {% if pay_mode != 'deposit_50' %}checked{% endif %}>
                <div>
                  <div class="opt__title">Pay 100% now</div>
                  <div class="opt__sub">
                    Charge now {{ payment_options.full.charge|money }} (includes {{ payment_options.full.fee|money }} card fee).
                    Balance later {{ payment_options.full.balance_due|money }}.
                  </div>
                </div>
              </label>
            </fieldset>

            {% if errors.payment %}
              <div class="callout callout--err"><div class="callout__body">{{ errors.payment }}</div></div>
            {% endif %}

            <div class="card-frame-wrap">
              <label class="label" for="card-container">Card details</label>
              <div id="card-container" class="card-frame" aria-live="polite"></div>
              <div id="card-errors" class="err" aria-live="polite"></div>
              <input type="hidden" name="square_payment_token" id="squarePaymentToken" value="">
            </div>

            {% if not square_ready %}
              <div class="callout callout--err">
                <div class="callout__body">
                  Square credentials are missing. Add SQUARE_APPLICATION_ID, SQUARE_LOCATION_ID, and SQUARE_ACCESS_TOKEN to enable checkout.
                </div>
              </div>
            {% endif %}
          </section>

          <!-- Order notes -->
          <section>
            <h3 class="block-title">Order notes</h3>
            <textarea class="input" name="comment" rows="4" placeholder="Anything we should know?">{{ form.comment|default_if_none:'' }}</textarea>
          </section>

          <!-- Reference photo -->
          <section>
            <h3 class="block-title">Photo reference <span class="section__desc" style="font-size:.9rem;">(optional)</span></h3>
            <div class="upload-card {% if errors.reference_image %}upload-card--invalid{% endif %}">
              <input type="file" id="reference_image" name="reference_image" accept="image/*" hidden>
              <div id="referenceDropzone" class="upload-drop">
                <div class="upload-graphic">üì∑</div>
                <div class="upload-copy">
                  <p class="upload-title">Drop an image or click to upload</p>
                  <p class="upload-subtitle">JPG, PNG, or WEBP ‚Äî up to {{ reference_image_limit_mb }} MB.</p>
                </div>
                <button type="button" id="uploadPick" class="btn btn--ghost btn--small">Browse</button>
              </div>
              <div id="referencePreview" class="upload-preview" hidden>
                <img id="referencePreviewImg" alt="Reference preview">
                <div>
                  <p id="referencePreviewName" class="upload-title"></p>
                  <p id="referencePreviewMeta" class="upload-subtitle"></p>
                </div>
                <button type="button" id="uploadClear" class="btn btn--ghost btn--small" hidden>Remove</button>
              </div>
              {% if errors.reference_image %}
                <div class="err">{{ errors.reference_image }}</div>
              {% else %}
                <p class="section__desc text-xs">If the form reloads you'll need to pick the file again.</p>
              {% endif %}
            </div>
          </section>

          <!-- Consent + actions -->
          <label class="check">
            <input id="agree" type="checkbox" name="agree" value="1" {% if form.agree %}checked{% endif %}>
            <span>I confirm my details are correct and agree to the purchase terms</span>
          </label>
          {% if errors.agree %}<div class="err">{{ errors.agree }}</div>{% endif %}

          <div class="actions">
            <button id="submitBtn" class="btn btn--primary" type="submit">Pay {{ selected_payment.charge|money }} now</button>
            <a class="btn btn--ghost" href="{% url 'store-cart' %}">Return to cart</a>
          </div>
        </div>
      </form>

      <!-- SUMMARY -->
      <aside class="card summary">
        <h3 class="block-title">Order summary</h3>

        {% if positions %}
          <ul class="summary__list">
            {% for it in positions %}
              <li class="summary__row">
                <div>
                  <div class="summary__title">{{ it.product.name }}</div>
                  <div class="section__desc">x{{ it.qty }} ‚Ä¢ {{ it.product.category.name }}</div>
                  {% if it.option %}
                    <div class="section__desc">Option: {{ it.option.name }}</div>
                  {% endif %}
                  <div class="section__desc">
                    Retail {{ it.retail_unit_price|money }}
                    {% if it.discount_percent %}
                      <span class="badge badge--dealer">Dealer {{ it.unit_price|money }}</span>
                    {% endif %}
                  </div>
                  {% if it.savings %}
                    <div class="section__desc">Saved {{ it.savings|money }}</div>
                  {% endif %}
                </div>
                <div class="summary__amount">{{ it.line_total|money }}</div>
              </li>
            {% endfor %}
          </ul>
          <div class="summary__total">
            <div>
              <span class="summary__total-label">{% if dealer_discount_percent %}Dealer total{% else %}Total{% endif %}</span>
              <span class="summary__total-sum">{{ total|money }}</span>
            </div>
            {% if cart_savings and cart_savings|floatformat:2 != '0.00' %}
              <div class="summary__total-savings">
                <span class="summary__total-label">You save</span>
                <span class="summary__total-sum">- {{ cart_savings|money }}</span>
              </div>
            {% endif %}
          </div>
          {% if cart_savings and cart_savings|floatformat:2 != '0.00' %}
            <p class="section__desc">Retail before discount: {{ retail_total|money }}</p>
          {% endif %}

          <div class="summary__divider"></div>
          <div class="summary__pay">
            <div class="summary__row">
              <span class="summary__total-label">Paying now</span>
              <span class="summary__total-sum" id="summaryCharge">{{ selected_payment.charge|money }}</span>
            </div>
            <div class="summary__row">
              <span class="section__desc">Card fee passed through</span>
              <span id="summaryFee">{{ selected_payment.fee|money }}</span>
            </div>
            <div class="summary__row">
              <span class="section__desc">Covers products worth</span>
              <span id="summaryBase">{{ selected_payment.base|money }}</span>
            </div>
            <div class="summary__row" id="balanceRow" {% if selected_payment.balance_due <= 0 %}hidden{% endif %}>
              <span class="section__desc">Balance later</span>
              <span id="summaryBalance">{{ selected_payment.balance_due|money }}</span>
            </div>
          </div>
        {% else %}
          <p class="section__desc">Your cart is empty. <a href="{% url 'store' %}">Browse catalog</a></p>
        {% endif %}
      </aside>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="{% static 'admin/js/bgm-smoke.js' %}"></script>
    {% if square_ready %}
      <script src="https://{% if square_is_sandbox %}sandbox.{% endif %}web.squarecdn.com/v1/square.js"></script>
    {% endif %}

  </div>
</section>

<style>
  /* Layout */
  .checkout-grid{
    display:grid; gap:1.2rem;
    grid-template-columns: 2fr 1fr;
  }
  @media (max-width: 960px){
    .checkout-grid{ grid-template-columns: 1fr; }
    .summary{ position: static; top:auto; }
  }
  .form-grid{ display:grid; gap:1rem; }
  .fields-2{ display:grid; gap:.8rem; grid-template-columns:1fr 1fr; }
  .fields-3{ display:grid; gap:.8rem; grid-template-columns:1fr 1fr 1fr; }
  @media (max-width: 720px){
    .fields-2, .fields-3{ grid-template-columns:1fr; }
  }

  /* Steps */
  .steps{ display:flex; align-items:center; gap:.5rem; margin-bottom:.6rem; color:var(--muted); }
  .steps__item{ padding:.2rem .45rem; border-radius:.45rem; background:rgba(255,255,255,.04); }
  .steps__item--current{ color:var(--ink); background:rgba(213,0,0,.12); border:1px solid rgba(213,0,0,.35); }
  .steps__item--muted{ opacity:.7; }
  .steps__sep{ opacity:.5; }

  /* Cards & controls */
  .checkout-form{ padding:1rem; }
  .summary{ padding:1rem; position:sticky; top:1rem; height:max-content; }
  .block-title{ font-weight:800; margin: .2rem 0 .6rem; }
  .label{ display:block; margin:0 0 .35rem .1rem; color:var(--muted); font-size:.9rem; }
  .input{
    width:100%; padding:.7rem .8rem; border-radius:.6rem;
    border:1px solid var(--card-border); background:var(--field-bg); color:var(--ink);
    outline:none; transition:border-color .15s ease, box-shadow .15s ease;
  }
  .input:focus{ border-color:var(--red); box-shadow:0 0 0 2px rgba(213,0,0,.28); }
  .input--invalid{ border-color:var(--error-text); box-shadow:0 0 0 2px rgba(255,138,128,.25); }
  textarea.input{ resize:vertical; min-height:110px; }

  .options{ display:grid; grid-template-columns:1fr 1fr; gap:.8rem; border:0; padding:0; margin:0 0 .6rem; }
  .opt{
    display:flex; align-items:center; gap:.55rem; padding:.6rem .7rem;
    border:1px solid var(--card-border); border-radius:.6rem; background:var(--field-bg);
  }
  .opt input{ accent-color:var(--red); }
  .options--pay{ grid-template-columns:1fr; }
  .opt--wide{ align-items:flex-start; }
  .opt__title{ font-weight:800; }
  .opt__sub{ color:var(--muted); font-size:.9rem; }

  .addr, .pickup{ margin-top:.8rem; }
  .pickup{ display:none; }

  .check{ display:flex; align-items:flex-start; gap:.55rem; padding:.6rem .7rem; border:1px solid var(--card-border); border-radius:.6rem; background:var(--field-bg); }
  .check input{ margin-top:.2rem; accent-color:var(--red); }

  .actions{ display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }
  .btn.is-busy{ opacity:.7; cursor:progress; }
  .btn--small{ padding:.45rem .75rem; font-size:.85rem; }

  .upload-card{
    border:1px dashed var(--card-border);
    border-radius:var(--radius-sm);
    padding:1rem;
    background:rgba(255,255,255,.02);
  }
  .upload-card--invalid{ border-color:var(--error-text); }
  .upload-drop{
    display:flex; align-items:center; gap:1rem;
    padding:1rem;
    border:1px dashed rgba(255,255,255,.2);
    border-radius:var(--radius-sm);
    cursor:pointer;
    transition:.2s;
  }
  .upload-card--invalid .upload-drop{ border-color:var(--error-text); }
  .upload-drop:hover,
  .upload-drop.is-dragover{
    border-color:var(--red); background:rgba(213,0,0,.04);
  }
  .upload-graphic{
    width:48px; height:48px;
    display:grid; place-items:center;
    font-size:1.5rem;
    border-radius:14px;
    background:rgba(255,255,255,.05);
  }
  .upload-title{ font-weight:700; margin-bottom:.15rem; }
  .upload-subtitle{ color:var(--muted); font-size:.9rem; }
  .upload-preview{
    display:flex; align-items:center; gap:1rem;
    margin-top:1rem;
    padding:1rem;
    border:1px solid rgba(255,255,255,.15);
    border-radius:var(--radius-sm);
    background:rgba(255,255,255,.02);
  }
  .upload-preview img{
    width:72px; height:72px; object-fit:cover;
    border-radius:12px; border:1px solid rgba(255,255,255,.12);
  }

  .card-frame-wrap{ margin-top:.8rem; }
  .card-frame{
    border:1px solid var(--card-border);
    border-radius:.6rem;
    padding:.8rem;
    background:var(--field-bg);
    min-height:56px;
  }

  .summary__list{ list-style:none; display:grid; gap:.6rem; margin:0; padding:0; }
  .summary__row{
    display:flex; justify-content:space-between; gap:.8rem;
    border-bottom:1px dashed var(--card-border); padding-bottom:.45rem;
  }
  .summary__title{ font-weight:700; }
  .summary__amount{ white-space:nowrap; }
  .summary__total{
    display:flex; flex-direction:column; gap:.4rem; margin-top:1rem;
  }
  .summary__total > div{
    display:flex; justify-content:space-between; font-weight:900;
  }
  .summary__total-label{font-weight:800;}
  .summary__total-sum{font-weight:900;}
  .summary__total-savings span{color:#17d45b;}
  .summary__divider{ height:1px; background:var(--card-border); margin:.9rem 0; }
  .summary__pay{ display:grid; gap:.45rem; }
  .badge{
    display:inline-flex; align-items:center; gap:.3rem;
    padding:.18rem .5rem; border-radius:.5rem;
    border:1px solid rgba(255,255,255,.15);
    background:rgba(255,255,255,.06);
    font-size:.8rem;
  }
  .badge--dealer{background:rgba(23,212,91,.12); border-color:rgba(23,212,91,.35); color:#17d45b;}

  .callout{ border-left:4px solid; background:var(--card-bg); border:1px solid var(--card-border); border-left-color:#d50000; border-radius:.6rem; margin-bottom:1rem; }
  .callout--ok{ border-left-color:#17d45b; }
  .callout__body{ padding:.9rem 1rem; }
  .err{ color:#ff8a80; font-size:.9rem; margin-top:.25rem; }
  /* –¥—ã–º ‚Äî —Å–ª–æ–π –ø–æ–∑–∞–¥–∏ –≤—Å–µ–≥–æ */
#bg{position:fixed; inset:0; z-index:0; pointer-events:none;}
#bg canvas{position:absolute; inset:0; width:100%; height:100%; display:block;}

/* –≤–µ—Å—å –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–≤–µ—Ä—Ö –¥—ã–º–∞ */
.site-header, .hero, .section, footer{position:relative; z-index:1;}

/* —É–±–∏—Ä–∞–µ–º –ø—Ä–µ–∂–Ω–∏–π —Ñ–æ–Ω —É hero */
.hero--store{ background:transparent !important; }

</style>

<script>
  (function(){
    const methodInputs = document.querySelectorAll('input[name="delivery_method"]');
    const addr   = document.getElementById('addr');
    const pickup = document.getElementById('pickup');
    const agree  = document.getElementById('agree');
    const submit = document.getElementById('submitBtn');
    const postal = document.getElementById('postal_code');
    const refInput = document.getElementById('reference_image');
    const refDrop  = document.getElementById('referenceDropzone');
    const refPick  = document.getElementById('uploadPick');
    const refClear = document.getElementById('uploadClear');
    const refPreview = document.getElementById('referencePreview');
    const refPreviewImg = document.getElementById('referencePreviewImg');
    const refPreviewName = document.getElementById('referencePreviewName');
    const refPreviewMeta = document.getElementById('referencePreviewMeta');
    const formEl = document.querySelector('.checkout-form');
    const payRadios = document.querySelectorAll('input[name="pay_mode"]');
    const paymentOptions = JSON.parse('{{ payment_options_json|escapejs }}' || '{}');
    const currencySymbol = "{{ currency_symbol }}";
    const squareReady = {{ square_ready|yesno:"true,false" }};
    const squareAppId = "{{ square_application_id }}";
    const squareLocationId = "{{ square_location_id }}";
    const cardErrors = document.getElementById('card-errors');
    const tokenInput = document.getElementById('squarePaymentToken');
    const summaryCharge = document.getElementById('summaryCharge');
    const summaryFee = document.getElementById('summaryFee');
    const summaryBase = document.getElementById('summaryBase');
    const summaryBalance = document.getElementById('summaryBalance');
    const balanceRow = document.getElementById('balanceRow');
    const serverPaymentError = "{{ errors.payment|default_if_none:'' }}";
    let cardInstance = null;
    let processingPayment = false;

    function syncDelivery(){
      const val = document.querySelector('input[name="delivery_method"]:checked')?.value;
      const ship = val !== 'pickup';
      addr.style.display   = ship ? 'block' : 'none';
      pickup.style.display = ship ? 'none'  : 'block';
    }
    function syncAgree(){
      if (!submit) return;
      submit.disabled = !agree.checked;
      submit.style.opacity = submit.disabled ? .6 : 1;
      submit.style.cursor = submit.disabled ? 'not-allowed' : 'pointer';
    }
    function normalizePostal(){
      if (!postal) return;
      postal.value = postal.value.toUpperCase().replace(/\s+/g,'').replace(/(.{3})/,'$1 ');
    }
    function bytesToString(bytes){
      if (!bytes && bytes !== 0) return '';
      if (bytes < 1024) return `${bytes} B`;
      if (bytes < 1048576) return `${(bytes/1024).toFixed(1)} KB`;
      return `${(bytes/1048576).toFixed(1)} MB`;
    }
    function resetPreview(){
      if (!refPreview) return;
      refPreview.setAttribute('hidden','');
      if (refClear) refClear.setAttribute('hidden','');
      if (refPreviewImg) refPreviewImg.src = '';
      if (refPreviewName) refPreviewName.textContent = '';
      if (refPreviewMeta) refPreviewMeta.textContent = '';
    }
    function showPreview(file){
      if (!file || !refPreview) return;
      refPreview.removeAttribute('hidden');
      if (refClear) refClear.removeAttribute('hidden');
      if (refPreviewName) refPreviewName.textContent = file.name || 'Selected image';
      if (refPreviewMeta) refPreviewMeta.textContent = bytesToString(file.size);
      if (refPreviewImg){
        const reader = new FileReader();
        reader.onload = e => { refPreviewImg.src = e.target.result; };
        reader.readAsDataURL(file);
      }
    }
    function assignFile(file){
      if (!(window.DataTransfer && file)) return false;
      try{
        const dt = new DataTransfer();
        dt.items.add(file);
        refInput.files = dt.files;
        return true;
      }catch(_){
        return false;
      }
    }
    function handleReferenceFile(file){
      if (!file) return;
      if (!assignFile(file)){
        alert('Drag & drop is not supported in this browser. Please use the Browse button.');
        return;
      }
      showPreview(file);
    }

    methodInputs.forEach(i => i.addEventListener('change', syncDelivery));
    if (agree)  agree.addEventListener('change', syncAgree);
    if (postal) postal.addEventListener('blur', normalizePostal);
    if (refInput){
      refInput.addEventListener('change', () => {
        if (!refInput.files.length){
          resetPreview();
          return;
        }
        showPreview(refInput.files[0]);
      });
    }
    if (refDrop){
      refDrop.addEventListener('click', () => refInput && refInput.click());
      ['dragenter','dragover'].forEach(evt => refDrop.addEventListener(evt, e => {
        e.preventDefault();
        refDrop.classList.add('is-dragover');
      }));
      ['dragleave','dragend','drop'].forEach(evt => refDrop.addEventListener(evt, e => {
        if (evt !== 'drop') e.preventDefault();
        refDrop.classList.remove('is-dragover');
      }));
      refDrop.addEventListener('drop', e => {
        e.preventDefault();
        const file = e.dataTransfer?.files?.[0];
        if (file) handleReferenceFile(file);
      });
    }
    if (refPick){
      refPick.addEventListener('click', (e) => {
        e.preventDefault();
        refInput && refInput.click();
      });
    }
    if (refClear){
      refClear.addEventListener('click', (e) => {
        e.preventDefault();
        if (refInput) refInput.value = '';
        resetPreview();
      });
    }

    function formatMoney(value){
      const num = Number(value || 0);
      return `${currencySymbol}${num.toFixed(2)}`;
    }

    function updatePaymentSummary(){
      const mode = document.querySelector('input[name="pay_mode"]:checked')?.value || 'full';
      const data = paymentOptions[mode] || paymentOptions.full || {charge:0, fee:0, base:0, balance_due:0};
      if (summaryCharge) summaryCharge.textContent = formatMoney(data.charge);
      if (summaryFee) summaryFee.textContent = formatMoney(data.fee);
      if (summaryBase) summaryBase.textContent = formatMoney(data.base);
      if (balanceRow){
        if ((data.balance_due || 0) > 0.009){
          balanceRow.hidden = false;
          if (summaryBalance) summaryBalance.textContent = formatMoney(data.balance_due);
        }else{
          balanceRow.hidden = true;
        }
      }
      if (submit) submit.textContent = `Pay ${formatMoney(data.charge)} now`;
      return data;
    }

    async function setupSquare(){
      if (!squareReady || !window.Square || !squareAppId || !squareLocationId){
        if (!squareReady && cardErrors){
          cardErrors.textContent = 'Payments are not configured yet. Please contact us to place the order.';
        }
        return;
      }
      try{
        const payments = window.Square.payments(squareAppId, squareLocationId);
        cardInstance = await payments.card();
        await cardInstance.attach('#card-container');
      }catch(err){
        console.error(err);
        if (cardErrors) cardErrors.textContent = 'Could not load the card form. Please refresh or contact us.';
      }
    }

    async function handleSubmit(event){
      if (!formEl || !submit) return;
      if (processingPayment){
        event.preventDefault();
        return;
      }
      event.preventDefault();
      if (!agree.checked){
        syncAgree();
        return;
      }
      if (!cardInstance){
        if (cardErrors) cardErrors.textContent = 'Payment form is not ready yet.';
        return;
      }
      processingPayment = true;
      submit.disabled = true;
      submit.classList.add('is-busy');
      if (cardErrors) cardErrors.textContent = '';
      const result = await cardInstance.tokenize();
      if (result.status === 'OK'){
        if (tokenInput) tokenInput.value = result.token;
        formEl.submit();
      }else{
        const msg = (result.errors && result.errors[0] && result.errors[0].message) || 'Card was declined. Please check details.';
        if (cardErrors) cardErrors.textContent = msg;
        processingPayment = false;
        submit.disabled = !agree.checked;
        submit.classList.remove('is-busy');
      }
    }

    methodInputs.forEach(i => i.addEventListener('change', syncDelivery));
    if (agree)  agree.addEventListener('change', syncAgree);
    if (postal) postal.addEventListener('blur', normalizePostal);
    payRadios.forEach(r => r.addEventListener('change', updatePaymentSummary));
    if (formEl) formEl.addEventListener('submit', handleSubmit);

    document.addEventListener('DOMContentLoaded', function(){
      syncDelivery();
      syncAgree();
      updatePaymentSummary();
      if (serverPaymentError && cardErrors){ cardErrors.textContent = serverPaymentError; }
      setupSquare();
    });
  })();
</script>
{% endblock %}
