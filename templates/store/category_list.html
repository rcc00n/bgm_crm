{% extends "store/_base_store.html" %}
{% load dealer_extras %}
{% block title %}BGM — {{ category.display_name }}{% endblock %}

{% block body %}
<div id="bg"></div>

{% if category.image %}
<section class="hero hero--cat" style="background:
  linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.85)),
  url('{{ category.image.url }}') center/cover no-repeat;">
  <div class="container hero__inner hero__inner--tight">
    <div>
      <h1 class="title">{{ category.display_name }}</h1>
      {% if category.description %}<p class="lead">{{ category.description }}</p>{% endif %}
      <div class="btn-row"><a class="btn btn--ghost" href="{% url 'store' %}">← All categories</a></div>
    </div>
  </div>
</section>
{% else %}
<section class="section">
  <div class="container">
    <h1 class="section__title">{{ category.display_name }}</h1>
    {% if category.description %}<p class="section__desc">{{ category.description }}</p>{% endif %}
    <a class="btn btn--ghost" href="{% url 'store' %}" style="margin-top:.6rem">← All categories</a>
  </div>
</section>
{% endif %}

<section class="section" data-search-root>
  <div class="container">
    <div class="search-bar" data-product-search>
      <label class="visually-hidden" for="categoryProductSearch">Search products</label>
      <div class="search-bar__field">
        <span class="search-bar__icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
            <path d="M15.5 14h-.79l-.28-.27A6 6 0 1 0 14 15.5l.27.28v.79L20 21.5 21.5 20l-6-6zm-5.5 0A4.5 4.5 0 1 1 10 5a4.5 4.5 0 0 1 0 9z"/>
          </svg>
        </span>
        <input id="categoryProductSearch"
               class="search-bar__input"
               type="search"
               inputmode="search"
               autocomplete="off"
               placeholder="Search products">
        <button type="button" class="search-bar__clear" data-search-clear hidden>Clear</button>
      </div>
      <div class="search-bar__meta" data-search-count aria-live="polite"></div>
    </div>
    <p class="search-empty" data-search-empty hidden>No products match your search.</p>

    <div class="grid grid--cards">
      {% for p in products %}
        <article class="card product" data-search-item data-search-text="{{ p.name }} {{ p.short_description|default:'' }} {{ p.category.display_name|default:'' }}">
          <a class="product__link" href="{% url 'store-product' slug=p.slug %}">
            <div class="card__img">
              {% if p.main_image %}
                <img src="{{ p.main_image_url }}" alt="{{ p.name }}" loading="lazy" class="img-fit">
              {% elif p.image %}
                <img src="{{ p.image.url }}" alt="{{ p.name }}" loading="lazy" class="img-fit">
              {% else %}
                <div class="ph" aria-hidden="true"></div>
              {% endif %}
            </div>
          </a>

          <div class="product__meta">
            <h3 class="product__title"><a href="{% url 'store-product' slug=p.slug %}">{{ p.name }}</a></h3>
            {% if p.short_description %}<p class="section__desc">{{ p.short_description }}</p>{% endif %}
            <div class="price price--stacked">
              {% if p.contact_for_estimate %}
                <strong>Contact for estimate</strong>
                {% if p.estimate_from_price %}<span class="price__hint">From {{ p.estimate_from_price|money }}</span>{% endif %}
              {% else %}
                <div class="price__retail-row">
                  {% if p.has_option_price_overrides %}<span class="price__hint">From</span>{% endif %}
                  <strong>{{ p.display_price|money }}</strong>
                  {% if p.old_price %}<span class="old">{{ p.old_price|money }}</span>{% endif %}
                </div>
                {% if dealer_portal.show_discount %}
                  <div class="price__dealer-row">
                    <span class="price__hint">Dealer {{ dealer_portal.discount_percent }}%</span>
                    <strong>{{ p.display_price|dealer_price:dealer_portal.discount_percent|money }}</strong>
                    <span class="price__save">Save {{ p.display_price|dealer_savings:dealer_portal.discount_percent|money }}</span>
                  </div>
                {% endif %}
              {% endif %}
            </div>

            <!-- quick actions -->
            <div class="quick row">
              {% if p.contact_for_estimate %}
                <a class="btn btn--primary" href="{% url 'home' %}#contact">Contact us</a>
                <a class="btn btn--ghost" href="{% url 'store-product' slug=p.slug %}">View product</a>
              {% elif p.has_active_options %}
                <a class="btn btn--primary" href="{% url 'store-product' slug=p.slug %}#product-options">Select options</a>
                <a class="btn btn--ghost" href="{% url 'store-product' slug=p.slug %}">View product</a>
              {% else %}
                <form method="post" action="{% url 'store-cart-add' slug=p.slug %}">{% csrf_token %}
                  <button class="btn btn--primary" type="submit">Add to cart</button>
                </form>
                <form method="post" action="{% url 'store-checkout' %}">{% csrf_token %}
                  <input type="hidden" name="buy_now_slug" value="{{ p.slug }}">
                  <button class="btn btn--ghost" type="submit">Buy now</button>
                </form>
              {% endif %}
            </div>
          </div>
        </article>
      {% empty %}
        <div class="empty">No products in this category yet.</div>
      {% endfor %}
    </div>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="{% static 'admin/js/bgm-smoke.js' %}"></script>

  </div>
</section>

<style>
  .hero--cat{box-shadow:inset 0 -80px 120px rgba(0,0,0,.35)}
  .hero__inner--tight{padding:2.2rem 0}
  .btn-row{display:flex;gap:.6rem;margin-top:.9rem;flex-wrap:wrap}

  .grid--cards{--min:260px;display:grid;grid-template-columns:repeat(auto-fill,minmax(var(--min),1fr));gap:1rem}
  .card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:1rem;box-shadow:0 6px 20px rgba(0,0,0,.25);transition:transform .18s ease, box-shadow .18s ease}
  .card:hover{transform:translateY(-2px);box-shadow:0 10px 26px rgba(0,0,0,.33)}
  .card__img{position:relative;overflow:hidden;border-radius:.9rem}
  .img-fit{width:100%;height:100%;object-fit:cover;aspect-ratio:16/9;display:block}

  .card.product{display:flex;flex-direction:column;height:100%}
  .product__meta{padding:.8rem;display:flex;flex-direction:column;flex:1}
  .product__title{margin:.6rem 0 0}
  .price{margin-top:.35rem;display:flex;gap:.5rem;align-items:baseline}
  .price--stacked{flex-direction:column;align-items:flex-start;gap:.3rem}
  .product__meta .price{margin-top:auto;padding-top:.35rem}
  .price__retail-row{display:flex;gap:.45rem;align-items:baseline}
  .price__dealer-row{
    display:inline-flex;
    gap:.35rem;
    flex-wrap:wrap;
    align-items:baseline;
    background:rgba(213,0,0,.12);
    border:1px solid rgba(213,0,0,.35);
    border-radius:.6rem;
    padding:.2rem .5rem;
  }
  .price__hint{font-size:.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;}
  .price .old{color:var(--muted);text-decoration:line-through}
  .price__save{font-size:.78rem;color:var(--muted)}
  .quick.row{margin-top:.7rem;display:flex;gap:.5rem;flex-wrap:wrap}

  .ph{
    border-radius:.8rem;width:100%;height:100%;aspect-ratio:16/9;
    background:
      radial-gradient(600px 260px at 10% -10%, rgba(213,0,0,.18), transparent 60%),
      linear-gradient(90deg,#111,#151515,#111);
    background-size:200% 100%;animation:sh 1.2s ease-in-out infinite;
  }
  @keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}
  /* дым — слой позади всего */
#bg{position:fixed; inset:0; z-index:0; pointer-events:none;}
#bg canvas{position:absolute; inset:0; width:100%; height:100%; display:block;}

/* весь контент поверх дыма */
.site-header, .hero, .section, footer{position:relative; z-index:1;}

/* убираем прежний фон у hero */
.hero--store{ background:transparent !important; }
/* Переопределение только для названия категории */
.hero--cat .title,
.section__title {
  text-transform: none !important;   /* убираем капс */
  letter-spacing: .01em !important;  /* меньше растяжки */
  font-size: clamp(1.9rem, 2.6vw, 2.3rem) !important; /* оставляем читаемый размер */
  line-height: 1.25 !important; 
}

@media (max-width: 900px){
  .section__head{flex-direction:column;align-items:flex-start;gap:.6rem;}
  .grid--cards{grid-template-columns:1fr;}
  .product__meta{padding:.9rem;}
  .product__meta .section__desc{
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
    overflow:hidden;
  }
  .btn-row{flex-direction:column;align-items:flex-start;}
  .btn-row .btn{width:100%;justify-content:center;}
  .quick.row{flex-direction:column;align-items:stretch;}
  .quick.row .btn{width:100%;justify-content:center;}
  .quick.row form{width:100%;}
  .quick.row form .btn{width:100%;justify-content:center;}
}

</style>
{% endblock %}
