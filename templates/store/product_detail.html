{% extends "store/_base_store.html" %}
{% block title %}{{ product.name }} — BGM Store{% endblock %}

{% block body %}
<div id="bg"></div>

<section class="section">
  <div class="container">
    <div class="section__head">
      <div>
        <h1 class="section__title">{{ product.name }}</h1>
        <p class="section__desc">{{ product.short_description }}</p>
      </div>
      <a class="btn btn--ghost" href="{% url 'store-cart' %}">Cart</a>
    </div>

    <div class="grid" style="grid-template-columns:1fr 1fr;gap:1.25rem">
      <div>
        {% if product.main_image %}
          <img class="card__img" style="aspect-ratio:auto;border-radius:1rem" src="{{ product.main_image.url }}" alt="{{ product.name }}">
        {% else %}
          <div class="card__img" style="aspect-ratio:16/9;border-radius:1rem"></div>
        {% endif %}

        {# галерея; если есть свой related_name=gallery — он сработает; иначе просто не отрисуется #}
        {% if product.gallery.all %}
          <div class="grid" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));margin-top:.8rem;gap:.6rem">
            {% for img in product.gallery.all %}
              <img class="card__img" style="aspect-ratio:1;border-radius:.6rem" src="{{ img.image.url }}" alt="{{ product.name }} photo {{ forloop.counter }}">
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <div>
        <div class="card" style="padding:1.2rem">
          <form class="product-form" method="post" action="{% url 'store-cart-add' slug=product.slug %}">
            {% csrf_token %}
            <div class="price">
              {% if product.contact_for_estimate %}
                <strong>Contact for estimate</strong>
                {% if product.estimate_from_price %}<span class="price__hint">From ${{ product.estimate_from_price|floatformat:2 }}</span>{% endif %}
              {% else %}
                {% if product.has_option_price_overrides %}
                  <span class="price__hint">Starting at</span>
                {% endif %}
                <strong
                  class="price__value"
                  data-product-price-value
                  data-currency-symbol="$"
                  style="font-size:1.4rem"
                >
                  ${{ product.display_price|floatformat:2 }}
                </strong>
                {% if product.old_price %}<span class="old">${{ product.old_price }}</span>{% endif %}
              {% endif %}
            </div>
            {% if product.contact_for_estimate %}
              <div class="quote-note">Custom builds are quoted individually. Share your spec and we’ll confirm lead time and final pricing.</div>
            {% endif %}

            {% if product_options %}
              <fieldset class="option-picker" id="product-options">
                <legend>Options</legend>
                <div class="option-picker__grid">
                  {% for opt in product_options %}
                    <label class="option-pill">
                      <input
                        type="radio"
                        name="option_id"
                        value="{{ opt.id }}"
                        data-price="{{ opt.unit_price|floatformat:2 }}"
                        {% if forloop.first %}checked{% endif %}
                        {% if not product.contact_for_estimate %}required{% endif %}
                      >
                      <span class="option-pill__inner">
                        <span class="option-pill__top">
                          <span class="option-pill__name">{{ opt.name }}</span>
                          {% if not product.contact_for_estimate %}
                            <span class="option-pill__price">${{ opt.unit_price|floatformat:2 }}</span>
                          {% endif %}
                        </span>
                        {% if opt.description %}
                          <span class="option-pill__desc">{{ opt.description }}</span>
                        {% endif %}
                      </span>
                    </label>
                  {% endfor %}
                </div>
              </fieldset>
            {% endif %}

            {% if not product.contact_for_estimate %}
              <label class="section__desc" for="qty">Quantity</label>
              <div class="qty-row">
                <input class="field" id="qty" name="qty" type="number" min="1" value="1" style="width:110px">
                <div class="btn-pair">
                  <button class="btn btn--primary" type="submit">Add to cart</button>
                  <button class="btn btn--ghost" type="submit" name="buy_now" value="1">Buy now</button>
                </div>
              </div>
            {% else %}
              <div class="btn-pair" style="margin-top:1rem">
                <a class="btn btn--primary" href="{% url 'home' %}#contact">Contact us</a>
                <a class="btn btn--ghost" href="{% url 'store' %}">Browse products</a>
              </div>
            {% endif %}
          </form>
        </div>

        {% if product.specs %}
          <div class="card" style="margin-top:1rem">
            <h3 style="font-weight:900;margin-bottom:.4rem">Specifications</h3>

            <!-- контейнер, куда JS отрисует таблицу -->
            <div id="specs-table"></div>

            <!-- фоллбек без JS -->
            <noscript>
              <dl class="specs">
                {% for k, v in product.specs.items %}
                  <div class="specs__row">
                    <dt class="specs__k">{{ k|title }}</dt>
                    <dd class="specs__v">{{ v }}</dd>
                  </div>
                {% endfor %}
              </dl>
            </noscript>

            {# безопасный JSON прямо в шаблоне (встроенный фильтр Django) #}
            {{ product.specs|json_script:"product-specs-json" }}
          </div>
        {% endif %}

{# Compatibility: free-form text shown to users; model data stays hidden #}
{% if product.compatibility %}
  <div class="card" style="margin-top:1rem">
    <h3 style="font-weight:900;margin-bottom:.4rem">Compatibility</h3>
    <div class="section__desc">{{ product.compatibility|linebreaks }}</div>
  </div>
{% endif %}

        <div class="card card--cta" style="margin-top:1rem">
          <div class="cta">
            <div>
              <p class="cta__eyebrow">Custom fitments</p>
              <h3 class="cta__title">Ready to build your deck?</h3>
              <p class="section__desc cta__copy">
                Tell us about your platform, performance goals, and timeline. We’ll map the parts,
                confirm availability, and send back a detailed quote with next steps.
              </p>
            </div>
            <a class="btn btn--primary" href="#quote-request">Get a quote today</a>
          </div>
        </div>
      </div>
    </div>

    <div id="quote-request" class="card card--quote">
      <div class="quote-card__intro">
        <p class="cta__eyebrow">Custom fitment brief</p>
        <h3 class="cta__title">Share the inputs, we’ll send the plan</h3>
        <p class="section__desc cta__copy">
          Outline your vehicle, performance targets, and timeline. The build desk will confirm availability,
          pricing, and next steps in writing.
        </p>
      </div>

      {% if messages %}
        <div class="quote-alerts">
          {% for message in messages %}
            <div class="quote-alert quote-alert--{{ message.tags|default:'info' }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <form method="post" action="" class="quote-form" novalidate>
        {% csrf_token %}
        <input type="hidden" name="form_type" value="custom_fitment">
        {{ quote_form.product }}
        {{ quote_form.source_url }}

        {% if quote_form.non_field_errors %}
          <div class="quote-alert quote-alert--error">
            {% for err in quote_form.non_field_errors %}<div>{{ err }}</div>{% endfor %}
          </div>
        {% endif %}

        <div class="quote-grid">
          <div class="quote-field{% if quote_form.customer_name.errors %} quote-field--error{% endif %}">
            <label for="{{ quote_form.customer_name.id_for_label }}">Full name *</label>
            {{ quote_form.customer_name }}
            {% if quote_form.customer_name.errors %}
              <p class="quote-field__error">{{ quote_form.customer_name.errors.0 }}</p>
            {% endif %}
          </div>

          <div class="quote-field{% if quote_form.email.errors %} quote-field--error{% endif %}">
            <label for="{{ quote_form.email.id_for_label }}">Email *</label>
            {{ quote_form.email }}
            {% if quote_form.email.errors %}
              <p class="quote-field__error">{{ quote_form.email.errors.0 }}</p>
            {% endif %}
          </div>

          <div class="quote-field{% if quote_form.phone.errors %} quote-field--error{% endif %}">
            <label for="{{ quote_form.phone.id_for_label }}">Phone</label>
            {{ quote_form.phone }}
            {% if quote_form.phone.errors %}
              <p class="quote-field__error">{{ quote_form.phone.errors.0 }}</p>
            {% endif %}
          </div>

          <div class="quote-field{% if quote_form.vehicle.errors %} quote-field--error{% endif %}">
            <label for="{{ quote_form.vehicle.id_for_label }}">Platform / chassis</label>
            {{ quote_form.vehicle }}
            {% if quote_form.vehicle.errors %}
              <p class="quote-field__error">{{ quote_form.vehicle.errors.0 }}</p>
            {% endif %}
          </div>

          <div class="quote-field{% if quote_form.performance_goals.errors %} quote-field--error{% endif %}">
            <label for="{{ quote_form.performance_goals.id_for_label }}">Performance goals</label>
            {{ quote_form.performance_goals }}
            {% if quote_form.performance_goals.errors %}
              <p class="quote-field__error">{{ quote_form.performance_goals.errors.0 }}</p>
            {% endif %}
          </div>

          <div class="quote-field{% if quote_form.timeline.errors %} quote-field--error{% endif %}">
            <label for="{{ quote_form.timeline.id_for_label }}">Timeline</label>
            {{ quote_form.timeline }}
            {% if quote_form.timeline.errors %}
              <p class="quote-field__error">{{ quote_form.timeline.errors.0 }}</p>
            {% endif %}
          </div>

          <div class="quote-field quote-field--full{% if quote_form.message.errors %} quote-field--error{% endif %}">
            <label for="{{ quote_form.message.id_for_label }}">Notes</label>
            {{ quote_form.message }}
            {% if quote_form.message.errors %}
              <p class="quote-field__error">{{ quote_form.message.errors.0 }}</p>
            {% endif %}
          </div>
        </div>

        <div class="quote-actions">
          <button class="btn btn--primary" type="submit">Submit request</button>
          <p class="quote-footnote">Response time: typically same day during business hours.</p>
        </div>
      </form>
    </div>

{% if go_along %}
  <div class="section__head" style="margin-top:1.6rem">
    <h3 class="section__title">Items that go along to complete your build</h3>
      </div>
      <div class="grid grid--cards">
        {% for p in go_along %}
          <article class="card">
            <a href="{% url 'store-product' slug=p.slug %}">
              {% if p.main_image %}
                <img class="card__img" src="{{ p.main_image.url }}" alt="{{ p.name }}">
              {% else %}
                <div class="card__img" style="aspect-ratio:16/9"></div>
              {% endif %}
              <div class="card__body" style="padding:.6rem .8rem">
                <h4>{{ p.name }}</h4>
                <p class="section__desc">{{ p.short_description|default:p.category.name }}</p>
                <div class="price" style="margin-top:.2rem">
                  {% if p.contact_for_estimate %}
                    <strong>Contact for estimate</strong>
                    {% if p.estimate_from_price %}<span class="price__hint">From ${{ p.estimate_from_price|floatformat:2 }}</span>{% endif %}
                  {% else %}
                    {% if p.has_option_price_overrides %}<span class="price__hint">From</span>{% endif %}
                    <strong>${{ p.display_price|floatformat:2 }}</strong>
                  {% endif %}
                </div>
              </div>
            </a>
          </article>
        {% endfor %}
      </div>
    {% endif %}

    {% if related %}
      <div class="section__head" style="margin-top:1.6rem">
        <h3 class="section__title">Related products</h3>
      </div>
      <div class="grid grid--cards">
        {% for p in related %}
          <article class="card">
            <a href="{% url 'store-product' slug=p.slug %}">
              {% if p.main_image %}
                <img class="card__img" src="{{ p.main_image.url }}" alt="{{ p.name }}">
              {% else %}
                <div class="card__img" style="aspect-ratio:16/9"></div>
              {% endif %}
              <h4 style="margin-top:.6rem">{{ p.name }}</h4>
              <div class="price" style="margin-top:.2rem">
                {% if p.contact_for_estimate %}
                  <strong>Contact for estimate</strong>
                  {% if p.estimate_from_price %}<span class="price__hint">From ${{ p.estimate_from_price|floatformat:2 }}</span>{% endif %}
                {% else %}
                  {% if p.has_option_price_overrides %}<span class="price__hint">From</span>{% endif %}
                  <strong>${{ p.display_price|floatformat:2 }}</strong>
                {% endif %}
              </div>
            </a>
          </article>
        {% endfor %}
      </div>
    {% endif %}

    <script>
      (function () {
        var priceEl = document.querySelector('[data-product-price-value]');
        var optionInputs = document.querySelectorAll('#product-options input[name="option_id"]');
        if (!priceEl || !optionInputs.length) return;

        var currency = priceEl.dataset.currencySymbol || '$';
        var format = function (val) {
          var num = Number(val);
          if (Number.isNaN(num)) {
            return currency + val;
          }
          return currency + num.toFixed(2);
        };
        var update = function (input) {
          var nextPrice = input && input.dataset ? input.dataset.price : null;
          if (!nextPrice) return;
          priceEl.textContent = format(nextPrice);
        };

        optionInputs.forEach(function (input) {
          input.addEventListener('change', function () {
            update(input);
          });
          if (input.checked) {
            update(input);
          }
        });
      })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="{% static 'admin/js/bgm-smoke.js' %}"></script>

  </div>
</section>

<style>
  .product-form{display:flex; flex-direction:column; gap:1rem}
  .qty-row{display:flex; flex-wrap:wrap; gap:.6rem; align-items:center}
  .btn-pair{display:flex; gap:.5rem; flex-wrap:wrap}
  .option-picker{border:none; padding:0; margin:0; display:flex; flex-direction:column; gap:.4rem}
  .option-picker legend{font-weight:800; font-size:.95rem; margin-bottom:.2rem}
  .option-picker__grid{display:flex; flex-direction:column; gap:.5rem}
  @media (min-width:600px){
    .option-picker__grid{flex-direction:row; flex-wrap:wrap}
  }
  .option-pill{display:block; cursor:pointer; position:relative;}
  .option-pill input{position:absolute; opacity:0; pointer-events:none;}
  .option-pill__inner{
    display:flex;
    flex-direction:column;
    gap:.15rem;
    padding:.6rem .8rem;
    border:1px solid var(--card-border);
    border-radius:.8rem;
    min-width:160px;
    transition:border-color .2s ease, box-shadow .2s ease, background .2s ease;
  }
  .price__hint{font-size:.82rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;}
  .price__value{display:inline-flex;align-items:center;gap:.3rem;line-height:1;}
  .option-pill__top{display:flex;align-items:center;justify-content:space-between;gap:.6rem;}
  .option-pill__price{font-weight:700;color:var(--ink);}
  .option-pill__name{font-weight:700; color:var(--ink);}
  .option-pill__desc{color:var(--muted); font-size:.88rem;}
  .option-pill input:checked + .option-pill__inner{
    border-color:rgba(213,0,0,.6);
    box-shadow:0 0 0 2px rgba(213,0,0,.2);
    background:rgba(213,0,0,.06);
  }
  .specs{margin:0; padding:.4rem .6rem}
  .specs__row{display:grid; grid-template-columns: 180px 1fr; gap:.6rem; padding:.35rem 0; border-bottom:1px solid var(--card-border)}
  .specs__row:last-child{border-bottom:none}
  .specs__k{font-weight:700; color:var(--ink)}
  .specs__v{color:var(--muted)}
  .compat{margin:.2rem 0 0;padding-left:1.1rem}
  .compat li{margin:.2rem 0}
  .card--cta{background:linear-gradient(135deg,rgba(213,0,0,.12),rgba(0,0,0,.65));border:1px solid rgba(213,0,0,.3)}
  .cta{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:1rem;
    flex-wrap:wrap;
  }
  .cta__eyebrow{
    text-transform:uppercase;
    letter-spacing:.16em;
    font-size:.78rem;
    font-weight:800;
    color:rgba(255,255,255,.72);
    margin-bottom:.3rem;
  }
  .cta__title{
    font-family:var(--font-body);
    font-weight:900;
    font-size:1.5rem;
    margin:0 0 .4rem;
  }
  .cta__copy{max-width:28rem;color:rgba(255,255,255,.9) !important;}
  @media (max-width:640px){
    .cta{flex-direction:column;align-items:flex-start}
    .cta .btn{width:100%;justify-content:center}
  }
  .card--quote{
    margin-top:1.5rem;
    padding:1.5rem;
    background:linear-gradient(145deg,rgba(213,0,0,.08),rgba(0,0,0,.8));
    border:1px solid rgba(213,0,0,.25);
    border-radius:1.1rem;
    box-shadow:0 18px 45px rgba(0,0,0,.35);
  }
  .quote-card__intro{margin-bottom:1rem;}
  .quote-form{display:flex;flex-direction:column;gap:1rem;margin-top:.5rem;}
  .quote-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
    gap:1rem;
  }
  .quote-field{display:flex;flex-direction:column;}
  .quote-field label{
    font-size:.85rem;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:rgba(255,255,255,.76);
    margin-bottom:.25rem;
  }
  .quote-field .field{width:100%;}
  .quote-field--full{grid-column:1 / -1;}
  .quote-field__error{
    color:var(--error-text);
    font-size:.8rem;
    margin-top:.3rem;
  }
  .quote-field--error .field{
    border-color:rgba(213,0,0,.7);
    box-shadow:0 0 0 1px rgba(213,0,0,.35);
  }
  .quote-alerts{display:flex;flex-direction:column;gap:.4rem;margin-bottom:1rem;}
  .quote-alert{
    padding:.6rem .8rem;
    border-radius:.7rem;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.04);
    font-weight:700;
    font-size:.9rem;
  }
  .quote-alert--success{border-color:rgba(33,150,83,.55);background:rgba(33,150,83,.15);color:#b9f6ca;}
  .quote-alert--error{border-color:rgba(255,138,128,.6);background:rgba(59,0,0,.8);color:var(--error-text);}
  .quote-alert--info{opacity:.85;}
  .quote-actions{display:flex;flex-direction:column;gap:.4rem;}
  .quote-footnote{color:var(--muted);font-size:.85rem;}
  @media (min-width:640px){
    .quote-actions{flex-direction:row;align-items:center;justify-content:flex-start;}
    .quote-actions .btn{flex-shrink:0;}
    .quote-footnote{margin:0;}
  }

  /* дым — слой позади всего */
#bg{position:fixed; inset:0; z-index:0; pointer-events:none;}
#bg canvas{position:absolute; inset:0; width:100%; height:100%; display:block;}

/* весь контент поверх дыма */
.site-header, .hero, .section, footer{position:relative; z-index:1;}

/* убираем прежний фон у hero */
.hero--store{ background:transparent !important; }

</style>

<script>
  (function () {
    var el = document.getElementById('product-specs-json');
    var mount = document.getElementById('specs-table');
    if (!el || !mount) return;

    try {
      var specs = JSON.parse(el.textContent || '{}');
      if (!specs || typeof specs !== 'object') return;

      // build table
      var table = document.createElement('table');
      table.style.width = '100%';
      table.style.borderCollapse = 'collapse';
      table.style.background = 'rgba(255,255,255,.03)';
      table.style.borderRadius = '8px';

      Object.keys(specs).forEach(function (key) {
        var tr = document.createElement('tr');

        var th = document.createElement('th');
        th.textContent = key.replace(/_/g, ' ').replace(/^\w/, c => c.toUpperCase());
        th.style.textAlign = 'left';
        th.style.padding = '.35rem .6rem';
        th.style.whiteSpace = 'nowrap';

        var td = document.createElement('td');
        var val = specs[key];

        // pretty print value (list/dict/scalar)
        var text;
        if (Array.isArray(val)) {
          text = val.join(', ');
        } else if (val && typeof val === 'object') {
          text = Object.keys(val).map(function(k){ return k + ': ' + val[k]; }).join('; ');
        } else {
          text = String(val);
        }
        td.textContent = text;
        td.style.padding = '.35rem .6rem';
        td.style.color = 'var(--ink)';
        td.style.opacity = .9;

        tr.appendChild(th);
        tr.appendChild(td);
        table.appendChild(tr);
      });

      mount.appendChild(table);
    } catch (e) {
      // silent fail — оставим noscript-версию/ничего
    }
  })();
</script>
{% endblock %}
