{% extends "store/_base_store.html" %}
{% block title %}{{ product.name }} — BGM Store{% endblock %}

{% block body %}
<div id="bg"></div>

<section class="section">
  <div class="container">
    <div class="section__head">
      <div>
        <h1 class="section__title">{{ product.name }}</h1>
        <p class="section__desc">{{ product.short_description }}</p>
      </div>
      <a class="btn btn--ghost" href="{% url 'store-cart' %}">Cart</a>
    </div>

    <div class="grid" style="grid-template-columns:1fr 1fr;gap:1.25rem">
      <div>
        {% if product.main_image %}
          <img class="card__img" style="aspect-ratio:auto;border-radius:1rem" src="{{ product.main_image.url }}" alt="{{ product.name }}">
        {% else %}
          <div class="card__img" style="aspect-ratio:16/9;border-radius:1rem"></div>
        {% endif %}

        {# галерея; если есть свой related_name=gallery — он сработает; иначе просто не отрисуется #}
        {% if product.gallery.all %}
          <div class="grid" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));margin-top:.8rem;gap:.6rem">
            {% for img in product.gallery.all %}
              <img class="card__img" style="aspect-ratio:1;border-radius:.6rem" src="{{ img.image.url }}" alt="{{ product.name }} photo {{ forloop.counter }}">
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <div>
        <div class="card" style="padding:1.2rem">
          <form class="product-form" method="post" action="{% url 'store-cart-add' slug=product.slug %}">
            {% csrf_token %}
            <div class="price">
              {% if product.has_option_price_overrides %}
                <span class="price__hint">Starting at</span>
              {% endif %}
              <strong
                class="price__value"
                data-product-price-value
                data-currency-symbol="$"
                style="font-size:1.4rem"
              >
                ${{ product.display_price|floatformat:2 }}
              </strong>
              {% if product.old_price %}<span class="old">${{ product.old_price }}</span>{% endif %}
            </div>

            {% if product_options %}
              <fieldset class="option-picker" id="product-options">
                <legend>Options</legend>
                <div class="option-picker__grid">
                  {% for opt in product_options %}
                    <label class="option-pill">
                      <input
                        type="radio"
                        name="option_id"
                        value="{{ opt.id }}"
                        data-price="{{ opt.unit_price|floatformat:2 }}"
                        {% if forloop.first %}checked{% endif %}
                        required
                      >
                      <span class="option-pill__inner">
                        <span class="option-pill__top">
                          <span class="option-pill__name">{{ opt.name }}</span>
                          <span class="option-pill__price">${{ opt.unit_price|floatformat:2 }}</span>
                        </span>
                        {% if opt.description %}
                          <span class="option-pill__desc">{{ opt.description }}</span>
                        {% endif %}
                      </span>
                    </label>
                  {% endfor %}
                </div>
              </fieldset>
            {% endif %}

            <label class="section__desc" for="qty">Quantity</label>
            <div class="qty-row">
              <input class="field" id="qty" name="qty" type="number" min="1" value="1" style="width:110px">
              <div class="btn-pair">
                <button class="btn btn--primary" type="submit">Add to cart</button>
                <button class="btn btn--ghost" type="submit" name="buy_now" value="1">Buy now</button>
              </div>
            </div>
          </form>
        </div>

        {% if product.specs %}
          <div class="card" style="margin-top:1rem">
            <h3 style="font-weight:900;margin-bottom:.4rem">Specifications</h3>

            <!-- контейнер, куда JS отрисует таблицу -->
            <div id="specs-table"></div>

            <!-- фоллбек без JS -->
            <noscript>
              <dl class="specs">
                {% for k, v in product.specs.items %}
                  <div class="specs__row">
                    <dt class="specs__k">{{ k|title }}</dt>
                    <dd class="specs__v">{{ v }}</dd>
                  </div>
                {% endfor %}
              </dl>
            </noscript>

            {# безопасный JSON прямо в шаблоне (встроенный фильтр Django) #}
            {{ product.specs|json_script:"product-specs-json" }}
          </div>
        {% endif %}

        {# Compatibility: сначала из M2M, иначе из текстового поля (если есть) #}
        {% with compat_qs=product.compatible_models.all %}
          {% if compat_qs %}
            <div class="card" style="margin-top:1rem">
              <h3 style="font-weight:900;margin-bottom:.4rem">Compatibility</h3>
              <ul class="compat">
                {% for cm in compat_qs %}
                  <li>{{ cm.make.name }} {{ cm.name }}{% if cm.year_from %} {{ cm.year_from }}{% if cm.year_to %}–{{ cm.year_to }}{% endif %}{% endif %}</li>
                {% endfor %}
              </ul>
            </div>
          {% elif product.compatibility %}
            <div class="card" style="margin-top:1rem">
              <h3 style="font-weight:900;margin-bottom:.4rem">Compatibility</h3>
              <div class="section__desc">{{ product.compatibility|linebreaks }}</div>
            </div>
          {% endif %}
        {% endwith %}
      </div>
    </div>

    {% if go_along %}
      <div class="section__head" style="margin-top:1.6rem">
        <h3 class="section__title">Items that go along</h3>
      </div>
      <div class="grid grid--cards">
        {% for p in go_along %}
          <article class="card">
            <a href="{% url 'store-product' slug=p.slug %}">
              {% if p.main_image %}
                <img class="card__img" src="{{ p.main_image.url }}" alt="{{ p.name }}">
              {% else %}
                <div class="card__img" style="aspect-ratio:16/9"></div>
              {% endif %}
              <div class="card__body" style="padding:.6rem .8rem">
                <h4>{{ p.name }}</h4>
                <p class="section__desc">{{ p.short_description|default:p.category.name }}</p>
                <div class="price" style="margin-top:.2rem">
                  {% if p.has_option_price_overrides %}<span class="price__hint">From</span>{% endif %}
                  <strong>${{ p.display_price|floatformat:2 }}</strong>
                </div>
              </div>
            </a>
          </article>
        {% endfor %}
      </div>
    {% endif %}

    {% if related %}
      <div class="section__head" style="margin-top:1.6rem">
        <h3 class="section__title">Related products</h3>
      </div>
      <div class="grid grid--cards">
        {% for p in related %}
          <article class="card">
            <a href="{% url 'store-product' slug=p.slug %}">
              {% if p.main_image %}
                <img class="card__img" src="{{ p.main_image.url }}" alt="{{ p.name }}">
              {% else %}
                <div class="card__img" style="aspect-ratio:16/9"></div>
              {% endif %}
              <h4 style="margin-top:.6rem">{{ p.name }}</h4>
              <div class="price" style="margin-top:.2rem">
                {% if p.has_option_price_overrides %}<span class="price__hint">From</span>{% endif %}
                <strong>${{ p.display_price|floatformat:2 }}</strong>
              </div>
            </a>
          </article>
        {% endfor %}
      </div>
    {% endif %}

    <script>
      (function () {
        var priceEl = document.querySelector('[data-product-price-value]');
        var optionInputs = document.querySelectorAll('#product-options input[name="option_id"]');
        if (!priceEl || !optionInputs.length) return;

        var currency = priceEl.dataset.currencySymbol || '$';
        var format = function (val) {
          var num = Number(val);
          if (Number.isNaN(num)) {
            return currency + val;
          }
          return currency + num.toFixed(2);
        };
        var update = function (input) {
          var nextPrice = input && input.dataset ? input.dataset.price : null;
          if (!nextPrice) return;
          priceEl.textContent = format(nextPrice);
        };

        optionInputs.forEach(function (input) {
          input.addEventListener('change', function () {
            update(input);
          });
          if (input.checked) {
            update(input);
          }
        });
      })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="{% static 'admin/js/bgm-smoke.js' %}"></script>

  </div>
</section>

<style>
  .product-form{display:flex; flex-direction:column; gap:1rem}
  .qty-row{display:flex; flex-wrap:wrap; gap:.6rem; align-items:center}
  .btn-pair{display:flex; gap:.5rem; flex-wrap:wrap}
  .option-picker{border:none; padding:0; margin:0; display:flex; flex-direction:column; gap:.4rem}
  .option-picker legend{font-weight:800; font-size:.95rem; margin-bottom:.2rem}
  .option-picker__grid{display:flex; flex-direction:column; gap:.5rem}
  @media (min-width:600px){
    .option-picker__grid{flex-direction:row; flex-wrap:wrap}
  }
  .option-pill{display:block; cursor:pointer; position:relative;}
  .option-pill input{position:absolute; opacity:0; pointer-events:none;}
  .option-pill__inner{
    display:flex;
    flex-direction:column;
    gap:.15rem;
    padding:.6rem .8rem;
    border:1px solid var(--card-border);
    border-radius:.8rem;
    min-width:160px;
    transition:border-color .2s ease, box-shadow .2s ease, background .2s ease;
  }
  .price__hint{font-size:.82rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;}
  .price__value{display:inline-flex;align-items:center;gap:.3rem;line-height:1;}
  .option-pill__top{display:flex;align-items:center;justify-content:space-between;gap:.6rem;}
  .option-pill__price{font-weight:700;color:var(--ink);}
  .option-pill__name{font-weight:700; color:var(--ink);}
  .option-pill__desc{color:var(--muted); font-size:.88rem;}
  .option-pill input:checked + .option-pill__inner{
    border-color:rgba(213,0,0,.6);
    box-shadow:0 0 0 2px rgba(213,0,0,.2);
    background:rgba(213,0,0,.06);
  }
  .specs{margin:0; padding:.4rem .6rem}
  .specs__row{display:grid; grid-template-columns: 180px 1fr; gap:.6rem; padding:.35rem 0; border-bottom:1px solid var(--card-border)}
  .specs__row:last-child{border-bottom:none}
  .specs__k{font-weight:700; color:var(--ink)}
  .specs__v{color:var(--muted)}
  .compat{margin:.2rem 0 0;padding-left:1.1rem}
  .compat li{margin:.2rem 0}

  /* дым — слой позади всего */
#bg{position:fixed; inset:0; z-index:0; pointer-events:none;}
#bg canvas{position:absolute; inset:0; width:100%; height:100%; display:block;}

/* весь контент поверх дыма */
.site-header, .hero, .section, footer{position:relative; z-index:1;}

/* убираем прежний фон у hero */
.hero--store{ background:transparent !important; }

</style>

<script>
  (function () {
    var el = document.getElementById('product-specs-json');
    var mount = document.getElementById('specs-table');
    if (!el || !mount) return;

    try {
      var specs = JSON.parse(el.textContent || '{}');
      if (!specs || typeof specs !== 'object') return;

      // build table
      var table = document.createElement('table');
      table.style.width = '100%';
      table.style.borderCollapse = 'collapse';
      table.style.background = 'rgba(255,255,255,.03)';
      table.style.borderRadius = '8px';

      Object.keys(specs).forEach(function (key) {
        var tr = document.createElement('tr');

        var th = document.createElement('th');
        th.textContent = key.replace(/_/g, ' ').replace(/^\w/, c => c.toUpperCase());
        th.style.textAlign = 'left';
        th.style.padding = '.35rem .6rem';
        th.style.whiteSpace = 'nowrap';

        var td = document.createElement('td');
        var val = specs[key];

        // pretty print value (list/dict/scalar)
        var text;
        if (Array.isArray(val)) {
          text = val.join(', ');
        } else if (val && typeof val === 'object') {
          text = Object.keys(val).map(function(k){ return k + ': ' + val[k]; }).join('; ');
        } else {
          text = String(val);
        }
        td.textContent = text;
        td.style.padding = '.35rem .6rem';
        td.style.color = 'var(--ink)';
        td.style.opacity = .9;

        tr.appendChild(th);
        tr.appendChild(td);
        table.appendChild(tr);
      });

      mount.appendChild(table);
    } catch (e) {
      // silent fail — оставим noscript-версию/ничего
    }
  })();
</script>
{% endblock %}
