{% extends "store/_base_store.html" %}
{% load dealer_extras %}
{% block title %}{{ product.name }} — BGM Store{% endblock %}

{% block body %}
<div id="bg"></div>

<section class="section">
  <div class="container">
    <div class="section__head">
      <div>
        <h1 class="section__title">{{ product.name }}</h1>
        <p class="section__desc">{{ product.short_description }}</p>
      </div>
      <a class="btn btn--ghost" href="{% url 'store-cart' %}">Cart</a>
    </div>

    <div class="grid product-detail__grid" style="grid-template-columns:1fr 1fr;gap:1.25rem">
      <div class="product-detail__media">
        {% if product.main_image %}
          <img class="card__img product-main__img" src="{{ product.main_image_url }}" alt="{{ product.name }}">
        {% else %}
          <div class="card__img product-main__img product-main__img--placeholder"></div>
        {% endif %}

        {# галерея; если есть свой related_name=gallery — он сработает; иначе просто не отрисуется #}
        {% if product.gallery.all %}
          <div class="grid" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));margin-top:.8rem;gap:.6rem">
            {% for img in product.gallery.all %}
              <img class="card__img" style="aspect-ratio:1;border-radius:.6rem" src="{{ img.image.url }}" alt="{{ product.name }} photo {{ forloop.counter }}">
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="product-detail__panel">
        <div class="card product-detail__options-card" style="padding:1.2rem">
          <form class="product-form" method="post" action="{% url 'store-cart-add' slug=product.slug %}">
            {% csrf_token %}
            <div class="price price--detail">
              {% if product.contact_for_estimate %}
                <strong>Contact for estimate</strong>
                {% if product.estimate_from_price %}<span class="price__hint">From {{ product.estimate_from_price|money }}</span>{% endif %}
              {% else %}
                <div class="price__retail-row">
                  {% if product.has_option_price_overrides %}
                    <span class="price__hint">Starting at</span>
                  {% endif %}
                  <strong
                    class="price__value"
                    data-product-price-retail
                    data-currency-symbol="{{ currency.symbol }}"
                    data-currency-code="{{ currency.code }}"
                    style="font-size:1.4rem"
                  >
                    {{ product.display_price|money }}
                  </strong>
                  {% if product.old_price %}<span class="old">{{ product.old_price|money }}</span>{% endif %}
                </div>
                {% if dealer_portal.show_discount %}
                  <div class="price__dealer-row" data-dealer-price-wrapper>
                    <span class="price__hint">Dealer {{ dealer_portal.discount_percent }}%</span>
                    <strong class="price__value" data-product-price-dealer>
                      {{ product.display_price|dealer_price:dealer_portal.discount_percent|money }}
                    </strong>
                    <span class="price__save" data-product-price-savings>
                      Save {{ product.display_price|dealer_savings:dealer_portal.discount_percent|money }}
                    </span>
                  </div>
                {% endif %}
              {% endif %}
            </div>
            {% if product.contact_for_estimate %}
              <div class="quote-note">Custom builds are quoted individually. Tell us what you’re building — we’ll take it from there.</div>
            {% endif %}

            {% if product_options %}
              <div class="options-collapse" data-options-collapse>
                <div class="options-preview" data-options-preview>
                  <fieldset class="option-picker{% if options_two_column %} option-picker--split{% endif %}" id="product-options">
                    <legend>Options</legend>
                    {% if options_two_column %}
                      <div class="option-columns">
                        <div class="option-column">
                          <div class="option-column__title">{{ product.option_column_1_label|default:"Options" }}</div>
                          <div class="option-picker__grid">
                            {% for opt in options_col_1 %}
                              {% if opt.is_separator %}
                                <div class="option-separator" role="presentation">
                                  <span class="option-separator__label">{{ opt.name }}</span>
                                </div>
                              {% else %}
                                <label class="option-pill">
                                  <input
                                    type="radio"
                                    name="option_id"
                                    value="{{ opt.id }}"
                                    data-price-retail="{{ opt.unit_price|floatformat:2 }}"
                                    data-price-dealer="{{ opt.unit_price|dealer_price:dealer_portal.discount_percent|floatformat:2 }}"
                                    data-price-savings="{{ opt.unit_price|dealer_savings:dealer_portal.discount_percent|floatformat:2 }}"
                                    {% if default_option_id and opt.id == default_option_id %}checked{% endif %}
                                    {% if not product.contact_for_estimate %}required{% endif %}
                                  >
                                  <span class="option-pill__inner">
                                    <span class="option-pill__top">
                                      <span class="option-pill__meta">
                                        <span class="option-pill__name">{{ opt.name }}</span>
                                        {% if opt.sku %}
                                          <span class="option-pill__sku">SKU: {{ opt.sku }}</span>
                                        {% endif %}
                                      </span>
                                      {% if not product.contact_for_estimate %}
                                        <span class="option-pill__price">
                                          {{ opt.unit_price|money }}
                                          {% if dealer_portal.show_discount %}
                                            <span class="option-pill__dealer">Dealer {{ opt.unit_price|dealer_price:dealer_portal.discount_percent|money }}</span>
                                          {% endif %}
                                        </span>
                                      {% endif %}
                                    </span>
                                    {% if opt.description %}
                                      <span class="option-pill__desc">{{ opt.description }}</span>
                                    {% endif %}
                                  </span>
                                </label>
                              {% endif %}
                            {% endfor %}
                          </div>
                        </div>

                        <div class="option-column">
                          <div class="option-column__title">{{ product.option_column_2_label|default:"More options" }}</div>
                          <div class="option-picker__grid">
                            {% for opt in options_col_2 %}
                              {% if opt.is_separator %}
                                <div class="option-separator" role="presentation">
                                  <span class="option-separator__label">{{ opt.name }}</span>
                                </div>
                              {% else %}
                                <label class="option-pill">
                                  <input
                                    type="radio"
                                    name="option_id"
                                    value="{{ opt.id }}"
                                    data-price-retail="{{ opt.unit_price|floatformat:2 }}"
                                    data-price-dealer="{{ opt.unit_price|dealer_price:dealer_portal.discount_percent|floatformat:2 }}"
                                    data-price-savings="{{ opt.unit_price|dealer_savings:dealer_portal.discount_percent|floatformat:2 }}"
                                    {% if default_option_id and opt.id == default_option_id %}checked{% endif %}
                                    {% if not product.contact_for_estimate %}required{% endif %}
                                  >
                                  <span class="option-pill__inner">
                                    <span class="option-pill__top">
                                      <span class="option-pill__meta">
                                        <span class="option-pill__name">{{ opt.name }}</span>
                                        {% if opt.sku %}
                                          <span class="option-pill__sku">SKU: {{ opt.sku }}</span>
                                        {% endif %}
                                      </span>
                                      {% if not product.contact_for_estimate %}
                                        <span class="option-pill__price">
                                          {{ opt.unit_price|money }}
                                          {% if dealer_portal.show_discount %}
                                            <span class="option-pill__dealer">Dealer {{ opt.unit_price|dealer_price:dealer_portal.discount_percent|money }}</span>
                                          {% endif %}
                                        </span>
                                      {% endif %}
                                    </span>
                                    {% if opt.description %}
                                      <span class="option-pill__desc">{{ opt.description }}</span>
                                    {% endif %}
                                  </span>
                                </label>
                              {% endif %}
                            {% endfor %}
                          </div>
                        </div>
                      </div>
                    {% else %}
                      <div class="option-picker__grid">
                        {% for opt in product_options %}
                          {% if opt.is_separator %}
                            <div class="option-separator" role="presentation">
                              <span class="option-separator__label">{{ opt.name }}</span>
                            </div>
                          {% else %}
                            <label class="option-pill">
                              <input
                                type="radio"
                                name="option_id"
                                value="{{ opt.id }}"
                                data-price-retail="{{ opt.unit_price|floatformat:2 }}"
                                data-price-dealer="{{ opt.unit_price|dealer_price:dealer_portal.discount_percent|floatformat:2 }}"
                                data-price-savings="{{ opt.unit_price|dealer_savings:dealer_portal.discount_percent|floatformat:2 }}"
                                {% if default_option_id and opt.id == default_option_id %}checked{% endif %}
                                {% if not product.contact_for_estimate %}required{% endif %}
                              >
                              <span class="option-pill__inner">
                                <span class="option-pill__top">
                                  <span class="option-pill__meta">
                                    <span class="option-pill__name">{{ opt.name }}</span>
                                    {% if opt.sku %}
                                      <span class="option-pill__sku">SKU: {{ opt.sku }}</span>
                                    {% endif %}
                                  </span>
                                  {% if not product.contact_for_estimate %}
                                    <span class="option-pill__price">
                                      {{ opt.unit_price|money }}
                                      {% if dealer_portal.show_discount %}
                                        <span class="option-pill__dealer">Dealer {{ opt.unit_price|dealer_price:dealer_portal.discount_percent|money }}</span>
                                      {% endif %}
                                    </span>
                                  {% endif %}
                                </span>
                                {% if opt.description %}
                                  <span class="option-pill__desc">{{ opt.description }}</span>
                                {% endif %}
                              </span>
                            </label>
                          {% endif %}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </fieldset>
                </div>
                <button
                  class="btn btn--ghost options-expand"
                  type="button"
                  data-options-toggle
                  data-label-expand="View all options"
                  data-label-collapse="Show fewer"
                >
                  View all options
                </button>
              </div>
            {% endif %}

            {% if not product.contact_for_estimate %}
              <label class="section__desc" for="qty">Quantity</label>
              <div class="qty-row">
                <input class="field" id="qty" name="qty" type="number" min="1" value="1" style="width:110px">
                <div class="btn-pair">
                  <button class="btn btn--primary" type="submit">Add to cart</button>
                  <button class="btn btn--ghost" type="submit" name="buy_now" value="1">Buy now</button>
                </div>
              </div>
            {% else %}
              <div class="btn-pair" style="margin-top:1rem">
                <a class="btn btn--primary" href="{% url 'home' %}#contact">Contact us</a>
                <a class="btn btn--ghost" href="{% url 'store' %}">Browse products</a>
              </div>
            {% endif %}
          </form>
        </div>

        {% if product.specs %}
          <div class="card" style="margin-top:1rem">
            <h3 style="font-weight:900;margin-bottom:.4rem">Specifications</h3>

            <!-- контейнер, куда JS отрисует таблицу -->
            <div id="specs-table"></div>

            <!-- фоллбек без JS -->
            <noscript>
              <dl class="specs">
                {% for k, v in product.specs.items %}
                  <div class="specs__row">
                    <dt class="specs__k">{{ k|title }}</dt>
                    <dd class="specs__v">{{ v }}</dd>
                  </div>
                {% endfor %}
              </dl>
            </noscript>

            {# безопасный JSON прямо в шаблоне (встроенный фильтр Django) #}
            {{ product.specs|json_script:"product-specs-json" }}
          </div>
        {% endif %}

      </div>
    </div>

    <div id="quote-request" class="card card--quote">
      <div class="quote-card__intro">
        <p class="cta__eyebrow">Custom fitment brief</p>
        <h3 class="cta__title">Share the inputs, we’ll send the plan</h3>
        <p class="section__desc cta__copy">
          Outline your vehicle, performance targets, and timeline. The build desk will confirm availability,
          pricing, and next steps in writing.
        </p>
      </div>

      {% if messages %}
        <div class="quote-alerts">
          {% for message in messages %}
            <div class="quote-alert quote-alert--{{ message.tags|default:'info' }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <form method="post" action="" class="quote-form" novalidate>
        {% csrf_token %}
        <input type="hidden" name="form_type" value="custom_fitment">
        {{ quote_form.product }}
        {{ quote_form.source_url }}

        {% if quote_form.non_field_errors %}
          <div class="quote-alert quote-alert--error">
            {% for err in quote_form.non_field_errors %}<div>{{ err }}</div>{% endfor %}
          </div>
        {% endif %}

        <div class="quote-grid">
          <div class="quote-field{% if quote_form.customer_name.errors %} quote-field--error{% endif %}">
            <label for="{{ quote_form.customer_name.id_for_label }}">Full name *</label>
            {{ quote_form.customer_name }}
            {% if quote_form.customer_name.errors %}
              <p class="quote-field__error">{{ quote_form.customer_name.errors.0 }}</p>
            {% endif %}
          </div>

          <div class="quote-field{% if quote_form.email.errors %} quote-field--error{% endif %}">
            <label for="{{ quote_form.email.id_for_label }}">Email *</label>
            {{ quote_form.email }}
            {% if quote_form.email.errors %}
              <p class="quote-field__error">{{ quote_form.email.errors.0 }}</p>
            {% endif %}
          </div>

          <div class="quote-field{% if quote_form.phone.errors %} quote-field--error{% endif %}">
            <label for="{{ quote_form.phone.id_for_label }}">Phone</label>
            {{ quote_form.phone }}
            {% if quote_form.phone.errors %}
              <p class="quote-field__error">{{ quote_form.phone.errors.0 }}</p>
            {% endif %}
          </div>

          <div class="quote-field{% if quote_form.vehicle.errors %} quote-field--error{% endif %}">
            <label for="{{ quote_form.vehicle.id_for_label }}">Platform / chassis</label>
            {{ quote_form.vehicle }}
            {% if quote_form.vehicle.errors %}
              <p class="quote-field__error">{{ quote_form.vehicle.errors.0 }}</p>
            {% endif %}
          </div>

          <div class="quote-field{% if quote_form.submodel.errors %} quote-field--error{% endif %}">
            <label for="{{ quote_form.submodel.id_for_label }}">Submodel / trim</label>
            {{ quote_form.submodel }}
            {% if quote_form.submodel.errors %}
              <p class="quote-field__error">{{ quote_form.submodel.errors.0 }}</p>
            {% endif %}
          </div>

          <div class="quote-field{% if quote_form.performance_goals.errors %} quote-field--error{% endif %}">
            <label for="{{ quote_form.performance_goals.id_for_label }}">Performance goals</label>
            {{ quote_form.performance_goals }}
            {% if quote_form.performance_goals.errors %}
              <p class="quote-field__error">{{ quote_form.performance_goals.errors.0 }}</p>
            {% endif %}
          </div>

          <div class="quote-field{% if quote_form.budget.errors %} quote-field--error{% endif %}">
            <label for="{{ quote_form.budget.id_for_label }}">Budget</label>
            {{ quote_form.budget }}
            {% if quote_form.budget.errors %}
              <p class="quote-field__error">{{ quote_form.budget.errors.0 }}</p>
            {% endif %}
          </div>

          <div class="quote-field{% if quote_form.timeline.errors %} quote-field--error{% endif %}">
            <label for="{{ quote_form.timeline.id_for_label }}">Timeline</label>
            {{ quote_form.timeline }}
            {% if quote_form.timeline.errors %}
              <p class="quote-field__error">{{ quote_form.timeline.errors.0 }}</p>
            {% endif %}
          </div>

          <div class="quote-field quote-field--full{% if quote_form.message.errors %} quote-field--error{% endif %}">
            <label for="{{ quote_form.message.id_for_label }}">Notes</label>
            {{ quote_form.message }}
            {% if quote_form.message.errors %}
              <p class="quote-field__error">{{ quote_form.message.errors.0 }}</p>
            {% endif %}
          </div>
        </div>

        <div class="quote-actions">
          <button class="btn btn--primary" type="submit">Submit request</button>
          <p class="quote-footnote">Response time: 1-2 business days to reply.</p>
        </div>
      </form>
    </div>

{% if go_along %}
  <div class="section__head" style="margin-top:1.6rem">
    <h3 class="section__title">Items that go along to complete your build</h3>
      </div>
      <div class="grid grid--cards">
        {% for p in go_along %}
          <article class="card">
            <a href="{% url 'store-product' slug=p.slug %}">
              {% if p.main_image %}
                <img class="card__img" src="{{ p.main_image_url }}" alt="{{ p.name }}">
              {% else %}
                <div class="card__img" style="aspect-ratio:16/9"></div>
              {% endif %}
              <div class="card__body" style="padding:.6rem .8rem">
                <h4>{{ p.name }}</h4>
                <p class="section__desc">{{ p.short_description|default:p.category.display_name }}</p>
              <div class="price price--stacked" style="margin-top:.2rem">
                {% if p.contact_for_estimate %}
                  <strong>Contact for estimate</strong>
                  {% if p.estimate_from_price %}<span class="price__hint">From {{ p.estimate_from_price|money }}</span>{% endif %}
                {% else %}
                  <div class="price__retail-row">
                    {% if p.has_option_price_overrides %}<span class="price__hint">From</span>{% endif %}
                    <strong>{{ p.display_price|money }}</strong>
                  </div>
                  {% if dealer_portal.show_discount %}
                    <div class="price__dealer-row">
                      <span class="price__hint">Dealer {{ dealer_portal.discount_percent }}%</span>
                      <strong>{{ p.display_price|dealer_price:dealer_portal.discount_percent|money }}</strong>
                      <span class="price__save">Save {{ p.display_price|dealer_savings:dealer_portal.discount_percent|money }}</span>
                    </div>
                  {% endif %}
                {% endif %}
              </div>
              </div>
            </a>
          </article>
        {% endfor %}
      </div>
    {% endif %}

    {% if related %}
      <div class="section__head" style="margin-top:1.6rem">
        <h3 class="section__title">Related products</h3>
      </div>
      <div class="grid grid--cards">
        {% for p in related %}
          <article class="card">
            <a href="{% url 'store-product' slug=p.slug %}">
              {% if p.main_image %}
                <img class="card__img" src="{{ p.main_image_url }}" alt="{{ p.name }}">
              {% else %}
                <div class="card__img" style="aspect-ratio:16/9"></div>
              {% endif %}
              <h4 style="margin-top:.6rem">{{ p.name }}</h4>
              <div class="price price--stacked" style="margin-top:.2rem">
                {% if p.contact_for_estimate %}
                  <strong>Contact for estimate</strong>
                  {% if p.estimate_from_price %}<span class="price__hint">From {{ p.estimate_from_price|money }}</span>{% endif %}
                {% else %}
                  <div class="price__retail-row">
                    {% if p.has_option_price_overrides %}<span class="price__hint">From</span>{% endif %}
                    <strong>{{ p.display_price|money }}</strong>
                  </div>
                  {% if dealer_portal.show_discount %}
                    <div class="price__dealer-row">
                      <span class="price__hint">Dealer {{ dealer_portal.discount_percent }}%</span>
                      <strong>{{ p.display_price|dealer_price:dealer_portal.discount_percent|money }}</strong>
                      <span class="price__save">Save {{ p.display_price|dealer_savings:dealer_portal.discount_percent|money }}</span>
                    </div>
                  {% endif %}
                {% endif %}
              </div>
            </a>
          </article>
        {% endfor %}
      </div>
    {% endif %}

    <script>
      (function () {
        var retailEl = document.querySelector('[data-product-price-retail]');
        var dealerEl = document.querySelector('[data-product-price-dealer]');
        var savingsEl = document.querySelector('[data-product-price-savings]');
        var optionInputs = document.querySelectorAll('#product-options input[name="option_id"]');
        if (!retailEl || !optionInputs.length) return;

        var symbol = retailEl.dataset.currencySymbol || '$';
        var code = (retailEl.dataset.currencyCode || '').trim();
        var wrap = function (amount) {
          var core = symbol + amount;
          return code ? code + ' ' + core : core;
        };
        var formatTarget = function (node, raw) {
          if (!node || raw === undefined) return;
          node.textContent = format(raw);
        };
        var format = function (val) {
          var num = Number(val);
          if (Number.isNaN(num)) {
            return wrap(String(val));
          }
          return wrap(num.toFixed(2));
        };
        var update = function (input) {
          if (!input || !input.dataset) return;
          var retail = input.dataset.priceRetail;
          if (retail) {
            retailEl.textContent = format(retail);
          }
          if (dealerEl) {
            var dealerPrice = input.dataset.priceDealer || retail;
            if (dealerPrice) {
              dealerEl.textContent = format(dealerPrice);
            }
          }
          if (savingsEl) {
            var savings = input.dataset.priceSavings;
            if (savings && Number(savings) > 0) {
              savingsEl.textContent = 'Save ' + format(savings);
            } else {
              savingsEl.textContent = '';
            }
          }
        };

        optionInputs.forEach(function (input) {
          input.addEventListener('change', function () {
            update(input);
          });
          if (input.checked) {
            update(input);
          }
        });
      })();
    </script>
    <script>
      (function () {
        var blocks = document.querySelectorAll('[data-options-collapse]');
        if (!blocks.length) return;

        blocks.forEach(function (root) {
          var preview = root.querySelector('[data-options-preview]');
          var toggle = root.querySelector('[data-options-toggle]');
          var card = root.closest('.product-detail__options-card');
          if (!preview || !toggle || !card) return;

          var labelExpand = toggle.dataset.labelExpand || 'View all options';
          var labelCollapse = toggle.dataset.labelCollapse || 'Show fewer';

          var setExpanded = function (expanded) {
            root.classList.toggle('options-collapse--expanded', expanded);
            card.classList.toggle('product-detail__options-card--expanded', expanded);
            toggle.textContent = expanded ? labelCollapse : labelExpand;
          };

          var checkOverflow = function () {
            if (root.classList.contains('options-collapse--expanded')) return;
            var hasOverflow = preview.scrollHeight > preview.clientHeight + 2;
            root.classList.toggle('options-collapse--active', hasOverflow);
            toggle.hidden = !hasOverflow;
            if (!hasOverflow) {
              setExpanded(false);
            } else {
              toggle.textContent = labelExpand;
            }
          };

          toggle.addEventListener('click', function () {
            var expanded = root.classList.contains('options-collapse--expanded');
            setExpanded(!expanded);
            if (!expanded) {
              root.classList.add('options-collapse--active');
              toggle.hidden = false;
            } else {
              checkOverflow();
            }
          });

          setExpanded(false);
          checkOverflow();
          window.addEventListener('resize', function () {
            if (root.classList.contains('options-collapse--expanded')) return;
            window.requestAnimationFrame(checkOverflow);
          });
          window.addEventListener('load', checkOverflow);
        });
      })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="{% static 'admin/js/bgm-smoke.js' %}"></script>

  </div>
</section>

<style>
  .product-detail__grid{
    --product-main-height: clamp(220px, 40vw, 380px);
  }
  .product-form{display:flex; flex-direction:column; gap:1rem}
  .qty-row{display:flex; flex-wrap:wrap; gap:.6rem; align-items:center}
  .btn-pair{display:flex; gap:.5rem; flex-wrap:wrap}
  .product-detail__panel{display:flex; flex-direction:column; gap:1rem;}
  .product-detail__options-card{
    height:var(--product-main-height);
    display:flex;
    flex-direction:column;
  }
  .product-detail__options-card--expanded{
    height:auto;
    min-height:var(--product-main-height);
  }
  .product-detail__options-card .product-form{
    flex:1;
    min-height:0;
  }
  .product-detail__options-card--expanded .product-form{
    min-height:auto;
  }
  .options-collapse{
    display:flex;
    flex-direction:column;
    gap:.6rem;
    flex:1;
    min-height:0;
  }
  .options-preview{
    position:relative;
    flex:1;
    min-height:0;
    overflow:hidden;
  }
  .options-collapse--active .options-preview::after{
    content:"";
    position:absolute;
    left:0;
    right:0;
    bottom:0;
    height:84px;
    background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.35) 35%, rgba(0,0,0,.75));
    backdrop-filter:blur(6px);
    -webkit-backdrop-filter:blur(6px);
    pointer-events:none;
  }
  .options-expand{
    display:none;
    align-self:center;
  }
  .options-collapse--active .options-expand{
    display:inline-flex;
  }
  .options-collapse--expanded .options-preview{
    overflow:visible;
  }
  .options-collapse--expanded .options-preview::after{
    display:none;
  }
  .product-detail__options-card--expanded .options-collapse{
    flex:initial;
    min-height:auto;
  }
  .product-detail__options-card--expanded .options-preview{
    flex:initial;
    min-height:auto;
  }
  .product-main__img{
    width:100%;
    height:var(--product-main-height);
    object-fit:cover;
    border-radius:1rem;
    display:block;
  }
  .product-main__img--placeholder{
    background:rgba(255,255,255,.06);
  }
  .option-picker{border:none; padding:0; margin:0; display:flex; flex-direction:column; gap:.4rem}
  .option-picker legend{font-weight:800; font-size:.95rem; margin-bottom:.2rem}
  .option-picker__grid{display:flex; flex-direction:column; gap:.5rem}
  @media (min-width:600px){
    .option-picker__grid{flex-direction:row; flex-wrap:wrap}
  }
  .option-picker--split .option-columns{
    display:grid;
    grid-template-columns:repeat(2, minmax(0, 1fr));
    gap:1rem;
  }
  .option-picker--split .option-column{
    display:flex;
    flex-direction:column;
    gap:.6rem;
  }
  .option-column__title{
    font-weight:800;
    font-size:.8rem;
    letter-spacing:.08em;
    text-transform:uppercase;
    color:var(--muted);
  }
  .option-picker--split .option-picker__grid{
    flex-direction:column;
    flex-wrap:nowrap;
  }
  .option-picker--split .option-pill__inner{width:100%;}
  .option-separator{
    display:flex;
    align-items:center;
    gap:.6rem;
    width:100%;
    padding:.1rem .2rem;
    color:var(--muted);
    font-size:.78rem;
    font-weight:800;
    text-transform:uppercase;
    letter-spacing:.08em;
  }
  .option-separator::before,
  .option-separator::after{
    content:"";
    flex:1;
    height:1px;
    background:linear-gradient(90deg, rgba(255,255,255,.18), rgba(255,255,255,0));
  }
  .option-separator::after{
    background:linear-gradient(270deg, rgba(255,255,255,.18), rgba(255,255,255,0));
  }
  .option-separator__label{
    padding:.2rem .55rem;
    border-radius:.5rem;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(255,255,255,.04);
    color:var(--fg);
  }
  .option-pill{display:block; cursor:pointer; position:relative;}
  .option-pill input{position:absolute; opacity:0; pointer-events:none;}
  .option-pill__inner{
    display:flex;
    flex-direction:column;
    gap:.15rem;
    padding:.6rem .8rem;
    border:1px solid var(--card-border);
    border-radius:.8rem;
    min-width:160px;
    transition:border-color .2s ease, box-shadow .2s ease, background .2s ease;
  }
  .price--detail{display:flex;flex-direction:column;gap:.35rem}
  .price--stacked{display:flex;flex-direction:column;gap:.3rem}
  .price__retail-row{display:flex;gap:.45rem;align-items:baseline}
  .price__dealer-row{
    display:inline-flex;
    gap:.35rem;
    flex-wrap:wrap;
    align-items:baseline;
    background:rgba(213,0,0,.12);
    border:1px solid rgba(213,0,0,.35);
    border-radius:.65rem;
    padding:.25rem .55rem;
  }
  .price__hint{font-size:.82rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;}
  .price__value{display:inline-flex;align-items:center;gap:.3rem;line-height:1;}
  .price__save{font-size:.82rem;color:var(--muted)}
  .option-pill__top{display:flex;align-items:center;justify-content:space-between;gap:.6rem;}
  .option-pill__price{font-weight:700;color:var(--ink);display:flex;flex-direction:column;align-items:flex-end;gap:.1rem;}
  .option-pill__dealer{font-size:.78rem;color:var(--muted);font-weight:600;}
  .option-pill__meta{display:flex;flex-direction:column;gap:.1rem;}
  .option-pill__name{font-weight:700; color:var(--ink);}
  .option-pill__sku{font-size:.78rem;color:var(--muted);letter-spacing:.02em;}
  .option-pill__desc{color:var(--muted); font-size:.88rem;}
  .option-pill input:checked + .option-pill__inner{
    border-color:rgba(213,0,0,.6);
    box-shadow:0 0 0 2px rgba(213,0,0,.2);
    background:rgba(213,0,0,.06);
  }
  .specs{margin:0; padding:.4rem .6rem}
  .specs__row{display:grid; grid-template-columns: 180px 1fr; gap:.6rem; padding:.35rem 0; border-bottom:1px solid var(--card-border)}
  .specs__row:last-child{border-bottom:none}
  .specs__k{font-weight:700; color:var(--ink)}
  .specs__v{color:var(--muted)}
  .compat{margin:.2rem 0 0;padding-left:1.1rem}
  .compat li{margin:.2rem 0}
  .card--cta{background:linear-gradient(135deg,rgba(213,0,0,.12),rgba(0,0,0,.65));border:1px solid rgba(213,0,0,.3)}
  .cta{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:1rem;
    flex-wrap:wrap;
  }
  .cta__eyebrow{
    text-transform:uppercase;
    letter-spacing:.16em;
    font-size:.78rem;
    font-weight:800;
    color:rgba(255,255,255,.72);
    margin-bottom:.3rem;
  }
  .cta__title{
    font-family:var(--font-body);
    font-weight:900;
    font-size:1.5rem;
    margin:0 0 .4rem;
  }
  .cta__copy{max-width:28rem;color:rgba(255,255,255,.9) !important;}
  @media (max-width:900px){
    .section__head{flex-direction:column;align-items:flex-start;gap:.6rem;}
    .product-detail__grid{grid-template-columns:1fr !important;}
    .product-detail__grid > div{width:100%;}
    .product-detail__options-card{height:auto;}
    .product-detail__options-card .product-form{flex:initial;min-height:auto;}
    .options-collapse{flex:initial;min-height:auto;}
    .options-preview{overflow:visible;}
    .options-preview::after{display:none;}
    .options-expand{display:none;}
    .qty-row{flex-direction:column;align-items:stretch;}
    .qty-row .field{width:100% !important;}
    .btn-pair{flex-direction:column;align-items:stretch;}
    .btn-pair .btn{width:100%;justify-content:center;}
    .option-picker--split .option-columns{grid-template-columns:1fr;}
    .option-pill__inner{min-width:0;}
    .option-pill__top{flex-direction:column;align-items:flex-start;}
    .option-pill__price{align-items:flex-start;}
    .option-pill__desc{font-size:.85rem;}
    .price__dealer-row{width:100%;}
    .specs__row{grid-template-columns:1fr;gap:.2rem;}
    .specs__k{font-size:.8rem;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);}
  }
  @media (max-width:640px){
    .cta{flex-direction:column;align-items:flex-start}
    .cta .btn{width:100%;justify-content:center}
  }
  .card--quote{
    margin-top:1.5rem;
    padding:1.5rem;
    background:linear-gradient(145deg,rgba(213,0,0,.08),rgba(0,0,0,.8));
    border:1px solid rgba(213,0,0,.25);
    border-radius:1.1rem;
    box-shadow:0 18px 45px rgba(0,0,0,.35);
  }
  .quote-card__intro{margin-bottom:1rem;}
  .quote-form{display:flex;flex-direction:column;gap:1rem;margin-top:.5rem;}
  .quote-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
    gap:1rem;
  }
  .quote-field{display:flex;flex-direction:column;}
  .quote-field label{
    font-size:.85rem;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:rgba(255,255,255,.76);
    margin-bottom:.25rem;
  }
  .quote-field .field{width:100%;}
  .quote-field--full{grid-column:1 / -1;}
  .quote-field__error{
    color:var(--error-text);
    font-size:.8rem;
    margin-top:.3rem;
  }
  .quote-field--error .field{
    border-color:rgba(213,0,0,.7);
    box-shadow:0 0 0 1px rgba(213,0,0,.35);
  }
  .quote-alerts{display:flex;flex-direction:column;gap:.4rem;margin-bottom:1rem;}
  .quote-alert{
    padding:.6rem .8rem;
    border-radius:.7rem;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.04);
    font-weight:700;
    font-size:.9rem;
  }
  .quote-alert--success{border-color:rgba(33,150,83,.55);background:rgba(33,150,83,.15);color:#b9f6ca;}
  .quote-alert--error{border-color:rgba(255,138,128,.6);background:rgba(59,0,0,.8);color:var(--error-text);}
  .quote-alert--info{opacity:.85;}
  .quote-actions{display:flex;flex-direction:column;gap:.4rem;}
  .quote-footnote{color:var(--muted);font-size:.85rem;}
  @media (min-width:640px){
    .quote-actions{flex-direction:row;align-items:center;justify-content:flex-start;}
    .quote-actions .btn{flex-shrink:0;}
    .quote-footnote{margin:0;}
  }

  /* дым — слой позади всего */
#bg{position:fixed; inset:0; z-index:0; pointer-events:none;}
#bg canvas{position:absolute; inset:0; width:100%; height:100%; display:block;}

/* весь контент поверх дыма */
.site-header, .hero, .section, footer{position:relative; z-index:1;}

/* убираем прежний фон у hero */
.hero--store{ background:transparent !important; }

</style>

<script>
  (function () {
    var el = document.getElementById('product-specs-json');
    var mount = document.getElementById('specs-table');
    if (!el || !mount) return;

    try {
      var specs = JSON.parse(el.textContent || '{}');
      if (!specs || typeof specs !== 'object') return;

      // build table
      var table = document.createElement('table');
      table.style.width = '100%';
      table.style.borderCollapse = 'collapse';
      table.style.background = 'rgba(255,255,255,.03)';
      table.style.borderRadius = '8px';

      Object.keys(specs).forEach(function (key) {
        var tr = document.createElement('tr');

        var th = document.createElement('th');
        th.textContent = key.replace(/_/g, ' ').replace(/^\w/, c => c.toUpperCase());
        th.style.textAlign = 'left';
        th.style.padding = '.35rem .6rem';
        th.style.whiteSpace = 'nowrap';

        var td = document.createElement('td');
        var val = specs[key];

        // pretty print value (list/dict/scalar)
        var text;
        if (Array.isArray(val)) {
          text = val.join(', ');
        } else if (val && typeof val === 'object') {
          text = Object.keys(val).map(function(k){ return k + ': ' + val[k]; }).join('; ');
        } else {
          text = String(val);
        }
        td.textContent = text;
        td.style.padding = '.35rem .6rem';
        td.style.color = 'var(--ink)';
        td.style.opacity = .9;

        tr.appendChild(th);
        tr.appendChild(td);
        table.appendChild(tr);
      });

      mount.appendChild(table);
    } catch (e) {
      // silent fail — оставим noscript-версию/ничего
    }
  })();
</script>
{% endblock %}
