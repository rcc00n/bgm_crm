{% load static dealer_extras %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Dealer Portal â€” BGM Customs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#050505;
      --ink:#f2f2f2;
      --muted:#b9b9b9;
      --line:rgba(255,255,255,.12);
      --card-bg:rgba(15,15,15,.85);
      --card-border:rgba(255,255,255,.1);
      --field-bg:rgba(255,255,255,.05);
      --red:#d50000;
      --green:#17d45b;
      --radius-lg:1.35rem;
      --radius-sm:.75rem;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --container:clamp(320px, 92vw, 1180px);
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.55;min-height:100vh;}
    a{color:inherit;text-decoration:none}
    img{display:block;max-width:100%}
    .container{width:var(--container);margin-inline:auto;padding-inline:clamp(1rem,3vw,2rem)}
    .site-header{position:sticky;top:0;z-index:20;background:rgba(0,0,0,.7);backdrop-filter:blur(12px);border-bottom:1px solid var(--line)}
    .site-header__inner{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:1.2rem;padding:.9rem 0}
    .brand{display:flex;align-items:baseline;gap:.45rem;font-weight:900;letter-spacing:.08em;text-transform:uppercase;}
    .brand__word--red{color:var(--red)}
    nav ul{display:flex;list-style:none;gap:.65rem;justify-content:flex-end}
    nav a{display:inline-flex;align-items:center;justify-content:center;padding:.65rem .95rem;border-radius:.6rem;font-weight:700;font-size:.85rem;letter-spacing:.05em;text-transform:uppercase;border:1px solid transparent;min-height:44px;line-height:1.1}
    nav a[aria-current="page"], nav a:hover{border-color:var(--line)}
    .badge{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .7rem;border-radius:999px;font-size:.82rem;background:var(--field-bg);border:1px solid var(--card-border)}
    .badge--accent{background:rgba(213,0,0,.14);border-color:rgba(213,0,0,.65);color:#fff}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.6rem;padding:.85rem 1.2rem;border-radius:var(--radius-sm);font-weight:800;border:1px solid transparent;cursor:pointer;transition:.18s;min-height:44px;line-height:1.1}
    .btn--primary{background:var(--red);color:#fff}
    .btn--primary:hover{transform:translateY(-2px);box-shadow:0 14px 30px rgba(213,0,0,.3)}
    .btn--ghost{background:transparent;border-color:var(--line);color:var(--ink)}
    .btn--ghost:hover{border-color:var(--red);color:var(--red)}
    main{padding:2rem 0 3rem}
    .hero{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1.5rem;margin-bottom:1.8rem;align-items:start}
    .hero__card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-lg);padding:1.6rem;box-shadow:var(--shadow)}
    .hero__eyebrow{text-transform:uppercase;letter-spacing:.14em;font-size:.78rem;color:var(--muted);font-weight:800;margin-bottom:.4rem}
    .hero__title{font-size:clamp(2rem,4vw,2.8rem);font-weight:900;margin:0}
    .hero__lead{color:var(--muted);margin-top:.4rem;max-width:40ch}
    .hero__media{
      position:relative;
      border-radius:var(--radius-lg);
      border:1px solid var(--card-border);
      overflow:hidden;
      box-shadow:var(--shadow);
      min-height:0;
      background:linear-gradient(180deg,rgba(12,12,12,.95),rgba(5,5,5,.95));
    }
    .hero__media img{
      width:100%;
      height:100%;
      object-fit:cover;
      aspect-ratio:16/9;
      display:block;
    }
    .hero__disclaimer{
      position:absolute;
      bottom:.85rem;
      right:.85rem;
      margin:0;
      padding:.45rem .9rem;
      border-radius:999px;
      background:rgba(0,0,0,.7);
      color:var(--muted);
      font-size:.78rem;
      letter-spacing:.01em;
      backdrop-filter:blur(8px) saturate(1.2);
    }
    @media (max-width: 720px){
      .hero__disclaimer{
        position:static;
        margin-top:.65rem;
        border-radius:.8rem;
        display:inline-flex;
      }
    }
    .hero__meta{display:flex;flex-wrap:wrap;gap:.5rem;margin:1rem 0 1.2rem}
    .hero__stat{display:flex;flex-direction:column;gap:.15rem}
    .hero__stat-label{color:var(--muted);font-size:.85rem;text-transform:uppercase;letter-spacing:.08em}
    .hero__stat-value{font-size:1.2rem;font-weight:800}
    .grid{display:grid;gap:1rem}
    .grid--3{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-lg);padding:1.4rem;box-shadow:var(--shadow);min-height:0}
    .card__header{display:flex;align-items:center;justify-content:space-between;margin-bottom:.6rem;gap:.8rem}
    .card__title{font-weight:800;font-size:1.15rem}
    .metrics{display:grid;gap:.4rem}
    .metric{display:flex;align-items:center;justify-content:space-between;padding:.35rem .2rem;border-bottom:1px solid rgba(255,255,255,.05)}
    .metric:last-child{border-bottom:none}
    .metric__label{color:var(--muted);font-size:.9rem}
    .metric__value{font-weight:800}
    .progress{margin-top:.8rem}
    .progress__bar{width:100%;height:12px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
    .progress__fill{height:100%;background:linear-gradient(90deg,#d50000,#ff4d4d)}
    .progress__meta{display:flex;align-items:center;justify-content:space-between;font-size:.9rem;color:var(--muted);margin-top:.35rem}
    .timeline{display:flex;flex-direction:column;gap:1rem;margin-top:1.2rem}
    .timeline__step{display:flex;gap:.8rem;align-items:flex-start}
    .timeline__icon{width:32px;height:32px;border-radius:999px;display:grid;place-items:center;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);font-size:.85rem}
    .timeline__body{flex:1}
    .timeline__label{font-weight:700}
    .timeline__note{color:var(--muted);font-size:.9rem}
    .table{width:100%;border-collapse:collapse;margin-top:.6rem;font-size:.95rem}
    .table th,.table td{padding:.6rem;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    .table th{font-size:.85rem;text-transform:uppercase;letter-spacing:.08em;color:var(--muted)}
    .callout{border-left:4px solid var(--red);background:rgba(213,0,0,.08);padding:.9rem 1.1rem;border-radius:var(--radius-sm);margin-bottom:1rem}
    .callout--ok{border-color:var(--green);background:rgba(23,212,91,.08)}
    .resources{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;margin-top:1.2rem}
    .resource{padding:1rem;border:1px solid rgba(255,255,255,.08);border-radius:var(--radius-sm);background:rgba(255,255,255,.02)}
    footer{border-top:1px solid var(--line);padding:1.2rem 0;color:var(--muted);font-size:.9rem}
    @media (max-width: 900px){
      .site-header__inner{grid-template-columns:auto auto;grid-template-rows:auto auto}
      nav{grid-column:1 / -1}
      nav ul{justify-content:flex-start;flex-wrap:wrap}
    }
    #bg{position:fixed;inset:0;z-index:-1;pointer-events:none;}
    #bg canvas{position:absolute;width:100%;height:100%;display:block;}
</style>
<style id="dealer-status-touch-targets">
  .site-header nav a{
    display:inline-flex !important;
    align-items:center !important;
    justify-content:center !important;
    min-height:44px !important;
    padding:.65rem .95rem !important;
    line-height:1.1 !important;
  }
  .btn{
    min-height:44px !important;
  }
</style>
</head>
<body>
  <div id="bg"></div>
  <header class="site-header">
    <div class="container site-header__inner">
      <a class="brand" href="{% url 'home' %}">
        <span class="brand__word">BAD GUY</span>
        <span class="brand__word brand__word--red">MOTORS</span>
      </a>
      <div class="badge">Dealer Portal</div>
      <nav aria-label="Main navigation">
        <ul>
          <li><a href="{% url 'store' %}">Store</a></li>
          <li><a href="{% url 'store-cart' %}">Cart</a></li>
          <li><a href="{% url 'dealer-status' %}" aria-current="page">Dealers</a></li>
          <li><a href="{% url 'client-dashboard' %}">Services</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div>
        <p class="hero__eyebrow">BGM Customs</p>
        <h1 class="hero__title">Dealer workspace</h1>
        <p class="hero__lead">
          Track your approval status, understand the tier ladder, and jump straight into the catalog with your negotiated pricing.
        </p>
        <div class="hero__meta">
          <span class="badge">Tier: {{ portal.tier_label|default:"Standard" }}</span>
          {% if portal.discount_percent %}
            <span class="badge badge--accent">{{ portal.discount_percent }}% off catalog</span>
          {% endif %}
        </div>
        <div class="hero__actions" style="display:flex;gap:.6rem;flex-wrap:wrap">
          <a class="btn btn--primary" href="{% url 'store' %}">Browse catalog</a>
          <a class="btn btn--ghost" href="{% url 'store-cart' %}">Open cart</a>
        </div>
      </div>
      <div class="hero__card">
        <div class="hero__stat">
          <span class="hero__stat-label">Dealer since</span>
          <span class="hero__stat-value">
            {% if userprofile and userprofile.dealer_since %}
              {{ userprofile.dealer_since|date:"M d, Y" }}
            {% else %}
              Pending activation
            {% endif %}
          </span>
        </div>
        <div class="hero__stat">
          <span class="hero__stat-label">Lifetime spend</span>
          <span class="hero__stat-value">${{ lifetime_spent|default:0|floatformat:2 }}</span>
        </div>
        {% if next_tier %}
          <div class="hero__stat">
            <span class="hero__stat-label">Next tier target</span>
            <span class="hero__stat-value">${{ next_tier.minimum_spend|floatformat:0 }}</span>
            {% if remaining_to_next %}
              <span class="hero__lead" style="font-size:.9rem;margin-top:.2rem;color:var(--muted);">
                ${{ remaining_to_next|floatformat:2 }} to unlock {{ next_tier.label }}
              </span>
            {% endif %}
          </div>
        {% else %}
          <div class="hero__stat">
            <span class="hero__stat-label">Top tier unlocked</span>
            <span class="hero__stat-value">Enjoy the max discount</span>
          </div>
        {% endif %}
      </div>
      <div class="hero__media">
        <img src="{{ hero_media.src }}" alt="{{ hero_media.alt|default:'Dealer hero' }}" loading="lazy" decoding="async">
        <p class="hero__disclaimer">{{ hero_media.caption|default:"Product may not appear exactly as shown." }}</p>
      </div>
    </section>

    {% if is_dealer %}
      <section class="grid grid--3">
        <article class="card">
          <div class="card__header">
            <h2 class="card__title">Account overview</h2>
            <span class="badge">Active</span>
          </div>
          <div class="metrics">
            <div class="metric"><span class="metric__label">Tier</span><span class="metric__value">{{ portal.tier_label|default:"Standard" }}</span></div>
            <div class="metric"><span class="metric__label">Discount</span><span class="metric__value">{% if portal.discount_percent %}{{ portal.discount_percent }}%{% else %}â€”{% endif %}</span></div>
            <div class="metric"><span class="metric__label">Lifetime spend</span><span class="metric__value">${{ lifetime_spent|default:0|floatformat:2 }}</span></div>
            <div class="metric"><span class="metric__label">Last review</span><span class="metric__value">
              {% if dealer_application and dealer_application.reviewed_at %}
                {{ dealer_application.reviewed_at|date:"M d, Y" }}
              {% else %}
                â€”
              {% endif %}
            </span></div>
          </div>
        </article>

        <article class="card">
          <div class="card__header">
            <h2 class="card__title">Progress to next tier</h2>
            {% if next_tier %}
              <span class="badge">{{ next_tier.label }}</span>
            {% else %}
              <span class="badge">Max tier unlocked</span>
            {% endif %}
          </div>
          <div class="progress">
            <div class="progress__bar">
              <div class="progress__fill" style="width:{{ portal.progress|default:0 }}%"></div>
            </div>
            <div class="progress__meta">
              <span>${{ current_threshold|default:0|floatformat:0 }}</span>
              <span>{{ portal.progress|default:0 }}%</span>
              <span>{% if next_tier %}${{ next_tier.minimum_spend|floatformat:0 }}{% else %}Top tier{% endif %}</span>
            </div>
          </div>
        </article>

        <article class="card">
          <div class="card__header">
            <h2 class="card__title">Orders</h2>
            <span class="badge">{{ orders_snapshot.total }} total</span>
          </div>
          <div class="metrics">
            <div class="metric"><span class="metric__label">Open</span><span class="metric__value">{{ orders_snapshot.open }}</span></div>
            <div class="metric"><span class="metric__label">Completed</span><span class="metric__value">{{ orders_snapshot.completed }}</span></div>
            <div class="metric"><span class="metric__label">Most recent</span>
              <span class="metric__value">
                {% if orders_snapshot.latest %}
                  #{{ orders_snapshot.latest.id }} Â· {{ orders_snapshot.latest.get_status_display }}
                {% else %}
                  â€”
                {% endif %}
              </span>
            </div>
          </div>
          <div class="hero__actions" style="margin-top:.8rem">
            <a class="btn btn--ghost" href="{% url 'store' %}">Place order</a>
          </div>
        </article>
      </section>

      <section class="card" style="margin-top:1.5rem">
        <div class="card__header">
          <h2 class="card__title">Resources</h2>
        </div>
        <div class="resources">
          <div class="resource">
            <h3 style="font-weight:800;margin-bottom:.3rem">Dealer price sheet</h3>
            <p class="hero__lead" style="font-size:.9rem;">Download the latest catalog with your discount baked in.</p>
            <a class="btn btn--ghost" href="{% url 'store' %}">Open catalog</a>
          </div>
          <div class="resource">
            <h3 style="font-weight:800;margin-bottom:.3rem">Support desk</h3>
            <p class="hero__lead" style="font-size:.9rem;">Need to escalate an order or request marketing assets? Reach out.</p>
            <a class="btn btn--ghost" href="{% url 'home' %}#contact">Contact support</a>
          </div>
          <div class="resource">
            <h3 style="font-weight:800;margin-bottom:.3rem">Dealer policy</h3>
            <p class="hero__lead" style="font-size:.9rem;">Review the playbook covering terms, logistics, and reporting cadence.</p>
            <a class="btn btn--ghost" href="{% url 'legal-terms' %}">View policy</a>
          </div>
        </div>
      </section>
    {% else %}
      <section class="card">
        <div class="card__header">
          <h2 class="card__title">Application status</h2>
          {% if dealer_application %}
            <span class="badge">{{ dealer_application.get_status_display }}</span>
          {% else %}
            <span class="badge badge--accent">Not submitted</span>
          {% endif %}
        </div>
        {% if dealer_application %}
          {% if dealer_application.status == "pending" %}
            <div class="callout">Thanks for applying. Your submission is in the review queue. We typically respond within 2 business days.</div>
          {% elif dealer_application.status == "rejected" %}
            <div class="callout">The previous request was declined. Feel free to update your details and submit a new application.</div>
          {% elif dealer_application.status == "approved" and not is_dealer %}
            <div class="callout callout--ok">Approved â€” we are finalizing onboarding. Expect an activation email shortly.</div>
          {% endif %}
          <div class="metrics" style="margin-top:.6rem">
            <div class="metric"><span class="metric__label">Business</span><span class="metric__value">{{ dealer_application.business_name }}</span></div>
            <div class="metric"><span class="metric__label">Requested tier</span><span class="metric__value">{{ dealer_application.get_preferred_tier_display }}</span></div>
            <div class="metric"><span class="metric__label">Submitted</span><span class="metric__value">{{ dealer_application.created_at|date:"M d, Y" }}</span></div>
          </div>
        {% else %}
          <div class="callout">You have not submitted a dealer request yet. Tell us about your business and projected volume to unlock wholesale pricing.</div>
        {% endif %}
        <div class="hero__actions" style="margin-top:1rem">
          {% if dealer_application and dealer_application.status == "pending" %}
            <a class="btn btn--ghost" href="{% url 'home' %}#contact">Need to update your data? Contact us</a>
          {% else %}
            <a class="btn btn--primary" href="{% url 'dealer-apply' %}">{% if dealer_application and dealer_application.status == "rejected" %}Reapply{% else %}Apply now{% endif %}</a>
          {% endif %}
        </div>
      </section>
    {% endif %}

    <section class="card" style="margin-top:1.6rem">
      <div class="card__header">
        <h2 class="card__title">Tier ladder</h2>
        <span class="badge">Transparent thresholds</span>
      </div>
      {% if tier_levels %}
        <table class="table" aria-label="Dealer tiers">
          <thead>
            <tr>
              <th scope="col">Tier</th>
              <th scope="col">Minimum spend</th>
              <th scope="col">Discount</th>
              <th scope="col">Notes</th>
            </tr>
          </thead>
          <tbody>
            {% for tier in tier_levels %}
              <tr {% if tier.code == portal.tier_code %}style="background:rgba(213,0,0,.08)"{% endif %}>
                <td>{{ tier.label }}</td>
                <td>${{ tier.minimum_spend|floatformat:0 }}</td>
                <td>{{ tier.discount_percent }}%</td>
                <td>{{ tier.description|default:"â€”" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="hero__lead">Tier configuration is coming soon.</p>
      {% endif %}
    </section>

    <section class="card" style="margin-top:1.6rem">
      <div class="card__header">
        <h2 class="card__title">Lifecycle timeline</h2>
      </div>
      <div class="timeline">
        {% for step in application_steps %}
          <div class="timeline__step">
            <div class="timeline__icon">
              {% if step.state %}âœ“{% else %}â€¢{% endif %}
            </div>
            <div class="timeline__body">
              <div class="timeline__label">{{ step.label }}</div>
              {% if step.timestamp %}
                <div class="timeline__note">{{ step.timestamp|date:"M d, Y" }}</div>
              {% else %}
                <div class="timeline__note">In progress</div>
              {% endif %}
              {% if step.details %}
                <div class="timeline__note">{{ step.details }}</div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </section>
  </main>

  <footer class="container">
    Â© {{ now|date:"Y" }} BGM Customs. Dealer portal.
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script src="{% static 'admin/js/bgm-smoke.js' %}"></script>
</body>
</html>
