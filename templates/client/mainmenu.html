{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Malva Booking — Services</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    /* ===== Brand palette ===== */
    :root{
      --green:#204029;        /* deep green */
      --gold:#AF9525;         /* accent gold */
      --taupe:#DAD3C1;        /* soft taupe */
      --lgray:#DEDEDE;        /* light gray (page bg) */
      --dgray:#4D4D4D;        /* text */
      --white:#FFFFFF;

      --radius-lg:1.25rem;
      --radius-sm:.6rem;
      --shadow:0 8px 20px rgba(0,0,0,.10);
      --container:clamp(280px,92vw,1160px);
    }

    /* ===== Base ===== */
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html{font-size:16px;scroll-behavior:smooth}
    body{
      font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;
      background:var(--lgray);
      color:var(--dgray);
      line-height:1.5;
    }
    img{max-width:100%;display:block}
    a{color:inherit;text-decoration:none}
    .container{width:var(--container);margin-inline:auto;padding-inline:1rem}

    /* ===== Buttons ===== */
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:.5em;
      padding:.75rem 1.25rem;border-radius:var(--radius-sm);
      font-weight:700;cursor:pointer;transition:.25s all;white-space:nowrap;user-select:none
    }
    .btn--primary{background:var(--gold);color:var(--white);border:none}
    .btn--primary:hover{filter:brightness(.95);transform:translateY(-2px)}
    .btn--ghost{
      background:transparent;color:var(--gold);border:2px solid var(--gold);
    }
    .btn--ghost:hover{background:rgba(175,149,37,.08);transform:translateY(-2px)}
    .btn--ghost[disabled]{opacity:.45;cursor:not-allowed}

    /* ===== Header ===== */
    .site-header{background:var(--green);box-shadow:var(--shadow);position:sticky;top:0;z-index:100;padding-block:.75rem}
    .site-header__inner{display:flex;align-items:center;justify-content:space-between}
    .logo{font-size:1.25rem;font-weight:800;color:var(--gold);letter-spacing:.3px}

    /* ===== Hero ===== */
    .hero{
      display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center;gap:1.25rem;
      padding:5.5rem 1rem;
      background:
        radial-gradient(60% 120% at 80% -10%, rgba(32,64,41,.18) 0%, rgba(32,64,41,0) 60%),
        linear-gradient(135deg, var(--taupe) 0%, var(--lgray) 100%);
    }
    .hero h1{font-size:clamp(2rem,4vw,3.2rem);font-weight:900;color:var(--green)}
    .hero p{font-size:1.125rem;max-width:52ch;color:var(--dgray)}

    /* ===== Filters ===== */
    .filters{display:flex;flex-wrap:wrap;gap:.75rem;margin:1.25rem 0 1.75rem}
    .filters input,.filters select{
      padding:.6rem 1rem;border:1px solid var(--taupe);border-radius:var(--radius-sm);
      font-size:.95rem;min-width:170px;background:var(--white)
    }

    /* ===== Cards ===== */
    .services-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1.25rem}
    .service-card{
      background:var(--white);border-radius:var(--radius-lg);padding:1.25rem;
      display:flex;flex-direction:column;gap:.85rem;box-shadow:var(--shadow);
      border:1px solid color-mix(in srgb, var(--taupe) 70%, transparent);
      transition:.25s
    }
    .service-card:hover{transform:translateY(-4px);box-shadow:0 12px 28px rgba(0,0,0,.14)}
    .service-card__img{
      aspect-ratio:16/9;background:color-mix(in srgb, var(--taupe) 40%, var(--white));
      border-radius:.75rem;display:flex;align-items:center;justify-content:center;
      font-size:.9rem;color:#8a8a8a
    }
    .service-card h3{font-size:1.08rem;font-weight:800;color:var(--dgray)}
    .service-meta{font-size:.9rem;color:#636363}
    .stub{font-style:italic;color:#666;padding:1rem}
    .muted{color:#666;font-size:.92rem}
    .old{color:#999;text-decoration:line-through}
    .badge{
      font-size:.75rem;background:var(--gold);color:var(--white);
      border-radius:999px;padding:.18rem .55rem;margin-left:.35rem
    }

    /* ===== Footer ===== */
    .site-footer{text-align:center;font-size:.875rem;color:#666;padding:2rem 1rem}

    /* ===== Modal: booking ===== */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.42);display:none;align-items:center;justify-content:center;padding:1rem;z-index:1000}
    .modal--open{display:flex}
    .modal__dialog{background:var(--white);border-radius:1rem;box-shadow:0 14px 36px rgba(0,0,0,.22);width:min(760px,96vw);padding:1.25rem 1.25rem 1rem;border:1px solid var(--taupe)}
    .modal__header{display:flex;justify-content:space-between;align-items:center;gap:.5rem;margin-bottom:1rem}
    .modal__title{font-weight:900;font-size:1.15rem;color:var(--green)}
    .modal__close{background:transparent;border:none;font-size:1.5rem;line-height:1;cursor:pointer;color:#666}
    .grid-2{display:grid;grid-template-columns:1.2fr .8fr;gap:1rem}
    .field{display:flex;flex-direction:column;gap:.35rem}
    .field label{font-size:.9rem;color:#555}
    .field input,.field select{padding:.6rem .8rem;border:1px solid var(--lgray);border-radius:.6rem;font-size:.95rem}
    .slots{
      display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:.5rem;margin-top:.5rem;
      max-height:240px;overflow:auto;border:1px dashed var(--lgray);padding:.5rem;border-radius:.5rem
    }
    .slot{padding:.5rem .65rem;border:1px solid #ddd;border-radius:.6rem;cursor:pointer;text-align:center;background:var(--white)}
    .slot--active{border-color:var(--gold);background:var(--taupe);color:var(--green);font-weight:800}
    .modal__footer{display:flex;justify-content:flex-end;gap:.5rem;margin-top:1rem}
    .hint{font-size:.85rem;color:#666}
    .error{color:#b00020;font-size:.9rem;margin-top:.5rem}
    .success{color:#0a7a3b;font-size:.95rem;margin-top:.5rem}
    .skeleton{background:linear-gradient(90deg,#eee,#f6f6f6,#eee);background-size:200% 100%;animation:sh 1.2s ease-in-out infinite;border-radius:.5rem;height:36px}
    @keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}
  </style>
</head>
<body>

  <!-- header -->
  <header class="site-header">
    <div class="container site-header__inner">
      <span class="logo">Malva Booking</span>
      <nav>
  {% if user.is_authenticated %}
    <a href="{% url 'dashboard' %}" class="btn btn--ghost">Client Profile</a>
  {% else %}
    <a href="{% url 'login' %}?next={{ request.get_full_path|urlencode }}" class="btn btn--ghost">Login</a>
  {% endif %}
</nav>

    </div>
  </header>

  <!-- hero -->
  <section class="hero">
    <h1>Book your appointment in 2 clicks</h1>
    <p>Pick a service, a specialist, and a time — we’ll handle the rest.</p>
    <a href="#services" class="btn btn--primary">Browse services ↓</a>
  </section>

  <main id="services" class="container" style="padding-block:3rem;">
    <h2 style="font-size:1.75rem;font-weight:800;margin-bottom:1.5rem;color:var(--green);">Services</h2>

    <!-- Filters -->
    <form method="get" class="filters" role="search">
      <input type="search" name="q" placeholder="Search a service…" value="{{ q|default:'' }}">
      <select name="cat">
        <option value="">All categories</option>
        {% for c in filter_categories %}
          <option value="{{ c.id }}" {% if active_category == c.id|stringformat:'s' %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
      <button class="btn btn--primary" type="submit">Search</button>
      {% if q or active_category %}
        <a class="btn btn--ghost" href="{% url 'client-dashboard' %}#services">Reset</a>
      {% endif %}
    </form>

    <!-- Live results (JS) -->
    <h3 id="liveTitle" style="margin:.5rem 0 1rem; display:none;">Search results</h3>
    <div id="liveGrid" class="services-grid" style="display:none;"></div>

    <!-- Server-rendered fallback/results -->
    <div id="serverContent">
      {% if search_results %}
        <h3 style="margin:.5rem 0 1rem;">Search results</h3>
        <div class="services-grid">
          {% for s in search_results %}
            <article class="service-card">
              <div class="service-card__img">IMG</div>
              <div class="muted">{{ s.category.name }}</div>
              <h3>{{ s.name }}</h3>
              {% if s.description %}<p class="muted">{{ s.description|truncatewords:22 }}</p>{% endif %}
              <div class="service-meta">
                {% with disc=s.get_active_discount %}
                  {% if disc %}
                    <span class="old">${{ s.base_price|floatformat:2 }}</span>
                    <strong>${{ s.get_discounted_price|floatformat:2 }}</strong>
                    <span class="badge">-{{ disc.discount_percent }}%</span>
                  {% else %}
                    <strong>${{ s.base_price|floatformat:2 }}</strong>
                  {% endif %}
                {% endwith %}
                · {{ s.duration_min }} min
              </div>
              <button class="btn btn--primary book-btn"
                      data-service-id="{{ s.id }}" data-service-name="{{ s.name }}">
                Pick a time
              </button>
            </article>
          {% empty %}
            <div class="stub">No results for “{{ q }}”.</div>
          {% endfor %}
        </div>
        <hr style="margin:2rem 0;border:none;border-top:1px solid var(--lgray)">
      {% endif %}

      {% for c in categories %}
        <h3 style="margin:1.5rem 0 .75rem;color:var(--green);font-weight:800">{{ c.name }}</h3>
        <div class="services-grid">
          {% for s in c.service_set.all %}
            <article class="service-card">
              <div class="service-card__img">IMG</div>
              <h3>{{ s.name }}</h3>
              {% if s.description %}<p class="muted">{{ s.description|truncatewords:22 }}</p>{% endif %}
              <div class="service-meta">
                {% with disc=s.get_active_discount %}
                  {% if disc %}
                    <span class="old">${{ s.base_price|floatformat:2 }}</span>
                    <strong>${{ s.get_discounted_price|floatformat:2 }}</strong>
                    <span class="badge">-{{ disc.discount_percent }}%</span>
                  {% else %}
                    <strong>${{ s.base_price|floatformat:2 }}</strong>
                  {% endif %}
                {% endwith %}
                · {{ s.duration_min }} min
              </div>
              <button class="btn btn--primary book-btn"
                      data-service-id="{{ s.id }}" data-service-name="{{ s.name }}">
                Pick a time
              </button>
            </article>
          {% empty %}
            <div class="stub">No services in this category yet.</div>
          {% endfor %}
        </div>
      {% endfor %}

      {% if uncategorized %}
        <h3 style="margin:1.5rem 0 .75rem;color:var(--green);font-weight:800">Uncategorized</h3>
        <div class="services-grid">
          {% for s in uncategorized %}
            <article class="service-card">
              <div class="service-card__img">IMG</div>
              <h3>{{ s.name }}</h3>
              {% if s.description %}<p class="muted">{{ s.description|truncatewords:22 }}</p>{% endif %}
              <div class="service-meta">
                {% with disc=s.get_active_discount %}
                  {% if disc %}
                    <span class="old">${{ s.base_price|floatformat:2 }}</span>
                    <strong>${{ s.get_discounted_price|floatformat:2 }}</strong>
                    <span class="badge">-{{ disc.discount_percent }}%</span>
                  {% else %}
                    <strong>${{ s.base_price|floatformat:2 }}</strong>
                  {% endif %}
                {% endwith %}
                · {{ s.duration_min }} min
              </div>
              <button class="btn btn--primary book-btn"
                      data-service-id="{{ s.id }}" data-service-name="{{ s.name }}">
                Pick a time
              </button>
            </article>
          {% endfor %}
        </div>
      {% endif %}

      {% if not has_any_services %}
        <div class="stub">The catalog will be available soon 👍</div>
      {% endif %}
    </div>
  </main>

  <footer class="site-footer">© 2025 Malva Booking</footer>

  <!-- ===== Modal: booking ===== -->
  <div class="modal" id="bookModal" aria-hidden="true">
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="bookTitle">
      <div class="modal__header">
        <div class="modal__title" id="bookTitle">Booking for <span id="bookServiceName"></span></div>
        <button class="modal__close" id="bookClose" aria-label="Close">×</button>
      </div>

      <div class="grid-2">
        <div>
          <div class="field">
            <label for="bookDate">Date</label>
            <input type="date" id="bookDate">
          </div>
          <div class="field" style="margin-top:.5rem">
            <label for="bookMaster">Master</label>
            <select id="bookMaster"></select>
          </div>
          <div class="field" style="margin-top:.5rem">
            <label>Available slots</label>
            <div class="slots" id="bookSlots">
              <div class="skeleton"></div>
            </div>
            <div class="hint">Choose a convenient time. Slots respect the service duration and master’s schedule.</div>
          </div>
        </div>
        <div>
          <div class="field">
            <label>Summary</label>
            <div class="muted" id="bookSummary">Pick a date, master, and time.</div>
          </div>
          <div class="error" id="bookError" style="display:none;"></div>
          <div class="success" id="bookSuccess" style="display:none;"></div>
        </div>
      </div>

      <div class="modal__footer">
        <button class="btn btn--ghost" id="bookCancel">Cancel</button>
        <button class="btn btn--primary" id="bookSubmit" disabled>Confirm booking</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const isAuth = {{ user.is_authenticated|yesno:"true,false" }};
      const loginUrl = "{% url 'login' %}?next={{ request.path }}";
      const apiAvail = "/accounts/api/availability/";
      const apiBook = "/accounts/api/book/";

      // helpers
      function getCookie(name){
        const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)'); return m ? m.pop() : '';
      }
      function fmtTime(iso){
        try { return new Date(iso).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
        catch(e){ return iso; }
      }
      function todayStr(){
        const d=new Date(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
        return `${d.getFullYear()}-${m}-${day}`;
      }

      // modal elements
      const modal=document.getElementById('bookModal');
      const btnClose=document.getElementById('bookClose');
      const btnCancel=document.getElementById('bookCancel');
      const btnSubmit=document.getElementById('bookSubmit');
      const elServiceName=document.getElementById('bookServiceName');
      const elDate=document.getElementById('bookDate');
      const elMaster=document.getElementById('bookMaster');
      const elSlots=document.getElementById('bookSlots');
      const elSummary=document.getElementById('bookSummary');
      const elError=document.getElementById('bookError');
      const elSuccess=document.getElementById('bookSuccess');

      let current={ serviceId:null, serviceName:'', masterId:null, slot:null, mastersData:[] };

      function openModal(serviceId, serviceName){
        if(!isAuth){ window.location=loginUrl; return; }
        current={ serviceId, serviceName, masterId:null, slot:null, mastersData:[] };
        elServiceName.textContent=serviceName;
        elError.style.display='none'; elSuccess.style.display='none';
        btnSubmit.disabled=true;
        elDate.min=todayStr(); elDate.value=todayStr();
        elMaster.innerHTML=''; elSlots.innerHTML='<div class="skeleton"></div>';
        elSummary.textContent='Pick a date, master, and time.';
        modal.classList.add('modal--open');
        loadAvailability();
      }
      function closeModal(){ modal.classList.remove('modal--open'); }

      async function loadAvailability(){
        elError.style.display='none';
        elSlots.innerHTML='<div class="skeleton"></div>';
        btnSubmit.disabled=true; current.slot=null;

        const params=new URLSearchParams({ service: current.serviceId, date: elDate.value });
        try{
          const resp=await fetch(`${apiAvail}?`+params.toString(),{credentials:'same-origin'});
          if(!resp.ok) throw new Error('Failed to load available slots');
          const data=await resp.json();
          current.mastersData=data.masters||[];

          // fill masters
          elMaster.innerHTML='';
          if(current.mastersData.length===0){
            const opt=document.createElement('option'); opt.value=''; opt.textContent='No masters available';
            elMaster.appendChild(opt);
            elSlots.innerHTML='<div class="hint">No masters for this service.</div>';
            return;
          }
          current.mastersData.forEach(m=>{
            const opt=document.createElement('option'); opt.value=m.id; opt.textContent=m.name; elMaster.appendChild(opt);
          });

          // default master: first with slots else first
          const withSlots=current.mastersData.find(m=>(m.slots||[]).length);
          elMaster.value=(withSlots?withSlots.id:current.mastersData[0].id);
          renderSlots();
        }catch(err){
          elError.textContent=err.message||'Unable to fetch availability';
          elError.style.display='block'; elSlots.innerHTML='';
        }
      }

      function renderSlots(){
        const mId=Number(elMaster.value);
        current.masterId=mId;
        const m=current.mastersData.find(x=>Number(x.id)===mId);
        const slots=(m&&m.slots)?m.slots:[];
        elSlots.innerHTML='';
        if(slots.length===0){
          elSlots.innerHTML='<div class="hint">No free slots for the selected date.</div>';
          btnSubmit.disabled=true; elSummary.textContent='Try another date.';
          return;
        }
        slots.forEach(iso=>{
          const b=document.createElement('button');
          b.type='button'; b.className='slot'; b.textContent=fmtTime(iso); b.dataset.iso=iso;
          b.addEventListener('click', ()=>{
            [...elSlots.querySelectorAll('.slot')].forEach(x=>x.classList.remove('slot--active'));
            b.classList.add('slot--active'); current.slot=iso; btnSubmit.disabled=false;
            elSummary.textContent=`Master: ${m.name}. Time: ${fmtTime(iso)}.`;
          });
          elSlots.appendChild(b);
        });
      }

      async function submitBooking(){
        if(!current.serviceId||!current.masterId||!current.slot) return;
        btnSubmit.disabled=true; elError.style.display='none'; elSuccess.style.display='none';

        try{
          const resp=await fetch(apiBook,{
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')},
            credentials:'same-origin',
            body:JSON.stringify({ service:current.serviceId, master:current.masterId, start_time:current.slot })
          });
          const data=await resp.json().catch(()=>({}));
          if(!resp.ok){
            const msg=(data&&(data.error||data.detail))?(data.error||data.detail):'Could not create an appointment';
            throw new Error(msg);
          }
          elSuccess.textContent='Appointment created! '+(data.appointment?.start_time?('Time: '+fmtTime(data.appointment.start_time)):'');
          elSuccess.style.display='block';
          setTimeout(()=>{ window.location.reload(); }, 700);
        }catch(err){
          elError.textContent=err.message||'Booking error';
          elError.style.display='block'; btnSubmit.disabled=false;
        }
      }

      // events (booking)
      document.addEventListener('click',(e)=>{
        const btn=e.target.closest('.book-btn'); if(btn){
          const id=btn.dataset.serviceId; const name=btn.dataset.serviceName||'service';
          openModal(id,name);
        }
      });
      btnClose.addEventListener('click',closeModal);
      btnCancel.addEventListener('click',closeModal);
      modal.addEventListener('click',(e)=>{ if(e.target===modal) closeModal(); });
      elDate.addEventListener('change',loadAvailability);
      elMaster.addEventListener('change',renderSlots);
      btnSubmit.addEventListener('click',submitBooking);

      /* ===== Live search ===== */
      const qInput = document.querySelector('input[name="q"]');
      const catSel = document.querySelector('select[name="cat"]');
      const liveTitle = document.getElementById('liveTitle');
      const liveGrid  = document.getElementById('liveGrid');
      const serverContent = document.getElementById('serverContent');
      const resetLink = document.querySelector('a.btn.btn--ghost[href*="client-dashboard"]');

      function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
      function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
      function showLive(){ liveTitle.style.display='block'; liveGrid.style.display='grid'; serverContent.style.display='none'; }
      function hideLive(){ liveTitle.style.display='none'; liveGrid.style.display='none'; serverContent.style.display='block'; }
      function skeleton(n=8){
        return Array.from({length:n}).map(()=>`
          <article class="service-card">
            <div class="service-card__img skeleton"></div>
            <div class="skeleton" style="height:18px;margin-top:10px;border-radius:6px;"></div>
            <div class="skeleton" style="height:14px;margin-top:6px;border-radius:6px;"></div>
            <div class="skeleton" style="height:36px;margin-top:12px;border-radius:10px;"></div>
          </article>`).join('');
      }
      function cardHTML(s){
        const hasDisc = Number.isFinite(+s.discount_percent) && +s.discount_percent > 0;
        const priceBlock = hasDisc
          ? `<span class="old">$${escapeHtml(s.base_price)}</span>
             <strong>$${escapeHtml(s.price)}</strong>
             <span class="badge">-${escapeHtml(String(s.discount_percent))}%</span>`
          : `<strong>$${escapeHtml(s.price || s.base_price)}</strong>`;
        const desc = s.description ? `<p class="muted">${escapeHtml(s.description)}</p>` : '';
        const cat  = s.category ? `<div class="muted">${escapeHtml(s.category)}</div>` : '';
        return `
          <article class="service-card">
            <div class="service-card__img">IMG</div>
            ${cat}
            <h3>${escapeHtml(s.name)}</h3>
            ${desc}
            <div class="service-meta">${priceBlock} · ${escapeHtml(String(s.duration_min))} min</div>
            <button class="btn btn--primary book-btn"
              data-service-id="${escapeHtml(s.id)}"
              data-service-name="${escapeHtml(s.name)}">Pick a time</button>
          </article>`;
      }

      let aborter = null;
      async function fetchServices(q, cat){
        if (aborter) aborter.abort();
        aborter = new AbortController();
        const params = new URLSearchParams();
        if (q)   params.set('q', q);
        if (cat) params.set('cat', cat);
        const url = `/accounts/api/services/search/?${params.toString()}`;
        const r = await fetch(url, { signal: aborter.signal, credentials: 'same-origin' });
        if (!r.ok) throw new Error('Failed to load');
        return r.json();
      }

      const runSearch = debounce(async ()=>{
        const q   = qInput?.value?.trim() || '';
        const cat = catSel?.value || '';
        if (!q && !cat) { hideLive(); return; }
        showLive();
        liveGrid.innerHTML = skeleton();
        try{
          const data = await fetchServices(q, cat);
          const items = (data && data.results) || [];
          if (items.length === 0){
            liveGrid.innerHTML = `<div class="stub">No services found.</div>`;
            return;
          }
          liveGrid.innerHTML = items.map(cardHTML).join('');
        }catch(e){
          liveGrid.innerHTML = `<div class="stub">Could not load results. Please try again.</div>`;
        }
      }, 300);

      if (qInput) qInput.addEventListener('input', runSearch);
      if (catSel) catSel.addEventListener('change', runSearch);
      if (resetLink){
        resetLink.addEventListener('click', (e)=>{
          e.preventDefault();
          if (qInput) qInput.value = '';
          if (catSel) catSel.value = '';
          hideLive();
          document.getElementById('services')?.scrollIntoView({behavior:'smooth', block:'start'});
        });
      }
    })();
  </script>
</body>
</html>
