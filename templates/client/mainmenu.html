{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Malva Booking ‚Äî –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --brand:#7e57c2; --brand-dark:#6546b4; --bg-light:#fafafa; --text-main:#333; --text-muted:#666; --radius-lg:1.25rem; --radius-sm:.5rem; --shadow:0 6px 18px rgba(0,0,0,.08); --container:clamp(280px,90vw,1180px); }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html{font-size:16px;scroll-behavior:smooth}
    body{font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;background:var(--bg-light);color:var(--text-main);line-height:1.45;}
    img{max-width:100%;display:block}
    a{color:inherit;text-decoration:none}
    .container{width:var(--container);margin-inline:auto;padding-inline:1rem;}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.4em;padding:.75rem 1.75rem;border-radius:var(--radius-sm);font-weight:600;cursor:pointer;transition:.25s all;white-space:nowrap;user-select:none}
    .btn--primary{background:var(--brand);color:#fff;border:none;}
    .btn--primary:hover{background:var(--brand-dark);transform:translateY(-2px);}
    .btn--ghost{background:transparent;color:var(--brand);border:2px solid var(--brand);}
    .btn--ghost:hover{color:var(--brand-dark);border-color:var(--brand-dark);background:rgba(126,87,194,.08);transform:translateY(-2px);}
    .btn--ghost[disabled]{opacity:.45;cursor:not-allowed}
    .site-header{background:#fff;box-shadow:var(--shadow);position:sticky;top:0;z-index:100;padding-block:.75rem;}
    .site-header__inner{display:flex;align-items:center;justify-content:space-between;}
    .logo{font-size:1.25rem;font-weight:700;color:var(--brand)}
    .hero{display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center;gap:1.5rem;padding:6rem 1rem;background:linear-gradient(135deg,#f7f7ff 0%,#ebe2ff 100%);}
    .hero h1{font-size:clamp(2rem,4vw,3.5rem);font-weight:800;color:var(--brand)}
    .hero p{font-size:1.125rem;color:var(--text-muted)}
    .filters{display:flex;flex-wrap:wrap;gap:.75rem;margin-bottom:1.5rem}
    .filters input,.filters select{padding:.6rem 1rem;border:1px solid #ccc;border-radius:var(--radius-sm);font-size:.9rem;min-width:160px;background:#fff;}
    .services-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1.25rem;}
    .service-card{background:#fff;border-radius:var(--radius-lg);padding:1.5rem;display:flex;flex-direction:column;gap:1rem;box-shadow:var(--shadow);transition:.25s}
    .service-card:hover{transform:translateY(-4px);box-shadow:0 10px 28px rgba(0,0,0,.12)}
    .service-card__img{aspect-ratio:16/9;background:#e6e1f5;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:.9rem;color:#aaa}
    .service-card h3{font-size:1.1rem;font-weight:700;color:var(--text-main)}
    .service-meta{font-size:.85rem;color:var(--text-muted);}
    .stub{font-style:italic;color:var(--text-muted);padding:1rem}
    .muted{color:#666;font-size:.85rem}
    .old{color:#999;text-decoration:line-through}
    .badge{font-size:.75rem;background:#ffe7ec;color:#c1003f;border-radius:999px;padding:.15rem .5rem}
    .debug{background:#fff7cd;border:1px dashed #e2a400;border-radius:10px;padding:.75rem 1rem;margin:1rem 0;font-size:.9rem;color:#715100}
    .debug code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .site-footer{text-align:center;font-size:.875rem;color:var(--text-muted);padding:2rem 1rem}

    /* ===== modal booking ===== */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:1rem;z-index:1000}
    .modal--open{display:flex}
    .modal__dialog{background:#fff;border-radius:1rem;box-shadow:0 12px 30px rgba(0,0,0,.18);width:min(720px,96vw);padding:1.25rem 1.25rem 1rem}
    .modal__header{display:flex;justify-content:space-between;align-items:center;gap:.5rem;margin-bottom:1rem}
    .modal__title{font-weight:800;font-size:1.15rem}
    .modal__close{background:transparent;border:none;font-size:1.5rem;line-height:1;cursor:pointer;color:#666}
    .grid-2{display:grid;grid-template-columns:1.2fr .8fr;gap:1rem}
    .field{display:flex;flex-direction:column;gap:.35rem}
    .field label{font-size:.9rem;color:#555}
    .field input,.field select{padding:.6rem .8rem;border:1px solid #ccc;border-radius:.6rem;font-size:.95rem}
    .slots{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:.5rem;margin-top:.5rem;max-height:240px;overflow:auto;border:1px dashed #eee;padding:.5rem;border-radius:.5rem}
    .slot{padding:.5rem .65rem;border:1px solid #ddd;border-radius:.6rem;cursor:pointer;text-align:center}
    .slot--active{border-color:var(--brand);background:#f3effd;color:#2b2060;font-weight:700}
    .modal__footer{display:flex;justify-content:flex-end;gap:.5rem;margin-top:1rem}
    .hint{font-size:.85rem;color:#666}
    .error{color:#b00020;font-size:.9rem;margin-top:.5rem}
    .success{color:#0a7a3b;font-size:.95rem;margin-top:.5rem}
    .skeleton{background:linear-gradient(90deg,#eee, #f6f6f6, #eee);background-size:200% 100%;animation:sh 1.2s ease-in-out infinite;border-radius:.5rem;height:36px}
    @keyframes sh {0%{background-position:200% 0}100%{background-position:-200% 0}}
  </style>
</head>
<body>
  <!-- header -->
  <header class="site-header">
    <div class="container site-header__inner">
      <span class="logo">Malva Booking</span>
      <nav>
        {% if user.is_authenticated %}
          <a href="{% url 'dashboard' %}" class="btn btn--ghost">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
        {% else %}
          <a href="{% url 'login' %}?next={% url 'dashboard' %}" class="btn btn--ghost">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
        {% endif %}
      </nav>
    </div>
  </header>

  <!-- hero -->
  <section class="hero">
    <h1>–û–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å—å –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É –∑–∞ 2 –∫–ª–∏–∫–∞</h1>
    <p>–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É, –º–∞—Å—Ç–µ—Ä–∞ –∏ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è ‚Äî –º—ã –ø–æ–∑–∞–±–æ—Ç–∏–º—Å—è –æ–±–æ –≤—Å—ë–º –æ—Å—Ç–∞–ª—å–Ω–æ–º</p>
    <a href="#services" class="btn btn--primary">–ö–∞—Ç–∞–ª–æ–≥ —É—Å–ª—É–≥ ‚Üì</a>
  </section>

  <main id="services" class="container" style="padding-block:3rem;">
    <h2 style="font-size:1.75rem;font-weight:700;margin-bottom:1.5rem;">–ö–∞—Ç–∞–ª–æ–≥ —É—Å–ª—É–≥</h2>

    <!-- üîé –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    <div class="debug">
      <div><strong>DEBUG:</strong>
        categories=<code>{{ categories|length }}</code>,
        filter_categories=<code>{{ filter_categories|length }}</code>,
        has_any_services=<code>{{ has_any_services }}</code>,
        q=<code>{{ q }}</code>,
        active_category=<code>{{ active_category }}</code>,
        uncategorized=<code>{% if uncategorized %}yes{% else %}no{% endif %}</code>
      </div>
      {% if categories %}
        <div style="margin-top:.5rem">
          {% for c in categories %}
            <div>cat ¬´{{ c.name }}¬ª: <code>{{ c.service_set.all|length }}</code> —É—Å–ª—É–≥</div>
          {% endfor %}
        </div>
      {% endif %}
    </div> -->

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <form method="get" class="filters" role="search">
      <input type="search" name="q" placeholder="–ü–æ–∏—Å–∫ —É—Å–ª—É–≥–∏‚Ä¶" value="{{ q|default:'' }}">
      <select name="cat">
        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
        {% for c in filter_categories %}
          <option value="{{ c.id }}" {% if active_category == c.id|stringformat:'s' %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
      <button class="btn btn--primary" type="submit">–ù–∞–π—Ç–∏</button>
      {% if q or active_category %}
        <a class="btn btn--ghost" href="{% url 'client-dashboard' %}#services">–°–±—Ä–æ—Å–∏—Ç—å</a>
      {% endif %}
    </form>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
    {% if search_results %}
      <h3 style="margin:.5rem 0 1rem;">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h3>
      <div class="services-grid">
        {% for s in search_results %}
          <article class="service-card">
            <div class="service-card__img">IMG</div>
            <div class="muted">{{ s.category.name }}</div>
            <h3>{{ s.name }}</h3>
            {% if s.description %}<p class="muted">{{ s.description|truncatewords:22 }}</p>{% endif %}
            <div class="service-meta">
              {% with disc=s.get_active_discount %}
                {% if disc %}
                  <span class="old">${{ s.base_price|floatformat:2 }}</span>
                  <strong>${{ s.get_discounted_price|floatformat:2 }}</strong>
                  <span class="badge">-{{ disc.discount_percent }}%</span>
                {% else %}
                  <strong>${{ s.base_price|floatformat:2 }}</strong>
                {% endif %}
              {% endwith %}
              ¬∑ {{ s.duration_min }} –º–∏–Ω
            </div>
            <button class="btn btn--primary book-btn"
                    data-service-id="{{ s.id }}" data-service-name="{{ s.name }}">
              –í—ã–±—Ä–∞—Ç—å –≤—Ä–µ–º—è
            </button>
          </article>
        {% empty %}
          <div class="stub">–ü–æ –∑–∞–ø—Ä–æ—Å—É ¬´{{ q }}¬ª –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>
        {% endfor %}
      </div>
      <hr style="margin:2rem 0;border:none;border-top:1px solid #eee">
    {% endif %}

    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ + —É—Å–ª—É–≥–∏ -->
    {% for c in categories %}
      <h3 style="margin:1.5rem 0 .75rem;">{{ c.name }}</h3>
      <div class="services-grid">
        {% for s in c.service_set.all %}
          <article class="service-card">
            <div class="service-card__img">IMG</div>
            <h3>{{ s.name }}</h3>
            {% if s.description %}<p class="muted">{{ s.description|truncatewords:22 }}</p>{% endif %}
            <div class="service-meta">
              {% with disc=s.get_active_discount %}
                {% if disc %}
                  <span class="old">${{ s.base_price|floatformat:2 }}</span>
                  <strong>${{ s.get_discounted_price|floatformat:2 }}</strong>
                  <span class="badge">-{{ disc.discount_percent }}%</span>
                {% else %}
                  <strong>${{ s.base_price|floatformat:2 }}</strong>
                {% endif %}
              {% endwith %}
              ¬∑ {{ s.duration_min }} –º–∏–Ω
            </div>
            <button class="btn btn--primary book-btn"
                    data-service-id="{{ s.id }}" data-service-name="{{ s.name }}">
              –í—ã–±—Ä–∞—Ç—å –≤—Ä–µ–º—è
            </button>
          </article>
        {% empty %}
          <div class="stub">–í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç —É—Å–ª—É–≥.</div>
        {% endfor %}
      </div>
    {% endfor %}

    {% if uncategorized %}
      <h3 style="margin:1.5rem 0 .75rem;">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
      <div class="services-grid">
        {% for s in uncategorized %}
          <article class="service-card">
            <div class="service-card__img">IMG</div>
            <h3>{{ s.name }}</h3>
            {% if s.description %}<p class="muted">{{ s.description|truncatewords:22 }}</p>{% endif %}
            <div class="service-meta">
              {% with disc=s.get_active_discount %}
                {% if disc %}
                  <span class="old">${{ s.base_price|floatformat:2 }}</span>
                  <strong>${{ s.get_discounted_price|floatformat:2 }}</strong>
                  <span class="badge">-{{ disc.discount_percent }}%</span>
                {% else %}
                  <strong>${{ s.base_price|floatformat:2 }}</strong>
                {% endif %}
              {% endwith %}
              ¬∑ {{ s.duration_min }} –º–∏–Ω
            </div>
            <button class="btn btn--primary book-btn"
                    data-service-id="{{ s.id }}" data-service-name="{{ s.name }}">
              –í—ã–±—Ä–∞—Ç—å –≤—Ä–µ–º—è
            </button>
          </article>
        {% endfor %}
      </div>
    {% endif %}

    {% if not has_any_services %}
      <div class="stub">–ö–∞—Ç–∞–ª–æ–≥ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω üëç</div>
    {% endif %}
  </main>

  <footer class="site-footer">¬© 2025 Malva Booking</footer>

  <!-- ===== Modal: booking ===== -->
  <div class="modal" id="bookModal" aria-hidden="true">
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="bookTitle">
      <div class="modal__header">
        <div class="modal__title" id="bookTitle">–ó–∞–ø–∏—Å—å –Ω–∞ <span id="bookServiceName"></span></div>
        <button class="modal__close" id="bookClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
      </div>

      <div class="grid-2">
        <div>
          <div class="field">
            <label for="bookDate">–î–∞—Ç–∞</label>
            <input type="date" id="bookDate">
          </div>
          <div class="field" style="margin-top:.5rem">
            <label for="bookMaster">–ú–∞—Å—Ç–µ—Ä</label>
            <select id="bookMaster"></select>
          </div>
          <div class="field" style="margin-top:.5rem">
            <label>–°–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã</label>
            <div class="slots" id="bookSlots">
              <div class="skeleton"></div>
            </div>
            <div class="hint">–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è. –°–ª–æ—Ç—ã —É—á–∏—Ç—ã–≤–∞—é—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Å–ª—É–≥–∏ –∏ –∑–∞–Ω—è—Ç–æ—Å—Ç—å –º–∞—Å—Ç–µ—Ä–∞.</div>
          </div>
        </div>
        <div>
          <div class="field">
            <label>–°–≤–æ–¥–∫–∞</label>
            <div class="muted" id="bookSummary">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É, –º–∞—Å—Ç–µ—Ä–∞ –∏ –≤—Ä–µ–º—è.</div>
          </div>
          <div class="error" id="bookError" style="display:none;"></div>
          <div class="success" id="bookSuccess" style="display:none;"></div>
        </div>
      </div>

      <div class="modal__footer">
        <button class="btn btn--ghost" id="bookCancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn--primary" id="bookSubmit" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const isAuth = {{ user.is_authenticated|yesno:"true,false" }};
      const loginUrl = "{% url 'login' %}?next={{ request.path }}";
      const apiAvail = "/accounts/api/availability/";
      const apiBook = "/accounts/api/book/";

      // helpers
      function getCookie(name){
        const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return m ? m.pop() : '';
      }
      function fmtTime(iso){
        try { return new Date(iso).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
        catch(e){ return iso; }
      }
      function todayStr(){
        const d = new Date();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        return `${d.getFullYear()}-${m}-${day}`;
      }

      // modal elements
      const modal = document.getElementById('bookModal');
      const btnClose = document.getElementById('bookClose');
      const btnCancel = document.getElementById('bookCancel');
      const btnSubmit = document.getElementById('bookSubmit');
      const elServiceName = document.getElementById('bookServiceName');
      const elDate = document.getElementById('bookDate');
      const elMaster = document.getElementById('bookMaster');
      const elSlots = document.getElementById('bookSlots');
      const elSummary = document.getElementById('bookSummary');
      const elError = document.getElementById('bookError');
      const elSuccess = document.getElementById('bookSuccess');

      let current = { serviceId: null, serviceName: '', masterId: null, slot: null, mastersData: [] };

      function openModal(serviceId, serviceName){
        if(!isAuth){ window.location = loginUrl; return; }
        current = { serviceId, serviceName, masterId: null, slot: null, mastersData: [] };
        elServiceName.textContent = serviceName;
        elError.style.display = 'none';
        elSuccess.style.display = 'none';
        btnSubmit.disabled = true;
        elDate.min = todayStr();
        elDate.value = todayStr();
        elMaster.innerHTML = '';
        elSlots.innerHTML = '<div class="skeleton"></div>';
        elSummary.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É, –º–∞—Å—Ç–µ—Ä–∞ –∏ –≤—Ä–µ–º—è.';
        modal.classList.add('modal--open');
        loadAvailability(); // initial
      }
      function closeModal(){
        modal.classList.remove('modal--open');
      }

      async function loadAvailability(){
        elError.style.display = 'none';
        elSlots.innerHTML = '<div class="skeleton"></div>';
        btnSubmit.disabled = true;
        current.slot = null;

        const params = new URLSearchParams({ service: current.serviceId, date: elDate.value });
        try{
          const resp = await fetch(`${apiAvail}?` + params.toString(), { credentials:'same-origin' });
          if(!resp.ok){ throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ—Ç–æ–≤'); }
          const data = await resp.json();
          current.mastersData = data.masters || [];

          // fill masters
          elMaster.innerHTML = '';
          if(current.mastersData.length === 0){
            const opt = document.createElement('option');
            opt.value = ''; opt.textContent = '–ú–∞—Å—Ç–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
            elMaster.appendChild(opt);
            elSlots.innerHTML = '<div class="hint">–ù–µ—Ç –º–∞—Å—Ç–µ—Ä–æ–≤ –¥–ª—è —ç—Ç–æ–π —É—Å–ª—É–≥–∏.</div>';
            return;
          }
          current.mastersData.forEach(m=>{
            const opt = document.createElement('option');
            opt.value = m.id;
            opt.textContent = `${m.name}`;
            elMaster.appendChild(opt);
          });

          // choose default master: –ø–µ—Ä–≤—ã–π —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ —Å–ª–æ—Ç–∞–º–∏, –∏–Ω–∞—á–µ –ø–µ—Ä–≤—ã–π
          const withSlots = current.mastersData.find(m => (m.slots||[]).length);
          elMaster.value = (withSlots ? withSlots.id : current.mastersData[0].id);
          renderSlots();
        }catch(err){
          elError.textContent = err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å';
          elError.style.display = 'block';
          elSlots.innerHTML = '';
        }
      }

      function renderSlots(){
        const mId = Number(elMaster.value);
        current.masterId = mId;
        const m = current.mastersData.find(x => Number(x.id) === mId);
        const slots = (m && m.slots) ? m.slots : [];
        elSlots.innerHTML = '';
        if(slots.length === 0){
          elSlots.innerHTML = '<div class="hint">–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É.</div>';
          btnSubmit.disabled = true;
          elSummary.textContent = '–°–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –Ω–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –¥–∞—Ç—É.';
          return;
        }
        slots.forEach(iso=>{
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'slot';
          b.textContent = fmtTime(iso);
          b.dataset.iso = iso;
          b.addEventListener('click', ()=>{
            [...elSlots.querySelectorAll('.slot')].forEach(x=>x.classList.remove('slot--active'));
            b.classList.add('slot--active');
            current.slot = iso;
            btnSubmit.disabled = false;
            elSummary.textContent = `–ú–∞—Å—Ç–µ—Ä: ${m.name}. –í—Ä–µ–º—è: ${fmtTime(iso)}.`;
          });
          elSlots.appendChild(b);
        });
      }

      async function submitBooking(){
        if(!current.serviceId || !current.masterId || !current.slot) return;
        btnSubmit.disabled = true;
        elError.style.display = 'none';
        elSuccess.style.display = 'none';

        try{
          const resp = await fetch(apiBook, {
            method:'POST',
            headers:{ 'Content-Type':'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            credentials:'same-origin',
            body: JSON.stringify({ service: current.serviceId, master: current.masterId, start_time: current.slot })
          });
          const data = await resp.json().catch(()=> ({}));
          if(!resp.ok){
            const msg = data && (data.error || data.detail) ? (data.error || data.detail) : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å';
            throw new Error(msg);
          }
          elSuccess.textContent = '–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞! ' + (data.appointment?.start_time ? ('–í—Ä–µ–º—è: ' + fmtTime(data.appointment.start_time)) : '');
          elSuccess.style.display = 'block';
          setTimeout(()=>{ window.location.reload(); }, 700);
        }catch(err){
          elError.textContent = err.message || '–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è';
          elError.style.display = 'block';
          btnSubmit.disabled = false;
        }
      }

      // events
      document.addEventListener('click', (e)=>{
        const btn = e.target.closest('.book-btn');
        if(btn){
          const id = btn.dataset.serviceId;
          const name = btn.dataset.serviceName || '—É—Å–ª—É–≥—É';
          openModal(id, name);
        }
      });
      btnClose.addEventListener('click', closeModal);
      btnCancel.addEventListener('click', closeModal);
      modal.addEventListener('click', (e)=> { if(e.target === modal) closeModal(); });
      elDate.addEventListener('change', loadAvailability);
      elMaster.addEventListener('change', renderSlots);
      btnSubmit.addEventListener('click', submitBooking);
    })();
  </script>
</body>
</html>
