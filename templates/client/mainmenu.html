{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bad Guy Motors ‚Äî Upgrades & Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  {% with meta_title="Bad Guy Motors ‚Äî Upgrades & Booking" meta_description="Browse detailing, protection, and performance services with live pricing from Bad Guy Motors." meta_section="services" %}
    {% include "includes/marketing_head.html" %}
  {% endwith %}

  <!-- Fonts -->
  <link rel="preload" href="{% static 'fonts/Diesel.ttf' %}" as="font" type="font/ttf" crossorigin>
  <link rel="preload" href="{% static 'fonts/Ford.ttf' %}"   as="font" type="font/ttf" crossorigin>

  <style>
    /* ========================= VARIABLES & FONTS ========================= */
    :root{
      --bg:#0a0a0a; --fg:#eaeaea; --muted:#bdbdbd; --muted-2:rgba(255,255,255,.72);
      --panel:#0E0E0E; --panel-2:#131313; --line:rgba(255,255,255,.12);
      --accent:#d50000; --accent-2:#ff1a1a; --ok:#17d45b;
      --card-bg:rgba(18,18,18,.9); --card-border:rgba(255,255,255,.1);
      --field-bg:rgba(255,255,255,.06);
      --radius-lg:1.25rem; --radius-md:.9rem; --radius-sm:.6rem; --shadow:0 10px 30px rgba(0,0,0,.45);
      --container:clamp(320px,92vw,1280px);
      --site-header-height:72px; --site-header-toggle-size:46px;

      --font-body:"Diesel", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      --font-head:"Ford",  ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }

    @font-face{
      font-family:"Diesel";
      src:url("{% static 'fonts/Diesel.ttf' %}") format("truetype");
      font-weight:100 900; font-style:normal; font-display:swap;
    }
    @font-face{
      font-family:"Ford";
      src:url("{% static 'fonts/Ford.ttf' %}") format("truetype");
      font-weight:100 900; font-style:normal; font-display:swap;
    }

    /* =============================== RESET =============================== */
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html{ text-rendering:optimizeLegibility; -webkit-font-smoothing:antialiased; }
    body{ background:var(--bg); color:var(--fg); font-family:var(--font-body); line-height:1.55; min-height:100dvh; overflow-x:hidden; }
    a{ color:inherit; text-decoration:none; }
    img{ max-width:100%; display:block; }
    .container{ width:var(--container); margin-inline:auto; padding-inline:1rem; }
    .visually-hidden{ position:absolute!important; width:1px; height:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }

    /* ============================== BUTTONS ============================== */
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:.6em;
      padding:.78rem 1.15rem; border-radius:var(--radius-sm); border:1px solid transparent;
      font-weight:800; letter-spacing:.02em; cursor:pointer; transition:.2s; line-height:1.1; min-height:44px;
      font-family:var(--font-body);
    }
    .btn--primary{ background:linear-gradient(180deg, var(--accent) 0%, #b60000 100%); color:#fff; border-color:rgba(255,255,255,.08); box-shadow:0 0 24px rgba(213,0,0,.25); }
    .btn--primary:hover{ transform:translateY(-1px); filter:brightness(1.02); }
    .btn--ghost{ background:transparent; color:var(--fg); border-color:var(--line); }
    .btn--ghost:hover{ box-shadow:0 0 18px rgba(213,0,0,.28); transform:translateY(-1px); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }
    .badge{ display:inline-block; font-size:.78rem; padding:.15rem .55rem; border-radius:999px; background:var(--accent); color:#fff; }

    /* =============================== HEADER ============================== */
    .site-header{
      position:sticky; top:0; z-index:3200;
      background:#000; border-bottom:1px solid var(--line);
    }
    .site-header__inner{
      display:flex; align-items:center; justify-content:space-between; gap:1.25rem; padding:.7rem 0;
    }

    .brand{ display:flex; align-items:baseline; gap:.9rem; min-width:max-content; font-weight:900; letter-spacing:.06em; text-transform:uppercase; }
    .site-header .brand__logo{ all:unset; display:inline-flex; gap:.5rem; line-height:1; font-weight:900; letter-spacing:.06em; font-size:clamp(1.2rem,1.8vw,1.55rem); }
    .brand__word--white{ color:#fff; } .brand__word--red{ color:var(--accent); }
    .brand__tagline{ margin-left:1.1rem; white-space:nowrap; font-size:.82rem; font-weight:900; letter-spacing:.14em; color:rgba(255,255,255,.78); font-family:var(--font-body); }
    @media (max-width:1200px){ .brand__tagline{ display:none; } }

    /* Inline nav (desktop) */
    nav ul{ display:flex; align-items:center; gap:1.6rem; list-style:none; }
    nav a{ line-height:1; font-weight:700; letter-spacing:.02em; font-size:.9rem; text-transform:none; color:rgba(255,255,255,.92); }
    nav a:hover, nav a[aria-current="page"]{ color:#fff; }
    /* make button-like links look like plain text in header */
    nav .btn, nav .btn--ghost{ padding:0; border:0; background:none; }

    /* Mobile toggle */
    .site-header__toggle{
      display:none; align-items:center; justify-content:center;
      width:var(--site-header-toggle-size); height:var(--site-header-toggle-size);
      border-radius:.85rem; border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06); color:#fff; cursor:pointer; transition:.18s;
    }
    .site-header__toggle:hover{ background:rgba(255,255,255,.12); border-color:rgba(255,255,255,.28); }
    .site-header__toggle:focus-visible{ outline:2px solid #fff; outline-offset:3px; }
    .site-header__toggle-box{ position:relative; width:20px; height:14px; display:block; }
    .site-header__toggle-lines,
    .site-header__toggle-lines::before,
    .site-header__toggle-lines::after{
      content:""; position:absolute; left:0; width:100%; height:2px; border-radius:999px; background:currentColor; transition:transform .22s, opacity .22s, background .22s;
    }
    .site-header__toggle-lines{ top:50%; transform:translateY(-50%); }
    .site-header__toggle-lines::before{ top:-6px; }
    .site-header__toggle-lines::after{ top:6px; }
    .site-header--open .site-header__toggle{ background:rgba(255,255,255,.16); border-color:rgba(255,255,255,.38); }
    .site-header--open .site-header__toggle-lines{ background:transparent; }
    .site-header--open .site-header__toggle-lines::before{ transform:translateY(6px) rotate(45deg); }
    .site-header--open .site-header__toggle-lines::after{ transform:translateY(-6px) rotate(-45deg); }

    /* Mobile nav overlay (robust, matches Merch) */
    @media (max-width:960px){
      body.nav-open{ overflow:hidden; }

      .site-header{ --site-header-height:max(62px, 10vh); }
      .site-header .container{ padding-inline:clamp(16px, 4vw, 24px); }
      .site-header__inner{ display:grid; grid-template-columns:auto max-content; align-items:center; gap:clamp(12px, 3vw, 24px); }
      .site-header__toggle{ display:inline-flex; }

      nav{
        position:fixed; inset:0;
        padding-top:calc(var(--site-header-height) + 1rem + env(safe-area-inset-top));
        padding-inline:clamp(20px, 6vw, 36px);
        padding-bottom:max(28px, env(safe-area-inset-bottom));
        background:rgba(5,5,5,.92); backdrop-filter:blur(18px) saturate(1.2);
        display:flex; align-items:flex-start;
        opacity:0; pointer-events:none; transform:translateY(-12px);
        transition:opacity .22s ease, transform .22s ease;
        z-index:3300; height:100dvh; overflow-y:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain;
      }
      nav ul{ flex-direction:column; align-items:stretch; gap:1.15rem; width:100%; }
      nav li{ width:100%; }
      nav a, nav .btn, nav .btn--ghost{
        width:100%; justify-content:space-between;
        background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.16); border-radius:1rem;
        padding:1.15rem 1.2rem; font-size:1.05rem; letter-spacing:.035em; min-height:56px;
        box-shadow:0 8px 24px rgba(0,0,0,.22);
      }
      nav a:hover, nav a[aria-current="page"], nav .btn:hover{
        background:rgba(255,255,255,.1); border-color:rgba(255,255,255,.22); color:#fff;
      }
      /* open in all supported states */
      .site-header--open nav,
      body.nav-open nav,
      .site-header .site-header__toggle[aria-expanded="true"] ~ nav{
        opacity:1; pointer-events:auto; transform:translateY(0);
      }
      /* keep FAB out of the way */
      body.nav-open .contact-fab, .site-header--open ~ .contact-fab{ display:none !important; }
    }

    /* ================================ HERO ================================ */
    .hero{
      position:relative; z-index:2; text-align:center;
      padding:5rem 1rem 3rem;
      background:radial-gradient(60% 120% at 82% -10%, rgba(213,0,0,.18) 0%, rgba(213,0,0,0) 60%),
                 radial-gradient(60% 120% at 12% 110%, rgba(255,255,255,.06) 0%, rgba(255,255,255,0) 60%);
      border-bottom:1px solid var(--line);
    }
    .hero h1{ font-family:var(--font-head); font-weight:900; font-size:clamp(2.1rem,4.5vw,3.3rem); line-height:1.15; letter-spacing:.01em; text-transform:none; color:#fff; }
    .hero p{ font-size:1.05rem; max-width:60ch; margin-inline:auto; color:var(--muted); }
    .hero .cta{ margin-top:.6rem; }

    /* ============================= CATALOG ============================= */
    main{ position:relative; z-index:2; }
    h2{ font-family:var(--font-head); font-weight:900; font-size:clamp(1.9rem, 2.6vw, 2.2rem); line-height:1.2; letter-spacing:.01em; color:#fff; margin-bottom:1.25rem; }
    .filters{ display:flex; flex-wrap:wrap; gap:.75rem; margin:1.25rem 0 1.75rem; }
    .filters input,.filters select{ padding:.65rem 1rem; border:1px solid var(--line); border-radius:var(--radius-sm); font-size:.95rem; min-width:170px; background:var(--field-bg); color:var(--fg); }
    .filters ::placeholder{ color:var(--muted); }

    .services-grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(260px,1fr)); gap:1.1rem; }
    .service-card{
      background:linear-gradient(160deg, var(--card-bg), rgba(19,19,19,.9));
      border-radius:var(--radius-lg); padding:1rem; display:flex; flex-direction:column; gap:.75rem;
      border:1px solid var(--card-border); box-shadow:var(--shadow);
      transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease; cursor:pointer;
    }
    .service-card:hover{ transform:translateY(-3px); border-color:rgba(213,0,0,.28); box-shadow:0 14px 36px rgba(0,0,0,.5), 0 0 24px rgba(213,0,0,.18); }
    .service-card:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; }

    .service-card__img{ position:relative; aspect-ratio:16/9; border:1px solid var(--line); border-radius:.9rem; overflow:hidden; background:linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); }
    .service-card__img img{ width:100%; height:100%; object-fit:cover; }
    .service-card__badge{
      position:absolute; left:.6rem; bottom:.6rem; z-index:2;
      font-size:.72rem; background:rgba(0,0,0,.55); color:#fff; border-radius:999px; padding:.18rem .55rem; border:1px solid rgba(255,255,255,.14); backdrop-filter: blur(4px) saturate(1.2);
    }

    .service-card h3{ font-family:var(--font-body); font-weight:900; font-size:1.08rem; letter-spacing:.01em; color:#fff; }
    .service-meta{ font-size:.92rem; color:var(--muted); }
    .muted{ color:var(--muted); }
    .old{ color:rgba(255,255,255,.45); text-decoration:line-through; }

    /* skeleton */
    .skeleton{ background:linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.12), rgba(255,255,255,.06)); background-size:200% 100%; animation:sh 1.1s ease-in-out infinite; border-radius:.5rem; height:36px; }
    .ph{ width:100%; height:100%; background:linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.12), rgba(255,255,255,.06)); background-size:200% 100%; animation:sh 1.1s ease-in-out infinite; }
    @keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}
    @media (prefers-reduced-motion:reduce){ .skeleton,.ph{ animation:none; } }

    /* =============================== MODAL =============================== */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.72); display:none; align-items:center; justify-content:center; padding:1rem; z-index:4000; overscroll-behavior:contain; }
    .modal--open{ display:flex; }
    .modal__dialog{ background:linear-gradient(180deg,#0c0c0c,#121212); color:var(--fg); border-radius:1rem; box-shadow:0 14px 36px rgba(0,0,0,.75), 0 0 32px rgba(213,0,0,.18); width:min(940px,calc(100dvw - 2rem)); max-height:calc(100dvh - 2rem); border:1px solid var(--line); padding:1.2rem 1.25rem 1rem; display:flex; flex-direction:column; overflow:hidden; }
    .modal__header{ display:flex; justify-content:space-between; align-items:center; gap:.5rem; margin-bottom:1rem; }
    .modal__title{ font-family:var(--font-body); font-weight:900; font-size:1.35rem; line-height:1.2; letter-spacing:.04em; }
    .modal__title span{ color:var(--accent); }
    .modal__close{ background:transparent; border:1px solid var(--line); color:var(--muted); border-radius:.5rem; width:36px; height:36px; cursor:pointer; font-size:1.2rem; }
    .grid-2{ display:grid; grid-template-columns:minmax(0,1.2fr) minmax(0,.8fr); gap:1rem; flex:1 1 auto; min-height:0; }
    .grid-2>div{ min-height:0; }
    @media (max-width:900px){ .grid-2{ grid-template-columns:1fr; } }

    .field{ display:flex; flex-direction:column; gap:.35rem; }
    .field label{ font-size:.9rem; color:var(--muted); }
    .field input,.field select{ padding:.6rem .8rem; border:1px solid var(--line); border-radius:.6rem; font-size:.95rem; background:#0a0a0a; color:var(--fg); }
    .modal__footer{ display:flex; justify-content:flex-end; gap:.5rem; margin-top:1rem; }
    .hint{ font-size:.85rem; color:var(--muted); }
    .error{ color:#ff5c72; font-size:.9rem; margin-top:.5rem; }
    .success{ color:var(--ok); font-size:.95rem; margin-top:.5rem; }

    /* booking outlook */
    .outlook{ display:flex; flex-direction:column; min-height:0; border:1px solid var(--line); border-radius:var(--radius-md); background:#0a0a0a; margin-top:.45rem; }
    .outlook__toolbar{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:.55rem .75rem; border-bottom:1px solid var(--line); background:#0c0c0c; }
    .outlook__toolbar .controls{ display:flex; gap:.4rem; }
    .outlook__toolbar .range{ font-weight:900; letter-spacing:.4px; }
    .outlook__toolbar button{ border:1px solid var(--line); background:#111; border-radius:.5rem; padding:.35rem .65rem; cursor:pointer; line-height:1; font-weight:800; color:var(--fg); }
    .outlook__wrap{ flex:1 1 auto; overflow:auto; max-height:56vh; min-height:300px; padding-bottom:10px; -webkit-overflow-scrolling:touch; scrollbar-gutter:stable both-edges; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)); }
    .outlook__grid{ display:grid; min-width:calc(96px + (var(--days,14) * 160px) + 1px); grid-auto-rows:minmax(36px, auto); grid-template-columns:96px repeat(var(--days, 14), 160px); }
    .outlook__cell{ border-bottom:1px solid var(--line); border-right:1px solid var(--line); padding:.25rem .4rem; background:#0a0a0a; white-space:nowrap; text-overflow:ellipsis; color:var(--fg); }
    .outlook__cell.time{ position:sticky; left:0; background:#0c0c0c; z-index:2; font-size:.85rem; color:var(--muted); }
    .outlook__head{ position:sticky; top:0; background:#0c0c0c; z-index:3; border-bottom:2px solid var(--line); box-shadow:0 1px 0 rgba(255,255,255,.04); padding:.45rem .5rem; }
    .day-head{ display:flex; flex-direction:column; }
    .day-title{ font:900 .95rem/1.1 var(--font-body); text-transform:capitalize; letter-spacing:.3px; }
    .day-sub{ font-size:.78rem; color:var(--muted); margin-top:.15rem; }
    .day--today{ background:linear-gradient(180deg, rgba(213,0,0,.08), rgba(213,0,0,0)); }
    .slot-chip{ display:inline-flex; align-items:center; justify-content:center; height:1.7rem; min-width:3.6rem; padding:0 .5rem; border-radius:.5rem; border:1.6px solid transparent; font-weight:900; font-size:.9rem; user-select:none; line-height:1; }
    .slot-free{ color:#fff; border-color:rgba(255,255,255,.22); background:#131313; cursor:pointer; }
    .slot-free:hover{ border-color:rgba(213,0,0,.55); box-shadow:0 0 16px rgba(213,0,0,.25); }
    .slot-busy{ color:#fff; background:var(--accent); opacity:.9; }
    .slot-selected{ background:var(--accent)!important; color:#fff; border-color:var(--accent)!important; box-shadow:0 0 0 2px rgba(213,0,0,.35); }

    /* =============================== FOOTER ============================== */
    .site-footer{ position:relative; z-index:2; text-align:center; font-size:.9rem; color:var(--muted); padding:2rem 1rem; border-top:1px solid var(--line); background:rgba(0,0,0,.6); }

    /* ============================= SMOKE LAYER =========================== */
    #bg{ position:fixed; inset:0; z-index:0; pointer-events:none; }
    #bg canvas{ position:absolute; inset:0; width:100%; height:100%; display:block; pointer-events:none; }
    .site-header, .hero, main, .site-footer{ position:relative; z-index:1; }

    /* ============================= CONTACT FAB =========================== */
    :root{ --ink:#eaeaea; --red-dark:#b60000; }
    .contact-fab{
      position:fixed; right:22px; bottom:22px; z-index:2100; display:inline-flex; align-items:center; gap:.6em;
      padding:.9rem 1.15rem; border-radius:999px; border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg,var(--accent) 0%,var(--red-dark) 100%); color:#fff; font-weight:900; letter-spacing:.02em; line-height:1;
      cursor:pointer; box-shadow:0 12px 26px rgba(213,0,0,.28), 0 0 26px rgba(213,0,0,.18); transition:.18s; font-family:var(--font-body);
    }
    .contact-fab:hover{ transform:translateY(-2px); filter:saturate(1.05); }
    .contact-fab:focus-visible{ outline:2px solid #fff; outline-offset:3px; }
    .contact-fab svg{ width:20px; height:20px; fill:currentColor; opacity:.95; }

    .contact-modal{ position:fixed; inset:0; z-index:2200; display:none; align-items:center; justify-content:center; padding:1rem; background:rgba(0,0,0,.65); backdrop-filter:blur(2px); }
    .contact-modal[open]{ display:flex; }
    .contact-dialog{ width:min(560px, 92vw); background:linear-gradient(180deg,#0c0c0c,#121212); border:1px solid var(--line); border-radius:1rem; padding:1.1rem 1.1rem .95rem; color:var(--ink); box-shadow:0 18px 44px rgba(0,0,0,.55), 0 0 32px rgba(213,0,0,.18); position:relative; }
    .contact-title{ font-family:var(--font-head); font-weight:900; letter-spacing:.005em; line-height:1.15; font-size:1.6rem; margin:.2rem 2.2rem 1rem .2rem; color:#fff; }
    .contact-close{ position:absolute; right:12px; top:10px; width:36px; height:36px; border:1px solid var(--line); border-radius:.5rem; background:#0f0f0f; color:#bdbdbd; cursor:pointer; font-size:20px; line-height:1; }
    .contact-body{ display:grid; gap:.75rem; }
    .contact-row{ display:flex; align-items:center; justify-content:space-between; gap:.6rem; background:rgba(255,255,255,.06); border:1px solid var(--line); border-radius:.7rem; padding:.7rem .8rem; font-family:var(--font-body); }
    .contact-row a{ color:#fff; font-weight:800; text-decoration:none; }
    .contact-sub{ color:rgba(255,255,255,.72); font-size:.95rem; }
    .contact-actions{ display:flex; gap:.6rem; margin-top:.9rem; flex-wrap:wrap; }
    .contact-btn{ display:inline-flex; align-items:center; gap:.5em; padding:.7rem 1rem; border-radius:.55rem; border:1px solid var(--line); background:#0f0f0f; color:#fff; cursor:pointer; font-family:var(--font-body); font-weight:800; }
    .contact-btn:hover{ border-color:rgba(213,0,0,.45); box-shadow:0 0 16px rgba(213,0,0,.25); }
    body.no-contact-fab .contact-fab{ display:none !important; }
    @media (max-width:640px){ .contact-fab{ right:14px; bottom:14px; } .contact-title{ font-size:1.45rem; } }
  </style>
</head>

<body>
  {% include "includes/marketing_body.html" %}

  <!-- Smoke -->
  <div id="bg"></div>

  <a href="#services" class="visually-hidden">Skip to main content</a>

  <!-- ============================== HEADER ============================== -->
  <header class="site-header" role="banner">
    <div class="container site-header__inner">
      <a class="brand" href="{% url 'home' %}">
        <span class="brand__logo">
          <span class="brand__word brand__word--white">BAD GUY</span>
          <span class="brand__word brand__word--red">MOTORS</span>
        </span>
        <span class="brand__tagline">CUSTOM BUILDS ‚Ä¢ INSTALLS ‚Ä¢ UPGRADES</span>
      </a>

      <button class="site-header__toggle" type="button" aria-expanded="false" aria-controls="siteNav">
        <span class="site-header__toggle-box" aria-hidden="true">
          <span class="site-header__toggle-lines"></span>
        </span>
        <span class="visually-hidden">Toggle navigation</span>
      </button>

      <nav id="siteNav" aria-label="Main navigation">
        <ul>
          <li><a href="{% url 'client-dashboard' %}" title="Services catalog">Services</a></li>
          {% if user.is_authenticated %}
            <li><a href="{% url 'dashboard' %}">Client Portal</a></li>
          {% else %}
            <li><a href="{% url 'login' %}?next={% url 'dashboard' %}" class="btn btn--ghost">Login</a></li>
          {% endif %}
          <li><a href="{% url 'store' %}">Products</a></li>
          <li><a href="{% url 'merch' %}">Merch <span class="badge">Soon</span></a></li>
          <li><a href="{% url 'dealer-status' %}">Dealers</a></li>
          <li><a href="{% url 'financing' %}">Financing</a></li>
          <li><a href="{% url 'our-story' %}">About</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- ================================ HERO =============================== -->
  <section class="hero">
    <h1>Built to be bad. Engineered to last.</h1>
    <p>Book custom fabrication, diesel performance, coatings, body swaps and more ‚Äî bumpers, headache & chase racks, mudflaps, running boards, fender flares, lift kits & 4‚Äëlinks, tuning, and installs.</p>
    <div class="cta"><a href="#services" class="btn btn--primary">Browse services ‚Üì</a></div>
  </section>

  <!-- =============================== MAIN =============================== -->
  <main id="services" class="container" style="padding-block:3rem;">
    <h2>Upgrades & Services</h2>

    <!-- Filters -->
    <form method="get" class="filters" role="search">
      <input type="search" name="q" placeholder="Search a service‚Ä¶" value="{{ q|default:'' }}">
      <select name="cat">
        <option value="">All categories</option>
        {% for c in filter_categories %}
          <option value="{{ c.id }}" {% if active_category == c.id|stringformat:'s' %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
      <button class="btn btn--primary" type="submit">Search</button>
      {% if q or active_category %}
        <a class="btn btn--ghost" href="{% url 'client-dashboard' %}#services">Reset</a>
      {% endif %}
    </form>

    <!-- Live results (JS) -->
    <h3 id="liveTitle" style="margin:.5rem 0 1rem; display:none;">Search results</h3>
    <div id="liveGrid" class="services-grid" style="display:none;"></div>

    <!-- Server-rendered content -->
    <div id="serverContent">
      {% if search_results %}
        <h3 style="margin:.5rem 0 1rem;">Search results</h3>
        <div class="services-grid">
          {% for s in search_results %}
            <article class="service-card" data-service-id="{{ s.id }}" data-service-name="{{ s.name }}" tabindex="0" role="button" aria-label="Book {{ s.name }}">
              <div class="service-card__img" aria-label="Service image">
                {% if s.image %}<img src="{{ s.image.url }}" alt="{{ s.name }}" loading="lazy" decoding="async">{% else %}<div class="ph" aria-hidden="true">BGM ‚Ä¢ SERVICE</div>{% endif %}
                {% if s.category %}<span class="service-card__badge">{{ s.category.name }}</span>{% endif %}
              </div>
              <div class="muted">{{ s.category.name }}</div>
              <h3>{{ s.name }}</h3>
              {% if s.description %}<p class="muted">{{ s.description|truncatewords:22 }}</p>{% endif %}
              <div class="service-meta">
                {% if s.contact_for_estimate %}
                  <strong>Contact for estimate</strong>
                  {% if s.estimate_from_price %}<span class="price__hint">From ${{ s.estimate_from_price|floatformat:2 }}</span>{% endif %}
                {% else %}
                  {% with disc=s.get_active_discount %}
                    {% if disc %}
                      <span class="old">${{ s.base_price|floatformat:2 }}</span>
                      <strong>${{ s.get_discounted_price|floatformat:2 }}</strong>
                      <span class="badge">-{{ disc.discount_percent }}%</span>
                    {% else %}
                      <strong>${{ s.base_price|floatformat:2 }}</strong>
                    {% endif %}
                  {% endwith %}
                {% endif %}
                ¬∑ {{ s.duration_min }} min
              </div>
              <button class="btn btn--primary book-btn" type="button" data-service-id="{{ s.id }}" data-service-name="{{ s.name }}">Pick a time</button>
            </article>
          {% empty %}
            <div class="muted" style="padding:1rem;border:1px dashed var(--line);border-radius:.6rem;background:rgba(255,255,255,.02)">No results for ‚Äú{{ q }}‚Äù.</div>
          {% endfor %}
        </div>
        <hr style="margin:2rem 0;border:none;border-top:1px solid var(--line)">
      {% endif %}

      {% for c in categories %}
        <h3 style="margin:1.5rem 0 .75rem; font:900 1.25rem/1 var(--font-body); letter-spacing:.5px;">{{ c.name }}</h3>
        <div class="services-grid">
          {% for s in c.service_set.all %}
            <article class="service-card" data-service-id="{{ s.id }}" data-service-name="{{ s.name }}" tabindex="0" role="button" aria-label="Book {{ s.name }}">
              <div class="service-card__img" aria-label="Service image">
                {% if s.image %}<img src="{{ s.image.url }}" alt="{{ s.name }}" loading="lazy" decoding="async">{% else %}<div class="ph" aria-hidden="true">BGM ‚Ä¢ SERVICE</div>{% endif %}
                <span class="service-card__badge">{{ c.name }}</span>
              </div>
              <h3>{{ s.name }}</h3>
              {% if s.description %}<p class="muted">{{ s.description|truncatewords:22 }}</p>{% endif %}
              <div class="service-meta">
                {% if s.contact_for_estimate %}
                  <strong>Contact for estimate</strong>
                  {% if s.estimate_from_price %}<span class="price__hint">From ${{ s.estimate_from_price|floatformat:2 }}</span>{% endif %}
                {% else %}
                  {% with disc=s.get_active_discount %}
                    {% if disc %}
                      <span class="old">${{ s.base_price|floatformat:2 }}</span>
                      <strong>${{ s.get_discounted_price|floatformat:2 }}</strong>
                      <span class="badge">-{{ disc.discount_percent }}%</span>
                    {% else %}
                      <strong>${{ s.base_price|floatformat:2 }}</strong>
                    {% endif %}
                  {% endwith %}
                {% endif %}
                ¬∑ {{ s.duration_min }} min
              </div>
              <button class="btn btn--primary book-btn" type="button" data-service-id="{{ s.id }}" data-service-name="{{ s.name }}">Pick a time</button>
            </article>
          {% empty %}
            <div class="muted" style="padding:1rem;border:1px dashed var(--line);border-radius:.6rem;background:rgba(255,255,255,.02)">No services in this category yet.</div>
          {% endfor %}
        </div>
      {% endfor %}

      {% if uncategorized %}
        <h3 style="margin:1.5rem 0 .75rem; font:900 1.25rem/1 var(--font-body); letter-spacing:.5px">Uncategorized</h3>
        <div class="services-grid">
          {% for s in uncategorized %}
            <article class="service-card" data-service-id="{{ s.id }}" data-service-name="{{ s.name }}" tabindex="0" role="button" aria-label="Book {{ s.name }}">
              <div class="service-card__img" aria-label="Service image">
                {% if s.image %}<img src="{{ s.image.url }}" alt="{{ s.name }}" loading="lazy" decoding="async">{% else %}<div class="ph" aria-hidden="true">BGM ‚Ä¢ SERVICE</div>{% endif %}
              </div>
              <h3>{{ s.name }}</h3>
              {% if s.description %}<p class="muted">{{ s.description|truncatewords:22 }}</p>{% endif %}
              <div class="service-meta">
                {% if s.contact_for_estimate %}
                  <strong>Contact for estimate</strong>
                  {% if s.estimate_from_price %}<span class="price__hint">From ${{ s.estimate_from_price|floatformat:2 }}</span>{% endif %}
                {% else %}
                  {% with disc=s.get_active_discount %}
                    {% if disc %}
                      <span class="old">${{ s.base_price|floatformat:2 }}</span>
                      <strong>${{ s.get_discounted_price|floatformat:2 }}</strong>
                      <span class="badge">-{{ disc.discount_percent }}%</span>
                    {% else %}
                      <strong>${{ s.base_price|floatformat:2 }}</strong>
                    {% endif %}
                  {% endwith %}
                {% endif %}
                ¬∑ {{ s.duration_min }} min
              </div>
              <button class="btn btn--primary book-btn" type="button" data-service-id="{{ s.id }}" data-service-name="{{ s.name }}">Pick a time</button>
            </article>
          {% endfor %}
        </div>
      {% endif %}

      {% if not has_any_services %}
        <div class="muted" style="padding:1rem;border:1px dashed var(--line);border-radius:.6rem;background:rgba(255,255,255,.02)">The catalog will be available soon üëç</div>
      {% endif %}
    </div>
  </main>

  <footer class="site-footer">
    {{ now|date:"Y" }} ¬© 2025 Bad Guy Motors ‚Ä¢ 620 Porcelain Ave SE, Medicine Hat, AB T1A 0C2 ‚Ä¢
  </footer>

  <!-- =============================== MODAL =============================== -->
  <div class="modal" id="bookModal" aria-hidden="true">
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="bookTitle">
      <div class="modal__header">
        <div class="modal__title" id="bookTitle">Booking for <span id="bookServiceName"></span></div>
        <button class="modal__close" id="bookClose" aria-label="Close">√ó</button>
      </div>

      <div class="grid-2">
        <div>
          <div class="field">
            <label for="bookMaster">Staff</label>
            <select id="bookMaster" class="visually-hidden" aria-hidden="true"></select>
            <div id="masterPicker" class="masters" role="listbox" aria-label="Pick a staff member"></div>
          </div>

          <div class="field" style="margin-top:.5rem">
            <label>Choose time</label>

            <div class="outlook" id="ol">
              <div class="outlook__toolbar">
                <div class="controls">
                  <button id="olPrev" type="button">‚Üê Prev</button>
                  <button id="olToday" type="button">Today</button>
                  <button id="olNext" type="button">Next ‚Üí</button>
                </div>
                <div class="range" id="olRange">‚Äî</div>
              </div>
              <div class="outlook__wrap" id="olWrap">
                <div class="outlook__grid" id="olGrid" tabindex="0" aria-live="polite"></div>
              </div>
            </div>

            <div class="hint" style="margin-top:.5rem">Shift + scroll for horizontal scroll. Red = busy (unclickable).</div>
          </div>
        </div>

        <div>
          <div class="field">
            <label>Summary</label>
            <div class="muted" id="bookSummary">Pick a staff member and time.</div>
          </div>
          <div class="field" style="margin-top:1rem;">
            <label for="contactName">Full name*</label>
            <input id="contactName" name="contact_name" type="text" maxlength="120" autocomplete="name" required placeholder="John Doe">
          </div>
          <div class="field">
            <label for="contactEmail">Email*</label>
            <input id="contactEmail" name="contact_email" type="email" autocomplete="email" required placeholder="you@example.com">
          </div>
          <div class="field">
            <label for="contactPhone">Phone*</label>
            <input id="contactPhone" name="contact_phone" type="tel" autocomplete="tel" inputmode="tel"
                   pattern="\+?\d{10,15}" title="Use digits only, optionally starting with +"
                   required placeholder="+1 5551234567">
          </div>
          <p class="hint">No account needed ‚Äî we confirm bookings by email and phone.</p>
          <div class="error" id="bookError" style="display:none;"></div>
          <div class="success" id="bookSuccess" style="display:none;"></div>
        </div>
      </div>

      <div class="modal__footer">
        <button class="btn btn--ghost" id="bookCancel">Cancel</button>
        <button class="btn btn--primary" id="bookSubmit" disabled>Confirm booking</button>
      </div>
    </div>
  </div>

  <!-- Smoke -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script src="{% static 'admin/js/bgm-smoke.js' %}"></script>

  <!-- Booking / search logic (unchanged functional code) -->
  {{ contact_prefill|json_script:"contactPrefillData" }}
  <script>
  /* === booking + live search (kept as in your version; trimmed only for hygiene) === */
  (function(){
    const contactPrefillEl = document.getElementById('contactPrefillData');
    const contactPrefill = contactPrefillEl ? JSON.parse(contactPrefillEl.textContent) : {name:'', email:'', phone:''};
    const contactDraft = {...contactPrefill};
    const LOCALE = 'en-US';

    const apiAvail= "/accounts/api/availability/";
    const apiBook = "/accounts/api/book/";
    function getCookie(name){ const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m?m.pop():''; }
    function ymd(d){ const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}-${m}-${day}`; }
    function parseISO(iso){ try{return new Date(iso);}catch(_){return null;} }
    function fmtHM(d){ return d.toLocaleTimeString(LOCALE, {hour:'numeric', minute:'2-digit'}); }

    const modal=document.getElementById('bookModal');
    const btnClose=document.getElementById('bookClose');
    const btnCancel=document.getElementById('bookCancel');
    const btnSubmit=document.getElementById('bookSubmit');
    const elServiceName=document.getElementById('bookServiceName');
    const elMaster=document.getElementById('bookMaster');
    const elMasterPicker=document.getElementById('masterPicker');
    const elSummary=document.getElementById('bookSummary');
    const elError=document.getElementById('bookError');
    const elSuccess=document.getElementById('bookSuccess');
    const contactInputs = {
      name: document.getElementById('contactName'),
      email: document.getElementById('contactEmail'),
      phone: document.getElementById('contactPhone'),
    };

    const olGrid=document.getElementById('olGrid');
    const olWrap=document.getElementById('olWrap');
    const olRange=document.getElementById('olRange');
    const olPrev=document.getElementById('olPrev');
    const olNext=document.getElementById('olNext');
    const olToday=document.getElementById('olToday');

    const WINDOW_DAYS = 14, START_HOUR=6, END_HOUR=23, STEP_MIN=30;
    let current={ serviceId:null, serviceName:'', masterId:null, slot:null, mastersData:[] };
    let baseStart = new Date(); baseStart.setHours(0,0,0,0);
    let availabilityCache = new Map();

    function hydrateContactForm(){ Object.entries(contactInputs).forEach(([k,i])=>{ i.value = contactDraft[k] || ""; }); }
    function getContactPayload(){ return { name: contactInputs.name.value.trim(), email: contactInputs.email.value.trim(), phone: contactInputs.phone.value.trim() }; }
    function contactIsComplete(){ const c=getContactPayload(); return Boolean(c.name && c.email && c.phone); }
    function updateSubmitState(){ const ready=current.serviceId&&current.masterId&&current.slot&&contactIsComplete(); btnSubmit.disabled=!ready; }
    Object.values(contactInputs).forEach(i=>i.addEventListener('input',()=>{ Object.assign(contactDraft,getContactPayload()); elError.style.display='none'; updateSubmitState(); }));
    hydrateContactForm(); updateSubmitState();

    function openModal(serviceId, serviceName){
      current={ serviceId, serviceName, masterId:null, slot:null, mastersData:[] };
      elServiceName.textContent=serviceName;
      elError.style.display='none'; elSuccess.style.display='none';
      elSummary.textContent='Pick a staff member and time.';
      availabilityCache.clear();
      baseStart = new Date(); baseStart.setHours(0,0,0,0);
      hydrateContactForm(); updateSubmitState();
      modal.classList.add('modal--open');
      loadMastersAndRender();
    }

    async function fetchAvailability(dayISO, masterId){
      const params = new URLSearchParams({ service: current.serviceId, date: dayISO });
      if (masterId) params.set('master', masterId);
      const r = await fetch(`${apiAvail}?${params.toString()}`, {credentials:'same-origin'});
      if(!r.ok) throw new Error('Failed to load available slots');
      const data = await r.json();

      let slots = [];
      if (masterId){
        const m = (data.masters||[]).find(x => Number(x.id)===Number(masterId));
        slots = m ? (m.slots||[]) : [];
      }else{
        slots = (data.masters && data.masters[0] && data.masters[0].slots) ? data.masters[0].slots : [];
      }
      const set=new Set(), map=new Map();
      slots.forEach(iso=>{ const d=parseISO(iso); if(!d) return; const key=`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; set.add(key); if(!map.has(key)) map.set(key, iso); });
      return {set, map, raw:data};
    }

    async function ensureRangeLoaded(startDate, daysCount){
      const tasks=[];
      for(let i=0;i<daysCount;i++){
        const d=new Date(startDate); d.setDate(d.getDate()+i); const ds=ymd(d);
        if(!availabilityCache.has(ds)){
          tasks.push((async()=>{ availabilityCache.set(ds,{loading:true}); const res=await fetchAvailability(ds, Number(elMaster.value||current.masterId)); availabilityCache.set(ds,{set:res.set, iso:res.map}); })());
        }
      }
      if(tasks.length) await Promise.allSettled(tasks);
    }

    function buildTimeRows(extraSets){
      const out=[]; for(let h=START_HOUR;h<=END_HOUR;h++){ for(let m=0;m<60;m+=STEP_MIN){ out.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`); } }
      (extraSets||[]).forEach(s=>s&&s.forEach(t=>{ if(!out.includes(t)) out.push(t); })); return out.sort();
    }

    function renderMasterPicker(masters){
      elMaster.innerHTML=''; elMasterPicker.innerHTML='';
      masters.forEach(m=>{
        const opt=document.createElement('option'); opt.value=m.id; opt.textContent=m.name; elMaster.appendChild(opt);
        const btn=document.createElement('button'); btn.type='button'; btn.className='master-pill'; btn.setAttribute('role','option'); btn.dataset.id=m.id;
        const img=document.createElement('img'); img.src=m.photo||m.avatar||'https://via.placeholder.com/56x56?text=%20'; img.alt='';
        const name=document.createElement('span'); name.className='master-name'; name.textContent=m.name;
        btn.append(img,name);
        btn.addEventListener('click', async ()=>{
          elMasterPicker.querySelectorAll('.master-pill[aria-pressed="true"]').forEach(x=>x.setAttribute('aria-pressed','false'));
          btn.setAttribute('aria-pressed','true'); elMaster.value=String(m.id); current.masterId=Number(m.id); current.slot=null;
          updateSubmitState(); elSummary.textContent='Pick a staff member and time.'; availabilityCache.clear(); await renderWindow();
        });
        elMasterPicker.appendChild(btn);
      });
      const withSlots = masters.find(mm => (mm.slots||[]).length); const pickId = withSlots ? withSlots.id : masters[0].id;
      elMaster.value = pickId; current.masterId = Number(pickId);
      const active = elMasterPicker.querySelector(`.master-pill[data-id="${pickId}"]`); if (active) active.setAttribute('aria-pressed','true');
    }

    async function loadMastersAndRender(){
      elError.style.display='none'; current.slot=null; updateSubmitState();
      try{
        const first = await fetchAvailability(ymd(baseStart), null);
        const masters = (first.raw && first.raw.masters) || []; current.mastersData = masters;
        if(masters.length===0){ elMaster.innerHTML=''; elMasterPicker.innerHTML='<div class="muted" style="padding:.6rem;border:1px dashed var(--line);border-radius:.6rem;background:rgba(255,255,255,.02)">No staff available</div>'; olGrid.innerHTML='<div class="skeleton" style="height:240px;margin:.5rem;"></div>'; return; }
        renderMasterPicker(masters); availabilityCache.clear(); await renderWindow();
      }catch(err){ elError.textContent=err.message||'Unable to fetch availability'; elError.style.display='block'; }
    }

    async function renderWindow(){
      await ensureRangeLoaded(baseStart, WINDOW_DAYS);
      const days = Array.from({length:WINDOW_DAYS}, (_,i)=>{ const d=new Date(baseStart); d.setDate(d.getDate()+i); return d;});
      const dayStrs=days.map(ymd); const dayData = dayStrs.map(ds => availabilityCache.get(ds));
      const timeRows = buildTimeRows(dayData.map(x=>x?.set));
      const from = days[0].toLocaleDateString(LOCALE, {month:'short', day:'numeric'}), to = days[days.length-1].toLocaleDateString(LOCALE, {month:'short', day:'numeric'});
      olRange.textContent = `${from} ‚Äì ${to}`; olGrid.style.setProperty('--days', String(WINDOW_DAYS));

      olGrid.innerHTML=''; const headTime = document.createElement('div'); headTime.className='outlook__cell outlook__head time'; olGrid.appendChild(headTime);
      days.forEach(d=>{ const h=document.createElement('div'); h.className='outlook__cell outlook__head'; if (new Date().toDateString()===d.toDateString()) h.classList.add('day--today');
        h.innerHTML = `<div class="day-head"><div class="day-title">${d.toLocaleDateString(LOCALE,{weekday:'long'})}</div><div class="day-sub">${d.toLocaleDateString(LOCALE,{month:'short',day:'numeric'})}</div></div>`; olGrid.appendChild(h); });

      timeRows.forEach(t=>{
        const [hh,mm]=t.split(':').map(n=>parseInt(n,10)); const fake=new Date(); fake.setHours(hh,mm,0,0);
        const tcell=document.createElement('div'); tcell.className='outlook__cell time'; tcell.textContent=fmtHM(fake); olGrid.appendChild(tcell);
        days.forEach((d,idx)=>{ const c=document.createElement('div'); c.className='outlook__cell'; const data=dayData[idx]; const isFree=data?.set?.has(t);
          const chip=document.createElement('button'); chip.type='button'; chip.className='slot-chip ' + (isFree?'slot-free':'slot-busy'); chip.textContent=fmtHM(fake);
          if (isFree){
            chip.addEventListener('click', ()=>{ olGrid.querySelectorAll('.slot-selected').forEach(el=>el.classList.remove('slot-selected')); chip.classList.add('slot-selected');
              current.masterId=Number(elMaster.value); current.slot=data.iso.get(t);
              elSummary.textContent=`Staff: ${elMaster.selectedOptions[0]?.text || (document.querySelector('.master-pill[aria-pressed="true"] .master-name')?.textContent || '')}. Time: ${chip.textContent}, ${d.toLocaleDateString()}.`;
              updateSubmitState();
            });
          } else { chip.disabled=true; }
          c.appendChild(chip); olGrid.appendChild(c);
        });
      });
      const todayIdx = days.findIndex(x=>x.toDateString()===new Date().toDateString()); if (todayIdx>0){ const colWidth=160; olWrap.scrollLeft=todayIdx*colWidth - colWidth; }
    }

    async function shiftWindow(deltaDays){ baseStart=new Date(baseStart); baseStart.setDate(baseStart.getDate()+deltaDays); await renderWindow(); }
    olPrev.addEventListener('click', ()=>shiftWindow(-WINDOW_DAYS));
    olNext.addEventListener('click', ()=>shiftWindow(WINDOW_DAYS));
    olToday.addEventListener('click', async ()=>{ baseStart=new Date(); baseStart.setHours(0,0,0,0); await renderWindow(); });

    async function submitBooking(){
      if(!current.serviceId||!current.masterId||!current.slot) return;
      if(!contactIsComplete()){ elError.textContent='Please add your name, email and phone.'; elError.style.display='block'; return; }
      const contact = getContactPayload(); btnSubmit.disabled=true; elError.style.display='none'; elSuccess.style.display='none';
      try{
        const resp=await fetch("/accounts/api/book/",{ method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')}, credentials:'same-origin',
          body:JSON.stringify({ service:current.serviceId, master:current.masterId, start_time:current.slot, contact }) });
        const data=await resp.json().catch(()=>({}));
        if(!resp.ok){ let message = (data?.errors?.contact && Object.values(data.errors.contact).find(Boolean)) || data?.error || data?.detail || 'Could not create an appointment'; if (Array.isArray(message)) message = message[0]; throw new Error(message); }
        elSuccess.textContent='Appointment created! ' + (data.appointment?.start_time?('Time: '+new Date(data.appointment.start_time).toLocaleString()):'');
        elSuccess.style.display='block'; setTimeout(()=>{ window.location.reload(); }, 700);
      }catch(err){ elError.textContent=err.message||'Booking error'; elError.style.display='block'; updateSubmitState(); }
    }

    // open from cards/buttons
    document.addEventListener('click',(e)=>{ const btn=e.target.closest('.book-btn'); if(btn){ openModal(btn.dataset.serviceId, btn.dataset.serviceName||'service'); return; }
      const isInteractive=e.target.closest('button,a,select,input,textarea,label'); if(isInteractive) return;
      const card=e.target.closest('.service-card[data-service-id]'); if(card){ openModal(card.dataset.serviceId, card.dataset.serviceName||'service'); }
    });
    document.addEventListener('keydown',(e)=>{ if (!['Enter',' '].includes(e.key)) return; const card=document.activeElement;
      if(card && card.matches('.service-card[data-service-id]')){ e.preventDefault(); openModal(card.dataset.serviceId, card.dataset.serviceName||'service'); } });

    // close modal
    const modalEl=document.getElementById('bookModal');
    document.getElementById('bookClose').addEventListener('click',()=>modalEl.classList.remove('modal--open'));
    document.getElementById('bookCancel').addEventListener('click',()=>modalEl.classList.remove('modal--open'));
    modalEl.addEventListener('click',(e)=>{ if(e.target===modalEl) modalEl.classList.remove('modal--open'); });
    document.getElementById('bookSubmit').addEventListener('click',submitBooking);

    // horizontal scroll helper
    document.getElementById('olWrap').addEventListener('wheel',(e)=>{ if(e.shiftKey && Math.abs(e.deltaY)>Math.abs(e.deltaX)){ e.preventDefault(); e.currentTarget.scrollLeft += e.deltaY; } }, {passive:false});

    // deep link "?book=<id>"
    (function(){
      const params=new URLSearchParams(window.location.search); const serviceId=(params.get('book')||'').trim(); if(!serviceId) return;
      const cleanup=()=>{ const u=new URL(window.location.href); u.searchParams.delete('book'); const s=u.searchParams.toString(); const next=u.pathname+(s?`?${s}`:'')+(u.hash||''); window.history.replaceState({}, document.title, next); };
      const tryOpen=(n=6)=>{ const safe=window.CSS&&CSS.escape?CSS.escape(serviceId):serviceId.replace(/"/g,'\\"'); const card=document.querySelector(`.service-card[data-service-id="${safe}"]`);
        if(card){ const name=card.dataset.serviceName || card.querySelector('h3')?.textContent?.trim() || 'service'; openModal(serviceId,name); card.scrollIntoView({behavior:'smooth', block:'center'}); cleanup(); return; }
        if(n>0) setTimeout(()=>tryOpen(n-1),200);
      }; tryOpen();
    })();
  })();
  </script>

  <!-- Contact FAB + Modal -->
  <button type="button" id="contactFab" class="contact-fab"
          aria-haspopup="dialog" aria-controls="contactModal" aria-expanded="false">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M6.6 10.8c1.5 2.9 3.7 5.1 6.6 6.6l2.2-2.2c.3-.3.8-.4 1.2-.3 1 .3 2.1.5 3.2.5.7 0 1.2.5 1.2 1.2v3.5c0 .7-.5 1.2-1.2 1.2C9.8 21.5 2.5 14.2 2.5 4.2c0-.7.5-1.2 1.2-1.2H7c.7 0 1.2.5 1.2 1.2 0 1.1.2 2.2.5 3.2.1.4 0 .9-.3 1.2L6.6 10.8z"/>
    </svg>
    Contact us
  </button>

  <div id="contactModal" class="contact-modal" role="dialog" aria-modal="true" aria-labelledby="contactTitle">
    <div class="contact-dialog">
      <button class="contact-close" type="button" aria-label="Close">√ó</button>
      <h2 id="contactTitle" class="contact-title">Contact us</h2>

      <div class="contact-body">
        <div class="contact-row">
          <div>
            <div><a href="mailto:support@badguymotors.com">support@badguymotors.com</a></div>
            <div class="contact-sub">E-mail</div>
          </div>
          <button class="contact-btn" data-copy="support@badguymotors.com" type="button">Copy</button>
        </div>

        <div class="contact-row">
          <div>
            <div><a href="tel:+14035250432">(403) 525-0432</a></div>
            <div class="contact-sub">Phone</div>
          </div>
          <div style="display:flex;gap:.5rem;flex-wrap:wrap">
            <a class="contact-btn" href="tel:+14035250432">Call</a>
            <button class="contact-btn" data-copy="+1 403 525 0432" type="button">Copy</button>
          </div>
        </div>

        <div class="contact-actions">
          <a class="contact-btn" href="mailto:support@badguymotors.com?subject=Inquiry%20from%20website">Write e-mail</a>
          <a class="contact-btn" href="sms:+14035250432">Text us</a>
        </div>
      </div>
    </div>
  </div>

  <script src="{% static 'js/topbar.js' %}"></script>

  <!-- Contact modal controls -->
  <script>
  (function(){
    const fab=document.getElementById('contactFab');
    const modal=document.getElementById('contactModal');
    const closeBtn=modal.querySelector('.contact-close');
    let lastFocus=null;

    function openModal(){ lastFocus=document.activeElement; modal.setAttribute('open',''); fab.setAttribute('aria-expanded','true'); setTimeout(()=>closeBtn.focus(),0); document.addEventListener('keydown', onKey); }
    function closeModal(){ modal.removeAttribute('open'); fab.setAttribute('aria-expanded','false'); if(lastFocus) lastFocus.focus(); document.removeEventListener('keydown', onKey); }
    function onKey(e){
      if(e.key==='Escape') closeModal();
      if(e.key==='Tab'){
        const list=[...modal.querySelectorAll('a,button,[tabindex]:not([tabindex="-1"])')].filter(el=>!el.disabled && el.offsetParent!==null);
        if(!list.length) return; const first=list[0], last=list[list.length-1];
        if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
        else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
      }
    }
    fab.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });
    modal.querySelectorAll('[data-copy]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        try{ await navigator.clipboard.writeText(btn.dataset.copy); btn.textContent='Copied'; setTimeout(()=>btn.textContent='Copy',1200); }
        catch{ btn.textContent='Copy failed'; setTimeout(()=>btn.textContent='Copy',1200); }
      });
    });
  })();
  </script>

  <!-- Mobile sidebar fallback (idempotent, matches Merch) -->
  <script>
  (function(){
    if (window.__BGMTopbarSafe) return; window.__BGMTopbarSafe = true;
    const header=document.querySelector('.site-header');
    const nav=document.getElementById('siteNav');
    const toggle=header && header.querySelector('.site-header__toggle');
    if(!header||!nav||!toggle) return;
    const mq=window.matchMedia('(max-width: 960px)');

    toggle.addEventListener('click', ()=>{
      if(!mq.matches) return;
      const before = header.classList.contains('site-header--open') || document.body.classList.contains('nav-open') || toggle.getAttribute('aria-expanded')==='true';
      requestAnimationFrame(()=>{
        const after = header.classList.contains('site-header--open') || document.body.classList.contains('nav-open') || toggle.getAttribute('aria-expanded')==='true';
        if (before === after){
          const next=!before;
          toggle.setAttribute('aria-expanded', String(next));
          header.classList.toggle('site-header--open', next);
          document.body.classList.toggle('nav-open', next);
        }
      });
    });
  })();
  </script>

  {% include "includes/analytics_tracker.html" %}
</body>
</html>
