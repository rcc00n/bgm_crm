{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ services_copy.meta_title|default:"Bad Guy Motors — Upgrades & Booking" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  {% with meta_title=services_copy.meta_title|default:"Bad Guy Motors — Upgrades & Booking" meta_description=services_copy.meta_description|default:"Browse detailing, protection, and performance services with live pricing from Bad Guy Motors." meta_section="services" meta_keywords=marketing.default_keywords %}
    {% include "includes/marketing_head.html" %}
  {% endwith %}

  <!-- Performance hints -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Uniform UI font как в примере -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
 <link rel="preload" href="{% static 'fonts/Diesel.ttf' %}" as="font" type="font/ttf" crossorigin>
  <link rel="preload" href="{% static 'fonts/Ford.ttf' %}"   as="font" type="font/ttf" crossorigin>

  <style>
    :root{
      --bg:#0a0a0a; --ink:#eaeaea; --muted:#bdbdbd;
      --red:#d50000; --red-dark:#b60000;
      --card-bg:rgba(18,18,18,.75); --card-border:rgba(255,255,255,.08);
      --field-bg:rgba(255,255,255,.06);
      --error-bg:#3b0000; --error-text:#ff8a80;
      --line:rgba(255,255,255,.12);
      --radius-lg:1.25rem; --radius-md:.9rem; --radius-sm:.6rem;
      --shadow:0 10px 30px rgba(0,0,0,.45);
      --container:clamp(320px,92vw,1280px);
      --site-header-height:72px;
      --site-header-toggle-size:46px;
    }
    ::selection{ background:var(--red); color:#fff; }

    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html{font-size:16px;scroll-behavior:smooth}
    body{background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.55;min-height:100dvh;overflow-x:hidden}
    img{max-width:100%;display:block}
    a{color:inherit;text-decoration:none}
    .container{width:var(--container);margin-inline:auto;padding-inline:1rem}
    .visually-hidden{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0}

    /* Buttons */
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5em;padding:.78rem 1.15rem;border-radius:var(--radius-sm);
      font-weight:900;letter-spacing:.25px;cursor:pointer;transition:.2s ease;white-space:nowrap;user-select:none;line-height:1;border:1px solid transparent;text-transform:uppercase}
    .btn--primary{background:linear-gradient(180deg, var(--red) 0%, var(--red-dark) 100%);color:#fff;border:1px solid rgba(255,255,255,.08);box-shadow:0 0 0 0 rgba(213,0,0,0), 0 0 24px rgba(213,0,0,.35), 0 0 48px rgba(213,0,0,.18)}
    .btn--primary:hover{transform:translateY(-1px);filter:brightness(1.02)}
    .btn--ghost{background:transparent;color:var(--ink);border:1px solid var(--red)}
    .btn--ghost:hover{box-shadow:0 0 18px rgba(213,0,0,.35);transform:translateY(-1px)}
    .btn[disabled]{opacity:.55;cursor:not-allowed}

    /* Header (как в «правильном примере») */
    .site-header{position:sticky;top:0;z-index:10;background:rgba(0,0,0,.65);backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid var(--line)}
    .site-header__inner{display:flex;align-items:center;justify-content:space-between;gap:1rem;padding:.8rem 0}
    .brand{display:flex;align-items:center;gap:.75rem;font-weight:900;letter-spacing:.5px}
    .brand__logo{width:34px;height:34px;border-radius:10px;background:radial-gradient(90% 90% at 30% 30%, #ff1a1a, var(--red));box-shadow:0 0 40px -6px #ff1a1a}
    nav ul{display:flex;list-style:none;gap:.75rem}
    nav a{padding:.55rem .8rem;border-radius:.55rem}
    nav a[aria-current="page"]{background:rgba(255,255,255,.04);border:1px solid var(--line)}

    /* Hero */
    .hero{position:relative;z-index:2;display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center;gap:1.15rem;
      padding:5.2rem 1rem 3.2rem;background:
      radial-gradient(60% 120% at 82% -10%, rgba(213,0,0,.18) 0%, rgba(213,0,0,0) 60%),
      radial-gradient(60% 120% at 12% 110%, rgba(255,255,255,.06) 0%, rgba(255,255,255,0) 60%);border-bottom:1px solid var(--line)}
    .hero h1{font:900 clamp(2.2rem,4.5vw,3.4rem)/1.05 Inter;text-transform:uppercase;letter-spacing:.8px;text-shadow:0 0 18px rgba(213,0,0,.25)}
    .hero p{font-size:1.05rem;max-width:60ch;color:var(--muted)}
    .hero .cta{margin-top:.35rem}

    /* Catalog */
    main{position:relative;z-index:2}
    h2{font:900 1.6rem/1.2 Inter;text-transform:uppercase;letter-spacing:.6px;margin-bottom:1.25rem}
    .filters{display:flex;flex-wrap:wrap;gap:.75rem;margin:1.25rem 0 1.75rem}
    .filters input,.filters select{padding:.65rem 1rem;border:1px solid var(--line);border-radius:var(--radius-sm);font-size:.95rem;min-width:170px;background:var(--field-bg);color:var(--ink)}
    .filters ::placeholder{color:var(--muted)}
    .services-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1.1rem}

    .service-card{
      background:linear-gradient(160deg, rgba(18,18,18,.9), rgba(19,19,19,.9));
      border-radius:var(--radius-lg);
      padding:1rem;display:flex;flex-direction:column;gap:.75rem;
      border:1px solid var(--card-border);box-shadow:var(--shadow);
      transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      cursor:pointer;
    }
    .service-card{height:100%}
    .service-card .book-btn{margin-top:auto}
    .service-card:hover{transform:translateY(-4px);border-color:rgba(213,0,0,.35);box-shadow:0 14px 36px rgba(213,0,0,.16), 0 10px 22px rgba(0,0,0,.5)}
    .service-card:focus-visible{outline:2px solid var(--red);outline-offset:2px}

    .service-card__img{position:relative;aspect-ratio:16/9;border:1px solid var(--line);
      background:linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02)),
                 repeating-linear-gradient(0deg, rgba(255,255,255,.06), rgba(255,255,255,.06) 2px, transparent 2px, transparent 6px);
      border-radius:.9rem;display:flex;align-items:center;justify-content:center;font-size:.85rem;color:var(--muted);
      text-transform:uppercase;letter-spacing:.6px;overflow:hidden}
    .service-card__img img{width:100%;height:100%;object-fit:cover;display:block;border-radius:.9rem}
    .service-card__badge{position:absolute;left:.6rem;bottom:.6rem;z-index:2;font-size:.72rem;background:rgba(0,0,0,.55);
      color:#fff;border-radius:999px;padding:.18rem .55rem;border:1px solid rgba(255,255,255,.14);backdrop-filter: blur(4px) saturate(120%)}

    .service-card h3{font-size:1.06rem;font-weight:900;letter-spacing:.2px}
    .service-meta{font-size:.92rem;color:var(--muted);display:flex;flex-wrap:wrap;gap:.35rem .5rem;align-items:baseline}
    .service-meta .price__hint{white-space:normal}
    .stub{font-style:italic;color:var(--muted);padding:1rem;border:1px dashed var(--line);border-radius:.5rem;background:rgba(255,255,255,.02)}
    .muted{color:var(--muted);font-size:.95rem}
    .old{color:rgba(255,255,255,.35);text-decoration:line-through}
    .badge{font-size:.72rem;background:var(--red);color:#fff;border-radius:999px;padding:.18rem .55rem;margin-left:.35rem;border:1px solid rgba(255,255,255,.14)}

    /* Skeleton */
    .skeleton{background:linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.12), rgba(255,255,255,.06));
      background-size:200% 100%;animation:sh 1.2s ease-in-out infinite;border-radius:.5rem;height:36px}
    .ph{width:100%;height:100%;background:linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.12), rgba(255,255,255,.06));
      background-size:200% 100%;animation:sh 1.2s ease-in-out infinite}
    @keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}

    /* Footer */
    .site-footer{position:relative;z-index:2;text-align:center;font-size:.9rem;color:var(--muted);padding:2rem 1rem;border-top:1px solid var(--line);background:rgba(0,0,0,.6)}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.72);display:none;align-items:center;justify-content:center;padding:1rem;z-index:1000;overscroll-behavior:contain}
    .modal--open{display:flex}
    .modal__dialog{background:linear-gradient(180deg, #0c0c0c, #121212);border-radius:1rem;box-shadow:0 14px 36px rgba(0,0,0,.75), 0 0 32px rgba(213,0,0,.18);
      width:min(940px,96vw);border:1px solid var(--line);padding:1.2rem 1.25rem 1rem;max-height:92vh;display:flex;flex-direction:column;overflow:hidden;color:var(--ink)}
    .modal__header{display:flex;justify-content:space-between;align-items:center;gap:.5rem;margin-bottom:1rem}
    .modal__title{
      font-family:var(--font-body);
      font-weight:900;
      font-size:1.35rem;
      line-height:1.2;
      letter-spacing:.04em;
      text-transform:none;
    }
    .modal__title span{
      color:var(--red);
      font-family:inherit;
    }
    .modal__close{background:transparent;border:1px solid var(--line);font-size:1.2rem;line-height:1;cursor:pointer;color:var(--muted);border-radius:.5rem;width:36px;height:36px}
    .grid-2{display:grid;grid-template-columns:minmax(0,1.2fr) minmax(0,.8fr);gap:1rem;flex:1 1 auto;min-height:0}
    .grid-2>div{min-height:0}
    .field{display:flex;flex-direction:column;gap:.35rem}
    .field label{font-size:.9rem;color:var(--muted)}
    .field input,.field select{padding:.6rem .8rem;border:1px solid var(--line);border-radius:.6rem;font-size:.95rem;background:#0a0a0a;color:var(--ink)}
    .modal__footer{display:flex;justify-content:flex-end;gap:.5rem;margin-top:1rem}
    .hint{font-size:.85rem;color:var(--muted)}
    .error{color:#ff5c72;font-size:.9rem;margin-top:.5rem}
    .success{color:#17d45b;font-size:.95rem;margin-top:.5rem}

    /* Outlook grid */
    .outlook{display:flex;flex-direction:column;min-height:0;border:1px solid var(--line);border-radius:var(--radius-md);overflow:visible;background:#0a0a0a;margin-top:.45rem}
    .outlook__toolbar{display:flex;align-items:center;justify-content:space-between;gap:.75rem;padding:.55rem .75rem;border-bottom:1px solid var(--line);background:#0c0c0c}
    .outlook__toolbar .controls{display:flex;gap:.4rem}
    .outlook__toolbar .range{font-weight:900;letter-spacing:.4px}
    .outlook__toolbar button{border:1px solid var(--line);background:#111;border-radius:.5rem;padding:.35rem .65rem;cursor:pointer;line-height:1;font-weight:800;color:var(--ink);text-transform:uppercase;letter-spacing:.4px}
    .outlook__toolbar button:hover{border-color:rgba(213,0,0,.45);box-shadow:0 0 16px rgba(213,0,0,.2)}
    .outlook__wrap{flex:1 1 auto;overflow-x:auto;overflow-y:auto;max-height:56vh;min-height:300px;max-width:100%;padding-bottom:10px;scrollbar-gutter:stable both-edges;-webkit-overflow-scrolling:touch;background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0))}
    .outlook__grid{display:grid;min-width:calc(96px + (var(--days,14) * 160px) + 1px);grid-auto-rows:minmax(36px, auto);grid-template-columns:96px repeat(var(--days, 14), 160px)}
    .outlook__cell{border-bottom:1px solid var(--line);border-right:1px solid var(--line);padding:.25rem .4rem;background:#0a0a0a;white-space:nowrap;text-overflow:ellipsis;color:var(--ink)}
    .outlook__cell.time{position:sticky;left:0;background:#0c0c0c;z-index:2;font-size:.85rem;color:var(--muted)}
    .outlook__head{position:sticky;top:0;background:#0c0c0c;z-index:3;border-bottom:2px solid var(--line);box-shadow:0 1px 0 rgba(255,255,255,.04);padding:.45rem .5rem}
    .day-head{display:flex;flex-direction:column}
    .day-title{font:900 .95rem/1.1 Inter;text-transform:capitalize;letter-spacing:.3px}
    .day-sub{font-size:.78rem;color:var(--muted);margin-top:.15rem}
    .day--today{background:linear-gradient(180deg, rgba(213,0,0,.08), rgba(213,0,0,0))}
    .slot-chip{display:inline-flex;align-items:center;justify-content:center;height:1.7rem;min-width:3.6rem;padding:0 .5rem;border-radius:.5rem;border:1.6px solid transparent;font-weight:900;font-size:.9rem;user-select:none;line-height:1;text-transform:uppercase;letter-spacing:.3px}
    .slot-free{color:#fff;border-color:rgba(255,255,255,.22);background:#131313;cursor:pointer}
    .slot-free:hover{border-color:rgba(213,0,0,.55);box-shadow:0 0 16px rgba(213,0,0,.25)}
    .slot-busy{color:#fff;background:var(--red);opacity:.9}
    .slot-selected{background:var(--red)!important;color:#fff;border-color:var(--red)!important;box-shadow:0 0 0 2px rgba(213,0,0,.35)}
    .mobile-picker{display:none;flex-direction:column;gap:1rem;margin-top:.75rem;border:1px solid var(--line);border-radius:var(--radius-md);padding:1rem;background:linear-gradient(180deg,#080808,#0d0d0d)}
    .mobile-picker__headline{display:flex;align-items:center;justify-content:space-between;gap:.75rem}
    .mobile-picker__eyebrow{font-size:.75rem;color:var(--muted);letter-spacing:.08em;text-transform:uppercase}
    .mobile-picker__selected{font-weight:900;font-size:1.05rem;line-height:1.2}
    .mobile-picker__today{border:1px solid var(--line);background:#111;border-radius:999px;padding:.4rem .95rem;font-size:.85rem;font-weight:800;text-transform:uppercase;letter-spacing:.06em;color:var(--ink);cursor:pointer}
    .mobile-picker__today:active{transform:scale(.98)}
    .mobile-day-scroll{display:flex;gap:.45rem;overflow-x:auto;padding-bottom:.1rem;scrollbar-width:none;-webkit-overflow-scrolling:touch}
    .mobile-day-scroll::-webkit-scrollbar{display:none}
    .mobile-day-pill{display:flex;flex-direction:column;gap:.05rem;min-width:96px;border-radius:.9rem;border:1px solid rgba(255,255,255,.14);background:#131313;padding:.55rem .7rem;color:#fff;cursor:pointer;text-align:left;font-weight:600;transition:.2s}
    .mobile-day-pill span{font-size:.78rem;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .mobile-day-pill strong{font-size:.98rem;font-weight:900}
    .mobile-day-pill--selected{border-color:var(--red);background:var(--red);box-shadow:0 0 0 2px rgba(213,0,0,.35)}
    .mobile-picker__row{display:flex;flex-direction:column;gap:.5rem}
    .mobile-picker__row label,.mobile-picker__label{font-size:.8rem;color:var(--muted);letter-spacing:.04em;text-transform:uppercase}
    .mobile-picker__select{
      width:100%;
      padding:.75rem .9rem;
      border-radius:.75rem;
      border:1px solid rgba(255,255,255,.18);
      background:#0f0f0f;
      color:#fff;
      font-weight:800;
      font-size:1rem;
    }
    .mobile-picker__slots{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:.5rem}
    .mobile-slot-btn{padding:.75rem 1rem;border-radius:.8rem;border:1px solid rgba(255,255,255,.18);background:#131313;color:#fff;font-weight:800;font-size:1rem;letter-spacing:.02em;cursor:pointer;text-align:center;transition:.2s}
    .mobile-slot-btn:hover,.mobile-slot-btn:focus-visible{border-color:rgba(213,0,0,.55);box-shadow:0 0 16px rgba(213,0,0,.18)}
    .mobile-slot-btn--selected{background:var(--red);border-color:var(--red);box-shadow:0 0 0 2px rgba(213,0,0,.35)}
    .mobile-slot-btn[disabled]{opacity:.45;cursor:not-allowed}
    .mobile-picker__empty{display:none;font-size:.95rem;color:var(--muted);font-weight:600;text-align:center}
    .modal__dialog{width:min(940px,calc(100dvw - 2rem));max-height:calc(100dvh - 2rem)}
    @supports not (height:100dvh){.modal__dialog{width:min(940px,calc(100vw - 2rem));max-height:calc(100vh - 2rem)}}
    @media (max-width:900px){.modal__dialog{width:min(96vw,720px)}.grid-2{grid-template-columns:1fr}.outlook__wrap{max-height:50vh}}
    @media (max-width:768px){
      .outlook{display:none}
      .hint{display:none}
      .mobile-picker{display:flex}
    }

    /* Master picker (аватарки) */
    .masters{display:flex;flex-wrap:wrap;gap:.6rem;margin-top:.25rem}
    .master-pill{display:flex;align-items:center;gap:.6rem;padding:.4rem .6rem;border:1px solid var(--line);border-radius:.8rem;background:#0b0b0b;cursor:pointer}
    .master-pill:hover{border-color:rgba(213,0,0,.45);box-shadow:0 0 18px rgba(213,0,0,.2)}
    .master-pill[aria-pressed="true"]{border-color:var(--red);box-shadow:0 0 0 2px rgba(213,0,0,.25)}
    .master-pill img{width:28px;height:28px;border-radius:50%;object-fit:cover;background:#111}
    .master-name{font-weight:800;font-size:.92rem;color:#fff;} /* ← белый текст имени мастера */
    .sr-only{position:absolute;left:-9999px}

    .master-option{display:flex;align-items:center;gap:.6rem;padding:.35rem .5rem;background:var(--panel-2);border-radius:.5rem;margin-bottom:.35rem;cursor:pointer}
    .master-option img{width:40px;height:40px;border-radius:50%;object-fit:cover}
    .master-option span{color:#fff;font-weight:600}

    /* smoke layer */
#bg{position:fixed; inset:0; z-index:0; pointer-events:none;}
#bg canvas{position:absolute; inset:0; width:100%; height:100%; display:block; pointer-events:none;}

/* контент поверх дыма */
.site-header, .hero, main, .site-footer{position:relative; z-index:1;}

/* убираем прежний фон у hero, чтобы был виден дым */
.hero{background:transparent;}
  </style>

  <style>
    /* Подключаем кастомные */
    @font-face{
      font-family:"Diesel";
      src: url("{% static 'fonts/Diesel.ttf' %}") format("truetype");
      font-weight:100 900; font-style:normal; font-display:swap;
    }
    @font-face{
      font-family:"Ford";
      src: url("{% static 'fonts/Ford.ttf' %}") format("truetype");
      font-weight:100 900; font-style:normal; font-display:swap;
    }

    :root{
      --font-body:"Diesel", Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      --font-head:"Ford",  Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* глобально */
    html, body{
      font-family:var(--font-body) !important;
    }

    /* заголовки и акценты */
    h1,h2,h3,h4,h5,h6,
    .brand, .brand__word,
    .btn, .badge, nav a{
      font-family:var(--font-head) !important;
    }
    /* === Booking page — readability & topbar overrides ==================== */

/* Топбар: всё (кроме логотипа) — на простом шрифте */
.site-header nav a,
.site-header nav .btn,
.site-header nav .btn--ghost{
  font-family: var(--font-body) !important;
  font-weight: 700 !important;
  font-size: .95rem !important;
  letter-spacing: .02em !important;
  line-height: 1.15 !important;
  text-transform: none !important;
  color: rgba(255,255,255,.92) !important;
}
.site-header nav a:hover,
.site-header nav a[aria-current="page"]{ color:#fff !important; }

/* Заголовки секций (Upgrades & Services и пр.) */
h2, .section__title{
  font-family: var(--font-body) !important;
  font-weight: 900 !important;
  font-size: clamp(1.85rem, 2.6vw, 2.2rem) !important;
  letter-spacing: .005em !important;
  line-height: 1.2 !important;
  text-transform: none !important;
  color: #fff !important;
}

/* Подзаголовки категоний/блоков (некоторые заданы инлайн — перебиваем) */
main h3{
  font-family: var(--font-body) !important;
  font-weight: 900 !important;
  font-size: 1.15rem !important;
  letter-spacing: .01em !important;
  text-transform: none !important;
  color: #fff !important;
}

/* Тексты описаний под заголовками */
.section__desc, .muted{
  font-family: var(--font-body) !important;
  font-weight: 400 !important;
  font-size: clamp(1rem, 1.3vw, 1.06rem) !important;
  color: rgba(255,255,255,.86) !important;
}

/* Карточки — заголовок сервиса читаемее */
.services-grid h3,
.service-card h3{
  font-family: var(--font-body) !important;
  font-weight: 900 !important;
  font-size: 1.08rem !important;
  letter-spacing: .01em !important;
}

/* Футер ссылки (если появятся) в том же стиле */
.footer__nav a{
  font-family: var(--font-body) !important;
  font-weight: 700 !important;
  letter-spacing: .02em !important;
  text-transform: none !important;
  color: rgba(255,255,255,.9) !important;
}
.footer__nav a:hover{ color:#fff !important; }

  </style>
  <style id="diesel-overrides">
  /* 1) Топбар полностью на Diesel */
  .site-header .brand,
  .site-header .brand__word,
  .site-header nav a,
  .site-header .badge{
    font-family: var(--font-body) !important;  /* Diesel */
    font-style: normal !important;
  }
  /* меню — не капсом, читаемый кегль */
  .site-header nav a{
    text-transform: none !important;
    letter-spacing: .02em !important;
    font-weight: 700 !important;
    font-size: .95rem !important;
  }

  /* 2) Заголовок hero — не капсом и тоже Diesel */
  .hero h1{
    font-family: var(--font-body) !important;  /* Diesel */
    text-transform: none !important;
    letter-spacing: .01em !important;
  }

  /* 3) Все мелкие тексты/CTA — Diesel */
  .btn,
  .btn--primary,
  .btn--ghost,
  .badge,
  .muted,
  .service-meta,
  .service-card h3,
  .slot-chip,
  .outlook__toolbar button,
  .master-name,
  .filters input,
  .filters select,
  .field label,
  .field input,
  .field select{
    font-family: var(--font-body) !important;  /* Diesel */
    text-transform: none !important;
    letter-spacing: .02em;
  }
  /* кнопкам точно убираем капс */
  .btn{ text-transform: none !important; }
</style>
<style id="ford-readable-fixes">
  /* 1) Hero title — Ford, без капса, читабельно */
  .hero h1,
  .hero .title{
    font-family: var(--font-head) !important;   /* Ford */
    text-transform: none !important;
    letter-spacing: .01em !important;
    font-weight: 900 !important;
    font-size: clamp(2.1rem, 4.5vw, 3.3rem) !important;
    line-height: 1.15 !important;
    text-shadow: none !important;
  }

  /* 2) "Upgrades & Services" — Ford, без капса */
  main h2,
  #services h2,
  .section__title{
    font-family: var(--font-head) !important;   /* Ford */
    text-transform: none !important;
    letter-spacing: .01em !important;
    font-weight: 900 !important;
    font-size: clamp(1.9rem, 2.6vw, 2.2rem) !important;
    line-height: 1.2 !important;
  }

  /* 3) Текст лого в топбаре — крупнее */
.brand__word{
    font-family: var(--font-head) !important;   /* Ford */
    font-size: clamp(1.1rem, 1.5vw, 1.35rem) !important;
    line-height: 1 !important;
    letter-spacing: .06em !important;
  }
</style>

<style id="topbar-home-clone">
  /* desktop baseline */
  .site-header{
    position:sticky;
    top:0;
    z-index:1000;
    background:#000;
    border-bottom:1px solid var(--line);
    backdrop-filter:none;
  }
  .site-header__inner{
    display:grid;
    grid-template-columns:auto 1fr;
    align-items:center;
    gap:1.25rem;
    padding:.7rem 0;
  }
  .brand{
    display:flex;
    align-items:baseline;
    gap:.9rem;
    min-width:max-content;
    font-weight:900;
    letter-spacing:.06em;
    text-transform:uppercase;
  }
  .brand__logo{
    all:unset;
    display:inline-flex;
    gap:.5rem;
    line-height:1;
    font-weight:900;
    letter-spacing:.06em;
    font-size:1rem;
  }
  .brand__word--white{color:#fff;}
  .brand__word--red{color:#d50000;}
  .brand__tagline{
    margin-left:1.1rem;
    white-space:nowrap;
    font-size:.82rem;
    font-weight:800;
    letter-spacing:.14em;
    color:rgba(255,255,255,.72);
  }
  .site-header nav{
    margin-left:auto;
    display:flex;
    justify-content:flex-end;
    min-width:0;
  }
  .site-header nav ul{
    display:flex;
    align-items:center;
    gap:1.6rem;
    margin:0;
    padding:0;
    list-style:none;
    flex-wrap:nowrap;
  }
  .site-header nav li + li::before{content:none;}
  .site-header nav a{
    background:none!important;
    border:0!important;
    border-radius:0;
    padding:0!important;
    line-height:1;
    text-transform:uppercase;
    font-weight:800;
    letter-spacing:.08em;
    font-size:.82rem;
    color:rgba(255,255,255,.75);
  }
  .site-header nav a:hover,
  .site-header nav a[aria-current=\"page\"]{
    color:#fff;
  }
  .site-header nav .btn,
  .site-header nav .btn--ghost{
    padding:0!important;
    border:none!important;
    background:none!important;
  }
  .site-header .badge{
    padding:.12rem .5rem;
    font-size:.72rem;
    transform:translateY(-.04rem);
  }

  @media (max-width:1200px){
    .brand__tagline{display:none;}
  }

  /* mobile toggle */
  .site-header__toggle{
    display:none;
    align-items:center;
    justify-content:center;
    width:var(--site-header-toggle-size);
    height:var(--site-header-toggle-size);
    border-radius:.85rem;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(255,255,255,.06);
    color:#fff;
    cursor:pointer;
    transition:transform .2s ease, border-color .2s ease, background .2s ease;
  }
  .site-header__toggle:hover{
    border-color:rgba(255,255,255,.35);
    background:rgba(255,255,255,.12);
  }
  .site-header__toggle:focus-visible{
    outline:2px solid #fff;
    outline-offset:2px;
  }
  .site-header__toggle-box{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:100%;
    height:100%;
  }
  .site-header__toggle-lines,
  .site-header__toggle-lines::before,
  .site-header__toggle-lines::after{
    content:\"\"; display:block;
    width:20px; height:2px;
    border-radius:999px;
    background:#fff;
    position:relative;
    transition:transform .2s ease, opacity .2s ease;
  }
  .site-header__toggle-lines::before,
  .site-header__toggle-lines::after{
    position:absolute;
    left:0;
  }
  .site-header__toggle-lines::before{ top:-6px; }
  .site-header__toggle-lines::after{ top:6px; }
  .site-header--open .site-header__toggle-lines{
    background:transparent;
  }
  .site-header--open .site-header__toggle-lines::before{
    transform:translateY(6px) rotate(45deg);
  }
  .site-header--open .site-header__toggle-lines::after{
    transform:translateY(-6px) rotate(-45deg);
  }

  @media (max-width:960px){
    body.nav-open{ overflow:hidden; }
    .site-header{
      --site-header-height:max(62px, 10vh);
    }
    .site-header__inner{
      grid-template-columns:auto max-content;
      gap:clamp(12px, 3vw, 24px);
    }
    .site-header__toggle{
      display:inline-flex;
    }
    .site-header nav{
      position:fixed;
      inset:0;
      padding-top:calc(var(--site-header-height) + 1rem);
      padding-inline:clamp(20px, 6vw, 36px);
      padding-bottom:clamp(28px, 12vh, 46px);
      background:rgba(5,5,5,.88);
      backdrop-filter:blur(18px) saturate(1.2);
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      opacity:0;
      pointer-events:none;
      transform:translateY(-12px);
      transition:opacity .22s ease, transform .22s ease;
      z-index:2400;
    }
    .site-header nav ul{
      flex-direction:column;
      align-items:stretch;
      gap:.45rem;
      width:100%;
    }
    .site-header nav li{ width:100%; }
    .site-header nav a,
    .site-header nav .btn,
    .site-header nav .btn--ghost{
      width:100%;
      justify-content:space-between;
      background:rgba(255,255,255,.04)!important;
      border:1px solid rgba(255,255,255,.08)!important;
      border-radius:.85rem!important;
      padding:.95rem 1rem!important;
      font-size:1.05rem!important;
      letter-spacing:.035em!important;
    }
    .site-header nav a:hover,
    .site-header nav a[aria-current=\"page\"],
    .site-header nav .btn:hover{
      background:rgba(255,255,255,.1)!important;
      border-color:rgba(255,255,255,.22)!important;
      color:#fff!important;
    }
    .site-header--open nav{
      opacity:1;
      pointer-events:auto;
      transform:translateY(0);
    }
    .site-header .site-header__toggle[aria-expanded=\"true\"] ~ nav{
      opacity:1!important;
      pointer-events:auto!important;
      transform:translateY(0)!important;
    }
  }

  body.nav-open .contact-fab{ display:none !important; }
</style>



</head>
<body>
  {% include "includes/marketing_body.html" %}
<div id="bg"></div>
<a href="#services" class="visually-hidden">{{ services_copy.skip_to_main_label }}</a>

{% with current='services' %}
  {% include "includes/site_header.html" %}
{% endwith %}


<section class="hero">
  <h1>{{ services_copy.hero_title }}</h1>
  <p>{{ services_copy.hero_lead }}</p>
  <div class="cta"><a href="#services" class="btn btn--primary">{{ services_copy.hero_cta_label }}</a></div>
</section>

<main id="services" class="container" style="padding-block:3rem;">
  <h2>{{ services_copy.section_title }}</h2>

  <!-- Filters -->
  <form method="get" class="filters" role="search">
    <input type="search" name="q" placeholder="{{ services_copy.search_placeholder }}" value="{{ q|default:'' }}">
    <select name="cat">
      <option value="">{{ services_copy.filter_all_categories_label }}</option>
      {% for c in filter_categories %}
        <option value="{{ c.id }}" {% if active_category == c.id|stringformat:'s' %}selected{% endif %}>{{ c.name }}</option>
      {% endfor %}
    </select>
    <button class="btn btn--primary" type="submit">{{ services_copy.search_button_label }}</button>
    {% if q or active_category %}
      <a class="btn btn--ghost" href="{% url 'client-dashboard' %}#services">{{ services_copy.reset_button_label }}</a>
    {% endif %}
  </form>

  <!-- Live results (JS) -->
  <h3 id="liveTitle" style="margin:.5rem 0 1rem; display:none;">{{ services_copy.search_results_label }}</h3>
  <div id="liveGrid" class="services-grid" style="display:none;"></div>

  <!-- Server-rendered fallback/results -->
  <div id="serverContent">
    {% if search_results %}
      <h3 style="margin:.5rem 0 1rem;">{{ services_copy.search_results_label }}</h3>
      <div class="services-grid">
        {% for s in search_results %}
          <article class="service-card" data-service-id="{{ s.id }}" data-service-name="{{ s.name }}" tabindex="0" role="button" aria-label="{{ services_copy.book_aria_prefix }} {{ s.name }}">
            <div class="service-card__img" aria-label="{{ services_copy.service_image_aria_label }}">
              {% if s.image %}<img src="{{ s.image.url }}" alt="{{ s.name }}" loading="lazy" decoding="async">{% else %}<div class="ph" aria-hidden="true">{{ services_copy.service_image_fallback_label }}</div>{% endif %}
              {% if s.category %}<span class="service-card__badge">{{ s.category.name }}</span>{% endif %}
            </div>
            <div class="muted">{{ s.category.name }}</div>
            <h3>{{ s.name }}</h3>
            {% if s.description %}<p class="muted">{{ s.description|truncatewords:22 }}</p>{% endif %}
            <div class="service-meta">
              {% if s.contact_for_estimate %}
                <strong>{{ services_copy.contact_for_estimate_label }}</strong>
                {% if s.estimate_from_price %}<span class="price__hint">{{ services_copy.from_label }} ${{ s.estimate_from_price|floatformat:2 }}</span>{% endif %}
              {% else %}
                {% with disc=s.get_active_discount %}
                  {% if disc %}
                    <span class="old">${{ s.base_price|floatformat:2 }}</span>
                    <strong>${{ s.get_discounted_price|floatformat:2 }}</strong>
                    <span class="badge">-{{ disc.discount_percent }}%</span>
                  {% else %}
                    <strong>${{ s.base_price|floatformat:2 }}</strong>
                  {% endif %}
                {% endwith %}
              {% endif %}
              {{ services_copy.duration_separator }} {{ s.duration_min }} {{ services_copy.duration_unit }}
            </div>
            <button class="btn btn--primary book-btn" type="button" data-service-id="{{ s.id }}" data-service-name="{{ s.name }}">{{ services_copy.pick_time_label }}</button>
          </article>
        {% empty %}
          <div class="stub">{{ services_copy.search_no_results_prefix }} “{{ q }}”{{ services_copy.search_no_results_suffix }}</div>
        {% endfor %}
      </div>
      <hr style="margin:2rem 0;border:none;border-top:1px solid var(--line)">
    {% endif %}

    {% for c in categories %}
      <h3 style="margin:1.5rem 0 .75rem; font:900 1.25rem/1 Inter; text-transform:uppercase; letter-spacing:.5px">{{ c.name }}</h3>
      <div class="services-grid">
        {% for s in c.service_set.all %}
          <article class="service-card" data-service-id="{{ s.id }}" data-service-name="{{ s.name }}" tabindex="0" role="button" aria-label="{{ services_copy.book_aria_prefix }} {{ s.name }}">
            <div class="service-card__img" aria-label="{{ services_copy.service_image_aria_label }}">
              {% if s.image %}<img src="{{ s.image.url }}" alt="{{ s.name }}" loading="lazy" decoding="async">{% else %}<div class="ph" aria-hidden="true">{{ services_copy.service_image_fallback_label }}</div>{% endif %}
              <span class="service-card__badge">{{ c.name }}</span>
            </div>
            <h3>{{ s.name }}</h3>
            {% if s.description %}<p class="muted">{{ s.description|truncatewords:22 }}</p>{% endif %}
            <div class="service-meta">
              {% if s.contact_for_estimate %}
                <strong>{{ services_copy.contact_for_estimate_label }}</strong>
                {% if s.estimate_from_price %}<span class="price__hint">{{ services_copy.from_label }} ${{ s.estimate_from_price|floatformat:2 }}</span>{% endif %}
              {% else %}
                {% with disc=s.get_active_discount %}
                  {% if disc %}
                    <span class="old">${{ s.base_price|floatformat:2 }}</span>
                    <strong>${{ s.get_discounted_price|floatformat:2 }}</strong>
                    <span class="badge">-{{ disc.discount_percent }}%</span>
                  {% else %}
                    <strong>${{ s.base_price|floatformat:2 }}</strong>
                  {% endif %}
                {% endwith %}
              {% endif %}
              {{ services_copy.duration_separator }} {{ s.duration_min }} {{ services_copy.duration_unit }}
            </div>
            <button class="btn btn--primary book-btn" type="button" data-service-id="{{ s.id }}" data-service-name="{{ s.name }}">{{ services_copy.pick_time_label }}</button>
          </article>
        {% empty %}
          <div class="stub">{{ services_copy.category_empty_label }}</div>
        {% endfor %}
      </div>
    {% endfor %}

    {% if uncategorized %}
      <h3 style="margin:1.5rem 0 .75rem; font:900 1.25rem/1 Inter; text-transform:uppercase; letter-spacing:.5px">{{ services_copy.uncategorized_title }}</h3>
      <div class="services-grid">
        {% for s in uncategorized %}
          <article class="service-card" data-service-id="{{ s.id }}" data-service-name="{{ s.name }}" tabindex="0" role="button" aria-label="{{ services_copy.book_aria_prefix }} {{ s.name }}">
            <div class="service-card__img" aria-label="{{ services_copy.service_image_aria_label }}">
              {% if s.image %}<img src="{{ s.image.url }}" alt="{{ s.name }}" loading="lazy" decoding="async">{% else %}<div class="ph" aria-hidden="true">{{ services_copy.service_image_fallback_label }}</div>{% endif %}
            </div>
            <h3>{{ s.name }}</h3>
            {% if s.description %}<p class="muted">{{ s.description|truncatewords:22 }}</p>{% endif %}
            <div class="service-meta">
              {% if s.contact_for_estimate %}
                <strong>{{ services_copy.contact_for_estimate_label }}</strong>
                {% if s.estimate_from_price %}<span class="price__hint">{{ services_copy.from_label }} ${{ s.estimate_from_price|floatformat:2 }}</span>{% endif %}
              {% else %}
                {% with disc=s.get_active_discount %}
                  {% if disc %}
                    <span class="old">${{ s.base_price|floatformat:2 }}</span>
                    <strong>${{ s.get_discounted_price|floatformat:2 }}</strong>
                    <span class="badge">-{{ disc.discount_percent }}%</span>
                  {% else %}
                    <strong>${{ s.base_price|floatformat:2 }}</strong>
                  {% endif %}
                {% endwith %}
              {% endif %}
              {{ services_copy.duration_separator }} {{ s.duration_min }} {{ services_copy.duration_unit }}
            </div>
            <button class="btn btn--primary book-btn" type="button" data-service-id="{{ s.id }}" data-service-name="{{ s.name }}">{{ services_copy.pick_time_label }}</button>
          </article>
        {% endfor %}
      </div>
    {% endif %}

    {% if not has_any_services %}
      <div class="stub">{{ services_copy.catalog_empty_label }}</div>
    {% endif %}
  </div>
</main>

{% include "includes/site_footer.html" %}

<!-- Modal -->
<div class="modal" id="bookModal" aria-hidden="true">
  <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="bookTitle">
    <div class="modal__header">
      <div class="modal__title" id="bookTitle">{{ services_copy.booking_modal_title_prefix }} <span id="bookServiceName"></span></div>
      <button class="modal__close" id="bookClose" aria-label="{{ services_copy.booking_close_label }}">×</button>
    </div>

    <div class="grid-2">
      <div>
        <div class="field">
          <label for="bookMaster">{{ services_copy.booking_staff_label }}</label>
          <!-- Скрытый/select для доступности -->
          <select id="bookMaster" class="sr-only" aria-hidden="true"></select>
          <!-- Пикер мастеров -->
          <div id="masterPicker" class="masters" role="listbox" aria-label="{{ services_copy.booking_staff_picker_label }}"></div>
        </div>

        <div class="field" style="margin-top:.5rem">
          <label>{{ services_copy.booking_choose_time_label }}</label>

          <div class="outlook" id="ol">
            <div class="outlook__toolbar">
              <div class="controls">
                <button id="olPrev" type="button">{{ services_copy.booking_prev_label }}</button>
                <button id="olToday" type="button">{{ services_copy.booking_today_label }}</button>
                <button id="olNext" type="button">{{ services_copy.booking_next_label }}</button>
              </div>
              <div class="range" id="olRange">—</div>
            </div>
            <div class="outlook__wrap" id="olWrap">
              <div class="outlook__grid" id="olGrid" tabindex="0" aria-live="polite"></div>
            </div>
          </div>

          <div class="mobile-picker" id="mobileTimePicker" aria-live="polite" aria-hidden="true">
            <div class="mobile-picker__headline">
              <div>
                <span class="mobile-picker__eyebrow">{{ services_copy.booking_mobile_day_label }}</span>
                <div class="mobile-picker__selected" id="mobileSelectedDay">{{ services_copy.booking_mobile_pick_day_label }}</div>
              </div>
              <button class="mobile-picker__today" id="mobileTodayBtn" type="button">{{ services_copy.booking_jump_today_label }}</button>
            </div>
            <div class="mobile-picker__row mobile-picker__row--date">
              <label class="mobile-picker__label" for="mobileDaySelect">{{ services_copy.booking_mobile_pick_day_label }}</label>
              <input id="mobileDaySelect" class="mobile-picker__select" type="date" aria-label="{{ services_copy.booking_mobile_pick_day_label }}">
            </div>
            <div class="mobile-picker__row">
              <label class="mobile-picker__label" for="mobileTimeSelect">{{ services_copy.booking_available_times_label }}</label>
              <input id="mobileTimeSelect" class="mobile-picker__select" type="time" aria-label="{{ services_copy.booking_available_times_label }}">
              <div class="mobile-picker__empty" id="mobileSlotsEmpty">{{ services_copy.booking_no_open_times_label }}</div>
            </div>
          </div>

          <div class="hint" style="margin-top:.5rem">{{ services_copy.booking_scroll_hint_desktop }}</div>
        </div>
      </div>

      <div>
        <div class="field">
          <label>{{ services_copy.booking_summary_label }}</label>
          <div class="muted" id="bookSummary">{{ services_copy.booking_summary_default }}</div>
        </div>
        <div class="field" style="margin-top:1rem;">
          <label for="contactName">{{ services_copy.booking_full_name_label }}</label>
          <input id="contactName" name="contact_name" type="text" maxlength="120"
                 class="input" autocomplete="name" required
                 placeholder="{{ services_copy.booking_full_name_placeholder }}">
        </div>
        <div class="field">
          <label for="contactEmail">{{ services_copy.booking_email_label }}</label>
          <input id="contactEmail" name="contact_email" type="email"
                 class="input" autocomplete="email" required
                 placeholder="{{ services_copy.booking_email_placeholder }}">
        </div>
        <div class="field">
          <label for="contactPhone">{{ services_copy.booking_phone_label }}</label>
          <input id="contactPhone" name="contact_phone" type="tel"
                 class="input" autocomplete="tel" inputmode="tel"
                 pattern="\+?\d{10,15}" title="{{ services_copy.booking_phone_title }}"
                 required placeholder="{{ services_copy.booking_phone_placeholder }}">
        </div>
        <p class="hint">{{ services_copy.booking_confirmation_hint }}</p>
        <div class="error" id="bookError" style="display:none;"></div>
        <div class="success" id="bookSuccess" style="display:none;"></div>
      </div>
    </div>

    <div class="modal__footer">
      <button class="btn btn--ghost" id="bookCancel">{{ services_copy.booking_cancel_label }}</button>
      <button class="btn btn--primary" id="bookSubmit" disabled>{{ services_copy.booking_confirm_label }}</button>
    </div>
  </div>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="{% static 'admin/js/bgm-smoke.js' %}"></script>

</div>

{{ contact_prefill|json_script:"contactPrefillData" }}

<script>
  (function(){
    const contactPrefillEl = document.getElementById('contactPrefillData');
    const contactPrefill = contactPrefillEl ? JSON.parse(contactPrefillEl.textContent) : {name:'', email:'', phone:''};
    const contactDraft = {...contactPrefill};
    const LOCALE = 'en-US'; // можно 'en-US'
    const copy = {
      summaryDefault: "{{ services_copy.booking_summary_default|escapejs }}",
      summaryStaffPrefix: "{{ services_copy.booking_summary_staff_prefix|escapejs }}",
      summaryTimePrefix: "{{ services_copy.booking_summary_time_prefix|escapejs }}",
      summaryTimeSelected: "{{ services_copy.booking_summary_time_selected_label|escapejs }}",
      mobilePickDayLabel: "{{ services_copy.booking_mobile_pick_day_label|escapejs }}",
      noAvailabilityLabel: "{{ services_copy.booking_no_availability_label|escapejs }}",
      noOpenTimesLabel: "{{ services_copy.booking_no_open_times_label|escapejs }}",
      noOpenTimesOnPrefix: "{{ services_copy.booking_no_open_times_on_prefix|escapejs }}",
      noOpenTimesOnSuffix: "{{ services_copy.booking_no_open_times_on_suffix|escapejs }}",
      failedSlotsLabel: "{{ services_copy.booking_failed_slots_label|escapejs }}",
      noStaffLabel: "{{ services_copy.booking_no_staff_label|escapejs }}",
      availabilityErrorLabel: "{{ services_copy.booking_availability_error_label|escapejs }}",
      missingContactError: "{{ services_copy.booking_missing_contact_error|escapejs }}",
      createErrorLabel: "{{ services_copy.booking_create_error_label|escapejs }}",
      createdLabel: "{{ services_copy.booking_created_label|escapejs }}",
      timeLabel: "{{ services_copy.booking_time_label|escapejs }}",
      bookingErrorLabel: "{{ services_copy.booking_error_label|escapejs }}",
    };

    const apiAvail= "/accounts/api/availability/";
    const apiBook = "/accounts/api/book/";

    function getCookie(name){ const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m?m.pop():''; }
    function ymd(d){ const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}-${m}-${day}`; }
    function parseISO(iso){ try{return new Date(iso);}catch(_){return null;} }
    function fmtHM(d){ return d.toLocaleTimeString(LOCALE, {hour:'numeric', minute:'2-digit'}); }
    function hmValue(d){ return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }

    const modal=document.getElementById('bookModal');
    const btnClose=document.getElementById('bookClose');
    const btnCancel=document.getElementById('bookCancel');
    const btnSubmit=document.getElementById('bookSubmit');
    const elServiceName=document.getElementById('bookServiceName');
    const elMaster=document.getElementById('bookMaster');
    const elMasterPicker=document.getElementById('masterPicker');
    const elSummary=document.getElementById('bookSummary');
    const elError=document.getElementById('bookError');
    const elSuccess=document.getElementById('bookSuccess');
    const contactInputs = {
      name: document.getElementById('contactName'),
      email: document.getElementById('contactEmail'),
      phone: document.getElementById('contactPhone'),
    };

    const olGrid=document.getElementById('olGrid');
    const olWrap=document.getElementById('olWrap');
    const olRange=document.getElementById('olRange');
    const olPrev=document.getElementById('olPrev');
    const olNext=document.getElementById('olNext');
    const olToday=document.getElementById('olToday');
    const mobilePickerEl=document.getElementById('mobileTimePicker');
    const mobileDaySelect=document.getElementById('mobileDaySelect');
    const mobileDaySummary=document.getElementById('mobileSelectedDay');
    const mobileTodayBtn=document.getElementById('mobileTodayBtn');
    const mobileSlotsEmpty=document.getElementById('mobileSlotsEmpty');
    const mobileTimeSelect=document.getElementById('mobileTimeSelect');
    const mobileQuery = window.matchMedia ? window.matchMedia('(max-width: 768px)') : null;
    const mobileState = { keys:[], days:[], data:[], selectedKey:'' };
    const SUMMARY_DEFAULT = copy.summaryDefault;

    const WINDOW_DAYS = 14, START_HOUR=6, END_HOUR=23, STEP_MIN=30;
    let current={ serviceId:null, serviceName:'', masterId:null, slot:null, mastersData:[] };
    let baseStart = new Date(); baseStart.setHours(0,0,0,0);
    let availabilityCache = new Map();
    if (mobilePickerEl){
      const syncMobileVisibility = ()=> {
        const active = mobileQuery ? mobileQuery.matches : false;
        mobilePickerEl.setAttribute('aria-hidden', active ? 'false' : 'true');
      };
      syncMobileVisibility();
      if (mobileQuery){
        try{ mobileQuery.addEventListener('change', syncMobileVisibility); }
        catch(_){ mobileQuery.addListener(syncMobileVisibility); }
      }
    }
    if (mobileDaySelect){
      mobileDaySelect.addEventListener('change', ()=>{
        applyMobileSelection(mobileDaySelect.value);
      });
    }
    if (mobileTimeSelect){
      mobileTimeSelect.addEventListener('change', ()=>{
        const timeValue = mobileTimeSelect.value;
        if (!timeValue){
          current.slot = null;
          setSummaryDefault();
          updateSubmitState();
          syncSelectedSlotUI();
          return;
        }
        const idx = mobileState.keys.indexOf(mobileState.selectedKey);
        const entry = idx>=0 ? mobileState.data[idx] : null;
        const iso = entry?.iso?.get(timeValue);
        if (iso){
          if (mobileSlotsEmpty) mobileSlotsEmpty.style.display='none';
          selectSlot(iso);
        }else{
          current.slot = null;
          setSummaryDefault();
          updateSubmitState();
          syncSelectedSlotUI();
          if (mobileSlotsEmpty){
            mobileSlotsEmpty.textContent = copy.noOpenTimesLabel;
            mobileSlotsEmpty.style.display='block';
          }
        }
      });
    }
    if (mobileTodayBtn){
      mobileTodayBtn.addEventListener('click', ()=>{
        if (!mobileState.keys.length) return;
        const todayKey = ymd(new Date());
        const firstWithSlots = mobileState.keys.find((key, idx)=>Boolean(mobileState.data[idx]?.set?.size));
        const target = mobileState.keys.includes(todayKey) ? todayKey : (firstWithSlots || mobileState.keys[0]);
        if (target) applyMobileSelection(target);
      });
    }

    function hydrateContactForm(){
      Object.entries(contactInputs).forEach(([key, input])=>{
        input.value = contactDraft[key] || "";
      });
    }

    function getContactPayload(){
      return {
        name: contactInputs.name.value.trim(),
        email: contactInputs.email.value.trim(),
        phone: contactInputs.phone.value.trim(),
      };
    }

    function contactIsComplete(){
      const c = getContactPayload();
      return Boolean(c.name && c.email && c.phone);
    }

    function setSummaryDefault(){
      elSummary.textContent = SUMMARY_DEFAULT;
    }

    function getActiveStaffName(){
      return elMaster.selectedOptions[0]?.text?.trim()
        || elMasterPicker.querySelector('.master-pill[aria-pressed="true"] .master-name')?.textContent?.trim()
        || '—';
    }

    function selectSlot(slotIso){
      if (!slotIso) return;
      if (elMaster.value){
        const parsedMaster = Number(elMaster.value);
        if (!Number.isNaN(parsedMaster)) current.masterId = parsedMaster;
      }
      current.slot = slotIso;
      const slotDate = parseISO(slotIso);
      if (slotDate){
        const dayLabel = slotDate.toLocaleDateString(LOCALE, {weekday:'long', month:'short', day:'numeric'});
        elSummary.textContent = `${copy.summaryStaffPrefix} ${getActiveStaffName()}. ${copy.summaryTimePrefix} ${fmtHM(slotDate)}, ${dayLabel}.`;
      }else{
        elSummary.textContent = `${copy.summaryStaffPrefix} ${getActiveStaffName()}. ${copy.summaryTimeSelected}`;
      }
      elError.style.display='none';
      updateSubmitState();
      syncSelectedSlotUI();
    }

    function syncSelectedSlotUI(){
      const slot = current.slot;
      if (olGrid){
        olGrid.querySelectorAll('.slot-chip').forEach(btn=>{
          btn.classList.toggle('slot-selected', Boolean(slot && btn.dataset.slot === slot));
        });
      }
      if (mobileTimeSelect){
        const slotDate = slot ? parseISO(slot) : null;
        const next = slotDate ? hmValue(slotDate) : '';
        if (mobileTimeSelect.value !== next) mobileTimeSelect.value = next;
      }
    }

    function renderMobileDayOptions(){
      if (!mobileDaySelect) return;
      if (!mobileState.keys.length){
        mobileDaySelect.value = '';
        mobileDaySelect.disabled = true;
        mobileDaySelect.min = '';
        mobileDaySelect.max = '';
        return;
      }
      const minKey = mobileState.keys[0];
      const maxKey = mobileState.keys[mobileState.keys.length - 1];
      mobileDaySelect.min = minKey;
      mobileDaySelect.max = maxKey;
      mobileDaySelect.step = 1;
      mobileDaySelect.disabled = false;
      if (!mobileState.selectedKey){
        const firstWithSlots = mobileState.keys.find((key, idx)=>Boolean(mobileState.data[idx]?.set?.size));
        mobileState.selectedKey = firstWithSlots || mobileState.keys[0];
      }
      if (mobileDaySelect.value !== mobileState.selectedKey) mobileDaySelect.value = mobileState.selectedKey;
    }

    function updateMobileDaySummary(){
      if (!mobileDaySummary) return;
      const idx = mobileState.keys.indexOf(mobileState.selectedKey);
      const dayObj = idx>=0 ? mobileState.days[idx] : null;
      if (dayObj){
        mobileDaySummary.textContent = dayObj.toLocaleDateString(LOCALE, {weekday:'long', month:'short', day:'numeric'});
      }else if (mobileState.keys.length){
        mobileDaySummary.textContent = copy.mobilePickDayLabel;
      }else{
        mobileDaySummary.textContent = copy.noAvailabilityLabel;
      }
    }

    function applyMobileSelection(nextKey){
      if (!mobilePickerEl) return;
      if (!mobileState.keys.length){
        mobileState.selectedKey='';
        if (mobileDaySelect){
          mobileDaySelect.value = '';
          mobileDaySelect.disabled = true;
          mobileDaySelect.min = '';
          mobileDaySelect.max = '';
        }
        if (mobileSlotsEmpty){
          mobileSlotsEmpty.textContent = copy.noAvailabilityLabel;
          mobileSlotsEmpty.style.display='block';
        }
        if (mobileTimeSelect){
          mobileTimeSelect.value = '';
          mobileTimeSelect.disabled = true;
          mobileTimeSelect.min = '';
          mobileTimeSelect.max = '';
          mobileTimeSelect.step = '';
        }
        updateMobileDaySummary();
        return;
      }
      const prevKey = mobileState.selectedKey;
      const isValid = Boolean(nextKey && mobileState.keys.includes(nextKey));
      if (isValid){
        mobileState.selectedKey = nextKey;
      }else if (!mobileState.selectedKey){
        const firstWithSlots = mobileState.keys.find((key, idx)=>Boolean(mobileState.data[idx]?.set?.size));
        mobileState.selectedKey = firstWithSlots || mobileState.keys[0];
      }
      if (prevKey && mobileState.selectedKey && prevKey !== mobileState.selectedKey){
        current.slot = null;
        setSummaryDefault();
        updateSubmitState();
      }
      renderMobileDayOptions();
      updateMobileDaySummary();
      renderMobileSlots();
    }

    function renderMobileSlots(){
      if (!mobileTimeSelect) return;
      const idx = mobileState.keys.indexOf(mobileState.selectedKey);
      const entry = idx>=0 ? mobileState.data[idx] : null;
      const timeKeys = entry?.set ? Array.from(entry.set) : [];
      if (!timeKeys.length){
        if (mobileTimeSelect){
          mobileTimeSelect.value = '';
          mobileTimeSelect.disabled = true;
          mobileTimeSelect.min = '';
          mobileTimeSelect.max = '';
          mobileTimeSelect.step = '';
        }
        if (mobileSlotsEmpty){
          const dayObj = idx>=0 ? mobileState.days[idx] : null;
          const dayLabel = dayObj
            ? dayObj.toLocaleDateString(LOCALE, {weekday:'long', month:'short', day:'numeric'})
            : '';
          mobileSlotsEmpty.textContent = dayLabel
            ? `${copy.noOpenTimesOnPrefix} ${dayLabel}${copy.noOpenTimesOnSuffix}`
            : copy.noOpenTimesLabel;
          mobileSlotsEmpty.style.display='block';
        }
        syncSelectedSlotUI();
        return;
      }
      if (mobileSlotsEmpty) mobileSlotsEmpty.style.display='none';
      timeKeys.sort();
      if (mobileTimeSelect){
        mobileTimeSelect.disabled = false;
        mobileTimeSelect.min = timeKeys[0];
        mobileTimeSelect.max = timeKeys[timeKeys.length - 1];
        mobileTimeSelect.step = String(STEP_MIN * 60);
        const slotDate = current.slot ? parseISO(current.slot) : null;
        if (slotDate && ymd(slotDate) === mobileState.selectedKey){
          mobileTimeSelect.value = hmValue(slotDate);
        }else{
          mobileTimeSelect.value = '';
        }
      }
      syncSelectedSlotUI();
    }

    function updateMobilePicker(days, dayData){
      if (!mobilePickerEl) return;
      mobileState.keys = days.map(ymd);
      mobileState.days = days.map(d=>new Date(d));
      mobileState.data = dayData;
      if (!mobileState.keys.includes(mobileState.selectedKey)){
        mobileState.selectedKey = '';
      }
      applyMobileSelection(mobileState.selectedKey);
    }

    function updateSubmitState(){
      const ready = current.serviceId && current.masterId && current.slot && contactIsComplete();
      btnSubmit.disabled = !ready;
    }

    Object.values(contactInputs).forEach(input=>{
      input.addEventListener('input', ()=>{
        const payload = getContactPayload();
        contactDraft.name = payload.name;
        contactDraft.email = payload.email;
        contactDraft.phone = payload.phone;
        elError.style.display='none';
        updateSubmitState();
      });
    });

    hydrateContactForm();
    updateSubmitState();

    function openModal(serviceId, serviceName){
      current={ serviceId, serviceName, masterId:null, slot:null, mastersData:[] };
      mobileState.keys=[]; mobileState.days=[]; mobileState.data=[]; mobileState.selectedKey='';
      if (mobileDaySelect){
        mobileDaySelect.value = '';
        mobileDaySelect.disabled = true;
        mobileDaySelect.min = '';
        mobileDaySelect.max = '';
      }
      if (mobileDaySummary) mobileDaySummary.textContent = copy.mobilePickDayLabel;
      if (mobileSlotsEmpty) mobileSlotsEmpty.style.display='none';
      if (mobileTimeSelect){
        mobileTimeSelect.value = '';
        mobileTimeSelect.disabled = true;
        mobileTimeSelect.min = '';
        mobileTimeSelect.max = '';
        mobileTimeSelect.step = '';
      }
      elServiceName.textContent=serviceName;
      elError.style.display='none'; elSuccess.style.display='none';
      setSummaryDefault();
      availabilityCache.clear();
      syncSelectedSlotUI();
      baseStart = new Date(); baseStart.setHours(0,0,0,0);
      hydrateContactForm();
      updateSubmitState();
      modal.classList.add('modal--open');
      loadMastersAndRender();
    }

    async function fetchAvailability(dayISO, masterId){
      const params = new URLSearchParams({ service: current.serviceId, date: dayISO });
      if (masterId) params.set('master', masterId);
      const r = await fetch(`${apiAvail}?${params.toString()}`, {credentials:'same-origin'});
      if(!r.ok) throw new Error(copy.failedSlotsLabel);
      const data = await r.json();

      let slots = [];
      if (masterId){
        const m = (data.masters||[]).find(x => Number(x.id)===Number(masterId));
        slots = m ? (m.slots||[]) : [];
      }else{
        slots = (data.masters && data.masters[0] && data.masters[0].slots) ? data.masters[0].slots : [];
      }

      const set = new Set(); const map = new Map();
      slots.forEach(iso=>{
        const d=parseISO(iso); if(!d) return;
        const key=`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        set.add(key); if(!map.has(key)) map.set(key, iso);
      });
      return {set, map, raw:data};
    }

    async function ensureRangeLoaded(startDate, daysCount){
      const tasks=[];
      for(let i=0;i<daysCount;i++){
        const d=new Date(startDate); d.setDate(d.getDate()+i);
        const ds=ymd(d);
        if(!availabilityCache.has(ds)){
          tasks.push((async()=>{
            availabilityCache.set(ds, {loading:true});
            const res=await fetchAvailability(ds, Number(elMaster.value||current.masterId));
            availabilityCache.set(ds,{set:res.set, iso:res.map});
          })());
        }
      }
      if (tasks.length) await Promise.allSettled(tasks);
    }

    function buildTimeRows(extraSets){
      const out=[];
      for(let h=START_HOUR;h<=END_HOUR;h++){
        for(let m=0;m<60;m+=STEP_MIN){ out.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`); }
      }
      (extraSets||[]).forEach(s=>s && s.forEach(t=>{ if(!out.includes(t)) out.push(t); }));
      return out.sort();
    }

    function renderMasterPicker(masters){
      elMaster.innerHTML = '';
      elMasterPicker.innerHTML = '';

      masters.forEach(m=>{
        // Заполняем скрытый select (для доступности)
        const opt=document.createElement('option');
        opt.value=m.id;
        opt.textContent=m.name;
        elMaster.appendChild(opt);

        // Плитка с аватаркой
        const btn=document.createElement('button');
        btn.type='button';
        btn.className='master-pill';
        btn.setAttribute('role','option');
        btn.setAttribute('aria-pressed','false');
        btn.dataset.id=m.id;

        const img=document.createElement('img');
        img.src = m.photo || m.avatar || 'https://via.placeholder.com/56x56?text=%20'; /* поддержка поля photo из API */
        img.alt = '';
        const name=document.createElement('span');
        name.className='master-name';
        name.textContent=m.name;

        btn.appendChild(img);
        btn.appendChild(name);
        btn.addEventListener('click', async ()=>{
          elMasterPicker.querySelectorAll('.master-pill[aria-pressed="true"]').forEach(x=>x.setAttribute('aria-pressed','false'));
          btn.setAttribute('aria-pressed','true');

          elMaster.value = String(m.id);
          current.masterId = Number(m.id);
          current.slot = null;
          updateSubmitState();
          setSummaryDefault();
          syncSelectedSlotUI();
          availabilityCache.clear();
          await renderWindow();
        });

        elMasterPicker.appendChild(btn);
      });

      const withSlots = masters.find(mm => (mm.slots||[]).length);
      const pickId = withSlots ? withSlots.id : masters[0].id;
      elMaster.value = pickId;
      current.masterId = Number(pickId);
      const active = elMasterPicker.querySelector(`.master-pill[data-id="${pickId}"]`);
      if (active) active.setAttribute('aria-pressed','true');
    }

    async function loadMastersAndRender(){
      elError.style.display='none';
      current.slot=null;
      updateSubmitState();
      try{
        const first = await fetchAvailability(ymd(baseStart), null);
        const masters = (first.raw && first.raw.masters) || [];
        current.mastersData = masters;

        if(masters.length===0){
          elMaster.innerHTML='';
          elMasterPicker.innerHTML = '';
          const stub = document.createElement('div');
          stub.className = 'stub';
          stub.textContent = copy.noStaffLabel;
          elMasterPicker.appendChild(stub);
          olGrid.innerHTML='<div class="skeleton" style="height:240px;margin:.5rem;"></div>';
          return;
        }

        renderMasterPicker(masters);
        availabilityCache.clear();
        await renderWindow();
      }catch(err){
        elError.textContent = err.message || copy.availabilityErrorLabel;
        elError.style.display='block';
      }
    }

    async function renderWindow(){
      await ensureRangeLoaded(baseStart, WINDOW_DAYS);
      const days = Array.from({length:WINDOW_DAYS}, (_,i)=>{ const d=new Date(baseStart); d.setDate(d.getDate()+i); return d;});
      const dayStrs=days.map(ymd);
      const dayData = dayStrs.map(ds => availabilityCache.get(ds));
      const timeRows = buildTimeRows(dayData.map(x=>x?.set));
      const LOCALE = 'en-US'; // можно 'en-US'

      const from = days[0].toLocaleDateString(LOCALE, {month:'short', day:'numeric'});
      const to   = days[days.length-1].toLocaleDateString(LOCALE, {month:'short', day:'numeric'});
      olRange.textContent = `${from} – ${to}`;
      olGrid.style.setProperty('--days', String(WINDOW_DAYS));

      olGrid.innerHTML='';
      const headTime = document.createElement('div');
      headTime.className='outlook__cell outlook__head time';
      olGrid.appendChild(headTime);

      days.forEach(d=>{
        const h=document.createElement('div');
        h.className='outlook__cell outlook__head';
        if (new Date().toDateString()===d.toDateString()) h.classList.add('day--today');
        h.innerHTML = `<div class="day-head">
          <div class="day-title">${d.toLocaleDateString(LOCALE, {weekday:'long'})}</div>
          <div class="day-sub">${d.toLocaleDateString(LOCALE, {month:'short', day:'numeric'})}</div>
        </div>`;
        olGrid.appendChild(h);
      });

      timeRows.forEach(t=>{
        const [hh,mm]=t.split(':').map(n=>parseInt(n,10)); const fake=new Date(); fake.setHours(hh,mm,0,0);
        const tcell=document.createElement('div'); tcell.className='outlook__cell time'; tcell.textContent=fmtHM(fake);
        olGrid.appendChild(tcell);

        days.forEach((_,idx)=>{
          const c=document.createElement('div'); c.className='outlook__cell';
          const data = dayData[idx];
          const isoValue = data?.iso?.get(t) || '';
          const isFree = Boolean(isoValue && data?.set?.has(t));
          const chip=document.createElement('button');
          chip.type='button'; chip.className='slot-chip ' + (isFree?'slot-free':'slot-busy');
          chip.textContent=fmtHM(fake);
          if (isoValue) chip.dataset.slot = isoValue;

          if (isFree){
            chip.addEventListener('click', ()=>selectSlot(isoValue));
          }else{
            chip.disabled=true;
          }
          c.appendChild(chip);
          olGrid.appendChild(c);
        });
      });

      const todayIdx = days.findIndex(x=>x.toDateString()===new Date().toDateString());
      if (todayIdx>0){ const colWidth = 160; olWrap.scrollLeft = todayIdx * colWidth - colWidth; }
      updateMobilePicker(days, dayData);
      syncSelectedSlotUI();
    }

    async function shiftWindow(deltaDays){ baseStart = new Date(baseStart); baseStart.setDate(baseStart.getDate() + deltaDays); await renderWindow(); }
    olPrev.addEventListener('click', ()=>shiftWindow(-WINDOW_DAYS));
    olNext.addEventListener('click', ()=>shiftWindow(WINDOW_DAYS));
    olToday.addEventListener('click', async ()=>{ baseStart = new Date(); baseStart.setHours(0,0,0,0); await renderWindow(); });

    async function submitBooking(){
      if(!current.serviceId||!current.masterId||!current.slot) return;
      if(!contactIsComplete()){
        elError.textContent = copy.missingContactError;
        elError.style.display='block';
        return;
      }
      const contact = getContactPayload();
      btnSubmit.disabled=true; elError.style.display='none'; elSuccess.style.display='none';
      try{
        const resp=await fetch(apiBook,{
          method:'POST',
          headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')},
          credentials:'same-origin',
          body:JSON.stringify({
            service:current.serviceId,
            master:current.masterId,
            start_time:current.slot,
            contact
          })
        });
        const data=await resp.json().catch(()=>({}));
        if(!resp.ok){
          const contactErrors = data?.errors?.contact;
          let message = (contactErrors && Object.values(contactErrors).find(Boolean)) || data?.error || data?.detail || copy.createErrorLabel;
          if (Array.isArray(message)) message = message[0];
          throw new Error(message);
        }
        elSuccess.textContent = copy.createdLabel + ' ' + (data.appointment?.start_time ? (copy.timeLabel + ' ' + new Date(data.appointment.start_time).toLocaleString()) : '');
        elSuccess.style.display='block';
        setTimeout(()=>{ window.location.reload(); }, 700);
      }catch(err){
        elError.textContent = err.message || copy.bookingErrorLabel;
        elError.style.display='block';
        updateSubmitState();
      }
    }

    // Открытие модалки с карточек/кнопок
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.book-btn');
      if (btn){
        openModal(btn.dataset.serviceId, btn.dataset.serviceName || 'service');
        return;
      }
      const isInteractive = e.target.closest('button, a, select, input, textarea, label');
      if (isInteractive) return;
      const card = e.target.closest('.service-card[data-service-id]');
      if (card){
        openModal(card.dataset.serviceId, card.dataset.serviceName || 'service');
      }
    });
    document.addEventListener('keydown', (e)=>{
      if (!['Enter',' '].includes(e.key)) return;
      const card = document.activeElement;
      if (card && card.matches('.service-card[data-service-id]')){
        e.preventDefault();
        openModal(card.dataset.serviceId, card.dataset.serviceName || 'service');
      }
    });

    function maybeOpenDeepLinkedService(){
      const params = new URLSearchParams(window.location.search);
      const serviceId = (params.get('book') || '').trim();
      if (!serviceId) return;

      const cleanupQuery = () => {
        const url = new URL(window.location.href);
        url.searchParams.delete('book');
        const nextSearch = url.searchParams.toString();
        const nextUrl = url.pathname + (nextSearch ? `?${nextSearch}` : '') + (url.hash || '');
        window.history.replaceState({}, document.title, nextUrl);
      };

      const attemptOpen = (retries = 6) => {
        const safeId = window.CSS && CSS.escape ? CSS.escape(serviceId) : serviceId.replace(/"/g, '\\"');
        const card = document.querySelector(`.service-card[data-service-id="${safeId}"]`);
        if (card){
          const serviceName = card.dataset.serviceName || card.querySelector('h3')?.textContent?.trim() || 'service';
          openModal(serviceId, serviceName);
          card.scrollIntoView({ behavior: 'smooth', block: 'center' });
          cleanupQuery();
          return;
        }
        if (retries > 0){
          setTimeout(() => attemptOpen(retries - 1), 200);
        }
      };

      attemptOpen();
    }

    maybeOpenDeepLinkedService();

    btnClose.addEventListener('click',()=>modal.classList.remove('modal--open'));
    btnCancel.addEventListener('click',()=>modal.classList.remove('modal--open'));
    modal.addEventListener('click',(e)=>{ if(e.target===modal) modal.classList.remove('modal--open'); });
    btnSubmit.addEventListener('click',submitBooking);

    // Горизонтальный скролл
    olWrap.addEventListener('wheel', (e)=>{
      if (e.shiftKey && Math.abs(e.deltaY) > Math.abs(e.deltaX)) { e.preventDefault(); olWrap.scrollLeft += e.deltaY; }
    }, { passive:false });

    /* ===== Live search ===== */
    const qInput = document.querySelector('input[name="q"]');
    const catSel = document.querySelector('select[name="cat"]');
    const liveTitle = document.getElementById('liveTitle');
    const liveGrid  = document.getElementById('liveGrid');
    const serverContent = document.getElementById('serverContent');
    const resetLink = document.querySelector('a.btn.btn--ghost[href*="client-dashboard"]');
    const searchCopy = {
      contactForEstimate: "{{ services_copy.contact_for_estimate_label|escapejs }}",
      fromLabel: "{{ services_copy.from_label|escapejs }}",
      pickTimeLabel: "{{ services_copy.pick_time_label|escapejs }}",
      durationSeparator: "{{ services_copy.duration_separator|escapejs }}",
      durationUnit: "{{ services_copy.duration_unit|escapejs }}",
      serviceImageAriaLabel: "{{ services_copy.service_image_aria_label|escapejs }}",
      serviceImageFallback: "{{ services_copy.service_image_fallback_label|escapejs }}",
      bookAriaPrefix: "{{ services_copy.book_aria_prefix|escapejs }}",
      liveNoResults: "{{ services_copy.live_no_results_label|escapejs }}",
      liveError: "{{ services_copy.live_error_label|escapejs }}",
    };

    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function formatMoney(val){
      const num = Number(val);
      if (Number.isFinite(num)) return num.toFixed(2);
      return val || '';
    }
    function showLive(){ liveTitle.style.display='block'; liveGrid.style.display='grid'; serverContent.style.display='none'; }
    function hideLive(){ liveTitle.style.display='none'; liveGrid.style.display='none'; serverContent.style.display='block'; }
    function skeleton(n=8){
      return Array.from({length:n}).map(()=>`
        <article class="service-card" aria-hidden="true">
          <div class="service-card__img skeleton" style="height:auto; aspect-ratio:16/9;"></div>
          <div class="skeleton" style="height:18px;margin-top:10px;border-radius:6px;"></div>
          <div class="skeleton" style="height:14px;margin-top:6px;border-radius:6px;"></div>
          <div class="skeleton" style="height:36px;margin-top:12px;border-radius:10px;"></div>
        </article>`).join('');
    }
    function cardHTML(s){
      let priceBlock;
      if (s.contact_for_estimate){
        const fromVal = s.estimate_from_price ? formatMoney(s.estimate_from_price) : '';
        const hint = fromVal ? `<span class="price__hint">${escapeHtml(searchCopy.fromLabel)} $${escapeHtml(fromVal)}</span>` : '';
        priceBlock = `<strong>${escapeHtml(searchCopy.contactForEstimate)}</strong>${hint ? ' ' + hint : ''}`;
      } else {
        const hasDisc = Number.isFinite(+s.discount_percent) && +s.discount_percent > 0;
        if (hasDisc){
          priceBlock = `<span class="old">$${escapeHtml(formatMoney(s.base_price))}</span>
             <strong>$${escapeHtml(formatMoney(s.price))}</strong>
             <span class="badge">-${escapeHtml(String(s.discount_percent))}%</span>`;
        } else {
          const current = s.price || s.base_price;
          priceBlock = `<strong>$${escapeHtml(formatMoney(current))}</strong>`;
        }
      }
      const desc = s.description ? `<p class="muted">${escapeHtml(s.description)}</p>` : '';
      const cat  = s.category ? `<div class="muted">${escapeHtml(s.category)}</div>` : '';
      const hasImage = typeof s.image === 'string' && s.image.trim().length > 0;
      const media = hasImage
        ? `<img src="${escapeHtml(s.image)}" alt="${escapeHtml(s.name)}" loading="lazy" decoding="async">`
        : `<div class="ph" aria-hidden="true">${escapeHtml(searchCopy.serviceImageFallback)}</div>`;
      const badge = s.category ? `<span class="service-card__badge">${escapeHtml(s.category)}</span>` : '';
      const durationBits = [searchCopy.durationSeparator, String(s.duration_min), searchCopy.durationUnit]
        .filter(Boolean)
        .map(escapeHtml)
        .join(" ");
      return `
        <article class="service-card"
                 data-service-id="${escapeHtml(s.id)}"
                 data-service-name="${escapeHtml(s.name)}"
                 tabindex="0" role="button" aria-label="${escapeHtml(searchCopy.bookAriaPrefix)} ${escapeHtml(s.name)}">
          <div class="service-card__img" aria-label="${escapeHtml(searchCopy.serviceImageAriaLabel)}">
            ${media}
            ${badge}
          </div>
          ${cat}
          <h3>${escapeHtml(s.name)}</h3>
          ${desc}
          <div class="service-meta">${priceBlock} ${durationBits}</div>
          <button class="btn btn--primary book-btn"
                  type="button"
                  data-service-id="${escapeHtml(s.id)}"
                  data-service-name="${escapeHtml(s.name)}">${escapeHtml(searchCopy.pickTimeLabel)}</button>
        </article>`;
    }

    let aborter=null;
    async function fetchServices(q, cat){
      if (aborter) aborter.abort();
      aborter = new AbortController();
      const params = new URLSearchParams();
      if (q)   params.set('q', q);
      if (cat) params.set('cat', cat);
      const url = `/accounts/api/services/search/?${params.toString()}`;
      const r = await fetch(url, { signal: aborter.signal, credentials: 'same-origin' });
      if (!r.ok) throw new Error('Failed to load');
      return r.json();
    }

    const runSearch = debounce(async ()=>{
      const q   = qInput?.value?.trim() || '';
      const cat = catSel?.value || '';
      if (!q && !cat) { hideLive(); return; }
      showLive();
      liveGrid.innerHTML = skeleton();
      try{
        const data = await fetchServices(q, cat);
        const items = (data && data.results) || [];
        liveGrid.innerHTML = items.length ? items.map(cardHTML).join('') : `<div class="stub">${escapeHtml(searchCopy.liveNoResults)}</div>`;
      }catch(e){
        liveGrid.innerHTML = `<div class="stub">${escapeHtml(searchCopy.liveError)}</div>`;
      }
    }, 300);

    if (qInput) qInput.addEventListener('input', runSearch);
    if (catSel) catSel.addEventListener('change', runSearch);
    if (resetLink){
      resetLink.addEventListener('click', (e)=>{
        e.preventDefault();
        if (qInput) qInput.value = '';
        if (catSel) catSel.value = '';
        hideLive();
        document.getElementById('services')?.scrollIntoView({behavior:'smooth', block:'start'});
      });
    }
  })();
</script>
<!-- ===== CONTACT FAB + MODAL (BGM) =================================== -->
<style id="contact-fab-css">
  :root{
    --ink:#eaeaea; --line:rgba(255,255,255,.12);
    --red:var(--accent, #d50000); --red-dark:#b60000;
    --contact-font:"Helvetica Neue", Arial, sans-serif;
  }
  /* floating button */
  .contact-fab{
    position:fixed; right:22px; bottom:22px; z-index:2100;
    display:inline-flex; align-items:center; gap:.6em;
    padding:.9rem 1.15rem; border-radius:999px;
    border:1px solid rgba(255,255,255,.08);
    background:linear-gradient(180deg,var(--red) 0%,var(--red-dark) 100%);
    color:#fff; font-weight:900; letter-spacing:.02em; line-height:1;
    cursor:pointer; box-shadow:0 12px 26px rgba(213,0,0,.28), 0 0 26px rgba(213,0,0,.18);
    transition:.18s ease; font-family:var(--contact-font); font-style:normal;
  }
  .contact-fab:hover{ transform:translateY(-2px); filter:saturate(1.05); }
  .contact-fab:focus-visible{ outline:2px solid #fff; outline-offset:3px; }
  .contact-fab svg{ width:20px; height:20px; fill:currentColor; opacity:.95; }

  /* modal */
  .contact-modal{
    position:fixed; inset:0; z-index:2200; display:none;
    align-items:center; justify-content:center; padding:1rem;
    background:rgba(0,0,0,.65); backdrop-filter:blur(2px);
  }
  .contact-modal[open]{ display:flex; }
  .contact-dialog{
    width:min(560px, 92vw);
    background:linear-gradient(180deg,#0c0c0c,#121212);
    border:1px solid var(--line); border-radius:1rem;
    padding:1.1rem 1.1rem .95rem; color:var(--ink);
    box-shadow:0 18px 44px rgba(0,0,0,.55), 0 0 32px rgba(213,0,0,.18);
    position:relative;
  }
  .contact-title{
    font-family:var(--font-head,"Ford"),system-ui,sans-serif;
    font-weight:900; letter-spacing:.005em; line-height:1.15;
    font-size:1.6rem; margin:.2rem 2.2rem 1rem .2rem; color:#fff;
    text-transform:none;
  }
  .contact-close{
    position:absolute; right:12px; top:10px; width:36px; height:36px;
    border:1px solid var(--line); border-radius:.5rem; background:#0f0f0f;
    color:#bdbdbd; cursor:pointer; font-size:20px; line-height:1;
  }
  .contact-body{ display:grid; gap:.75rem; }
  .contact-row{
    display:flex; align-items:center; justify-content:space-between; gap:.6rem;
    background:rgba(255,255,255,.06); border:1px solid var(--line);
    border-radius:.7rem; padding:.7rem .8rem;
    font-family:var(--contact-font); font-style:normal;
  }
  .contact-row a{ color:#fff; font-weight:800; text-decoration:none; }
  .contact-sub{ color:rgba(255,255,255,.72); font-size:.95rem; }
  .contact-actions{ display:flex; gap:.6rem; margin-top:.9rem; flex-wrap:wrap; }
  .contact-btn{
    display:inline-flex; align-items:center; gap:.5em; padding:.7rem 1rem; border-radius:.55rem;
    border:1px solid var(--line); background:#0f0f0f; color:#fff; cursor:pointer;
    font-family:var(--contact-font); font-weight:800; font-style:normal;
  }
  .contact-btn:hover{ border-color:rgba(213,0,0,.45); box-shadow:0 0 16px rgba(213,0,0,.25); }

  /* hide everywhere if needed: add .no-contact-fab to <body> */
  body.no-contact-fab .contact-fab{ display:none !important; }

  @media (max-width:640px){
    .contact-fab{ right:14px; bottom:14px; }
    .contact-title{ font-size:1.45rem; }
  }


</style>
<style>
/* === MOBILE ADAPTATION PATCH (safe, additive) ========================== */
/* 0) Unified mobile sidebar (same on all pages) */
@media (max-width:960px){
  body.nav-open{ overflow:hidden; }
  .site-header{ z-index:10000 !important; }
  .site-header__toggle{ position:relative; z-index:10002 !important; }
  .site-header nav{
    position:fixed !important;
    inset:0 !important;
    height:100dvh !important;
    padding-top:calc(var(--site-header-height) + 1rem) !important;
    padding-inline:clamp(20px,6vw,36px) !important;
    padding-bottom:calc(28px + env(safe-area-inset-bottom)) !important;
    background:rgba(6,6,6,.62) !important;
    -webkit-backdrop-filter:blur(24px) saturate(1.2) !important;
    backdrop-filter:blur(24px) saturate(1.2) !important;
    display:flex !important;
    align-items:flex-start !important;
    opacity:0;
    pointer-events:none;
    transform:translateY(-12px);
    transition:opacity .22s ease, transform .22s ease;
    overflow-y:auto !important;
    overscroll-behavior:contain;
    z-index:10001 !important;
  }
  .site-header--open nav,
  body.nav-open nav,
  .site-header .site-header__toggle[aria-expanded="true"] ~ nav{
    opacity:1 !important;
    pointer-events:auto !important;
    transform:translateY(0) !important;
  }
  .site-header nav ul{
    flex-direction:column !important;
    align-items:stretch !important;
    gap:1rem !important;
    width:100% !important;
  }
  .site-header nav li{ width:100% !important; }
  .site-header nav a,
  .site-header nav .btn,
  .site-header nav .btn--ghost{
    width:100% !important;
    min-height:56px;
    padding:1.1rem 1.2rem !important;
    border-radius:1rem !important;
    background:rgba(255,255,255,.05) !important;
    border:1px solid rgba(255,255,255,.12) !important;
    display:flex !important;
    align-items:center !important;
    justify-content:space-between !important;
  }
}
/* 1) Header/menu layers & mobile nav behavior (поверх FAB и контента) */
.site-header{ z-index:3200; } /* выше контента и FAB */
@media (max-width:960px){
  .site-header nav{
    z-index:3300;                       /* меню поверх FAB */
    overflow-y:auto; -webkit-overflow-scrolling:touch;
  }
  /* Открытие меню работает при .site-header--open и при body.nav-open */
  .site-header--open nav,
  body.nav-open nav{
    opacity:1; pointer-events:auto; transform:translateY(0);
  }
  /* Больше расстояние и уверенные hit‑areas */
  .site-header nav ul{
    gap:1.1rem !important;
    width:100%; padding-block:.25rem;
  }
  .site-header nav li{ width:100%; }
  .site-header nav a,
  .site-header nav .btn,
  .site-header nav .btn--ghost{
    width:100% !important;
    display:flex !important; align-items:center; justify-content:space-between;
    padding:1.15rem 1.2rem !important; min-height:56px;
    border-radius:1rem !important;
    background:rgba(255,255,255,.05) !important;
    border:1px solid rgba(255,255,255,.12) !important;
    box-shadow:0 8px 24px rgba(0,0,0,.35);
  }
  .site-header nav a:hover,
  .site-header nav a[aria-current="page"],
  .site-header nav .btn:hover{
    background:rgba(255,255,255,.1) !important;
    border-color:rgba(255,255,255,.22) !important;
    color:#fff !important;
  }
}
/* Прячем FAB при открытом мобильном меню (любой вариант открытия) */
body.nav-open .contact-fab,
.site-header--open ~ .contact-fab{
  display:none !important;
}

/* 2) Фильтры — на телефоне в столбик, элементы на всю ширину */
@media (max-width:720px){
  .filters{ display:grid; grid-template-columns:1fr; gap:.6rem; }
  .filters input, .filters select, .filters .btn{ width:100%; }
}

/* 3) Карточки — компактнее паддинги и уверенная кнопка */
@media (max-width:720px){
  .service-card{ padding:.9rem; }
  .service-card__img{ aspect-ratio:16/10; }
  .service-card .btn{ width:100%; }
}

/* 4) Модалка — одна колонка и крупнее слоты на телефоне */
@media (max-width:900px){
  .grid-2{ grid-template-columns:1fr; }
  .outlook__wrap{ max-height:50svh; } /* iOS‑friendly */
  .slot-chip{ min-width:3.1rem; height:2rem; font-size:.95rem; }
  .modal__footer{
    position:sticky; bottom:0;
    background:linear-gradient(180deg, rgba(0,0,0,0), #0c0c0c);
    padding-top:.75rem;
  }
}

/* 5) Аккуратные фокусы для iOS */
.site-header nav a:focus{ outline:none; }
.site-header nav a:focus-visible{
  outline:2px solid rgba(255,255,255,.6); outline-offset:3px;
  border-color:rgba(255,255,255,.22);
}

/* 6) FAB с учётом safe‑area и скрытие, когда открыта любая модалка */
.contact-fab{ bottom:calc(22px + env(safe-area-inset-bottom)); }
body.modal-open .contact-fab{ display:none !important; }

/* 7) Mobile density reset for services catalog */
@media (max-width:760px){
  main.container{ padding-block:2.2rem !important; }
  .hero{ padding:3.4rem 1rem 2.4rem; gap:.9rem; }
  .hero h1{ font-size:clamp(1.9rem, 7vw, 2.6rem); letter-spacing:.4px; }
  .hero p{ font-size:1rem; }
  h2{ font-size:1.35rem; margin-bottom:.9rem; }
  #liveTitle,
  #serverContent > h3{
    font-size:1.05rem;
    margin:1.1rem 0 .6rem !important;
    letter-spacing:.4px;
  }
  .filters{ gap:.55rem; padding:.75rem; border-radius:1rem; }
  .filters input, .filters select, .filters .btn{
    min-height:48px;
    font-size:1rem;
  }
  .services-grid{ grid-template-columns:1fr !important; gap:1rem; }
  .service-card{ padding:1rem; gap:.6rem; }
  .service-card__img{ aspect-ratio:4/3; border-radius:.85rem; }
  .service-card h3{ font-size:1.05rem; }
  .service-card > div.muted{ display:none; }
  .service-card p.muted{
    font-size:.92rem;
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
    overflow:hidden;
  }
  .service-meta{ font-size:.88rem; gap:.25rem .6rem; row-gap:.35rem; }
  .service-meta .price__hint{ font-size:.75rem; }
  .service-card .btn{ width:100%; }
  .stub{ padding:.85rem; }
}
@media (max-width:480px){
  .service-card__badge{ font-size:.64rem; padding:.14rem .45rem; }
  .service-meta{ font-size:.85rem; }
}

/* 7b) Mobile booking picker — simplify dates/time */
@media (max-width:768px){
  .mobile-picker{ padding:.85rem; gap:.8rem; }
  .mobile-picker__headline{ flex-direction:column; align-items:flex-start; gap:.4rem; }
  .mobile-picker__eyebrow{ display:none; }
  .mobile-day-scroll{ gap:.35rem; }
  .mobile-day-pill{ min-width:88px; padding:.5rem .6rem; }
  .mobile-picker__slots{ grid-template-columns:1fr; }
  .mobile-slot-btn{ width:100%; }
  .mobile-picker__label{ font-size:.75rem; }
}

/* 8) Меньше анимаций при reduce motion */
@media (prefers-reduced-motion:reduce){
  .skeleton, .ph{ animation:none !important; }
  .btn, .service-card{ transition:none !important; }
}
</style>

<button type="button" id="contactFab" class="contact-fab"
        aria-haspopup="dialog" aria-controls="contactModal" aria-expanded="false">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M6.6 10.8c1.5 2.9 3.7 5.1 6.6 6.6l2.2-2.2c.3-.3.8-.4 1.2-.3 1 .3 2.1.5 3.2.5.7 0 1.2.5 1.2 1.2v3.5c0 .7-.5 1.2-1.2 1.2C9.8 21.5 2.5 14.2 2.5 4.2c0-.7.5-1.2 1.2-1.2H7c.7 0 1.2.5 1.2 1.2 0 1.1.2 2.2.5 3.2.1.4 0 .9-.3 1.2L6.6 10.8z"/>
  </svg>
  {{ services_copy.contact_fab_label }}
</button>

<div id="contactModal" class="contact-modal" role="dialog" aria-modal="true" aria-labelledby="contactTitle">
  <div class="contact-dialog">
    <button class="contact-close" type="button" aria-label="{{ services_copy.contact_close_label }}">×</button>
    <h2 id="contactTitle" class="contact-title">{{ services_copy.contact_modal_title }}</h2>

    <div class="contact-body">
      <div class="contact-row">
        <div>
          <div><a href="mailto:support@badguymotors.com">support@badguymotors.com</a></div>
          <div class="contact-sub">{{ services_copy.contact_email_label }}</div>
        </div>
        <button class="contact-btn" data-copy="support@badguymotors.com" type="button">{{ services_copy.contact_copy_label }}</button>
      </div>

      <div class="contact-row">
        <div>
          <div><a href="tel:+14035250432">(403) 525-0432</a></div>
          <div class="contact-sub">{{ services_copy.contact_phone_label }}</div>
        </div>
        <div style="display:flex;gap:.5rem;flex-wrap:wrap">
          <a class="contact-btn" href="tel:+14035250432">{{ services_copy.contact_call_label }}</a>
          <button class="contact-btn" data-copy="+1 403 525 0432" type="button">{{ services_copy.contact_copy_label }}</button>
        </div>
      </div>

      <div class="contact-actions">
        <a class="contact-btn" href="mailto:support@badguymotors.com?subject=Inquiry%20from%20website">{{ services_copy.contact_write_email_label }}</a>
        <a class="contact-btn" href="sms:+14035250432">{{ services_copy.contact_text_label }}</a>
</div>
</div>
</div>
</div>

<script src="{% static 'js/topbar.js' %}"></script>

<script id="contact-fab-js">
(function(){
  const fab   = document.getElementById('contactFab');
  const modal = document.getElementById('contactModal');
  const closeBtn = modal.querySelector('.contact-close');
  const copyLabel = "{{ services_copy.contact_copy_label|escapejs }}";
  const copySuccess = "{{ services_copy.contact_copy_success_label|escapejs }}";
  const copyFailed = "{{ services_copy.contact_copy_failed_label|escapejs }}";
  let lastFocus = null;

  function openModal(){
    lastFocus = document.activeElement;
    modal.setAttribute('open','');
    fab.setAttribute('aria-expanded','true');
    setTimeout(()=>closeBtn.focus(),0);
    document.addEventListener('keydown', onKey);
  }
  function closeModal(){
    modal.removeAttribute('open');
    fab.setAttribute('aria-expanded','false');
    if (lastFocus) lastFocus.focus();
    document.removeEventListener('keydown', onKey);
  }
  function onKey(e){
    if (e.key === 'Escape') closeModal();
    if (e.key === 'Tab'){
      const focusables = modal.querySelectorAll('a,button,[tabindex]:not([tabindex="-1"])');
      const list = Array.from(focusables).filter(el=>!el.disabled && el.offsetParent!==null);
      if(!list.length) return;
      const first = list[0], last = list[list.length-1];
      if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
    }
  }

  fab.addEventListener('click', openModal);
  closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

  // copy helpers
  modal.querySelectorAll('[data-copy]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(btn.dataset.copy); btn.textContent=copySuccess; setTimeout(()=>btn.textContent=copyLabel,1200); }
      catch{ btn.textContent=copyFailed; setTimeout(()=>btn.textContent=copyLabel,1200); }
    });
  });
})();
</script>
<!-- ==================================================================== -->
<script>
/* === MOBILE ADAPTATION PATCH (safe, additive) ========================== */
(function(){
  /* 1) Отслеживаем состояние модалки бронирования и прячем FAB без правок вашего кода */
  const bookModal = document.getElementById('bookModal');
  if (bookModal){
    const syncModalFlag = () => {
      document.body.classList.toggle('modal-open', bookModal.classList.contains('modal--open'));
    };
    syncModalFlag();
    new MutationObserver(syncModalFlag).observe(bookModal, { attributes:true, attributeFilter:['class'] });
  }

  /* 2) Подсказка для тач‑устройств: меняем текст про скролл */
  const hintEl = document.querySelector('.hint');
  const hintMobile = "{{ services_copy.booking_scroll_hint_mobile|escapejs }}";
  const hintDesktop = "{{ services_copy.booking_scroll_hint_desktop|escapejs }}";
  if (hintEl){
    const mq = window.matchMedia('(pointer: coarse)');
    const setHint = () => {
      hintEl.textContent = mq.matches ? hintMobile : hintDesktop;
    };
    setHint();
    try{ mq.addEventListener('change', setHint); }catch(_){ mq.onchange = setHint; }
  }

  /* 3) Drag‑scroll для сетки расписания на трекпадах/тачпадах */
  const wrap = document.getElementById('olWrap');
  if (wrap){
    let down=false, startX=0, base=0, pointerId=null;
    const interactiveSelector='button, a, input, select, textarea, label';
    const isInteractiveTarget = (target)=>!!(target && target.closest(interactiveSelector));
    wrap.addEventListener('pointerdown', e => {
      if (isInteractiveTarget(e.target)) return;
      down = true; pointerId = e.pointerId;
      startX = e.clientX; base = wrap.scrollLeft;
      if (typeof wrap.setPointerCapture === 'function'){
        try{ wrap.setPointerCapture(pointerId); }catch(_){}
      }
    });
    wrap.addEventListener('pointermove', e => {
      if (!down || (pointerId!==null && e.pointerId!==pointerId)) return;
      wrap.scrollLeft = base - (e.clientX - startX);
    });
    const stopDrag = (e) => {
      if (!down || (pointerId!==null && e.pointerId!==pointerId)) return;
      down = false;
      if (pointerId!==null && typeof wrap.releasePointerCapture === 'function'){
        try{ wrap.releasePointerCapture(pointerId); }catch(_){}
      }
      pointerId = null;
    };
    ['pointerup','pointercancel','pointerleave'].forEach(ev => {
      wrap.addEventListener(ev, stopDrag);
    });
  }
})();
</script>



<!-- === Mobile sidebar hardening (safe, additive) ======================= -->




{% include "includes/analytics_tracker.html" %}


</body>
</html>
