{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Malva Booking ‚Äî –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --brand:#7e57c2; --brand-dark:#6546b4; --bg-light:#fafafa; --text-main:#333; --text-muted:#666; --radius-lg:1.25rem; --radius-sm:.5rem; --shadow:0 6px 18px rgba(0,0,0,.08); --container:clamp(280px,90vw,1180px); }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html{font-size:16px;scroll-behavior:smooth}
    body{font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;background:var(--bg-light);color:var(--text-main);line-height:1.45;}
    img{max-width:100%;display:block}
    a{color:inherit;text-decoration:none}
    .container{width:var(--container);margin-inline:auto;padding-inline:1rem;}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.4em;padding:.75rem 1.75rem;border-radius:var(--radius-sm);font-weight:600;cursor:pointer;transition:.25s all;white-space:nowrap;user-select:none}
    .btn--primary{background:var(--brand);color:#fff;border:none;}
    .btn--primary:hover{background:var(--brand-dark);transform:translateY(-2px);}
    .btn--ghost{background:transparent;color:var(--brand);border:2px solid {--brand};}
    .btn--ghost[disabled]{opacity:.45;cursor:not-allowed}
    .site-header{background:#fff;box-shadow:var(--shadow);position:sticky;top:0;z-index:100;padding-block:.75rem;}
    .site-header__inner{display:flex;align-items:center;justify-content:space-between;}
    .logo{font-size:1.25rem;font-weight:700;color:var(--brand)}
    .hero{display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center;gap:1.5rem;padding:6rem 1rem;background:linear-gradient(135deg,#f7f7ff 0%,#ebe2ff 100%);}
    .hero h1{font-size:clamp(2rem,4vw,3.5rem);font-weight:800;color:var(--brand)}
    .hero p{font-size:1.125rem;color:var(--text-muted)}
    .filters{display:flex;flex-wrap:wrap;gap:.75rem;margin-bottom:1.5rem}
    .filters input,.filters select{padding:.6rem 1rem;border:1px solid #ccc;border-radius:var(--radius-sm);font-size:.9rem;min-width:160px;background:#fff;}
    .services-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1.25rem;}
    .service-card{background:#fff;border-radius:var(--radius-lg);padding:1.5rem;display:flex;flex-direction:column;gap:1rem;box-shadow:var(--shadow);transition:.25s}
    .service-card:hover{transform:translateY(-4px);box-shadow:0 10px 28px rgba(0,0,0,.12)}
    .service-card__img{aspect-ratio:16/9;background:#e6e1f5;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:.9rem;color:#aaa}
    .service-card h3{font-size:1.1rem;font-weight:700;color:var(--text-main)}
    .service-meta{font-size:.85rem;color:var(--text-muted);}
    .stub{font-style:italic;color:var(--text-muted);padding:1rem}
    .muted{color:#666;font-size:.85rem}
    .old{color:#999;text-decoration:line-through}
    .badge{font-size:.75rem;background:#ffe7ec;color:#c1003f;border-radius:999px;padding:.15rem .5rem}
    .debug{background:#fff7cd;border:1px dashed #e2a400;border-radius:10px;padding:.75rem 1rem;margin:1rem 0;font-size:.9rem;color:#715100}
    .debug code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .site-footer{text-align:center;font-size:.875rem;color:var(--text-muted);padding:2rem 1rem}
  </style>
</head>
<body>
  <!-- header -->
  <header class="site-header">
    <div class="container site-header__inner">
      <span class="logo">Malva Booking</span>
      <nav>
        {% if user.is_authenticated %}
          <!-- –≤–µ–¥—ë–º –Ω–∞–ø—Ä—è–º—É—é –≤ –∫–∞–±–∏–Ω–µ—Ç -->
          <a href="{% url 'dashboard' %}" class="btn btn--ghost">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
        {% else %}
          <!-- –¥–ª—è –≥–æ—Å—Ç–µ–π: –Ω–∞ –ª–æ–≥–∏–Ω —Å next=dashboard -->
          <a href="{% url 'login' %}?next={% url 'dashboard' %}" class="btn btn--ghost">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
        {% endif %}
      </nav>
    </div>
  </header>

  <!-- hero -->
  <section class="hero">
    <h1>–û–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å—å –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É –∑–∞ 2 –∫–ª–∏–∫–∞</h1>
    <p>–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É, –º–∞—Å—Ç–µ—Ä–∞ –∏ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è ‚Äî –º—ã –ø–æ–∑–∞–±–æ—Ç–∏–º—Å—è –æ–±–æ –≤—Å—ë–º –æ—Å—Ç–∞–ª—å–Ω–æ–º</p>
    <a href="#services" class="btn btn--primary">–ö–∞—Ç–∞–ª–æ–≥ —É—Å–ª—É–≥ ‚Üì</a>
  </section>

  <main id="services" class="container" style="padding-block:3rem;">
    <h2 style="font-size:1.75rem;font-weight:700;margin-bottom:1.5rem;">–ö–∞—Ç–∞–ª–æ–≥ —É—Å–ª—É–≥</h2>

    <!-- üîé –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ -->
    <div class="debug">
      <div><strong>DEBUG:</strong>
        categories=<code>{{ categories|length }}</code>,
        filter_categories=<code>{{ filter_categories|length }}</code>,
        has_any_services=<code>{{ has_any_services }}</code>,
        q=<code>{{ q }}</code>,
        active_category=<code>{{ active_category }}</code>,
        uncategorized=<code>{% if uncategorized %}yes{% else %}no{% endif %}</code>
      </div>
      {% if categories %}
        <div style="margin-top:.5rem">
          {% for c in categories %}
            <div>cat ¬´{{ c.name }}¬ª: <code>{{ c.service_set.all|length }}</code> —É—Å–ª—É–≥</div>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <form method="get" class="filters" role="search">
      <input type="search" name="q" placeholder="–ü–æ–∏—Å–∫ —É—Å–ª—É–≥–∏‚Ä¶" value="{{ q|default:'' }}">
      <select name="cat">
        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
        {% for c in filter_categories %}
          <option value="{{ c.id }}" {% if active_category == c.id|stringformat:'s' %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
      <button class="btn btn--primary" type="submit">–ù–∞–π—Ç–∏</button>
      {% if q or active_category %}
        <!-- —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥ -->
        <a class="btn btn--ghost" href="{% url 'client-dashboard' %}#services">–°–±—Ä–æ—Å–∏—Ç—å</a>
      {% endif %}
    </form>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
    {% if search_results %}
      <h3 style="margin:.5rem 0 1rem;">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h3>
      <div class="services-grid">
        {% for s in search_results %}
          <article class="service-card">
            <div class="service-card__img">IMG</div>
            <div class="muted">{{ s.category.name }}</div>
            <h3>{{ s.name }}</h3>
            {% if s.description %}<p class="muted">{{ s.description|truncatewords:22 }}</p>{% endif %}
            <div class="service-meta">
              {% with disc=s.get_active_discount %}
                {% if disc %}
                  <span class="old">${{ s.base_price|floatformat:2 }}</span>
                  <strong>${{ s.get_discounted_price|floatformat:2 }}</strong>
                  <span class="badge">-{{ disc.discount_percent }}%</span>
                {% else %}
                  <strong>${{ s.base_price|floatformat:2 }}</strong>
                {% endif %}
              {% endwith %}
              ¬∑ {{ s.duration_min }} –º–∏–Ω
            </div>
            <button class="btn btn--primary" disabled title="–°–∫–æ—Ä–æ">–í—ã–±—Ä–∞—Ç—å –≤—Ä–µ–º—è</button>
          </article>
        {% empty %}
          <div class="stub">–ü–æ –∑–∞–ø—Ä–æ—Å—É ¬´{{ q }}¬ª –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>
        {% endfor %}
      </div>
      <hr style="margin:2rem 0;border:none;border-top:1px solid #eee">
    {% endif %}

    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ + —É—Å–ª—É–≥–∏ -->
    {% for c in categories %}
      <h3 style="margin:1.5rem 0 .75rem;">{{ c.name }}</h3>
      <div class="services-grid">
        {% for s in c.service_set.all %}
          <article class="service-card">
            <div class="service-card__img">IMG</div>
            <h3>{{ s.name }}</h3>
            {% if s.description %}<p class="muted">{{ s.description|truncatewords:22 }}</p>{% endif %}
            <div class="service-meta">
              {% with disc=s.get_active_discount %}
                {% if disc %}
                  <span class="old">${{ s.base_price|floatformat:2 }}</span>
                  <strong>${{ s.get_discounted_price|floatformat:2 }}</strong>
                  <span class="badge">-{{ disc.discount_percent }}%</span>
                {% else %}
                  <strong>${{ s.base_price|floatformat:2 }}</strong>
                {% endif %}
              {% endwith %}
              ¬∑ {{ s.duration_min }} –º–∏–Ω
            </div>
            <button class="btn btn--primary" disabled title="–°–∫–æ—Ä–æ">–í—ã–±—Ä–∞—Ç—å –≤—Ä–µ–º—è</button>
          </article>
        {% empty %}
          <div class="stub">–í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç —É—Å–ª—É–≥.</div>
        {% endfor %}
      </div>
    {% endfor %}

    {% if uncategorized %}
      <h3 style="margin:1.5rem 0 .75rem;">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
      <div class="services-grid">
        {% for s in uncategorized %}
          <article class="service-card">
            <div class="service-card__img">IMG</div>
            <h3>{{ s.name }}</h3>
            {% if s.description %}<p class="muted">{{ s.description|truncatewords:22 }}</p>{% endif %}
            <div class="service-meta">
              {% with disc=s.get_active_discount %}
                {% if disc %}
                  <span class="old">${{ s.base_price|floatformat:2 }}</span>
                  <strong>${{ s.get_discounted_price|floatformat:2 }}</strong>
                  <span class="badge">-{{ disc.discount_percent }}%</span>
                {% else %}
                  <strong>${{ s.base_price|floatformat:2 }}</strong>
                {% endif %}
              {% endwith %}
              ¬∑ {{ s.duration_min }} –º–∏–Ω
            </div>
            <button class="btn btn--primary" disabled title="–°–∫–æ—Ä–æ">–í—ã–±—Ä–∞—Ç—å –≤—Ä–µ–º—è</button>
          </article>
        {% endfor %}
      </div>
    {% endif %}

    {% if not has_any_services %}
      <div class="stub">–ö–∞—Ç–∞–ª–æ–≥ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω üëç</div>
    {% endif %}
  </main>

  <footer class="site-footer">¬© 2025 Malva Booking</footer>
</body>
</html>
