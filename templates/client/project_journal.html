{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ page_title }} | Bad Guy Motors</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  {% with resolved_title=page_title|default:"Project Journal" %}
    {% with meta_title=resolved_title|add:" | Bad Guy Motors" meta_description=meta_description|default:"Project deep dives from Bad Guy Motors." meta_section="journal" meta_robots="noindex,nofollow" %}
      {% include "includes/marketing_head.html" %}
    {% endwith %}
  {% endwith %}

  {% if font_settings and font_settings.preload_fonts %}
    {% for font in font_settings.preload_fonts %}
      <link rel="preload" href="{{ font.url }}" as="font" type="{{ font.mime_type|default:'font/ttf' }}" crossorigin>
    {% endfor %}
  {% else %}
    <link rel="preload" href="{% static 'fonts/Diesel.ttf' %}" as="font" type="font/ttf" crossorigin>
    <link rel="preload" href="{% static 'fonts/Inter-Variable.ttf' %}" as="font" type="font/ttf" crossorigin>
  {% endif %}

  <style>
    :root {
      color-scheme: dark;
      --bg: #0b0c10;
      --bg-soft: #12131a;
      --panel: #151724;
      --panel-2: #1b1d2b;
      --ink: #f7f7fb;
      --muted: #b4b7c8;
      --accent: #ff3b30;
      --accent-dark: #b71c1c;
      --line: rgba(255, 255, 255, 0.08);
      --shadow: 0 24px 48px rgba(0, 0, 0, 0.45);
      --radius-lg: 24px;
      --radius-md: 18px;
      --radius-sm: 12px;
      --font-body: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
      --font-head: "Diesel", system-ui, -apple-system, "Segoe UI", sans-serif;
      --font-ui: var(--font-body);
    }
    {% if font_settings %}
      {% for font in font_settings.fonts %}
        {% if font.has_source %}
    @font-face {
      font-family: "{{ font.family }}";
      src: url("{{ font.url }}") format("{{ font.format|default:'truetype' }}");
      font-weight: {{ font.weight|default:"400" }};
      font-style: {{ font.style|default:"normal" }};
      font-display: {{ font.display|default:"swap" }};
    }
        {% endif %}
      {% endfor %}
      {% with body_stack=font_settings.body.stack|default:'"Inter", system-ui, -apple-system, "Segoe UI", sans-serif' %}
      {% with heading_stack=font_settings.heading.stack|default:'"Diesel", system-ui, -apple-system, "Segoe UI", sans-serif' %}
      {% with ui_stack=font_settings.ui.stack|default:body_stack %}
    :root {
      --font-body: {{ body_stack|safe }};
      --font-head: {{ heading_stack|safe }};
      --font-ui: {{ ui_stack|safe }};
    }
      {% endwith %}
      {% endwith %}
      {% endwith %}
    {% else %}
    @font-face {
      font-family: "Diesel";
      src: url("{% static 'fonts/Diesel.ttf' %}") format("truetype");
      font-weight: 100 900;
      font-style: normal;
      font-display: swap;
    }
    {% endif %}
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--font-body);
      background:
        radial-gradient(circle at top, rgba(255, 59, 48, 0.18), transparent 45%),
        linear-gradient(140deg, #08090d 0%, #0d0f16 50%, #0b0c10 100%);
      color: var(--ink);
      min-height: 100vh;
    }
    a { color: inherit; }
    .page {
      max-width: 1240px;
      margin: 0 auto;
      padding: 2.75rem 1.5rem 4rem;
      display: grid;
      gap: 2.5rem;
    }
    .eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.32em;
      font-size: 0.72rem;
      color: var(--muted);
      margin: 0 0 0.35rem;
    }
    .hero {
      display: grid;
      gap: 1.4rem;
    }
    .hero__top {
      display: flex;
      gap: 1.5rem;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .hero h1 {
      font-family: var(--font-head);
      font-size: clamp(2.4rem, 4vw, 3.4rem);
      letter-spacing: -0.02em;
      margin: 0;
    }
    .hero .lead {
      margin: 0;
      max-width: 720px;
      font-size: 1.02rem;
      line-height: 1.7;
      color: var(--muted);
    }
    .hero__actions {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.3rem;
      border-radius: 999px;
      border: 1px solid var(--line);
      text-decoration: none;
      font-family: var(--font-ui);
      font-weight: 600;
      font-size: 0.85rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      background: transparent;
      color: var(--ink);
      transition: border-color 0.2s ease, background 0.2s ease, color 0.2s ease;
    }
    .btn--primary {
      border: none;
      background: linear-gradient(120deg, var(--accent), var(--accent-dark));
      box-shadow: 0 14px 30px rgba(255, 59, 48, 0.3);
    }
    .btn--ghost:hover {
      border-color: rgba(255, 255, 255, 0.35);
    }
    .tag-filter {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
    }
    .tag-filter a {
      padding: 0.45rem 1rem;
      border-radius: 999px;
      border: 1px solid var(--line);
      color: var(--ink);
      font-size: 0.82rem;
      text-decoration: none;
      transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease;
    }
    .tag-filter a:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    .tag-filter a.active {
      background: rgba(255, 59, 48, 0.15);
      border-color: rgba(255, 59, 48, 0.45);
      color: #fff;
    }
    .stage {
      display: grid;
      grid-template-columns: minmax(0, 1.05fr) minmax(0, 0.95fr);
      gap: 2rem;
      background: var(--panel);
      border-radius: var(--radius-lg);
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      padding: 2.2rem;
    }
    .stage__summary {
      display: grid;
      gap: 1.2rem;
      align-content: start;
    }
    .stage-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem 1.1rem;
      font-size: 0.85rem;
      color: var(--muted);
    }
    .stage-title {
      font-family: var(--font-head);
      font-size: 2rem;
      margin: 0;
    }
    .stage-excerpt {
      margin: 0;
      font-size: 1rem;
      line-height: 1.7;
    }
    .highlight {
      display: inline-flex;
      align-items: center;
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      font-size: 0.78rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: rgba(255, 59, 48, 0.15);
      border: 1px solid rgba(255, 59, 48, 0.35);
    }
    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem;
    }
    .chip-row span {
      padding: 0.3rem 0.75rem;
      border-radius: 999px;
      border: 1px solid var(--line);
      font-size: 0.75rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--muted);
      background: rgba(255, 255, 255, 0.03);
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.9rem;
    }
    .info-card {
      background: var(--panel-2);
      border-radius: var(--radius-sm);
      border: 1px solid var(--line);
      padding: 0.95rem 1rem;
      display: grid;
      gap: 0.5rem;
    }
    .info-card h3 {
      margin: 0;
      font-size: 0.72rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .info-card .body-copy {
      margin: 0;
      color: var(--ink);
      font-size: 0.92rem;
      line-height: 1.6;
    }
    .stage-report {
      border-top: 1px solid var(--line);
      padding-top: 1rem;
    }
    details summary {
      cursor: pointer;
      list-style: none;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.45rem;
      color: var(--accent);
    }
    details summary::-webkit-details-marker { display: none; }
    details summary svg {
      width: 14px;
      height: 14px;
      transition: transform 0.2s ease;
    }
    details[open] summary svg { transform: rotate(90deg); }
    details .body-copy {
      margin-top: 0.75rem;
      color: var(--muted);
      line-height: 1.65;
    }
    .stage-compare {
      display: grid;
      gap: 1.5rem;
      align-content: start;
    }
    .carousel {
      background: #0f1018;
      border-radius: var(--radius-md);
      border: 1px solid var(--line);
      padding: 1.2rem;
      display: grid;
      gap: 0.85rem;
    }
    .carousel__head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }
    .carousel__title {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
    }
    .carousel__controls {
      display: flex;
      align-items: center;
      gap: 0.55rem;
      font-size: 0.8rem;
      color: var(--muted);
    }
    .icon-btn {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: transparent;
      color: var(--ink);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: border-color 0.2s ease, color 0.2s ease;
    }
    .icon-btn:disabled {
      opacity: 0.4;
      cursor: default;
    }
    .carousel__frame {
      position: relative;
      border-radius: var(--radius-sm);
      overflow: hidden;
      background: radial-gradient(circle at top, rgba(255, 255, 255, 0.06), transparent 55%);
      min-height: 220px;
    }
    .carousel__image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .carousel__placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: var(--muted);
      padding: 1.5rem;
      font-size: 0.9rem;
    }
    .carousel__thumbs {
      display: flex;
      gap: 0.4rem;
      overflow-x: auto;
      padding-bottom: 0.2rem;
    }
    .thumb {
      width: 46px;
      height: 46px;
      border-radius: 10px;
      border: 1px solid transparent;
      background-size: cover;
      background-position: center;
      background-color: #0c0d12;
      flex: 0 0 auto;
      cursor: pointer;
    }
    .thumb.is-active {
      border-color: rgba(255, 59, 48, 0.6);
      box-shadow: 0 0 0 2px rgba(255, 59, 48, 0.15);
    }
    .build-list {
      display: grid;
      gap: 1.25rem;
    }
    .build-list__head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .build-list__head h2 {
      margin: 0;
      font-size: 1.4rem;
      font-family: var(--font-head);
    }
    .build-list__head p {
      margin: 0;
      color: var(--muted);
      font-size: 0.95rem;
    }
    .project-strip {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: minmax(240px, 1fr);
      gap: 1rem;
      overflow-x: auto;
      padding-bottom: 0.75rem;
      scroll-snap-type: x mandatory;
    }
    .post-card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius-md);
      padding: 1.1rem;
      display: grid;
      gap: 0.8rem;
      cursor: pointer;
      transition: border-color 0.2s ease, transform 0.2s ease;
      scroll-snap-align: start;
    }
    .post-card.is-active {
      border-color: rgba(255, 59, 48, 0.6);
      transform: translateY(-2px);
    }
    .post-card:focus-visible {
      outline: 2px solid rgba(255, 255, 255, 0.6);
      outline-offset: 4px;
    }
    .post-card__media {
      border-radius: var(--radius-sm);
      overflow: hidden;
      background: #0d0f15;
      height: 160px;
    }
    .post-card__media img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .post-card__placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: var(--muted);
      font-size: 0.82rem;
      padding: 0.9rem;
    }
    .post-card h3 {
      margin: 0;
      font-size: 1.08rem;
    }
    .meta-line {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem 1rem;
      font-size: 0.8rem;
      color: var(--muted);
    }
    .empty-state {
      border: 1px dashed var(--line);
      border-radius: var(--radius-lg);
      padding: 3rem 1.5rem;
      text-align: center;
      color: var(--muted);
      background: rgba(255, 255, 255, 0.02);
    }
    @media (max-width: 960px) {
      .page { padding: 2.2rem 1.1rem 3rem; }
      .stage { grid-template-columns: 1fr; padding: 1.6rem; }
      .stage-compare { grid-template-columns: 1fr; }
      .project-strip { grid-auto-columns: minmax(220px, 78vw); }
    }
    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; }
    }
  </style>
</head>
<body>
  {% include "includes/marketing_body.html" %}
  <main class="page">
    <header class="hero">
      <div class="hero__top">
        <div>
          <p class="eyebrow">Build Journal</p>
          <h1>{{ page_title }}</h1>
        </div>
        <div class="hero__actions">
          <a class="btn btn--ghost" href="{% url 'home' %}">Go Home</a>
        </div>
      </div>
      <p class="lead">
        Before-and-after build stories with photo comparisons, written for clients who want the straight story.
        Tap a project to update the comparison below.
      </p>
      {% if available_tags %}
      <div class="tag-filter" aria-label="Filter by tag">
        <a href="{% url 'project-journal' %}" class="{% if not tag_filter %}active{% endif %}">All projects</a>
        {% for tag in available_tags %}
          {% with lower=tag|lower %}
          <a href="{% url 'project-journal' %}?tag={{ tag|urlencode }}" class="{% if tag_filter and tag|lower == tag_filter|lower %}active{% endif %}">
            {{ tag }}
          </a>
          {% endwith %}
        {% endfor %}
        {% if tag_filter %}
          <a href="{% url 'project-journal' %}" class="btn">Clear filter</a>
        {% endif %}
      </div>
      {% endif %}
    </header>

    {% if has_posts and featured_post %}
      <section class="stage" data-stage data-active-id="{{ featured_post.id }}">
        <div class="stage__summary">
          <div class="stage-meta">
            <span data-field="date">{{ featured_post.published_at|date:"M d, Y" }}</span>
            {% if featured_post.client_name %}
              <span data-field="client">Client · {{ featured_post.client_name }}</span>
            {% endif %}
            {% if featured_post.location %}
              <span data-field="location">{{ featured_post.location }}</span>
            {% endif %}
            <span data-field="reading">{{ featured_post.reading_time }} min read</span>
          </div>
          <h2 class="stage-title" id="projectTitle">{{ featured_post.hero_title }}</h2>
          <div class="highlight" id="projectHighlight" {% if not featured_post.result_highlight %}hidden{% endif %}>
            {{ featured_post.result_highlight }}
          </div>
          <p class="stage-excerpt" id="projectExcerpt">
            {{ featured_post.excerpt|default:"This build highlight is ready whenever you are." }}
          </p>
          {% if featured_post.services_list %}
            <div class="chip-row" id="projectServices" aria-label="Services performed">
              {% for service in featured_post.services_list %}
                <span>{{ service }}</span>
              {% endfor %}
            </div>
          {% else %}
            <div class="chip-row" id="projectServices" aria-label="Services performed" hidden></div>
          {% endif %}
          {% if featured_post.tag_list %}
            <div class="chip-row" id="projectTags" aria-label="Tags">
              {% for tag in featured_post.tag_list %}
                <span>#{{ tag }}</span>
              {% endfor %}
            </div>
          {% else %}
            <div class="chip-row" id="projectTags" aria-label="Tags" hidden></div>
          {% endif %}
          <div class="info-grid">
            <article class="info-card" data-section="overview" {% if not featured_post.overview and not featured_post.excerpt %}hidden{% endif %}>
              <h3>Overview</h3>
              <div class="body-copy" data-field="overview">
                {{ featured_post.overview|default:featured_post.excerpt|linebreaks }}
              </div>
            </article>
            <article class="info-card" data-section="parts" {% if not featured_post.parts %}hidden{% endif %}>
              <h3>Parts</h3>
              <div class="body-copy" data-field="parts">{{ featured_post.parts|linebreaks }}</div>
            </article>
            <article class="info-card" data-section="customizations" {% if not featured_post.customizations %}hidden{% endif %}>
              <h3>Customizations</h3>
              <div class="body-copy" data-field="customizations">{{ featured_post.customizations|linebreaks }}</div>
            </article>
            <article class="info-card" data-section="backstory" {% if not featured_post.backstory %}hidden{% endif %}>
              <h3>Backstory</h3>
              <div class="body-copy" data-field="backstory">{{ featured_post.backstory|linebreaks }}</div>
            </article>
          </div>
          <details class="stage-report" id="projectReport" {% if not featured_post.body %}hidden{% endif %}>
            <summary>
              Read the full report
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M8 5l8 7-8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </summary>
            <div class="body-copy" data-field="body">
              {{ featured_post.body|linebreaks }}
            </div>
          </details>
        </div>
        <div class="stage-compare">
          <div class="carousel" data-carousel="before">
            <div class="carousel__head">
              <div>
                <p class="eyebrow">Before</p>
                <p class="carousel__title">Original condition</p>
              </div>
              <div class="carousel__controls">
                <button class="icon-btn" type="button" data-carousel-prev aria-label="Previous before photo">&#9664;</button>
                <span data-carousel-count>0 / 0</span>
                <button class="icon-btn" type="button" data-carousel-next aria-label="Next before photo">&#9654;</button>
              </div>
            </div>
            <div class="carousel__frame" data-carousel-frame>
              <img class="carousel__image" data-carousel-image alt="" hidden>
              <div class="carousel__placeholder" data-carousel-placeholder>Before photos coming soon.</div>
            </div>
            <div class="carousel__thumbs" data-carousel-thumbs></div>
          </div>
          <div class="carousel" data-carousel="after">
            <div class="carousel__head">
              <div>
                <p class="eyebrow">After</p>
                <p class="carousel__title">Delivered result</p>
              </div>
              <div class="carousel__controls">
                <button class="icon-btn" type="button" data-carousel-prev aria-label="Previous after photo">&#9664;</button>
                <span data-carousel-count>0 / 0</span>
                <button class="icon-btn" type="button" data-carousel-next aria-label="Next after photo">&#9654;</button>
              </div>
            </div>
            <div class="carousel__frame" data-carousel-frame>
              <img class="carousel__image" data-carousel-image alt="" hidden>
              <div class="carousel__placeholder" data-carousel-placeholder>After photos coming soon.</div>
            </div>
            <div class="carousel__thumbs" data-carousel-thumbs></div>
          </div>
        </div>
      </section>

      <section class="build-list">
        <div class="build-list__head">
          <h2>All builds</h2>
          <p>Tap a card to refresh the comparison carousel.</p>
        </div>
        <div class="project-strip" role="list">
          {% for post in gallery_posts %}
            <article class="post-card {% if featured_post and post.id == featured_post.id %}is-active{% endif %}" data-project-id="{{ post.id }}" data-project-slug="{{ post.slug }}" role="button" tabindex="0" aria-pressed="{% if featured_post and post.id == featured_post.id %}true{% else %}false{% endif %}">
              <div class="post-card__media">
                {% if post.cover_image %}
                  <img src="{{ post.cover_image.url }}" alt="{{ post.title }} cover" loading="lazy" decoding="async">
                {% else %}
                  <div class="post-card__placeholder">Cover image pending</div>
                {% endif %}
              </div>
              <div class="meta-line">
                <span>{{ post.published_at|date:"M d, Y" }}</span>
                <span>{{ post.reading_time }} min read</span>
              </div>
              <h3>{{ post.title }}</h3>
              <p>{{ post.excerpt|default:"Tap to view the full build breakdown." }}</p>
              {% if post.tag_list %}
                <div class="chip-row">
                  {% for tag in post.tag_list %}
                    <span>#{{ tag }}</span>
                  {% endfor %}
                </div>
              {% endif %}
            </article>
          {% endfor %}
        </div>
      </section>
    {% else %}
      <section class="empty-state">
        {% if tag_filter %}
          No posts found for “{{ tag_filter }}”. Remove the filter to see everything we have documented so far.
        {% else %}
          The journal is empty right now. Once the team adds a post in the admin panel it will appear here automatically.
        {% endif %}
      </section>
    {% endif %}
  </main>

  {% if has_posts and featured_post %}
    {{ project_payload|json_script:"projectJournalData" }}
    <script>
      (function(){
        const dataEl = document.getElementById('projectJournalData');
        if (!dataEl) return;
        let projects = [];
        try {
          projects = JSON.parse(dataEl.textContent);
        } catch (err) {
          return;
        }
        if (!Array.isArray(projects) || !projects.length) return;

        const byId = new Map();
        const bySlug = new Map();
        projects.forEach((project) => {
          if (project && project.id) {
            byId.set(project.id, project);
          }
          if (project && project.slug) {
            bySlug.set(project.slug, project);
          }
        });

        const stage = document.querySelector('[data-stage]');
        if (!stage) return;

        const titleEl = document.getElementById('projectTitle');
        const excerptEl = document.getElementById('projectExcerpt');
        const highlightEl = document.getElementById('projectHighlight');
        const servicesEl = document.getElementById('projectServices');
        const tagsEl = document.getElementById('projectTags');
        const reportEl = document.getElementById('projectReport');
        const reportBodyEl = stage.querySelector('[data-field="body"]');

        const metaEls = {
          date: stage.querySelector('[data-field="date"]'),
          client: stage.querySelector('[data-field="client"]'),
          location: stage.querySelector('[data-field="location"]'),
          reading: stage.querySelector('[data-field="reading"]'),
        };

        const sectionEls = {
          overview: {
            wrapper: stage.querySelector('[data-section="overview"]'),
            body: stage.querySelector('[data-field="overview"]'),
          },
          parts: {
            wrapper: stage.querySelector('[data-section="parts"]'),
            body: stage.querySelector('[data-field="parts"]'),
          },
          customizations: {
            wrapper: stage.querySelector('[data-section="customizations"]'),
            body: stage.querySelector('[data-field="customizations"]'),
          },
          backstory: {
            wrapper: stage.querySelector('[data-section="backstory"]'),
            body: stage.querySelector('[data-field="backstory"]'),
          },
        };

        const cards = Array.from(document.querySelectorAll('[data-project-id]'));

        function setupCarousel(el){
          if (!el) return null;
          const state = {
            el,
            prev: el.querySelector('[data-carousel-prev]'),
            next: el.querySelector('[data-carousel-next]'),
            count: el.querySelector('[data-carousel-count]'),
            img: el.querySelector('[data-carousel-image]'),
            placeholder: el.querySelector('[data-carousel-placeholder]'),
            thumbs: el.querySelector('[data-carousel-thumbs]'),
            images: [],
            index: 0,
            altFallback: '',
            placeholderText: '',
          };
          if (state.prev) {
            state.prev.addEventListener('click', () => shiftCarousel(state, -1));
          }
          if (state.next) {
            state.next.addEventListener('click', () => shiftCarousel(state, 1));
          }
          return state;
        }

        const carousels = {
          before: setupCarousel(stage.querySelector('[data-carousel="before"]')),
          after: setupCarousel(stage.querySelector('[data-carousel="after"]')),
        };

        function normalizeImages(items){
          if (!Array.isArray(items)) return [];
          return items.map((item) => {
            if (typeof item === 'string') {
              return { url: item, alt: '' };
            }
            if (item && typeof item === 'object') {
              return {
                url: item.url || item.src || '',
                alt: item.alt || '',
              };
            }
            return null;
          }).filter((entry) => entry && entry.url);
        }

        function renderText(container, text){
          if (!container) return;
          container.innerHTML = '';
          const value = (text || '').trim();
          if (!value) return;
          const lines = value.split(/\n+/).filter(Boolean);
          if (!lines.length) {
            container.textContent = value;
            return;
          }
          lines.forEach((line) => {
            const p = document.createElement('p');
            p.textContent = line;
            container.appendChild(p);
          });
        }

        function setMeta(el, value){
          if (!el) return;
          if (!value) {
            el.hidden = true;
            return;
          }
          el.hidden = false;
          el.textContent = value;
        }

        function renderChips(container, items, prefix){
          if (!container) return;
          container.innerHTML = '';
          if (!items || !items.length) {
            container.hidden = true;
            return;
          }
          container.hidden = false;
          items.forEach((item) => {
            const span = document.createElement('span');
            span.textContent = prefix ? `${prefix}${item}` : item;
            container.appendChild(span);
          });
        }

        function renderThumbs(state){
          if (!state || !state.thumbs) return;
          state.thumbs.innerHTML = '';
          if (!state.images || state.images.length <= 1) return;
          state.images.forEach((image, idx) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'thumb';
            btn.style.backgroundImage = `url('${image.url}')`;
            btn.setAttribute('aria-label', `View image ${idx + 1}`);
            if (idx === state.index) {
              btn.classList.add('is-active');
            }
            btn.addEventListener('click', () => {
              state.index = idx;
              renderCarousel(state);
              renderThumbs(state);
            });
            state.thumbs.appendChild(btn);
          });
        }

        function renderCarousel(state){
          if (!state) return;
          const images = state.images || [];
          if (!images.length) {
            if (state.img) state.img.hidden = true;
            if (state.placeholder) {
              state.placeholder.hidden = false;
              state.placeholder.textContent = state.placeholderText || 'Photos coming soon.';
            }
            if (state.count) state.count.textContent = '0 / 0';
            if (state.prev) state.prev.disabled = true;
            if (state.next) state.next.disabled = true;
            return;
          }
          const total = images.length;
          const active = images[state.index] || images[0];
          if (state.img) {
            state.img.hidden = false;
            state.img.src = active.url;
            state.img.alt = active.alt || state.altFallback || 'Project photo';
          }
          if (state.placeholder) state.placeholder.hidden = true;
          if (state.count) state.count.textContent = `${state.index + 1} / ${total}`;
          if (state.prev) state.prev.disabled = total <= 1;
          if (state.next) state.next.disabled = total <= 1;
        }

        function shiftCarousel(state, delta){
          if (!state || !state.images || state.images.length <= 1) return;
          const total = state.images.length;
          state.index = (state.index + delta + total) % total;
          renderCarousel(state);
          renderThumbs(state);
        }

        function setCarousel(state, items, altFallback, placeholderText){
          if (!state) return;
          state.images = normalizeImages(items);
          state.index = 0;
          state.altFallback = altFallback || '';
          state.placeholderText = placeholderText || '';
          renderCarousel(state);
          renderThumbs(state);
        }

        function setSection(key, value){
          const section = sectionEls[key];
          if (!section || !section.body) return;
          const text = (value || '').trim();
          if (!text) {
            if (section.wrapper) section.wrapper.hidden = true;
            return;
          }
          if (section.wrapper) section.wrapper.hidden = false;
          renderText(section.body, text);
        }

        function setActive(project, options){
          if (!project) return;
          const opts = options || {};
          stage.dataset.activeId = project.id;

          if (titleEl) titleEl.textContent = project.hero_title || project.title || '';
          if (excerptEl) {
            excerptEl.textContent = project.excerpt || project.overview || 'This build highlight is ready whenever you are.';
          }
          if (highlightEl) {
            if (project.result_highlight) {
              highlightEl.textContent = project.result_highlight;
              highlightEl.hidden = false;
            } else {
              highlightEl.hidden = true;
            }
          }

          setMeta(metaEls.date, project.published_label || '');
          setMeta(metaEls.client, project.client_name ? `Client · ${project.client_name}` : '');
          setMeta(metaEls.location, project.location || '');
          setMeta(metaEls.reading, project.reading_time ? `${project.reading_time} min read` : '');

          renderChips(servicesEl, project.services, '');
          renderChips(tagsEl, project.tags, '#');

          setSection('overview', project.overview || project.excerpt);
          setSection('parts', project.parts);
          setSection('customizations', project.customizations);
          setSection('backstory', project.backstory);

          if (reportEl && reportBodyEl) {
            const bodyText = (project.body || '').trim();
            if (!bodyText) {
              reportEl.hidden = true;
            } else {
              reportEl.hidden = false;
              reportEl.removeAttribute('open');
              renderText(reportBodyEl, bodyText);
            }
          }

          let beforeImages = project.before_images || project.before_gallery || project.before || [];
          let afterImages = project.after_images || project.after_gallery || project.after || [];
          if (!beforeImages || !beforeImages.length) {
            if (project.cover_image) {
              beforeImages = [{ url: project.cover_image, alt: `${project.title} before` }];
            }
          }
          if (!afterImages || !afterImages.length) {
            if (project.cover_image) {
              afterImages = [{ url: project.cover_image, alt: `${project.title} after` }];
            }
          }
          setCarousel(carousels.before, beforeImages, `${project.title} before`, 'Before photos coming soon.');
          setCarousel(carousels.after, afterImages, `${project.title} after`, 'After photos coming soon.');

          cards.forEach((card) => {
            const isActive = card.dataset.projectId === project.id;
            card.setAttribute('aria-pressed', isActive ? 'true' : 'false');
            card.classList.toggle('is-active', isActive);
          });

          if (opts.updateHash && project.slug) {
            history.replaceState(null, '', `#project-${project.slug}`);
          }
        }

        function selectById(id, options){
          if (!id) return;
          const project = byId.get(id);
          if (project) {
            setActive(project, options);
          }
        }

        cards.forEach((card) => {
          card.addEventListener('click', () => {
            selectById(card.dataset.projectId, { updateHash: true });
          });
          card.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              selectById(card.dataset.projectId, { updateHash: true });
            }
          });
        });

        const hash = window.location.hash || '';
        if (hash.startsWith('#project-')) {
          const slug = hash.replace('#project-', '');
          const project = bySlug.get(slug);
          if (project) {
            setActive(project);
            return;
          }
        }

        const initialId = stage.dataset.activeId;
        if (initialId) {
          selectById(initialId);
        }
      })();
    </script>
  {% endif %}
  {% include "includes/analytics_tracker.html" %}
</body>
</html>
