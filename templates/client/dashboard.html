{% load i18n tz %}<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
    <meta charset="utf-8">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç | Malva Booking</title>

    <!-- Tailwind CSS JIT CDN -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

    <!-- Chart.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="h-full bg-gray-100 text-gray-800">

<div class="min-h-screen flex">

    <!-- ‚ñ∏‚ñ∏ SIDEBAR ‚óÇ‚óÇ -->
<aside class="w-64 bg-white shadow-lg">
    <div class="p-6 font-bold text-indigo-600 text-xl">Malva</div>

    <nav id="sidebar" class="space-y-1 px-4 text-sm">
        <a href="#" data-tab="dashboard"
           class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md hover:bg-indigo-50">
            üè† <span>–û–±–∑–æ—Ä</span>
        </a>
        <a href="#" data-tab="appointments"
           class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md hover:bg-indigo-50">
            üìÖ <span>–ó–∞–ø–∏—Å–∏</span>
        </a>
        <a href="#" data-tab="files"
           class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md hover:bg-indigo-50">
            üìÇ <span>–§–∞–π–ª—ã</span>
        </a>
        <a href="#" data-tab="notifications"
           class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md hover:bg-indigo-50">
            üîî <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
        </a>
        <a href="#" data-tab="profile"
           class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md hover:bg-indigo-50">
            üë§ <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </a>

        <!-- –∫–Ω–æ–ø–∫–∞ ¬´–ù–∞ –≥–ª–∞–≤–Ω—É—é¬ª ‚Üí /accounts/ -->
        <a href="/accounts/"
           class="flex items-center gap-3 px-3 py-2 rounded-md hover:bg-indigo-50">
            ‚¨ÖÔ∏è <span>–ù–∞&nbsp;–≥–ª–∞–≤–Ω—É—é</span>
        </a>
    </nav>
</aside>

    <!-- ‚ñ∏‚ñ∏ MAIN ‚óÇ‚óÇ -->
    <main class="flex-1 p-8 overflow-y-auto">

        <!-- DASHBOARD -->
        <section id="tab-dashboard" class="tab">
            <h1 class="text-3xl font-bold mb-8">
                {% if request.user.first_name %}
                    –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {{ request.user.first_name }}!
                {% else %}
                    –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {{ request.user.username }}!
                {% endif %}
            </h1>

            <div class="grid lg:grid-cols-3 gap-6">

                <!-- –ë–ª–∏–∂–∞–π—à–∏–π –≤–∏–∑–∏—Ç -->
                <div class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-lg font-semibold mb-4">–ë–ª–∏–∂–∞–π—à–∏–π –≤–∏–∑–∏—Ç</h2>
                    {% if next_appointment %}
                        <p class="font-medium">
                            {{ next_appointment.start_time|localtime|date:"d E Y, H:i" }}
                        </p>
                        <p class="text-sm text-gray-600">
                            {{ next_appointment.service.name }} ¬∑
                            {{ next_appointment.master.get_full_name }}
                        </p>
                        <div class="mt-4 flex gap-4 text-sm">
                            <a href="#" class="text-red-600 hover:underline">–û—Ç–º–µ–Ω–∏—Ç—å</a>
                            <a href="#" class="text-indigo-600 hover:underline">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏</a>
                        </div>
                    {% else %}
                        <p class="text-gray-500">–ë–ª–∏–∂–∞–π—à–∏—Ö –≤–∏–∑–∏—Ç–æ–≤ –Ω–µ—Ç.</p>
                    {% endif %}
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="bg-white rounded-xl shadow p-6 lg:col-span-2">
                    <h2 class="text-lg font-semibold mb-4">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                    <canvas id="stats_chart"
                            data-labels="{{ chart_labels|join:',' }}"
                            data-data="{{ chart_data|join:',' }}"
                            class="w-full h-56"></canvas>
                </div>
            </div>

            <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤–∏–∑–∏—Ç—ã -->
            <div class="bg-white rounded-xl shadow p-6 mt-8">
                <h2 class="text-lg font-semibold mb-4">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤–∏–∑–∏—Ç—ã</h2>
                {% if recent_appointments %}
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead>
                            <tr class="text-left text-gray-500 border-b">
                                <th class="py-2 pr-4">–î–∞—Ç–∞</th>
                                <th class="py-2 pr-4">–£—Å–ª—É–≥–∞</th>
                                <th class="py-2 pr-4">–ú–∞—Å—Ç–µ—Ä</th>
                                <th class="py-2 pr-4">–°—Ç–∞—Ç—É—Å</th>
                                <th class="py-2">–°—É–º–º–∞</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for a in recent_appointments %}
                                <tr class="border-b">
                                    <td class="py-2 pr-4 whitespace-nowrap">
                                        {{ a.start_time|localtime|date:"d.m.Y H:i" }}
                                    </td>
                                    <td class="py-2 pr-4">{{ a.service.name }}</td>
                                    <td class="py-2 pr-4">{{ a.master.get_full_name }}</td>
                                    <td class="py-2 pr-4">{{ a.current_status }}</td>
                                    <td class="py-2">{{ a.price|default:"‚Äî" }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-gray-500">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –≤–∏–∑–∏—Ç–æ–≤.</p>
                {% endif %}
            </div>
        </section>

        <!-- APPOINTMENTS -->
        <section id="tab-appointments" class="tab hidden">
            <div class="flex items-center mb-6">
                <h2 class="text-2xl font-semibold">–ú–æ–∏ –∑–∞–ø–∏—Å–∏</h2>
                <button class="ml-auto px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700">
                    + –ó–∞–ø–∏—Å–∞—Ç—å—Å—è
                </button>
            </div>

            {% if appointments %}
                <div class="space-y-4">
                    {% for a in appointments %}
                        <div class="bg-white shadow rounded-lg p-4 flex justify-between items-center
                                    {% if a.start_time < now %}opacity-50{% endif %}">
                            <div>
                                <p class="font-medium">
                                    {{ a.start_time|localtime|date:"d E Y, H:i" }}
                                </p>
                                <p class="text-sm text-gray-600">
                                    {{ a.service.name }} ¬∑ {{ a.master.get_full_name }}
                                </p>
                            </div>

                            {% if a.start_time >= now %}
                                <div class="flex gap-3 text-sm">
                                    <a href="#" class="text-red-600 hover:underline">–û—Ç–º–µ–Ω–∏—Ç—å</a>
                                    <a href="#" class="text-indigo-600 hover:underline">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏</a>
                                </div>
                            {% else %}
                                <span class="text-xs text-gray-500">–ó–∞–≤–µ—Ä—à—ë–Ω</span>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500">–ó–∞–ø–∏—Å–µ–π –Ω–µ—Ç.</p>
            {% endif %}
        </section>

        <!-- FILES (–ø–æ–∫–∞ —Å—Ç–∞—Ç–∏—á–Ω–æ) -->
        <section id="tab-files" class="tab hidden">
            <h2 class="text-2xl font-semibold mb-6">–§–∞–π–ª—ã</h2>
            <!-- –ø–æ–∑–∂–µ –ø–æ–¥–∫–ª—é—á–∏–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
            <p class="text-gray-500">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</p>
        </section>

        <!-- NOTIFICATIONS (–ø–æ–∫–∞ —Å—Ç–∞—Ç–∏—á–Ω–æ) -->
        <section id="tab-notifications" class="tab hidden">
            <h2 class="text-2xl font-semibold mb-6">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
            <p class="text-gray-500">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</p>
        </section>

        <!-- PROFILE -->
        <section id="tab-profile" class="tab hidden">
            <h2 class="text-2xl font-semibold mb-6">–ü—Ä–æ—Ñ–∏–ª—å</h2>

            <form method="post" class="grid md:grid-cols-2 gap-6 bg-white shadow rounded-xl p-6">
                {% csrf_token %}
                <div>
                    <label class="block text-sm font-medium">–ò–º—è</label>
                    <input type="text" name="first_name"
                           value="{{ request.user.first_name }}"
                           class="w-full mt-1 rounded-lg border-gray-300 px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium">–§–∞–º–∏–ª–∏—è</label>
                    <input type="text" name="last_name"
                           value="{{ request.user.last_name }}"
                           class="w-full mt-1 rounded-lg border-gray-300 px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="text" name="phone"
                           value="{{ profile.phone }}"
                           class="w-full mt-1 rounded-lg border-gray-300 px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium">E-mail</label>
                    <input type="email" name="email"
                           value="{{ request.user.email }}"
                           class="w-full mt-1 rounded-lg border-gray-300 px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                    <input type="date" name="birth_date"
                           value="{{ profile.birth_date|date:'Y-m-d' }}"
                           class="w-full mt-1 rounded-lg border-gray-300 px-3 py-2 text-sm">
                </div>

                <div class="md:col-span-2 text-right">
                    <button type="submit"
                            class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </form>
        </section>

    </main>
</div>

<!-- ‚ñ∏‚ñ∏ JS ‚óÇ‚óÇ -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    /* --- –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ --- */
    const links = document.querySelectorAll('.sidebar-link');
    const tabs  = document.querySelectorAll('.tab');

    function activate(tabName) {
        tabs.forEach(t => t.classList.toggle('hidden', t.id !== 'tab-' + tabName));
        links.forEach(l => {
            const active = l.dataset.tab === tabName;
            l.classList.toggle('bg-indigo-50', active);
            l.classList.toggle('text-indigo-700', active);
        });
    }

    links.forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            activate(link.dataset.tab);
        });
    });
    activate('dashboard');

    /* --- Chart.js –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö --- */
    const el = document.getElementById('stats_chart');
    if (el) {
        const labels = el.dataset.labels ? el.dataset.labels.split(',') : [];
        const data   = el.dataset.data   ? el.dataset.data.split(',').map(Number) : [];
        new Chart(el, {
            type: 'bar',
            data: { labels, datasets: [{ data, label: '–í–∏–∑–∏—Ç—ã' }] },
            options: {
                plugins: { legend: { display: false }},
                scales : { y: { beginAtZero: true, ticks: { stepSize: 1 }}}
            }
        });
    }
});
</script>
</body>
</html>
