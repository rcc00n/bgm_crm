{% load i18n tz %}<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <title>Bad Guy Motors | Client Portal</title>

  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="preload" href="{% static 'fonts/Diesel.ttf' %}" as="font" type="font/ttf" crossorigin>
<link rel="preload" href="{% static 'fonts/Ford.ttf' %}"   as="font" type="font/ttf" crossorigin>

  <style>
    :root{
      --bg:#000; --ink:#fff; --muted:rgba(255,255,255,.70); --muted-2:rgba(255,255,255,.55);
      --red:#d50000; --grid:rgba(255,255,255,.12); --panel:rgba(255,255,255,.03); --panel-2:rgba(255,255,255,.06);
      --ring:rgba(213,0,0,.5); --chip:rgba(255,255,255,.06); --busy:#444; --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.6);
    }
    html, body{height:100%}
    body{background:var(--bg); color:var(--ink); background:var(--bg); color:var(--ink); font-family:var(--font-body); letter-spacing:.2px}

    .smoke{position:fixed; inset:0; pointer-events:none; z-index:0; overflow:hidden}
    .smoke span{position:absolute; bottom:-220px; border-radius:50%; background:radial-gradient(rgba(255,255,255,.35), rgba(255,255,255,0) 70%);
      filter:blur(28px); opacity:0; will-change:transform,opacity; animation:rise 24s linear infinite}
    @keyframes rise{0%,100%{transform:translateY(0) scale(.4); opacity:0}10%{opacity:.45}50%{opacity:.25}100%{transform:translateY(-120vh) scale(1.8); opacity:0}}

    .app-wrap{position:relative; z-index:1; min-height:100vh; display:flex}

    .sidebar{width:16rem; background:linear-gradient(180deg, #070707 0%, #0b0b0b 100%); border-right:1px solid var(--grid); box-shadow:var(--shadow)}
    .brand{padding:1.25rem 1.5rem; display:flex; align-items:center; gap:.6rem; font-weight:900; letter-spacing:.8px; text-transform:uppercase}
    .brand .mark{color:var(--ink); background:var(--red); padding:.15rem .45rem; border-radius:10px; font-size:.95rem}
    .brand .name{color:#fff; opacity:.9}
    #sidebar a, #sidebar button{color:var(--muted)}
    .sidebar-link{display:flex; align-items:center; gap:.8rem; padding:.6rem .9rem; border-left:3px solid transparent; border-radius:10px; transition:.2s}
    .sidebar-link:hover{background:rgba(255,255,255,.04); color:#fff}
    .sidebar-link.is-active{background:rgba(213,0,0,.18); border-left-color:var(--red); color:#fff}
    .logout-btn{width:100%; text-align:left; border-left:3px solid transparent; border-radius:10px; padding:.6rem .9rem}
    .logout-btn:hover{background:rgba(255,255,255,.04); color:#fff}

    main{flex:1; padding:2rem; overflow-y:auto; background:
      radial-gradient(1200px 60vh at 80% -10%, rgba(213,0,0,.10), transparent 60%),
      radial-gradient(1000px 50vh at 10% 110%, rgba(255,255,255,.05), transparent 60%)
    }
    h1,h2,h3{color:#fff}
    .kicker{color:var(--muted)}

    .panel{background:var(--panel); border:1px solid var(--grid); border-radius:var(--radius); box-shadow:var(--shadow)}
    .panel-strong{background:var(--panel-2)}
    .panel-pad{padding:1.25rem}
    .table th{background:rgba(213,0,0,.18); color:#fff}
    .table td, .table th{border-bottom:1px solid var(--grid)}
    .muted{color:var(--muted)} .muted-2{color:var(--muted-2)} .ink{color:#fff}

    .btn{display:inline-flex; align-items:center; gap:.5rem; padding:.6rem 1rem; border-radius:10px; font-weight:800; transition:.18s; white-space:nowrap}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .btn-primary{background:var(--red); color:#fff; border:1px solid rgba(255,255,255,.1)}
    .btn-primary:hover{filter:brightness(1.03); transform:translateY(-1px); box-shadow:0 8px 16px rgba(213,0,0,.35)}
    .btn-ghost{background:transparent; color:#fff; border:1px solid var(--grid)}
    .btn-ghost:hover{background:rgba(255,255,255,.06)}
    .link{color:#fff; text-underline-offset:4px} .link:hover{color:var(--red); text-decoration:underline}

    .ol2{display:flex;flex-direction:column;border:1px solid var(--grid);border-radius:12px;background:rgba(0,0,0,.35);backdrop-filter:saturate(1.2) blur(2px);overflow:visible}
    .ol2__toolbar{display:flex;align-items:center;justify-content:space-between;padding:.5rem .75rem;border-bottom:1px solid var(--grid)}
    .ol2__wrap{flex:1 1 auto;overflow-x:auto;overflow-y:auto;max-height:56vh;min-height:300px;padding-bottom:10px;scrollbar-gutter:stable both-edges}
    .ol2__grid{display:grid;grid-auto-rows:36px;grid-template-columns:100px repeat(var(--days,14),140px);min-width:calc(100px + var(--days,14)*140px + 1px)}
    .ol2__cell{border-bottom:1px solid var(--grid);border-right:1px solid var(--grid);padding:.25rem .35rem;background:transparent;color:#fff;white-space:nowrap}
    .ol2__cell.time{position:sticky;left:0;background:rgba(0,0,0,.5);backdrop-filter:blur(3px);z-index:2;font-size:.85rem;color:var(--muted)}
    .ol2__head{position:sticky;top:0;background:rgba(0,0,0,.5);backdrop-filter:blur(3px);z-index:3;border-bottom:2px solid var(--grid)}
    .ol2__day{display:flex;flex-direction:column;padding:.4rem .45rem}
    .ol2__day .t{font-weight:900;font-size:.92rem;color:#fff;text-transform:capitalize}
    .ol2__day .s{font-size:.75rem;color:var(--muted)}
    .ol2__day.today{background:rgba(213,0,0,.12)}
    .chip{display:inline-flex;align-items:center;justify-content:center;height:1.7rem;min-width:3.4rem;padding:0 .45rem;border-radius:.5rem;border:1.6px solid transparent;font-weight:900;font-size:.9rem;line-height:1;user-select:none}
    .chip--free{color:#fff;border-color:rgba(255,255,255,.35);background:var(--chip);cursor:pointer}
    .chip--free:hover{filter:brightness(1.05)}
    .chip--busy{color:#aaa;background:var(--busy);opacity:.9; cursor:not-allowed}
    .chip--sel{background:var(--red)!important;color:#fff;border-color:var(--red)!important;box-shadow:0 0 0 2px var(--ring)}

    .modal{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; padding:1rem; z-index:50}
    .modal--open{display:flex}
    .modal__dialog{background:linear-gradient(180deg, rgba(15,15,15,.98), rgba(10,10,10,.98)); border:1px solid var(--grid); border-radius:16px; width:min(64rem, 96vw); padding:1rem; color:#fff; box-shadow:var(--shadow)}
    .modal__header{display:flex; align-items:center; justify-content:space-between; padding:.25rem .25rem .5rem .25rem; border-bottom:1px solid var(--grid)}
    .modal__title{font-weight:900; letter-spacing:.6px; color:#fff}
    .modal__close{background:transparent;color:var(--muted); border:none; font-size:1.6rem; line-height:1; cursor:pointer}
    .grid-2{display:grid;grid-template-columns:minmax(0,1.1fr) minmax(0,.9fr); gap:1rem; padding:1rem 0}
    .field{display:flex;flex-direction:column;gap:.35rem}
    .field label{font-size:.9rem;color:var(--muted)}
    .field input,.field select, .field textarea{background:#0b0b0b; color:#fff; border:1px solid var(--grid); border-radius:10px; padding:.6rem .8rem; font-size:.95rem}
    .hint{color:var(--muted-2); font-size:.85rem}
    .error{color:#ff6b6b; font-size:.9rem; margin-top:.5rem}
    .success{color:#33d17a; font-size:.95rem; margin-top:.5rem}

    .badge{display:inline-block;padding:.18rem .55rem;border-radius:999px;font-weight:800;font-size:.78rem;color:#fff;border:1px solid rgba(255,255,255,.12)}
    .st-processing{background:#f5a623}
    .st-shipped{background:#2d9cdb}
    .st-completed{background:#17d45b}
    .st-cancelled{background:#ff5c72}

    @media (max-width: 900px){ .grid-2{grid-template-columns:1fr} .ol2__wrap{max-height:50vh} }
    table.min-w-full{color:#fff}
    /* Profile form: make input text visible on white fields */
#tab-profile input,
#tab-profile select,
#tab-profile textarea{
  color:#111 !important;      /* —Ç—ë–º–Ω—ã–π —Ç–µ–∫—Å—Ç */
  caret-color:#111;
}
#tab-profile input::placeholder,
#tab-profile textarea::placeholder{
  color:rgba(0,0,0,.55);
}
  #bg{position:fixed; inset:0; z-index:0; pointer-events:none}
 
  .app-wrap{position:relative; z-index:1} /* —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –±—ã–ª –ø–æ–≤–µ—Ä—Ö —Ñ–æ–Ω–∞ */
  
#bg canvas{position:absolute; inset:0; width:100%; height:100%; display:block; pointer-events:none}

@font-face{
  font-family:"Diesel";
  src: url("{% static 'fonts/Diesel.ttf' %}") format("truetype");
  font-weight:100 900; font-style:normal; font-display:swap;
}
@font-face{
  font-family:"Ford";
  src: url("{% static 'fonts/Ford.ttf' %}") format("truetype");
  font-weight:100 900; font-style:normal; font-display:swap;
}

/* –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ */
:root{
  --font-body: "Diesel", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  --font-head: "Ford",  ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
}

/* —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ */
html{ text-rendering:optimizeLegibility; -webkit-font-smoothing:antialiased; }

h1,h2,h3,h4,h5,h6,
.brand, .brand .name, .brand .mark,
.modal__title,
.sidebar .sidebar-link,
.btn, .badge,
.table th,
.font-bold, .font-black, .font-semibold {
  font-family: var(--font-head) !important;
}

/* –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç/–∏–Ω–ø—É—Ç—ã */
body, input, select, textarea, button, .muted, .muted-2, .kicker, .panel, .chip {
  font-family: var(--font-body) !important;
}
  </style>
</head>
<body class="h-full">

<!-- <div class="smoke" id="smoke-layer"></div> -->
<div id="bg"></div>


<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="{% static 'admin/js/bgm-smoke.js' %}"></script>

<div class="app-wrap">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand"><span class="mark">BGM</span><span class="name">Client Portal</span></div>

    <nav id="sidebar" class="space-y-1 px-3 text-sm">
      <a href="#" data-tab="dashboard"     class="sidebar-link">üèÅ <span>Overview</span></a>
      <a href="#" data-tab="appointments"  class="sidebar-link">üóìÔ∏è <span>Appointments</span></a>
      <a href="#" data-tab="orders"        class="sidebar-link">üõí <span>Orders</span></a>
      <a href="#" data-tab="files"         class="sidebar-link">üìÇ <span>Files</span></a>
      <a href="#" data-tab="notifications" class="sidebar-link">üîî <span>Notifications</span></a>
      <a href="#" data-tab="profile"       class="sidebar-link">üßæ <span>Profile</span></a>

      {% url 'home' as home_url %}
      <a href="{{ home_url|default:'/' }}" class="mt-2 sidebar-link">‚¨ÖÔ∏è <span>Back to Home</span></a>

      <div class="my-3" style="border-top:1px solid var(--grid)"></div>
      <form method="post" action="{% url 'logout' %}" class="pb-4">{% csrf_token %}
        <button type="submit" class="logout-btn focus:outline-none">üö™ <span>Sign out</span></button>
      </form>
    </nav>
  </aside>

  <!-- MAIN -->
  <main>
    <!-- DASHBOARD -->
    <section id="tab-dashboard" class="tab">
      <h1 class="text-4xl font-black mb-2 tracking-wide">
        {% if request.user.first_name %}Welcome back, {{ request.user.first_name }}.{% else %}Welcome back, {{ request.user.username }}.{% endif %}
      </h1>
      <p class="kicker mb-8">Keep your builds on schedule. No mercy for missed slots.</p>

      <div class="grid lg:grid-cols-3 gap-6">
        <!-- Upcoming -->
        <div class="panel panel-pad">
          <h2 class="text-lg font-bold mb-4">Upcoming</h2>
          {% if upcoming_appointments %}
            <ul class="space-y-4 max-h-64 overflow-y-auto pr-1">
              {% for a in upcoming_appointments %}
                <li data-appt-id="{{ a.id }}">
                  <p class="font-semibold ink">{{ a.start_time|localtime|date:"d M Y, H:i" }}</p>
                  <p class="text-sm muted">{{ a.service.name }} ¬∑ {{ a.master.get_full_name }}</p>
                  <div class="mt-2 flex gap-4 text-sm">
                    <a href="#" class="appt-cancel link" data-appt-id="{{ a.id }}">Cancel</a>
                    <a href="#" class="appt-reschedule link" data-appt-id="{{ a.id }}" data-service-id="{{ a.service.id }}">Reschedule</a>
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="muted-2">No upcoming appointments.</p>
          {% endif %}
        </div>

        <!-- Stats -->
        <div class="panel panel-pad lg:col-span-2 panel-strong">
          <h2 class="text-lg font-bold mb-4">Stats</h2>
          <canvas id="stats_chart"
                  data-labels="{{ chart_labels|default:''|join:',' }}"
                  data-data="{{ chart_data|default:''|join:',' }}"
                  class="w-full h-56"></canvas>
        </div>
      </div>

      <!-- Recent -->
      <div class="panel panel-pad mt-8">
        <h2 class="text-lg font-bold mb-4">Recent appointments</h2>
        {% if recent_appointments %}
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm table rounded-lg overflow-hidden">
              <thead>
                <tr class="text-left">
                  <th class="py-2 pl-3 pr-4">Date</th>
                  <th class="py-2 pr-4">Service</th>
                  <th class="py-2 pr-4">Master</th>
                  <th class="py-2 pr-4">Status</th>
                  <th class="py-2 pr-3">Amount</th>
                </tr>
              </thead>
              <tbody>
                {% for a in recent_appointments %}
                  <tr class="bg-transparent" data-appt-id="{{ a.id }}">
                    <td class="py-2 pr-4 pl-3 whitespace-nowrap muted">{{ a.start_time|localtime|date:"d.m.Y H:i" }}</td>
                    <td class="py-2 pr-4">{{ a.service.name }}</td>
                    <td class="py-2 pr-4">{{ a.master.get_full_name }}</td>
                    <td class="py-2 pr-4">{{ a.current_status }}</td>
                    <td class="py-2 pr-3">{{ a.price|default:"‚Äî" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="muted-2">No completed appointments yet.</p>
        {% endif %}
      </div>
            <!-- RATES & FACTS -->
      <div class="grid lg:grid-cols-3 gap-6 mt-8">
        <div class="panel panel-pad">
          <h2 class="text-lg font-bold mb-4">Rates</h2>
          <div class="space-y-2 text-sm">
            <div class="flex items-center justify-between">
              <span class="muted">Shop rate</span><span class="font-bold">$130/hr</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="muted">Design/CAD rate</span><span class="font-bold">$150/hr</span>
            </div>
          </div>
        </div>

        <div class="panel panel-pad lg:col-span-2 panel-strong">
          <h2 class="text-lg font-bold mb-4">Quick facts</h2>
          <ul class="list-disc ms-5 text-sm space-y-1">
            <li>Alberta-made parts, built in Medicine Hat</li>
            <li>Custom fabrication, diesel performance, coatings</li>
            <li>Warranty &amp; aftercare included with every build</li>
          </ul>
        </div>
      </div>

      <!-- POLICIES & CARE -->
      <div class="grid lg:grid-cols-2 gap-6 mt-6">
        <div class="panel panel-pad">
          <h2 class="text-lg font-bold mb-3">Shop info &amp; policies</h2>
          <ul class="list-disc ms-5 text-sm space-y-1">
            <li>Deposits secure your slot; balances due on delivery.</li>
            <li>Storage fees may apply for completed items not picked up in a timely manner.</li>
            <li>We use DOM tubing, quality hardware, and proven components.</li>
            <li>Transparent timelines with progress updates in your portal.</li>
          </ul>
        </div>

        <div class="panel panel-pad">
          <h2 class="text-lg font-bold mb-3">Care &amp; warranty</h2>
          <ul class="list-disc ms-5 text-sm space-y-1">
            <li>Torque checks after install; follow-up available by appointment.</li>
            <li>Coatings (Armadillo / Smooth Criminal Liner): mild soap, soft brush; avoid harsh solvents.</li>
            <li>We stand behind our work‚Äîif something isn‚Äôt right, tell us and we‚Äôll make it right.</li>
          </ul>
        </div>
      </div>

    </section>

    <!-- APPOINTMENTS -->
    <section id="tab-appointments" class="tab hidden">
      <div class="flex items-center mb-6">
        <h2 class="text-2xl font-bold">My appointments</h2>
        <a href="/accounts/#services" class="ml-auto btn btn-primary shadow">+ Book</a>
      </div>

      {% if appointments %}
        <div class="space-y-4">
          {% for a in appointments %}
            <div class="panel panel-pad flex justify-between items-center {% if a.start_time < now %}opacity-70{% endif %}" data-appt-id="{{ a.id }}">
              <div class="appt-main">
                <p class="font-semibold ink appt-dt">{{ a.start_time|localtime|date:"d M Y, H:i" }}</p>
                <p class="text-sm muted">{{ a.service.name }} ¬∑ {{ a.master.get_full_name }}</p>
              </div>

              {% if a.start_time >= now %}
                <div class="flex gap-3 text-sm appt-actions">
                  <a href="#" class="appt-cancel link" data-appt-id="{{ a.id }}">Cancel</a>
                  <a href="#" class="appt-reschedule link" data-appt-id="{{ a.id }}" data-service-id="{{ a.service.id }}">Reschedule</a>
                </div>
              {% else %}
                <span class="text-xs muted-2">Completed</span>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="muted-2">No appointments.</p>
      {% endif %}
    </section>

    <!-- ORDERS -->
    <section id="tab-orders" class="tab hidden">
      <div class="flex items-center mb-6">
        <h2 class="text-2xl font-bold">My orders</h2>
        <a href="{% url 'store' %}" class="ml-auto btn btn-ghost">Go to products</a>
      </div>

      {# 1) –µ—Å–ª–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —É–∂–µ –µ—Å—Ç—å `orders` #}
      {% if orders %}
        {% with orders as orders_qs %}
          <div class="space-y-3">
            {% for o in orders_qs %}
              <div class="panel panel-pad">
                <div class="flex flex-wrap items-center gap-3">
                  <div class="text-sm muted">Order</div>
                  <div class="font-bold">#{{ o.id }}</div>
                  <div class="text-sm muted">
                    ¬∑ {{
                      o.created_at|default:o.shipped_at|default:o.completed_at|default:o.cancelled_at
                      |localtime|date:"d M Y, H:i"
                    }}
                  </div>
                  <div class="ml-auto flex items-center gap-3">
                    <span class="badge st-{{ o.status|default:'processing' }}">
                      {{ o.status_label|default:o.get_status_display|default:o.status }}
                    </span>
                    <div class="font-bold">${{ o.total|floatformat:2 }}</div>
                  </div>
                </div>

                {% with items=o.items.all %}
                  {% if items %}
                    <div class="mt-3 border-t border-[color:var(--grid)] pt-3">
                      {% for it in items %}
                        <div class="flex items-center justify-between py-1 text-sm">
                          <div class="truncate">
                            <span class="font-semibold">{{ it.product.name }}</span>
                            {% if it.product.sku %}<span class="muted-2"> ¬∑ SKU: {{ it.product.sku }}</span>{% endif %}
                          </div>
                          <div class="muted-2">x {{ it.qty }}</div>
                          <div class="font-semibold">${{ it.subtotal|floatformat:2 }}</div>
                        </div>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endwith %}
              </div>
            {% endfor %}
          </div>
        {% endwith %}

      {# 2) –∏–Ω–∞—á–µ ‚Äî –µ—Å–ª–∏ —é–∑–µ—Ä –∑–∞–ª–æ–≥–∏–Ω–µ–Ω, –ø—Ä–æ–±—É–µ–º –µ–≥–æ —Å–≤—è–∑–∞–Ω–Ω—ã–µ `orders` #}
      {% elif request.user.is_authenticated %}
        {% with user_orders=request.user.orders.all %}
          {% if user_orders %}
            {% with user_orders as orders_qs %}
              <div class="space-y-3">
                {% for o in orders_qs %}
                  <div class="panel panel-pad">
                    <div class="flex flex-wrap items-center gap-3">
                      <div class="text-sm muted">Order</div>
                      <div class="font-bold">#{{ o.id }}</div>
                      <div class="text-sm muted">
                        ¬∑ {{ o.created_at|default:o.shipped_at|default:o.completed_at|default:o.cancelled_at|localtime|date:"d M Y, H:i" }}
                      </div>
                      <div class="ml-auto flex items-center gap-3">
                        <span class="badge st-{{ o.status|default:'processing' }}">
                          {{ o.status_label|default:o.get_status_display|default:o.status }}
                        </span>
                        <div class="font-bold">${{ o.total|floatformat:2 }}</div>
                      </div>
                    </div>
                    {% with items=o.items.all %}
                      {% if items %}
                        <div class="mt-3 border-t border-[color:var(--grid)] pt-3">
                          {% for it in items %}
                            <div class="flex items-center justify-between py-1 text-sm">
                              <div class="truncate">
                                <span class="font-semibold">{{ it.product.name }}</span>
                                {% if it.product.sku %}<span class="muted-2"> ¬∑ SKU: {{ it.product.sku }}</span>{% endif %}
                              </div>
                              <div class="muted-2">x {{ it.qty }}</div>
                              <div class="font-semibold">${{ it.subtotal|floatformat:2 }}</div>
                            </div>
                          {% endfor %}
                        </div>
                      {% endif %}
                    {% endwith %}
                  </div>
                {% endfor %}
              </div>
            {% endwith %}
          {% else %}
            {# 3) —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–ª–±—ç–∫: –µ—Å–ª–∏ –≤–¥—Ä—É–≥ related_name –¥—Ä—É–≥–æ–π (order_set) #}
            {% with legacy_orders=request.user.order_set.all %}
              {% if legacy_orders %}
                {% with legacy_orders as orders_qs %}
                  <div class="space-y-3">
                    {% for o in orders_qs %}
                      <div class="panel panel-pad">
                        <div class="flex flex-wrap items-center gap-3">
                          <div class="text-sm muted">Order</div>
                          <div class="font-bold">#{{ o.id }}</div>
                          <div class="text-sm muted">
                            ¬∑ {{ o.created_at|default:o.shipped_at|default:o.completed_at|default:o.cancelled_at|localtime|date:"d M Y, H:i" }}
                          </div>
                          <div class="ml-auto flex items-center gap-3">
                            <span class="badge st-{{ o.status|default:'processing' }}">
                              {{ o.status_label|default:o.get_status_display|default:o.status }}
                            </span>
                            <div class="font-bold">${{ o.total|floatformat:2 }}</div>
                          </div>
                        </div>
                        {% with items=o.items.all %}
                          {% if items %}
                            <div class="mt-3 border-t border-[color:var(--grid)] pt-3">
                              {% for it in items %}
                                <div class="flex items-center justify-between py-1 text-sm">
                                  <div class="truncate">
                                    <span class="font-semibold">{{ it.product.name }}</span>
                                    {% if it.product.sku %}<span class="muted-2"> ¬∑ SKU: {{ it.product.sku }}</span>{% endif %}
                                  </div>
                                  <div class="muted-2">x {{ it.qty }}</div>
                                  <div class="font-semibold">${{ it.subtotal|floatformat:2 }}</div>
                                </div>
                              {% endfor %}
                            </div>
                          {% endif %}
                        {% endwith %}
                      </div>
                    {% endfor %}
                  </div>
                {% endwith %}
              {% else %}
                <p class="muted-2">No orders yet.</p>
              {% endif %}
            {% endwith %}
          {% endif %}
        {% endwith %}
      {% else %}
        <p class="muted-2">No orders yet.</p>
      {% endif %}
    </section>

    <!-- FILES -->
    <section id="tab-files" class="tab hidden">
      <h2 class="text-2xl font-bold mb-6">Files</h2>
      <p class="muted-2">Coming soon.</p>
    </section>

    <!-- NOTIFICATIONS -->
    <section id="tab-notifications" class="tab hidden">
      <h2 class="text-2xl font-bold mb-6">Notifications</h2>
      <p class="muted-2">Coming soon.</p>
    </section>

    <!-- PROFILE -->
    {% if messages %}
      <div class="mb-4 rounded-lg border border-[color:var(--ring)] bg-[rgba(213,0,0,.1)] text-white px-4 py-3 text-sm">
        {% for m in messages %}{{ m }}{% endfor %}
      </div>
    {% endif %}
    {% if profile_form_errors %}
      <div class="md:col-span-2 rounded-lg border border-red-500/50 bg-red-500/10 text-white px-4 py-3 text-sm">
        <ul class="list-disc ms-5">
          {% for field, errs in profile_form_errors.items %}
            {% for e in errs %}<li>{{ e }}</li>{% endfor %}
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <section id="tab-profile" class="tab hidden">
      <h2 class="text-2xl font-bold mb-6">Profile</h2>
      <form method="post" class="grid md:grid-cols-2 gap-6 panel panel-pad">
        {% csrf_token %}
        <div><label class="block text-sm muted">First name</label><input type="text" name="first_name" value="{{ request.user.first_name }}"></div>
        <div><label class="block text-sm muted">Last name</label><input type="text" name="last_name" value="{{ request.user.last_name }}"></div>
        <div><label class="block text-sm muted">Phone</label><input type="text" name="phone" value="{{ profile.phone }}"></div>
        <div><label class="block text-sm muted">E-mail</label><input type="email" name="email" value="{{ request.user.email }}"></div>
        <div><label class="block text-sm muted">Birth date</label><input type="date" name="birth_date" value="{{ profile.birth_date|date:'Y-m-d' }}"></div>
        <div class="md:col-span-2 text-right"><button type="submit" class="btn btn-ghost">Save changes</button></div>
      </form>
    </section>
  </main>
</div>

<!-- ===== MODAL: Reschedule ===== -->
<div id="resModal" class="modal">
  <div class="modal__dialog">
    <div class="modal__header">
      <h3 class="modal__title">Reschedule appointment</h3>
      <button id="resClose" class="modal__close" aria-label="Close">&times;</button>
    </div>

    <div class="space-y-3" style="padding-top:.75rem">
      <div>
        <label class="text-sm muted">Master</label>
        <select id="resMaster" class="w-full"></select>
      </div>

      <div>
        <label class="text-sm muted">Choose time</label>
        <div class="ol2 mt-1" id="rsOl">
          <div class="ol2__toolbar">
            <div class="flex gap-2">
              <button id="rsPrev"  type="button" class="btn btn-ghost px-2 py-1">‚Üê Prev</button>
              <button id="rsToday" type="button" class="btn btn-ghost px-2 py-1">Today</button>
              <button id="rsNext"  type="button" class="btn btn-ghost px-2 py-1">Next ‚Üí</button>
            </div>
            <div id="rsRange" class="font-bold">‚Äî</div>
          </div>
          <div class="ol2__wrap" id="rsWrap">
            <div class="ol2__grid" id="rsGrid" style="--days:14" tabindex="0"></div>
          </div>
        </div>

        <p class="text-xs muted-2 mt-2">Shift+Scroll ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞. –°–µ—Ä—ã–µ —Å–ª–æ—Ç—ã –∑–∞–Ω—è—Ç—ã.</p>
        <p class="text-sm" style="color:#ff6b6b; display:none" id="resErr"></p>
        <p class="text-sm" style="color:#33d17a; display:none" id="resOk"></p>
      </div>
    </div>

    <div class="flex justify-end gap-2 mt-4">
      <button id="resCancel" class="btn btn-ghost">Cancel</button>
      <button id="resSubmit" class="btn btn-primary disabled:opacity-50" disabled>Save</button>
    </div>
  </div>
</div>

<script>

  /* ==== —Ç–∞–±—ã ==== */
  const links = document.querySelectorAll('.sidebar-link');
  const tabs  = document.querySelectorAll('.tab');
  function setActive(el, yes){ el.classList.toggle('is-active', !!yes); }
  function activate(name){ tabs.forEach(t => t.classList.toggle('hidden', t.id !== 'tab-' + name));
                           links.forEach(l => setActive(l, l.dataset.tab === name)); }
  const allowed = ['dashboard','appointments','orders','files','notifications','profile'];
  const initial = allowed.includes(location.hash.replace('#','')) ? location.hash.replace('#','') : 'dashboard';
  activate(initial);
  links.forEach(link => link.addEventListener('click', e => {
    const tab = link.dataset.tab; if(!tab) return; e.preventDefault(); activate(tab); history.replaceState(null, '', '#'+tab);
  }));

    /* ==== Chart.js (robust) ==== */
  window.addEventListener('load', () => {          // <‚Äî –¥–æ–±–∞–≤—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É
    const el = document.getElementById('stats_chart');
    if (!el || !window.Chart) return;

    const parseArr = (raw) => {
      if (!raw) return [];
      try { const t = String(raw).trim(); if (t.startsWith('[')) return JSON.parse(t); } catch(e){}
      return String(raw).split(',').map(s => s.trim()).filter(Boolean);
    };
    const labels = parseArr(el.dataset.labels);
    const data   = parseArr(el.dataset.data).map(Number).filter(v => !Number.isNaN(v));

    if (!labels.length || !data.length) return;    // –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚Äî –Ω–µ —Ä–∏—Å—É–µ–º

    new Chart(el, {
      type: 'bar',
      data: { labels, datasets: [{ data, label: 'Appointments', backgroundColor: '#d50000', borderRadius: 8 }] },
      options: {
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#ccc' }, grid: { color: 'rgba(255,255,255,.06)' } },
          y: { beginAtZero: true, ticks: { stepSize: 1, color: '#ccc' }, grid: { color: 'rgba(255,255,255,.06)' } }
        }
      }
    });
  });

  /* ==== helpers ==== */
  const csrftoken = (document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)')||[])[2] || '';
  const fmtHM = d => d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
  const ymd = d => { const m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}-${m}-${day}`; };

  /* ==== Cancel ==== */
  async function cancelAppointment(id){
    if(!confirm('Cancel this appointment?')) return;
    const r = await fetch(`/accounts/api/appointment/${id}/cancel/`, { method:'POST', headers:{'X-CSRFToken': csrftoken}, credentials:'same-origin' });
    if(!r.ok){ alert('Cancel error: ' + (await r.text())); return; }
    strikeOut(id);
  }
  function strikeOut(id){
    document.querySelectorAll(`[data-appt-id="${id}"]`).forEach(node=>{
      node.classList.add('opacity-60');
      node.querySelectorAll('.appt-actions a').forEach(a=>{ a.classList.add('pointer-events-none','opacity-50'); a.removeAttribute('href'); });
      node.querySelectorAll('.appt-dt, .appt-main, p, td').forEach(el=> el.classList.add('line-through'));
    });
  }
  document.addEventListener('click', async (e)=>{
    const a = e.target.closest('.appt-cancel'); if(!a) return; e.preventDefault();
    const id = a.dataset.apptId; if(!id) return;
    cancelAppointment(id);
  });

  /* ==== RESCHEDULE ==== */
  const resModal  = document.getElementById('resModal');
  const resClose  = document.getElementById('resClose');
  const resCancel = document.getElementById('resCancel');
  const resSubmit = document.getElementById('resSubmit');
  const resMaster = document.getElementById('resMaster');
  const resErr    = document.getElementById('resErr');
  const resOk     = document.getElementById('resOk');

  const rsGrid = document.getElementById('rsGrid');
  const rsWrap = document.getElementById('rsWrap');
  const rsRange= document.getElementById('rsRange');
  const rsPrev = document.getElementById('rsPrev');
  const rsNext = document.getElementById('rsNext');
  const rsToday= document.getElementById('rsToday');

  if (resModal) {
    const WINDOW_DAYS = 14, START=6, END=23, STEP=30;

    let resState = {
      apptId:null, serviceId:null, masterId:null, slot:null, masters:[],
      baseStart: (()=>{const d=new Date(); d.setHours(0,0,0,0); return d;})(),
      cache: new Map()
    };

    function openRes(apptId, serviceId){
      resState = { ...resState, apptId, serviceId, masterId:null, slot:null, masters:[], cache:new Map() };
      resMaster.innerHTML = '';
      resSubmit.disabled = true;
      resErr.style.display='none'; resOk.style.display='none';
      resModal.classList.add('modal--open');
      loadMastersAndRender();
    }
    function closeRes(){ resModal.classList.remove('modal--open'); }

    async function fetchAvail(dayISO, masterId){
      const params = new URLSearchParams({ service: resState.serviceId, date: dayISO });
      if (masterId) params.set('master', masterId);
      const r = await fetch(`/accounts/api/availability/?${params.toString()}`, {credentials:'same-origin'});
      if(!r.ok) throw new Error('Failed to load slots');
      const data = await r.json();

      let slots=[];
      if (masterId){
        const m=(data.masters||[]).find(x=>Number(x.id)===Number(masterId)); slots = m ? (m.slots||[]) : [];
      }else{
        slots = (data.masters && data.masters[0] && data.masters[0].slots) ? data.masters[0].slots : [];
      }
      const set=new Set(), map=new Map();
      (slots||[]).forEach(iso=>{ const d=new Date(iso); const key=`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; set.add(key); if(!map.has(key)) map.set(key, iso); });
      return { raw:data, set, map };
    }

    async function ensureRangeLoaded(start, days){
      const jobs=[];
      for(let i=0;i<days;i++){
        const d=new Date(start); d.setDate(d.getDate()+i); const ds=ymd(d);
        if(!resState.cache.has(ds)){
          jobs.push((async()=>{
            resState.cache.set(ds, {loading:true});
            const {set,map}=await fetchAvail(ds, resState.masterId);
            resState.cache.set(ds,{set,iso:map});
          })());
        }
      }
      if (jobs.length) await Promise.allSettled(jobs);
    }

    function buildTimeRows(extraSets){
      const out=[];
      for(let h=START;h<=END;h++) for(let m=0;m<60;m+=STEP) out.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`);
      (extraSets||[]).forEach(s=>s && s.forEach(t=>{ if(!out.includes(t)) out.push(t); }));
      return out.sort();
    }

    async function loadMastersAndRender(){
      try{
        const first = await fetchAvail(ymd(resState.baseStart), null);
        resState.masters = (first.raw && first.raw.masters) || [];
        resMaster.innerHTML = '';
        if(resState.masters.length===0){
          resMaster.innerHTML = '<option>No masters available</option>';
          rsGrid.innerHTML = '<div class="p-4 text-sm muted-2">No availability</div>';
          return;
        }
        resState.masters.forEach(m=>{ const opt=document.createElement('option'); opt.value=m.id; opt.textContent=m.name; resMaster.appendChild(opt); });
        const withSlots = resState.masters.find(m=>(m.slots||[]).length) || resState.masters[0];
        resMaster.value = withSlots.id;
        resState.masterId = Number(resMaster.value);
        resState.cache.clear();
        await renderWindow();
      }catch(e){
        resErr.textContent = e.message || 'Unable to fetch availability';
        resErr.style.display='block';
      }
    }

    async function renderWindow(){
      await ensureRangeLoaded(resState.baseStart, WINDOW_DAYS);

      const days = Array.from({length:WINDOW_DAYS}, (_,i)=>{ const d=new Date(resState.baseStart); d.setDate(d.getDate()+i); return d;});
      const dayStrs = days.map(ymd);
      const dayData = dayStrs.map(ds => resState.cache.get(ds));
      const timeRows = buildTimeRows(dayData.map(x=>x?.set));

      const from = days[0].toLocaleDateString([], {month:'short', day:'numeric'});
      const to   = days[days.length-1].toLocaleDateString([], {month:'short', day:'numeric'});
      rsRange.textContent = `${from} ‚Äì ${to}`;
      rsGrid.style.setProperty('--days', String(WINDOW_DAYS));
      rsGrid.innerHTML='';

      const corner=document.createElement('div'); corner.className='ol2__cell ol2__head time'; rsGrid.appendChild(corner);

      days.forEach(d=>{
        const h=document.createElement('div');
        h.className='ol2__cell ol2__head';
        const today = (new Date()).toDateString()===d.toDateString();
        h.innerHTML = `<div class="ol2__day ${today?'today':''}">
          <div class="t">${d.toLocaleDateString([], {weekday:'long'})}</div>
          <div class="s">${d.toLocaleDateString([], {month:'short', day:'numeric'})}</div>
        </div>`;
        rsGrid.appendChild(h);
      });

      timeRows.forEach(t=>{
        const [hh,mm]=t.split(':').map(Number);
        const fake=new Date(); fake.setHours(hh,mm,0,0);
        const timeCell=document.createElement('div');
        timeCell.className='ol2__cell time'; timeCell.textContent = fmtHM(fake);
        rsGrid.appendChild(timeCell);

        days.forEach((d, idx)=>{
          const cell=document.createElement('div'); cell.className='ol2__cell';
          const data = dayData[idx]; const isFree = data?.set?.has(t);
          const chip=document.createElement('button');
          chip.type='button'; chip.className='chip ' + (isFree?'chip--free':'chip--busy');
          chip.textContent = fmtHM(fake);

          if(isFree){
            chip.addEventListener('click', ()=>{
              rsGrid.querySelectorAll('.chip--sel').forEach(x=>x.classList.remove('chip--sel'));
              chip.classList.add('chip--sel');
              resState.slot = data.iso.get(t);
              resSubmit.disabled=false;
            });
          }else{
            chip.disabled=true;
          }
          cell.appendChild(chip);
          rsGrid.appendChild(cell);
        });
      });

      const todayIdx = days.findIndex(x=>x.toDateString()===(new Date()).toDateString());
      if (todayIdx>0){ rsWrap.scrollLeft = todayIdx*140 - 140; }
    }

    async function shiftWindow(delta){
      const d=new Date(resState.baseStart); d.setDate(d.getDate()+delta); d.setHours(0,0,0,0); resState.baseStart = d;
      await renderWindow();
    }

    resMaster.addEventListener('change', async ()=>{
      resState.masterId = Number(resMaster.value);
      resState.slot = null; resSubmit.disabled=true; resState.cache.clear();
      await renderWindow();
    });
    rsPrev.addEventListener('click', ()=>shiftWindow(-WINDOW_DAYS));
    rsNext.addEventListener('click', ()=>shiftWindow(WINDOW_DAYS));
    rsToday.addEventListener('click', async ()=>{ const d=new Date(); d.setHours(0,0,0,0); resState.baseStart=d; await renderWindow(); });

    // Shift+Wheel ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª
    rsWrap.addEventListener('wheel', (e)=>{ if(e.shiftKey && Math.abs(e.deltaY)>Math.abs(e.deltaX)){ e.preventDefault(); rsWrap.scrollLeft += e.deltaY; } }, {passive:false});

    async function submitRes(){
      if(!resState.apptId || !resState.slot) return;
      resSubmit.disabled = true; resErr.style.display='none'; resOk.style.display='none';
      const r = await fetch(`/accounts/api/appointment/${resState.apptId}/reschedule/`, {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken': csrftoken},
        credentials:'same-origin',
        body: JSON.stringify({ start_time: resState.slot, master: resState.masterId })
      });
      const data = await r.json().catch(()=> ({}));
      if(r.ok){
        resOk.textContent = 'Rescheduled to ' + (data.appointment?.start_time || '');
        resOk.style.display='block';
        document.querySelectorAll(`[data-appt-id="${resState.apptId}"] .appt-dt`).forEach(dt=>{
          try{ dt.textContent = new Date(data.appointment.start_time).toLocaleString(); }catch(_){}
        });
        setTimeout(()=> location.reload(), 700);
      }else{
        resErr.textContent = data.error || data.detail || 'Reschedule failed';
        resErr.style.display='block'; resSubmit.disabled = false;
      }
    }

    document.addEventListener('click', (e)=>{
      const a = e.target.closest('.appt-reschedule');
      if(!a) return; e.preventDefault();
      openRes(a.dataset.apptId, a.dataset.serviceId);
    });
    resClose.addEventListener('click', closeRes);
    resCancel.addEventListener('click', closeRes);
    resModal.addEventListener('click', (e)=>{ if(e.target===resModal) closeRes(); });
    resSubmit.addEventListener('click', submitRes);
  }

</script>
</body>
</html>
