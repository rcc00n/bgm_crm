{% load i18n tz %}<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
    <meta charset="utf-8">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç | Malva Booking</title>

    <!-- Tailwind CSS JIT CDN -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

    <!-- Chart.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="h-full bg-gray-100 text-gray-800">

<div class="min-h-screen flex">

    <!-- ‚ñ∏‚ñ∏ SIDEBAR ‚óÇ‚óÇ -->
<aside class="w-64 bg-white shadow-lg">
    <div class="p-6 font-bold text-indigo-600 text-xl">Malva</div>

    <nav id="sidebar" class="space-y-1 px-4 text-sm">
        <a href="#" data-tab="dashboard"
           class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md hover:bg-indigo-50">
            üè† <span>–û–±–∑–æ—Ä</span>
        </a>
        <a href="#" data-tab="appointments"
           class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md hover:bg-indigo-50">
            üìÖ <span>–ó–∞–ø–∏—Å–∏</span>
        </a>
        <a href="#" data-tab="files"
           class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md hover:bg-indigo-50">
            üìÇ <span>–§–∞–π–ª—ã</span>
        </a>
        <a href="#" data-tab="notifications"
           class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md hover:bg-indigo-50">
            üîî <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
        </a>
        <a href="#" data-tab="profile"
           class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md hover:bg-indigo-50">
            üë§ <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </a>

        <!-- –∫–Ω–æ–ø–∫–∞ ¬´–ù–∞ –≥–ª–∞–≤–Ω—É—é¬ª ‚Üí /accounts/ -->
        <a href="/accounts/"
           class="flex items-center gap-3 px-3 py-2 rounded-md hover:bg-indigo-50">
            ‚¨ÖÔ∏è <span>–ù–∞&nbsp;–≥–ª–∞–≤–Ω—É—é</span>
        </a>

        <!-- —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
        <div class="my-3 border-t border-gray-100"></div>

        <!-- –í—ã–π—Ç–∏ (POST), —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–æ –∫–∞–∫ –ø—É–Ω–∫—Ç –º–µ–Ω—é -->
        <form method="post" action="{% url 'logout' %}">
          {% csrf_token %}
          <button type="submit"
                  class="w-full text-left flex items-center gap-3 px-3 py-2 rounded-md
                         text-rose-600 hover:text-rose-700 hover:bg-rose-50
                         focus:outline-none focus:ring-2 focus:ring-rose-300 transition">
            üö™ <span>–í—ã–π—Ç–∏</span>
          </button>
        </form>
    </nav>
</aside>

    <!-- ‚ñ∏‚ñ∏ MAIN ‚óÇ‚óÇ -->
    <main class="flex-1 p-8 overflow-y-auto">

        <!-- DASHBOARD -->
        <section id="tab-dashboard" class="tab">
            <h1 class="text-3xl font-bold mb-8">
                {% if request.user.first_name %}
                    –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {{ request.user.first_name }}!
                {% else %}
                    –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {{ request.user.username }}!
                {% endif %}
            </h1>

            <div class="grid lg:grid-cols-3 gap-6">

                <!-- –ë–ª–∏–∂–∞–π—à–∏–π –≤–∏–∑–∏—Ç -->
                <div class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-lg font-semibold mb-4">–ë–ª–∏–∂–∞–π—à–∏–π –≤–∏–∑–∏—Ç</h2>
                    {% if next_appointment %}
                        <p class="font-medium">
                            {{ next_appointment.start_time|localtime|date:"d E Y, H:i" }}
                        </p>
                        <p class="text-sm text-gray-600">
                            {{ next_appointment.service.name }} ¬∑
                            {{ next_appointment.master.get_full_name }}
                        </p>
                        <div class="mt-4 flex gap-4 text-sm">
                            <!-- –î–û–ë–ê–í–õ–ï–ù–û: data-* –∏ –∫–ª–∞—Å—Å—ã –¥–ª—è JS -->
                            <a href="#"
                               class="text-red-600 hover:underline appt-cancel"
                               data-appt-id="{{ next_appointment.id }}">
                               –û—Ç–º–µ–Ω–∏—Ç—å
                            </a>
                            <a href="#"
                               class="text-indigo-600 hover:underline appt-reschedule"
                               data-appt-id="{{ next_appointment.id }}"
                               data-service-id="{{ next_appointment.service.id }}">
                               –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏
                            </a>
                        </div>
                    {% else %}
                        <p class="text-gray-500">–ë–ª–∏–∂–∞–π—à–∏—Ö –≤–∏–∑–∏—Ç–æ–≤ –Ω–µ—Ç.</p>
                    {% endif %}
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="bg-white rounded-xl shadow p-6 lg:col-span-2">
                    <h2 class="text-lg font-semibold mb-4">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                    <canvas id="stats_chart"
                            data-labels="{{ chart_labels|join:',' }}"
                            data-data="{{ chart_data|join:',' }}"
                            class="w-full h-56"></canvas>
                </div>
            </div>

            <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤–∏–∑–∏—Ç—ã -->
            <div class="bg-white rounded-xl shadow p-6 mt-8">
                <h2 class="text-lg font-semibold mb-4">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤–∏–∑–∏—Ç—ã</h2>
                {% if recent_appointments %}
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead>
                            <tr class="text-left text-gray-500 border-b">
                                <th class="py-2 pr-4">–î–∞—Ç–∞</th>
                                <th class="py-2 pr-4">–£—Å–ª—É–≥–∞</th>
                                <th class="py-2 pr-4">–ú–∞—Å—Ç–µ—Ä</th>
                                <th class="py-2 pr-4">–°—Ç–∞—Ç—É—Å</th>
                                <th class="py-2">–°—É–º–º–∞</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for a in recent_appointments %}
                                <tr class="border-b">
                                    <td class="py-2 pr-4 whitespace-nowrap">
                                        {{ a.start_time|localtime|date:"d.m.Y H:i" }}
                                    </td>
                                    <td class="py-2 pr-4">{{ a.service.name }}</td>
                                    <td class="py-2 pr-4">{{ a.master.get_full_name }}</td>
                                    <td class="py-2 pr-4">{{ a.current_status }}</td>
                                    <td class="py-2">{{ a.price|default:"‚Äî" }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-gray-500">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –≤–∏–∑–∏—Ç–æ–≤.</p>
                {% endif %}
            </div>
        </section>

        <!-- APPOINTMENTS -->
        <section id="tab-appointments" class="tab hidden">
            <div class="flex items-center mb-6">
                <h2 class="text-2xl font-semibold">–ú–æ–∏ –∑–∞–ø–∏—Å–∏</h2>
                <button class="ml-auto px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700">
                    + –ó–∞–ø–∏—Å–∞—Ç—å—Å—è
                </button>
            </div>

            {% if appointments %}
                <div class="space-y-4">
                    {% for a in appointments %}
                        <div class="bg-white shadow rounded-lg p-4 flex justify-between items-center
                                    {% if a.start_time < now %}opacity-50{% endif %}">
                            <div>
                                <p class="font-medium">
                                    {{ a.start_time|localtime|date:"d E Y, H:i" }}
                                </p>
                                <p class="text-sm text-gray-600">
                                    {{ a.service.name }} ¬∑ {{ a.master.get_full_name }}
                                </p>
                            </div>

                            {% if a.start_time >= now %}
                                <div class="flex gap-3 text-sm">
                                    <!-- –î–û–ë–ê–í–õ–ï–ù–û: data-* –∏ –∫–ª–∞—Å—Å—ã –¥–ª—è JS -->
                                    <a href="#"
                                       class="text-red-600 hover:underline appt-cancel"
                                       data-appt-id="{{ a.id }}">
                                       –û—Ç–º–µ–Ω–∏—Ç—å
                                    </a>
                                    <a href="#"
                                       class="text-indigo-600 hover:underline appt-reschedule"
                                       data-appt-id="{{ a.id }}"
                                       data-service-id="{{ a.service.id }}">
                                       –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏
                                    </a>
                                </div>
                            {% else %}
                                <span class="text-xs text-gray-500">–ó–∞–≤–µ—Ä—à—ë–Ω</span>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500">–ó–∞–ø–∏—Å–µ–π –Ω–µ—Ç.</p>
            {% endif %}
        </section>

        <!-- FILES (–ø–æ–∫–∞ —Å—Ç–∞—Ç–∏—á–Ω–æ) -->
        <section id="tab-files" class="tab hidden">
            <h2 class="text-2xl font-semibold mb-6">–§–∞–π–ª—ã</h2>
            <!-- –ø–æ–∑–∂–µ –ø–æ–¥–∫–ª—é—á–∏–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
            <p class="text-gray-500">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</p>
        </section>

        <!-- NOTIFICATIONS (–ø–æ–∫–∞ —Å—Ç–∞—Ç–∏—á–Ω–æ) -->
        <section id="tab-notifications" class="tab hidden">
            <h2 class="text-2xl font-semibold mb-6">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
            <p class="text-gray-500">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</p>
        </section>

        <!-- PROFILE -->
        <section id="tab-profile" class="tab hidden">
            <h2 class="text-2xl font-semibold mb-6">–ü—Ä–æ—Ñ–∏–ª—å</h2>

            <form method="post" class="grid md:grid-cols-2 gap-6 bg-white shadow rounded-xl p-6">
                {% csrf_token %}
                <div>
                    <label class="block text-sm font-medium">–ò–º—è</label>
                    <input type="text" name="first_name"
                           value="{{ request.user.first_name }}"
                           class="w-full mt-1 rounded-lg border-gray-300 px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium">–§–∞–º–∏–ª–∏—è</label>
                    <input type="text" name="last_name"
                           value="{{ request.user.last_name }}"
                           class="w-full mt-1 rounded-lg border-gray-300 px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="text" name="phone"
                           value="{{ profile.phone }}"
                           class="w-full mt-1 rounded-lg border-gray-300 px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium">E-mail</label>
                    <input type="email" name="email"
                           value="{{ request.user.email }}"
                           class="w-full mt-1 rounded-lg border-gray-300 px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                    <input type="date" name="birth_date"
                           value="{{ profile.birth_date|date:'Y-m-d' }}"
                           class="w-full mt-1 rounded-lg border-gray-300 px-3 py-2 text-sm">
                </div>

                <div class="md:col-span-2 text-right">
                    <button type="submit"
                            class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </form>
        </section>

    </main>
</div>

<!-- ‚ñ∏‚ñ∏ MODAL: –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–ø–∏—Å—å ‚óÇ‚óÇ -->
<div id="resModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
  <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl p-4">
    <div class="flex items-center justify-between mb-3">
      <h3 class="font-bold text-lg">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–ø–∏—Å—å</h3>
      <button id="resClose" class="text-gray-500 text-2xl leading-none">&times;</button>
    </div>

    <div class="space-y-3">
      <div>
        <label class="text-sm text-gray-600">–î–∞—Ç–∞</label>
        <input type="date" id="resDate" class="w-full border rounded-md px-3 py-2">
      </div>
      <div>
        <label class="text-sm text-gray-600">–ú–∞—Å—Ç–µ—Ä</label>
        <select id="resMaster" class="w-full border rounded-md px-3 py-2"></select>
      </div>
      <div>
        <label class="text-sm text-gray-600">–°–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã</label>
        <div id="resSlots" class="grid grid-cols-3 gap-2 max-h-56 overflow-auto border rounded-md p-2">
          <div class="animate-pulse h-9 bg-gray-100 rounded"></div>
        </div>
        <p class="text-sm text-gray-500 mt-1" id="resHint">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</p>
        <p class="text-sm text-red-600 mt-1 hidden" id="resErr"></p>
        <p class="text-sm text-emerald-700 mt-1 hidden" id="resOk"></p>
      </div>
    </div>

    <div class="flex justify-end gap-2 mt-4">
      <button id="resCancel" class="px-4 py-2 rounded-md border">–û—Ç–º–µ–Ω–∞</button>
      <button id="resSubmit" class="px-4 py-2 rounded-md bg-indigo-600 text-white disabled:opacity-50" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- ‚ñ∏‚ñ∏ JS ‚óÇ‚óÇ -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    /* --- –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ --- */
    const links = document.querySelectorAll('.sidebar-link');
    const tabs  = document.querySelectorAll('.tab');

    function activate(tabName) {
        tabs.forEach(t => t.classList.toggle('hidden', t.id !== 'tab-' + tabName));
        links.forEach(l => {
            const active = l.dataset.tab === tabName;
            l.classList.toggle('bg-indigo-50', active);
            l.classList.toggle('text-indigo-700', active);
        });
    }

    links.forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            activate(link.dataset.tab);
        });
    });
    activate('dashboard');

    /* --- Chart.js –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö --- */
    const el = document.getElementById('stats_chart');
    if (el) {
        const labels = el.dataset.labels ? el.dataset.labels.split(',') : [];
        const data   = el.dataset.data   ? el.dataset.data.split(',').map(Number) : [];
        new Chart(el, {
            type: 'bar',
            data: { labels, datasets: [{ data, label: '–í–∏–∑–∏—Ç—ã' }] },
            options: {
                plugins: { legend: { display: false }},
                scales : { y: { beginAtZero: true, ticks: { stepSize: 1 }}}
            }
        });
    }

    /* ====== –î–û–ë–ê–í–õ–ï–ù–û: –æ—Ç–º–µ–Ω–∞ –∏ –ø–µ—Ä–µ–Ω–æ—Å –∑–∞–ø–∏—Å–∏ ====== */
    const csrftoken = (document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)')||[])[2] || '';
    function fmtTime(iso){
      try { return new Date(iso).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
      catch(e){ return iso; }
    }
    function todayStr(){
      const d=new Date(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${m}-${day}`;
    }

    // --- Cancel ---
    document.addEventListener('click', async (e)=>{
      const a = e.target.closest('.appt-cancel');
      if(!a) return;
      e.preventDefault();
      const id = a.dataset.apptId;
      if(!id) return;
      if(!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
      const r = await fetch(`/accounts/api/appointment/${id}/cancel/`, {
        method:'POST', headers:{'X-CSRFToken': csrftoken}, credentials:'same-origin'
      });
      if(r.ok) location.reload();
      else alert('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã: ' + (await r.text()));
    });

    // --- Reschedule modal ---
    const resModal  = document.getElementById('resModal');
    const resClose  = document.getElementById('resClose');
    const resCancel = document.getElementById('resCancel');
    const resSubmit = document.getElementById('resSubmit');
    const resDate   = document.getElementById('resDate');
    const resMaster = document.getElementById('resMaster');
    const resSlots  = document.getElementById('resSlots');
    const resErr    = document.getElementById('resErr');
    const resOk     = document.getElementById('resOk');
    let current = { apptId:null, serviceId:null, masterId:null, slot:null, masters:[] };

    function openRes(apptId, serviceId){
      current = { apptId, serviceId, masterId:null, slot:null, masters:[] };
      resDate.min = todayStr();
      resDate.value = todayStr();
      resMaster.innerHTML = '';
      resSlots.innerHTML = '<div class="animate-pulse h-9 bg-gray-100 rounded"></div>';
      resSubmit.disabled = true;
      resErr.classList.add('hidden'); resOk.classList.add('hidden');
      resModal.classList.remove('hidden');
      loadAvail();
    }
    function closeRes(){ resModal.classList.add('hidden'); }

    async function loadAvail(){
      const params = new URLSearchParams({ service: current.serviceId, date: resDate.value });
      const r = await fetch(`/accounts/api/availability/?` + params.toString(), {credentials:'same-origin'});
      if(!r.ok){ resErr.textContent='–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ—Ç–æ–≤'; resErr.classList.remove('hidden'); return; }
      const data = await r.json();
      current.masters = data.masters || [];
      resMaster.innerHTML = '';
      if(current.masters.length === 0){
        resMaster.innerHTML = '<option>–ù–µ—Ç –º–∞—Å—Ç–µ—Ä–æ–≤</option>';
        resSlots.innerHTML = '<div class="text-sm text-gray-500">–ù–µ—Ç —Å–ª–æ—Ç–æ–≤</div>';
        return;
      }
      current.masters.forEach(m=>{
        const opt=document.createElement('option'); opt.value=m.id; opt.textContent=m.name; resMaster.appendChild(opt);
      });
      const m = current.masters.find(x => (x.slots||[]).length) || current.masters[0];
      resMaster.value = m.id;
      renderSlots();
    }

    function renderSlots(){
      resSubmit.disabled = true; current.slot = null;
      const mId = Number(resMaster.value);
      const m = current.masters.find(x=> Number(x.id)===mId);
      const slots = (m && m.slots) ? m.slots : [];
      resSlots.innerHTML = '';
      if(slots.length === 0){
        resSlots.innerHTML = '<div class="text-sm text-gray-500">–ù–µ—Ç —Å–ª–æ—Ç–æ–≤ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É</div>';
        return;
      }
      slots.forEach(iso=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='px-3 py-2 border rounded-md hover:bg-indigo-50';
        b.textContent = fmtTime(iso);
        b.addEventListener('click', ()=>{
          [...resSlots.children].forEach(el=>el.classList.remove('ring','ring-indigo-300','bg-indigo-50'));
          b.classList.add('ring','ring-indigo-300','bg-indigo-50');
          current.slot = iso; current.masterId = mId; resSubmit.disabled = false;
        });
        resSlots.appendChild(b);
      });
    }

    async function submitRes(){
      if(!current.apptId || !current.slot) return;
      resSubmit.disabled = true; resErr.classList.add('hidden'); resOk.classList.add('hidden');
      const r = await fetch(`/accounts/api/appointment/${current.apptId}/reschedule/`, {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken': csrftoken},
        credentials:'same-origin',
        body: JSON.stringify({ start_time: current.slot, master: current.masterId })
      });
      const data = await r.json().catch(()=> ({}));
      if(r.ok){
        resOk.textContent = '–ó–∞–ø–∏—Å—å –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –Ω–∞ ' + (data.appointment?.start_time || '');
        resOk.classList.remove('hidden');
        setTimeout(()=> location.reload(), 600);
      }else{
        resErr.textContent = data.error || data.detail || '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞';
        resErr.classList.remove('hidden'); resSubmit.disabled = false;
      }
    }

    document.addEventListener('click', (e)=>{
      const a = e.target.closest('.appt-reschedule');
      if(!a) return;
      e.preventDefault();
      openRes(a.dataset.apptId, a.dataset.serviceId);
    });
    resClose.addEventListener('click', closeRes);
    resCancel.addEventListener('click', closeRes);
    resModal.addEventListener('click', (e)=>{ if(e.target===resModal) closeRes(); });
    resDate.addEventListener('change', loadAvail);
    resMaster.addEventListener('change', renderSlots);
    resSubmit.addEventListener('click', submitRes);
});
</script>
</body>
</html>
